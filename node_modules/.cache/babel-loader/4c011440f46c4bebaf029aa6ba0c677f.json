{"ast":null,"code":"import _objectWithoutProperties from \"@babel/runtime/helpers/objectWithoutProperties\";\nimport _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport _assertThisInitialized from \"@babel/runtime/helpers/assertThisInitialized\";\nimport _inherits from \"@babel/runtime/helpers/inherits\";\nimport _createSuper from \"@babel/runtime/helpers/createSuper\";\nimport _defineProperty from \"@babel/runtime/helpers/defineProperty\";\nvar _excluded = [\"id\"];\nimport { createScopedElement } from \"../../lib/jsxRuntime\";\nimport * as React from \"react\";\nimport { classNames } from \"../../lib/classNames\";\nimport { transitionEvent } from \"../../lib/supportEvents\";\nimport { withPlatform } from \"../../hoc/withPlatform\";\nimport { withContext } from \"../../hoc/withContext\";\nimport ModalRootContext from \"./ModalRootContext\";\nimport { ConfigProviderContext, WebviewType } from \"../ConfigProvider/ConfigProviderContext\";\nimport { ANDROID, VKCOM } from \"../../lib/platform\";\nimport { getClassName } from \"../../helpers/getClassName\";\nimport { withDOM } from \"../../lib/dom\";\nimport { getNavId } from \"../../lib/getNavId\";\nimport { warnOnce } from \"../../lib/warnOnce\";\nimport { FocusTrap } from \"../FocusTrap/FocusTrap\";\nimport { withModalManager } from \"./useModalManager\";\nvar warn = warnOnce(\"ModalRoot\");\n\nvar ModalRootDesktopComponent = /*#__PURE__*/function (_React$Component) {\n  _inherits(ModalRootDesktopComponent, _React$Component);\n\n  var _super = _createSuper(ModalRootDesktopComponent);\n\n  function ModalRootDesktopComponent(props) {\n    var _this;\n\n    _classCallCheck(this, ModalRootDesktopComponent);\n\n    _this = _super.call(this, props);\n\n    _defineProperty(_assertThisInitialized(_this), \"maskElementRef\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"maskAnimationFrame\", undefined);\n\n    _defineProperty(_assertThisInitialized(_this), \"modalRootContext\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"restoreFocusTo\", undefined);\n\n    _this.maskElementRef = /*#__PURE__*/React.createRef();\n    _this.modalRootContext = {\n      updateModalHeight: function updateModalHeight() {\n        return undefined;\n      },\n      registerModal: function registerModal(_ref) {\n        var id = _ref.id,\n            data = _objectWithoutProperties(_ref, _excluded);\n\n        return Object.assign(_this.getModalState(id), data);\n      },\n      onClose: function onClose() {\n        return _this.props.closeActiveModal();\n      },\n      isInsideModal: true\n    };\n    return _this;\n  }\n\n  _createClass(ModalRootDesktopComponent, [{\n    key: \"timeout\",\n    get: function get() {\n      return this.props.platform === ANDROID || this.props.platform === VKCOM ? 320 : 400;\n    }\n  }, {\n    key: \"modals\",\n    get: function get() {\n      return React.Children.toArray(this.props.children);\n    }\n  }, {\n    key: \"getModalState\",\n    value: function getModalState(id) {\n      if (id === null) {\n        return undefined;\n      }\n\n      return this.props.getModalState(id);\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps) {\n      var _this2 = this; // transition phase 2: animate exiting modal\n\n\n      if (this.props.exitingModal && this.props.exitingModal !== prevProps.exitingModal) {\n        this.closeModal(this.props.exitingModal);\n      } // transition phase 3: animate entering modal\n\n\n      if (this.props.enteringModal && this.props.enteringModal !== prevProps.enteringModal) {\n        var enteringModal = this.props.enteringModal;\n        var enteringState = this.getModalState(enteringModal);\n        requestAnimationFrame(function () {\n          if (_this2.props.enteringModal === enteringModal) {\n            _this2.waitTransitionFinish(enteringState, function () {\n              return _this2.props.onEnter(enteringModal);\n            });\n\n            _this2.animateModalOpacity(enteringState, true);\n          }\n        });\n      } // focus restoration\n\n\n      if (this.props.activeModal && !prevProps.activeModal) {\n        var _this$props$document$, _this$props$document;\n\n        this.restoreFocusTo = (_this$props$document$ = (_this$props$document = this.props.document) === null || _this$props$document === void 0 ? void 0 : _this$props$document.activeElement) !== null && _this$props$document$ !== void 0 ? _this$props$document$ : undefined;\n      }\n\n      if (!this.props.activeModal && !this.props.exitingModal && this.restoreFocusTo) {\n        this.restoreFocusTo.focus();\n        this.restoreFocusTo = undefined;\n      }\n    }\n  }, {\n    key: \"closeModal\",\n    value: function closeModal(id) {\n      var _this3 = this;\n\n      var prevModalState = this.getModalState(id);\n\n      if (!prevModalState) {\n        return;\n      }\n\n      this.waitTransitionFinish(prevModalState, function () {\n        return _this3.props.onExit(id);\n      });\n      this.animateModalOpacity(prevModalState, false);\n\n      if (!this.props.activeModal) {\n        this.setMaskOpacity(prevModalState, 0);\n      }\n    }\n  }, {\n    key: \"waitTransitionFinish\",\n    value: function waitTransitionFinish(modalState, eventHandler) {\n      if (transitionEvent.supported) {\n        var _modalState$innerElem2;\n\n        var onceHandler = function onceHandler() {\n          var _modalState$innerElem;\n\n          modalState === null || modalState === void 0 ? void 0 : (_modalState$innerElem = modalState.innerElement) === null || _modalState$innerElem === void 0 ? void 0 : _modalState$innerElem.removeEventListener(transitionEvent.name, onceHandler);\n          eventHandler();\n        };\n\n        modalState === null || modalState === void 0 ? void 0 : (_modalState$innerElem2 = modalState.innerElement) === null || _modalState$innerElem2 === void 0 ? void 0 : _modalState$innerElem2.addEventListener(transitionEvent.name, onceHandler);\n      } else {\n        setTimeout(eventHandler, this.timeout);\n      }\n    }\n    /* Анимирует сдивг модалки */\n\n  }, {\n    key: \"animateModalOpacity\",\n    value: function animateModalOpacity(modalState, display) {\n      if (modalState !== null && modalState !== void 0 && modalState.innerElement) {\n        modalState.innerElement.style.transitionDelay = display && this.props.delayEnter ? \"\".concat(this.timeout, \"ms\") : \"\";\n        modalState.innerElement.style.opacity = display ? \"1\" : \"0\";\n      }\n    }\n    /* Устанавливает прозрачность для полупрозрачной подложки */\n\n  }, {\n    key: \"setMaskOpacity\",\n    value: function setMaskOpacity(modalState) {\n      var _this$props$history,\n          _this4 = this;\n\n      var forceOpacity = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n\n      if (forceOpacity === null && ((_this$props$history = this.props.history) === null || _this$props$history === void 0 ? void 0 : _this$props$history[0]) !== modalState.id) {\n        return;\n      }\n\n      if (this.maskAnimationFrame) {\n        cancelAnimationFrame(this.maskAnimationFrame);\n      }\n\n      this.maskAnimationFrame = requestAnimationFrame(function () {\n        if (_this4.maskElementRef.current) {\n          var _modalState$translate = modalState.translateY,\n              translateY = _modalState$translate === void 0 ? 0 : _modalState$translate,\n              _modalState$translate2 = modalState.translateYCurrent,\n              translateYCurrent = _modalState$translate2 === void 0 ? 0 : _modalState$translate2;\n          var opacity = forceOpacity === null ? 1 - (translateYCurrent - translateY) / (100 - translateY) || 0 : forceOpacity;\n          _this4.maskElementRef.current.style.opacity = Math.max(0, Math.min(100, opacity)).toString();\n        }\n      });\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this$props$configPro,\n          _this5 = this;\n\n      var _this$props = this.props,\n          exitingModal = _this$props.exitingModal,\n          activeModal = _this$props.activeModal,\n          enteringModal = _this$props.enteringModal;\n\n      if (!activeModal && !exitingModal) {\n        return null;\n      }\n\n      return createScopedElement(ModalRootContext.Provider, {\n        value: this.modalRootContext\n      }, createScopedElement(\"div\", {\n        vkuiClass: classNames(getClassName(\"ModalRoot\", this.props.platform), {\n          \"ModalRoot--vkapps\": ((_this$props$configPro = this.props.configProvider) === null || _this$props$configPro === void 0 ? void 0 : _this$props$configPro.webviewType) === WebviewType.VKAPPS\n        }, \"ModalRoot--desktop\")\n      }, createScopedElement(\"div\", {\n        vkuiClass: \"ModalRoot__mask\",\n        ref: this.maskElementRef,\n        onClick: this.props.closeActiveModal\n      }), createScopedElement(\"div\", {\n        vkuiClass: \"ModalRoot__viewport\"\n      }, this.modals.map(function (Modal) {\n        var modalId = getNavId(Modal.props, warn);\n\n        if (modalId !== activeModal && modalId !== exitingModal) {\n          return null;\n        }\n\n        var key = \"modal-\".concat(modalId);\n        return createScopedElement(FocusTrap, {\n          restoreFocus: false,\n          onClose: _this5.props.closeActiveModal,\n          timeout: _this5.timeout,\n          key: key,\n          vkuiClass: classNames(\"ModalRoot__modal\", {\n            \"ModalRoot__modal--active\": !exitingModal && !enteringModal && modalId === activeModal,\n            \"ModalRoot__modal--prev\": modalId === exitingModal,\n            \"ModalRoot__modal--next\": Boolean(exitingModal) && modalId === activeModal\n          })\n        }, Modal);\n      }))));\n    }\n  }]);\n\n  return ModalRootDesktopComponent;\n}(React.Component);\n\nexport var ModalRootDesktop = withContext(withPlatform(withDOM(withModalManager()(ModalRootDesktopComponent))), ConfigProviderContext, \"configProvider\");","map":{"version":3,"mappings":"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","names":["React","classNames","transitionEvent","withPlatform","withContext","ModalRootContext","ConfigProviderContext","WebviewType","ANDROID","VKCOM","getClassName","withDOM","getNavId","warnOnce","FocusTrap","withModalManager","warn","ModalRootDesktopComponent","props","_classCallCheck","_this","_defineProperty","undefined","maskElementRef","createRef","modalRootContext","updateModalHeight","registerModal","id","data","Object","assign","getModalState","onClose","closeActiveModal","isInsideModal","platform","Children","toArray","children","prevProps","exitingModal","closeModal","enteringModal","enteringState","requestAnimationFrame","_this2","waitTransitionFinish","onEnter","animateModalOpacity","activeModal","restoreFocusTo","document","_this$props$document","activeElement","focus","prevModalState","_this3","onExit","setMaskOpacity","modalState","eventHandler","supported","onceHandler","innerElement","removeEventListener","name","addEventListener","setTimeout","timeout","display","style","transitionDelay","delayEnter","opacity","forceOpacity","history","maskAnimationFrame","cancelAnimationFrame","_this4","current","translateY","translateYCurrent","Math","max","min","toString","createScopedElement","Provider","value","vkuiClass","configProvider","webviewType","VKAPPS","ref","onClick","modals","map","Modal","modalId","key","restoreFocus","_this5","Boolean","Component","ModalRootDesktop"],"sources":["/Users/al.balandin/code/vkvideo-test/node_modules/@vkontakte/vkui/src/components/ModalRoot/ModalRootDesktop.tsx"],"sourcesContent":["import * as React from \"react\";\nimport { classNames } from \"../../lib/classNames\";\nimport { transitionEvent } from \"../../lib/supportEvents\";\nimport { HasPlatform } from \"../../types\";\nimport { withPlatform } from \"../../hoc/withPlatform\";\nimport { withContext } from \"../../hoc/withContext\";\nimport ModalRootContext, {\n  ModalRootContextInterface,\n} from \"./ModalRootContext\";\nimport {\n  ConfigProviderContext,\n  ConfigProviderContextInterface,\n  WebviewType,\n} from \"../ConfigProvider/ConfigProviderContext\";\nimport { ModalsStateEntry } from \"./types\";\nimport { ANDROID, VKCOM } from \"../../lib/platform\";\nimport { getClassName } from \"../../helpers/getClassName\";\nimport { DOMProps, withDOM } from \"../../lib/dom\";\nimport { getNavId } from \"../../lib/getNavId\";\nimport { warnOnce } from \"../../lib/warnOnce\";\nimport { FocusTrap } from \"../FocusTrap/FocusTrap\";\nimport { ModalTransitionProps, withModalManager } from \"./useModalManager\";\nimport \"./ModalRoot.css\";\n\nconst warn = warnOnce(\"ModalRoot\");\n\nexport interface ModalRootProps extends HasPlatform {\n  activeModal?: string | null;\n  /**\n   * @ignore\n   */\n  configProvider?: ConfigProviderContextInterface;\n\n  /**\n   * Будет вызвано при закрытии активной модалки с её id\n   */\n  onClose?(modalId: string): void;\n}\n\nclass ModalRootDesktopComponent extends React.Component<\n  ModalRootProps & DOMProps & ModalTransitionProps\n> {\n  constructor(props: ModalRootProps & ModalTransitionProps) {\n    super(props);\n\n    this.maskElementRef = React.createRef();\n\n    this.modalRootContext = {\n      updateModalHeight: () => undefined,\n      registerModal: ({ id, ...data }) =>\n        Object.assign(this.getModalState(id), data),\n      onClose: () => this.props.closeActiveModal(),\n      isInsideModal: true,\n    };\n  }\n\n  private readonly maskElementRef: React.RefObject<HTMLDivElement>;\n  private maskAnimationFrame: number | undefined = undefined;\n  private readonly modalRootContext: ModalRootContextInterface;\n  private restoreFocusTo: HTMLElement | undefined = undefined;\n\n  private get timeout() {\n    return this.props.platform === ANDROID || this.props.platform === VKCOM\n      ? 320\n      : 400;\n  }\n\n  private get modals() {\n    return React.Children.toArray(this.props.children) as React.ReactElement[];\n  }\n\n  getModalState(id: string | null) {\n    if (id === null) {\n      return undefined;\n    }\n    return this.props.getModalState(id);\n  }\n\n  componentDidUpdate(prevProps: ModalRootProps & ModalTransitionProps) {\n    // transition phase 2: animate exiting modal\n    if (\n      this.props.exitingModal &&\n      this.props.exitingModal !== prevProps.exitingModal\n    ) {\n      this.closeModal(this.props.exitingModal);\n    }\n\n    // transition phase 3: animate entering modal\n    if (\n      this.props.enteringModal &&\n      this.props.enteringModal !== prevProps.enteringModal\n    ) {\n      const { enteringModal } = this.props;\n      const enteringState = this.getModalState(enteringModal);\n      requestAnimationFrame(() => {\n        if (this.props.enteringModal === enteringModal) {\n          this.waitTransitionFinish(enteringState, () =>\n            this.props.onEnter(enteringModal)\n          );\n          this.animateModalOpacity(enteringState, true);\n        }\n      });\n    }\n\n    // focus restoration\n    if (this.props.activeModal && !prevProps.activeModal) {\n      this.restoreFocusTo = (this.props.document?.activeElement ??\n        undefined) as HTMLElement | undefined;\n    }\n    if (\n      !this.props.activeModal &&\n      !this.props.exitingModal &&\n      this.restoreFocusTo\n    ) {\n      this.restoreFocusTo.focus();\n      this.restoreFocusTo = undefined;\n    }\n  }\n\n  closeModal(id: string) {\n    const prevModalState = this.getModalState(id);\n    if (!prevModalState) {\n      return;\n    }\n\n    this.waitTransitionFinish(prevModalState, () => this.props.onExit(id));\n    this.animateModalOpacity(prevModalState, false);\n    if (!this.props.activeModal) {\n      this.setMaskOpacity(prevModalState, 0);\n    }\n  }\n\n  waitTransitionFinish(\n    modalState: ModalsStateEntry | undefined,\n    eventHandler: () => void\n  ) {\n    if (transitionEvent.supported) {\n      const onceHandler = () => {\n        modalState?.innerElement?.removeEventListener(\n          transitionEvent.name as string,\n          onceHandler\n        );\n        eventHandler();\n      };\n\n      modalState?.innerElement?.addEventListener(\n        transitionEvent.name as string,\n        onceHandler\n      );\n    } else {\n      setTimeout(eventHandler, this.timeout);\n    }\n  }\n\n  /* Анимирует сдивг модалки */\n  animateModalOpacity(\n    modalState: ModalsStateEntry | undefined,\n    display: boolean\n  ) {\n    if (modalState?.innerElement) {\n      modalState.innerElement.style.transitionDelay =\n        display && this.props.delayEnter ? `${this.timeout}ms` : \"\";\n      modalState.innerElement.style.opacity = display ? \"1\" : \"0\";\n    }\n  }\n\n  /* Устанавливает прозрачность для полупрозрачной подложки */\n  setMaskOpacity(\n    modalState: ModalsStateEntry,\n    forceOpacity: number | null = null\n  ) {\n    if (forceOpacity === null && this.props.history?.[0] !== modalState.id) {\n      return;\n    }\n\n    if (this.maskAnimationFrame) {\n      cancelAnimationFrame(this.maskAnimationFrame);\n    }\n    this.maskAnimationFrame = requestAnimationFrame(() => {\n      if (this.maskElementRef.current) {\n        const { translateY = 0, translateYCurrent = 0 } = modalState;\n\n        const opacity =\n          forceOpacity === null\n            ? 1 - (translateYCurrent - translateY) / (100 - translateY) || 0\n            : forceOpacity;\n        this.maskElementRef.current.style.opacity = Math.max(\n          0,\n          Math.min(100, opacity)\n        ).toString();\n      }\n    });\n  }\n\n  render() {\n    const { exitingModal, activeModal, enteringModal } = this.props;\n\n    if (!activeModal && !exitingModal) {\n      return null;\n    }\n\n    return (\n      <ModalRootContext.Provider value={this.modalRootContext}>\n        <div\n          vkuiClass={classNames(\n            getClassName(\"ModalRoot\", this.props.platform),\n            {\n              \"ModalRoot--vkapps\":\n                this.props.configProvider?.webviewType === WebviewType.VKAPPS,\n            },\n            \"ModalRoot--desktop\"\n          )}\n        >\n          <div\n            vkuiClass=\"ModalRoot__mask\"\n            ref={this.maskElementRef}\n            onClick={this.props.closeActiveModal}\n          />\n          <div vkuiClass=\"ModalRoot__viewport\">\n            {this.modals.map((Modal: React.ReactElement) => {\n              const modalId = getNavId(Modal.props, warn);\n              if (modalId !== activeModal && modalId !== exitingModal) {\n                return null;\n              }\n\n              const key = `modal-${modalId}`;\n\n              return (\n                <FocusTrap\n                  restoreFocus={false}\n                  onClose={this.props.closeActiveModal}\n                  timeout={this.timeout}\n                  key={key}\n                  vkuiClass={classNames(\"ModalRoot__modal\", {\n                    \"ModalRoot__modal--active\":\n                      !exitingModal &&\n                      !enteringModal &&\n                      modalId === activeModal,\n                    \"ModalRoot__modal--prev\": modalId === exitingModal,\n                    \"ModalRoot__modal--next\":\n                      Boolean(exitingModal) && modalId === activeModal,\n                  })}\n                >\n                  {Modal}\n                </FocusTrap>\n              );\n            })}\n          </div>\n        </div>\n      </ModalRootContext.Provider>\n    );\n  }\n}\n\nexport const ModalRootDesktop = withContext(\n  withPlatform(\n    withDOM<ModalRootProps>(withModalManager()(ModalRootDesktopComponent))\n  ),\n  ConfigProviderContext,\n  \"configProvider\"\n);\n"]},"metadata":{},"sourceType":"module"}