/**
 * @vkontakte/videoplayer-statistics v1.0.25
 * Wed, 21 Sep 2022 08:17:06 GMT
 * https://st.mycdn.me/static/vkontakte-videoplayer/1-0-25/doc/
 */
import{ValueSubject as t,getExponentialDelay as e,Subscription as s,Subject as r,fromEvent as o}from'@vkontakte/videoplayer-shared/esnext.esm.js';import i from'lodash/debounce.js';const a=(()=>{try{const t=Date.now().toString(),e=window.localStorage;e.setItem(t,t);const s=e.getItem(t)===t;return e.removeItem(t),s?e:null}catch(t){return null}})();var n,h,u,c,p,l,d,m={get:t=>function(t){const e=a?a.getItem('_one-stat_'+t):null;if(null===e)return null;try{return JSON.parse(e)}catch(t){return null}}(t)||null,set(t,e){!function(t,e){try{a&&a.setItem('_one-stat_'+t,JSON.stringify(e))}catch(t){}}(t,e)},remove(t){!function(t){a&&a.removeItem('_one-stat_'+t)}(t)}};!function(t){t.PROD='prod',t.VK_ALIAS='vk_alias',t.VIDEOTEST='videotest',t.TEST='test',t.AUTO='auto'}(n||(n={})),function(t){t.Q144P='144',t.Q240P='240',t.Q360P='360',t.Q480P='480',t.Q720P='720',t.Q1080P='1080',t.Q1440P='1440',t.Q2160P='2160',t.Q4320P='4320',t.UNKNOWN='unknown'}(h||(h={})),function(t){t.CHROMECAST='chromecast',t.APPLE_TV='appletv',t.PIP='pip',t.HEADPHONES='externalHeadphones',t.SCREEN=''}(u||(u={})),function(t){t.MP4='mp4',t.DASH='dash',t.DASH_SEP='dash_sep',t.ONDEMAND_DASH='ondemand_dash',t.HLS='hls',t.ONDEMAND_HLS='ondemand_hls',t.WEBM='webm',t.RTMP='rtmp',t.UNKNOWN='unknown'}(c||(c={})),function(t){t.AUTO='auto',t.MANUAL=''}(p||(p={})),function(t){t.HTTP1='http1',t.HTTP2='http2',t.HTTP3='http3'}(l||(l={})),function(t){t[t.YES=1]='YES',t[t.NO=0]='NO'}(d||(d={}));const g={[n.PROD]:'https://api.ok.ru',[n.VK_ALIAS]:'https://api.mycdn.me',[n.VIDEOTEST]:'https://videotestapi.ok.ru/api',[n.TEST]:'https://apitest.ok.ru',[n.AUTO]:''},f={start:1e3,factor:1.5,max:3e5,random:.1};var y;!function(t){t[t.PARAM_SESSION_EXPIRED=102]='PARAM_SESSION_EXPIRED',t[t.PARAM_SESSION_KEY=103]='PARAM_SESSION_KEY',t[t.PARAM_SIGNATURE=104]='PARAM_SIGNATURE',t[t.AUTH_LOGIN=401]='AUTH_LOGIN'}(y||(y={}));class A{params;uuid;authToken;sessionKey;authorizePromise;refreshAuthTokenPromise;consequentAuthErrors=0;authorized$=new t(!1);backoffTimeoutId;constructor(t){this.params=t;const e=m.get('uuid');e?this.uuid=String(e):(this.uuid=function(){const t='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split(''),e=new Array(36);let s,r,o=0;for(r=0;r<36;r++)8===r||13===r||18===r||23===r?e[r]='-':14===r?e[r]='4':(o<=2&&(o=33554432+16777216*Math.random()|0),s=15&o,o>>=4,e[r]=t[19===r?3&s|8:s]);return e.join('')}(),m.set('uuid',this.uuid))}async authorize(t){return this.authToken=t??await this.refreshAuthToken(),this._authorizeWithBackoff()}logBeacon(t){const e=this.createLogParams(t),s=this.sessionKey;if(!s)return;this.params.apiTransport.sendBeacon('log.externalLog',e,s)||this.logRequest(t)}async logRequest(t){const e='log.externalLog',s=this.createLogParams(t),r=this.sessionKey??await this._authorizeWithBackoff();if(!r)return;const o=async(t,i=this.params.requestRetryCount)=>{try{return await this.params.apiTransport.sendRequest(e,s,r)}catch(s){if(!s||!('error_code'in s))return void this.params.error$.next({id:'logRequestUnknown',message:`Unknown ${e} error`,thrown:s});const r=s?.error_code;switch(r){case y.PARAM_SESSION_EXPIRED:case y.PARAM_SESSION_KEY:case y.PARAM_SIGNATURE:return this.authorized$.next(!1),this.sessionKey=await this._authorizeWithBackoff(),i>0?o(t,i-1):void 0;case y.AUTH_LOGIN:return this.authorized$.next(!1),this.authToken=await this.refreshAuthToken(),this.sessionKey=await this._authorizeWithBackoff(),i>0?o(t,i-1):void 0;default:return void this.params.error$.next({id:`LogRequest#${r}`,message:`${e} error`,data:s})}}};return o(t)}destroy(){window.clearTimeout(this.backoffTimeoutId),this.backoffTimeoutId=0}async refreshAuthToken(){if(this.params.refreshAuthToken)return this.refreshAuthTokenPromise||(this.refreshAuthTokenPromise=this.params.refreshAuthToken().finally((()=>{this.refreshAuthTokenPromise=void 0}))),this.refreshAuthTokenPromise}createLogParams(t){return{collector:'ok.mobile.apps.video',data:JSON.stringify({application:'@vkontakte/videoplayer-statistics:1.0.25',platform:'WEB',items:t.map((t=>({...t,time:0,type:1})))})}}_authorizeWithBackoff(){if(!this.consequentAuthErrors)return this._authorize();const t=e(this.consequentAuthErrors,f);return new Promise((e=>{this.backoffTimeoutId||(this.backoffTimeoutId=window.setTimeout((()=>{this._authorize().then(e).catch((t=>this.params.error$.next({id:'AuthorizeBackoff',message:'Otherwise unhandle errror in authrization',thrown:t}))).finally((()=>this.backoffTimeoutId=0))}),t))}))}async _authorize(){if(this.authorizePromise)return this.authorizePromise;this.sessionKey=void 0,this.authorized$.next(!1);const t={session_data:{version:2,device_id:this.uuid,client_version:'1.0.25'.split('-')[0],client_type:'SDK_JS'}};return void 0!==this.authToken&&(t.session_data.auth_token=this.authToken,t.session_data.version=3),this.authorizePromise=this.params.apiTransport.sendRequest('auth.anonymLogin',t).then((t=>(t&&t.session_key||this.params.error$.next({id:'AuthorizeFailed',message:'No session key',data:t}),this.sessionKey=t?.session_key??void 0,this.sessionKey))).catch((async t=>{this.sessionKey=void 0;const e=t?.error_code;switch(e){case y.AUTH_LOGIN:return this.authToken=await this.refreshAuthToken(),this._authorizeWithBackoff()}e?this.params.error$.next({id:`Authorize#${e}`,message:'authorize error',data:t}):this.params.error$.next({id:'AuthorizeUnknown',message:'authorize error',thrown:t})})).finally((()=>{this.authorizePromise=void 0,this.consequentAuthErrors=this.sessionKey?0:this.consequentAuthErrors+1,this.authorized$.next(void 0!==this.sessionKey)})),this.authorizePromise}}function _(t){return t.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL?(console.log('__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL=true is set, will force install polyfill'),!0):'function'==typeof t.Request&&!t.Request.prototype.hasOwnProperty('signal')||!t.AbortController}const w=_({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}),T=w?function(t){'function'==typeof t&&(t={fetch:t});const{fetch:e,Request:s=e.Request,AbortController:r,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:o=!1}=t;if(!_({fetch:e,Request:s,AbortController:r,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:o}))return{fetch:e,Request:i};let i=s;(i&&!i.prototype.hasOwnProperty('signal')||o)&&(i=function(t,e){let r;e&&e.signal&&(r=e.signal,delete e.signal);const o=new s(t,e);return r&&Object.defineProperty(o,'signal',{writable:!1,enumerable:!1,configurable:!0,value:r}),o},i.prototype=s.prototype);const a=e;return{fetch:(t,e)=>{const s=i&&i.prototype.isPrototypeOf(t)?t.signal:e?e.signal:void 0;if(s){let r;try{r=new DOMException('Aborted','AbortError')}catch(t){r=new Error('Aborted'),r.name='AbortError'}if(s.aborted)return Promise.reject(r);const o=new Promise(((t,e)=>{s.addEventListener('abort',(()=>e(r)),{once:!0})}));return e&&e.signal&&delete e.signal,Promise.race([o,a(t,e)])}return a(t,e)},Request:i}}({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}):void 0,P=w?T.fetch:window.fetch;w?T.Request:window.Request;class S{apiKey;apiBaseUrl;apiEnv;isApiBaseUrlFetched;params;constructor(t){this.params=t,this.apiKey=t.apiKey,this.apiEnv=t.apiEnv,this.apiBaseUrl=t.apiBaseUrl,this.isApiBaseUrlFetched=!1}async resolveApiBaseUrl(){if(this.apiEnv!==n.AUTO||this.isApiBaseUrlFetched)return this.apiBaseUrl;try{const t=atob('aHR0cHM6Ly9kbnMuZ29vZ2xlL3Jlc29sdmU/bmFtZT12aWRlby5fZW5kcG9pbnQub2sucnUmdHlwZT1UWFQ='),e=await P(t,{method:'GET',mode:'cors',cache:'no-cache'}),s=(await e.json())?.Answer[0]?.data;if(!s)throw new Error('Wrong DNS response');return s}catch(t){return this.params.error$.next({id:'OneStat:ApiTransport:resolveApiBaseUrl',message:'Unhandled resolve api base url error',thrown:t}),g[n.VK_ALIAS]}finally{this.isApiBaseUrlFetched=!0}}sendBeacon(t,e,s){if(!window.Blob||!window.navigator.sendBeacon)return!1;const r=this._prepareQueryParams({method:t,queryParams:e,sessionKey:s}),o=new window.Blob([r.toString()],{type:'application/x-www-form-urlencoded'});try{return window.navigator.sendBeacon(`${this.apiBaseUrl}/fb.do`,o)}catch(s){this.params.error$.next({id:'OneStat:ApiTransport:sendBeacon',message:'Unhandled beacon error',thrown:s,data:{method:t,params:e}})}return!1}async sendRequest(t,e,s){const r=Date.now(),o=o=>{o instanceof TypeError&&['Failed to fetch','NetworkError when attempting to fetch resource.'].includes(o.message)?this.params.error$.next({id:'Network',message:'Request failed',thrown:o}):this.params.error$.next({id:'OneStat:ApiTransport:sendRequest',message:'Unhandled request error',thrown:o,data:{method:t,params:e,sessionKey:s,time:Date.now()-r}})};return this.apiBaseUrl=await this.resolveApiBaseUrl(),P(`${this.apiBaseUrl}/fb.do`,{method:'post',headers:{'Content-type':'application/x-www-form-urlencoded'},body:this._prepareQueryParams({method:t,queryParams:e,sessionKey:s})}).then((t=>Number(t.headers.get('content-length'))>0?t.json().then((t=>Object.prototype.hasOwnProperty.call(t,'error_msg')?Promise.reject(t):t),o):void 0),o)}_prepareQueryParams(t){const e=new URLSearchParams({format:'JSON',method:t.method,application_key:this.apiKey});return void 0!==t.sessionKey&&e.append('session_key',t.sessionKey),Object.entries(t.queryParams).forEach((([t,s])=>e.append(t,'string'==typeof s?s:JSON.stringify(s)))),e}}class E{api;error$;requestQueue=[];subscription;isPaused=!1;debouncedFlush=i((()=>{try{this.flush()}catch(t){this.error$.next({id:'LoggerError',message:String(t)??'Unknown logger error',thrown:t})}}),3e3,{maxWait:15e3});constructor(t){this.api=t.api,this.error$=t.error$,this.subscription=this.api.authorized$.subscribe((t=>{t&&this.debouncedFlush()}))}log(t){this.requestQueue.push(t),this.isPaused||this.debouncedFlush()}flush(t=!1){0!==this.requestQueue.length&&(this.api.authorized$.getValue()?(t?this.api.logBeacon(this.requestQueue):this.api.logRequest(this.requestQueue),this.requestQueue=[]):t||this.api.authorize(),this.debouncedFlush.cancel())}pause(){this.isPaused=!0,this.debouncedFlush.cancel()}resume(){this.isPaused=!1,this.debouncedFlush()}destroy(){this.subscription.unsubscribe()}}class R{api;logger;config;subscription=new s;experimental;statContext;constructor(t,e){this.statContext=t,this.config={...e.config??{},requestRetryCount:1};const s=new r;this.experimental={error$:s};const i=new S({apiKey:'CIOPGQJGDIHBABABA',apiBaseUrl:g[e.apiEnv],apiEnv:e.apiEnv,error$:s});this.api=new A({apiTransport:i,refreshAuthToken:e.refreshAuthToken,requestRetryCount:this.config.requestRetryCount,error$:s}),this.logger=new E({api:this.api,error$:s}),this.subscription.add(o(window,'beforeunload').subscribe((()=>this.logger.flush(!0))))}updateContext(t){this.statContext={...this.statContext,...t}}authorize(t){return this.api.authorize(t)}pause(){this.logger.pause()}resume(){this.logger.resume()}destroy(){this.logger.flush(),this.subscription.unsubscribe(),this.api.destroy(),this.logger.destroy()}logInited(){this.log({operation:'init'})}logReady(t){this.log({operation:'player_ready',param:String(t.time)})}logStarted(t){this.log({operation:'play',param:String(Math.round(t.position))})}logPlay(){this.log({operation:'play_toggle'})}logPause(t){this.log({operation:'pause',param:String(Math.round(t.position))})}logSeek(){this.log({operation:'seek'})}logFirstBytes(t){this.log({operation:'first_bytes',param:String(t.time)})}logFirstFrame(t){this.log({operation:'first_frame',param:String(t.time)})}logError(t){this.log({operation:'error',param:t.errorType})}logWatchCoverageRecord(t){this.log({operation:'watch_coverage_record',param:`${t.start}-${t.end}`}),this.logger.flush(!0)}logWatchCoverageLive(t){this.log({operation:'watch_coverage_live',param:`${t.start}-${t.end}`}),this.logger.flush(!0)}logEmptyBuffer(t){this.log({operation:'empty_buffer',param:String(t.duration)})}logDownloadSpeed(t){this.log({operation:'download_speed',param:String(t.speed)})}logAdSlotRequest(){this.log({operation:'adv',param:'slot_request'})}logAdStarted(t){this.log({operation:'adv',param:t})}logAdPaused(){this.log({operation:'adv',param:'pause'})}logAdResumed(){this.log({operation:'adv',param:'resume'})}logAdEnded(){this.log({operation:'adv',param:'ended'})}logAdSkipped(){this.log({operation:'adv',param:'skip'})}logAdClicked(){this.log({operation:'adv',param:'click'})}log(t){const e=this.crateLogItem(t);this.logger.log(e)}crateLogItem({operation:t,param:e}){const s=Date.now(),r={vid:this.statContext.movieId,quality:this.statContext.quality,dst:this.statContext.destination,ct:this.statContext.contentType,aid:this.statContext.albumId,place:this.statContext.place,cdn_host:this.statContext.cdnHostname,connection_type:this.statContext.connectionType,connection_reused:!0===this.statContext.connectionReused?d.YES:!1===this.statContext.connectionReused?d.NO:void 0,stat_type:!0===this.statContext.autoplay?p.AUTO:!1===this.statContext.autoplay?p.MANUAL:void 0,vk_playlist_id:this.statContext.vkPlaylistId,vk_app_id:this.statContext.vkAppId,track_code:this.statContext.trackCode};return void 0!==e&&(r.param=e),{operation:t,timestamp:s,custom:r}}}export{n as ApiEnv,l as ConnectionType,c as ContentType,R as OneStat,h as Quality,u as ScreenDestination};
