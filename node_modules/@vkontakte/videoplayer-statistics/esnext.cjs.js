/**
 * @vkontakte/videoplayer-statistics v1.0.25
 * Wed, 21 Sep 2022 08:17:06 GMT
 * https://st.mycdn.me/static/vkontakte-videoplayer/1-0-25/doc/
 */
'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var e=require('@vkontakte/videoplayer-shared/esnext.cjs.js');function t(e){return e&&'object'==typeof e&&'default'in e?e:{default:e}}var o=t(require('lodash/debounce.js'));const s=(()=>{try{const e=Date.now().toString(),t=window.localStorage;t.setItem(e,e);const o=t.getItem(e)===e;return t.removeItem(e),o?t:null}catch(e){return null}})();var r,i,a,n,h,u,p,c={get:e=>function(e){const t=s?s.getItem('_one-stat_'+e):null;if(null===t)return null;try{return JSON.parse(t)}catch(e){return null}}(e)||null,set(e,t){!function(e,t){try{s&&s.setItem('_one-stat_'+e,JSON.stringify(t))}catch(e){}}(e,t)},remove(e){!function(e){s&&s.removeItem('_one-stat_'+e)}(e)}};exports.ApiEnv=void 0,(r=exports.ApiEnv||(exports.ApiEnv={})).PROD='prod',r.VK_ALIAS='vk_alias',r.VIDEOTEST='videotest',r.TEST='test',r.AUTO='auto',exports.Quality=void 0,(i=exports.Quality||(exports.Quality={})).Q144P='144',i.Q240P='240',i.Q360P='360',i.Q480P='480',i.Q720P='720',i.Q1080P='1080',i.Q1440P='1440',i.Q2160P='2160',i.Q4320P='4320',i.UNKNOWN='unknown',exports.ScreenDestination=void 0,(a=exports.ScreenDestination||(exports.ScreenDestination={})).CHROMECAST='chromecast',a.APPLE_TV='appletv',a.PIP='pip',a.HEADPHONES='externalHeadphones',a.SCREEN='',exports.ContentType=void 0,(n=exports.ContentType||(exports.ContentType={})).MP4='mp4',n.DASH='dash',n.DASH_SEP='dash_sep',n.ONDEMAND_DASH='ondemand_dash',n.HLS='hls',n.ONDEMAND_HLS='ondemand_hls',n.WEBM='webm',n.RTMP='rtmp',n.UNKNOWN='unknown',function(e){e.AUTO='auto',e.MANUAL=''}(h||(h={})),exports.ConnectionType=void 0,(u=exports.ConnectionType||(exports.ConnectionType={})).HTTP1='http1',u.HTTP2='http2',u.HTTP3='http3',function(e){e[e.YES=1]='YES',e[e.NO=0]='NO'}(p||(p={}));const l={[exports.ApiEnv.PROD]:'https://api.ok.ru',[exports.ApiEnv.VK_ALIAS]:'https://api.mycdn.me',[exports.ApiEnv.VIDEOTEST]:'https://videotestapi.ok.ru/api',[exports.ApiEnv.TEST]:'https://apitest.ok.ru',[exports.ApiEnv.AUTO]:''},d={start:1e3,factor:1.5,max:3e5,random:.1};var m;!function(e){e[e.PARAM_SESSION_EXPIRED=102]='PARAM_SESSION_EXPIRED',e[e.PARAM_SESSION_KEY=103]='PARAM_SESSION_KEY',e[e.PARAM_SIGNATURE=104]='PARAM_SIGNATURE',e[e.AUTH_LOGIN=401]='AUTH_LOGIN'}(m||(m={}));class g{params;uuid;authToken;sessionKey;authorizePromise;refreshAuthTokenPromise;consequentAuthErrors=0;authorized$=new e.ValueSubject(!1);backoffTimeoutId;constructor(e){this.params=e;const t=c.get('uuid');t?this.uuid=String(t):(this.uuid=function(){const e='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split(''),t=new Array(36);let o,s,r=0;for(s=0;s<36;s++)8===s||13===s||18===s||23===s?t[s]='-':14===s?t[s]='4':(r<=2&&(r=33554432+16777216*Math.random()|0),o=15&r,r>>=4,t[s]=e[19===s?3&o|8:o]);return t.join('')}(),c.set('uuid',this.uuid))}async authorize(e){return this.authToken=e??await this.refreshAuthToken(),this._authorizeWithBackoff()}logBeacon(e){const t=this.createLogParams(e),o=this.sessionKey;if(!o)return;this.params.apiTransport.sendBeacon('log.externalLog',t,o)||this.logRequest(e)}async logRequest(e){const t='log.externalLog',o=this.createLogParams(e),s=this.sessionKey??await this._authorizeWithBackoff();if(!s)return;const r=async(e,i=this.params.requestRetryCount)=>{try{return await this.params.apiTransport.sendRequest(t,o,s)}catch(o){if(!o||!('error_code'in o))return void this.params.error$.next({id:'logRequestUnknown',message:`Unknown ${t} error`,thrown:o});const s=o?.error_code;switch(s){case m.PARAM_SESSION_EXPIRED:case m.PARAM_SESSION_KEY:case m.PARAM_SIGNATURE:return this.authorized$.next(!1),this.sessionKey=await this._authorizeWithBackoff(),i>0?r(e,i-1):void 0;case m.AUTH_LOGIN:return this.authorized$.next(!1),this.authToken=await this.refreshAuthToken(),this.sessionKey=await this._authorizeWithBackoff(),i>0?r(e,i-1):void 0;default:return void this.params.error$.next({id:`LogRequest#${s}`,message:`${t} error`,data:o})}}};return r(e)}destroy(){window.clearTimeout(this.backoffTimeoutId),this.backoffTimeoutId=0}async refreshAuthToken(){if(this.params.refreshAuthToken)return this.refreshAuthTokenPromise||(this.refreshAuthTokenPromise=this.params.refreshAuthToken().finally((()=>{this.refreshAuthTokenPromise=void 0}))),this.refreshAuthTokenPromise}createLogParams(e){return{collector:'ok.mobile.apps.video',data:JSON.stringify({application:'@vkontakte/videoplayer-statistics:1.0.25',platform:'WEB',items:e.map((e=>({...e,time:0,type:1})))})}}_authorizeWithBackoff(){if(!this.consequentAuthErrors)return this._authorize();const t=e.getExponentialDelay(this.consequentAuthErrors,d);return new Promise((e=>{this.backoffTimeoutId||(this.backoffTimeoutId=window.setTimeout((()=>{this._authorize().then(e).catch((e=>this.params.error$.next({id:'AuthorizeBackoff',message:'Otherwise unhandle errror in authrization',thrown:e}))).finally((()=>this.backoffTimeoutId=0))}),t))}))}async _authorize(){if(this.authorizePromise)return this.authorizePromise;this.sessionKey=void 0,this.authorized$.next(!1);const e={session_data:{version:2,device_id:this.uuid,client_version:'1.0.25'.split('-')[0],client_type:'SDK_JS'}};return void 0!==this.authToken&&(e.session_data.auth_token=this.authToken,e.session_data.version=3),this.authorizePromise=this.params.apiTransport.sendRequest('auth.anonymLogin',e).then((e=>(e&&e.session_key||this.params.error$.next({id:'AuthorizeFailed',message:'No session key',data:e}),this.sessionKey=e?.session_key??void 0,this.sessionKey))).catch((async e=>{this.sessionKey=void 0;const t=e?.error_code;switch(t){case m.AUTH_LOGIN:return this.authToken=await this.refreshAuthToken(),this._authorizeWithBackoff()}t?this.params.error$.next({id:`Authorize#${t}`,message:'authorize error',data:e}):this.params.error$.next({id:'AuthorizeUnknown',message:'authorize error',thrown:e})})).finally((()=>{this.authorizePromise=void 0,this.consequentAuthErrors=this.sessionKey?0:this.consequentAuthErrors+1,this.authorized$.next(void 0!==this.sessionKey)})),this.authorizePromise}}function f(e){return e.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL?(console.log('__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL=true is set, will force install polyfill'),!0):'function'==typeof e.Request&&!e.Request.prototype.hasOwnProperty('signal')||!e.AbortController}const y=f({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}),A=y?function(e){'function'==typeof e&&(e={fetch:e});const{fetch:t,Request:o=t.Request,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:r=!1}=e;if(!f({fetch:t,Request:o,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:r}))return{fetch:t,Request:i};let i=o;(i&&!i.prototype.hasOwnProperty('signal')||r)&&(i=function(e,t){let s;t&&t.signal&&(s=t.signal,delete t.signal);const r=new o(e,t);return s&&Object.defineProperty(r,'signal',{writable:!1,enumerable:!1,configurable:!0,value:s}),r},i.prototype=o.prototype);const a=t;return{fetch:(e,t)=>{const o=i&&i.prototype.isPrototypeOf(e)?e.signal:t?t.signal:void 0;if(o){let s;try{s=new DOMException('Aborted','AbortError')}catch(e){s=new Error('Aborted'),s.name='AbortError'}if(o.aborted)return Promise.reject(s);const r=new Promise(((e,t)=>{o.addEventListener('abort',(()=>t(s)),{once:!0})}));return t&&t.signal&&delete t.signal,Promise.race([r,a(e,t)])}return a(e,t)},Request:i}}({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}):void 0,_=y?A.fetch:window.fetch;y?A.Request:window.Request;class w{apiKey;apiBaseUrl;apiEnv;isApiBaseUrlFetched;params;constructor(e){this.params=e,this.apiKey=e.apiKey,this.apiEnv=e.apiEnv,this.apiBaseUrl=e.apiBaseUrl,this.isApiBaseUrlFetched=!1}async resolveApiBaseUrl(){if(this.apiEnv!==exports.ApiEnv.AUTO||this.isApiBaseUrlFetched)return this.apiBaseUrl;try{const e=atob('aHR0cHM6Ly9kbnMuZ29vZ2xlL3Jlc29sdmU/bmFtZT12aWRlby5fZW5kcG9pbnQub2sucnUmdHlwZT1UWFQ='),t=await _(e,{method:'GET',mode:'cors',cache:'no-cache'}),o=(await t.json())?.Answer[0]?.data;if(!o)throw new Error('Wrong DNS response');return o}catch(e){return this.params.error$.next({id:'OneStat:ApiTransport:resolveApiBaseUrl',message:'Unhandled resolve api base url error',thrown:e}),l[exports.ApiEnv.VK_ALIAS]}finally{this.isApiBaseUrlFetched=!0}}sendBeacon(e,t,o){if(!window.Blob||!window.navigator.sendBeacon)return!1;const s=this._prepareQueryParams({method:e,queryParams:t,sessionKey:o}),r=new window.Blob([s.toString()],{type:'application/x-www-form-urlencoded'});try{return window.navigator.sendBeacon(`${this.apiBaseUrl}/fb.do`,r)}catch(o){this.params.error$.next({id:'OneStat:ApiTransport:sendBeacon',message:'Unhandled beacon error',thrown:o,data:{method:e,params:t}})}return!1}async sendRequest(e,t,o){const s=Date.now(),r=r=>{r instanceof TypeError&&['Failed to fetch','NetworkError when attempting to fetch resource.'].includes(r.message)?this.params.error$.next({id:'Network',message:'Request failed',thrown:r}):this.params.error$.next({id:'OneStat:ApiTransport:sendRequest',message:'Unhandled request error',thrown:r,data:{method:e,params:t,sessionKey:o,time:Date.now()-s}})};return this.apiBaseUrl=await this.resolveApiBaseUrl(),_(`${this.apiBaseUrl}/fb.do`,{method:'post',headers:{'Content-type':'application/x-www-form-urlencoded'},body:this._prepareQueryParams({method:e,queryParams:t,sessionKey:o})}).then((e=>Number(e.headers.get('content-length'))>0?e.json().then((e=>Object.prototype.hasOwnProperty.call(e,'error_msg')?Promise.reject(e):e),r):void 0),r)}_prepareQueryParams(e){const t=new URLSearchParams({format:'JSON',method:e.method,application_key:this.apiKey});return void 0!==e.sessionKey&&t.append('session_key',e.sessionKey),Object.entries(e.queryParams).forEach((([e,o])=>t.append(e,'string'==typeof o?o:JSON.stringify(o)))),t}}class v{api;error$;requestQueue=[];subscription;isPaused=!1;debouncedFlush=o.default((()=>{try{this.flush()}catch(e){this.error$.next({id:'LoggerError',message:String(e)??'Unknown logger error',thrown:e})}}),3e3,{maxWait:15e3});constructor(e){this.api=e.api,this.error$=e.error$,this.subscription=this.api.authorized$.subscribe((e=>{e&&this.debouncedFlush()}))}log(e){this.requestQueue.push(e),this.isPaused||this.debouncedFlush()}flush(e=!1){0!==this.requestQueue.length&&(this.api.authorized$.getValue()?(e?this.api.logBeacon(this.requestQueue):this.api.logRequest(this.requestQueue),this.requestQueue=[]):e||this.api.authorize(),this.debouncedFlush.cancel())}pause(){this.isPaused=!0,this.debouncedFlush.cancel()}resume(){this.isPaused=!1,this.debouncedFlush()}destroy(){this.subscription.unsubscribe()}}exports.OneStat=class{api;logger;config;subscription=new e.Subscription;experimental;statContext;constructor(t,o){this.statContext=t,this.config={...o.config??{},requestRetryCount:1};const s=new e.Subject;this.experimental={error$:s};const r=new w({apiKey:'CIOPGQJGDIHBABABA',apiBaseUrl:l[o.apiEnv],apiEnv:o.apiEnv,error$:s});this.api=new g({apiTransport:r,refreshAuthToken:o.refreshAuthToken,requestRetryCount:this.config.requestRetryCount,error$:s}),this.logger=new v({api:this.api,error$:s}),this.subscription.add(e.fromEvent(window,'beforeunload').subscribe((()=>this.logger.flush(!0))))}updateContext(e){this.statContext={...this.statContext,...e}}authorize(e){return this.api.authorize(e)}pause(){this.logger.pause()}resume(){this.logger.resume()}destroy(){this.logger.flush(),this.subscription.unsubscribe(),this.api.destroy(),this.logger.destroy()}logInited(){this.log({operation:'init'})}logReady(e){this.log({operation:'player_ready',param:String(e.time)})}logStarted(e){this.log({operation:'play',param:String(Math.round(e.position))})}logPlay(){this.log({operation:'play_toggle'})}logPause(e){this.log({operation:'pause',param:String(Math.round(e.position))})}logSeek(){this.log({operation:'seek'})}logFirstBytes(e){this.log({operation:'first_bytes',param:String(e.time)})}logFirstFrame(e){this.log({operation:'first_frame',param:String(e.time)})}logError(e){this.log({operation:'error',param:e.errorType})}logWatchCoverageRecord(e){this.log({operation:'watch_coverage_record',param:`${e.start}-${e.end}`}),this.logger.flush(!0)}logWatchCoverageLive(e){this.log({operation:'watch_coverage_live',param:`${e.start}-${e.end}`}),this.logger.flush(!0)}logEmptyBuffer(e){this.log({operation:'empty_buffer',param:String(e.duration)})}logDownloadSpeed(e){this.log({operation:'download_speed',param:String(e.speed)})}logAdSlotRequest(){this.log({operation:'adv',param:'slot_request'})}logAdStarted(e){this.log({operation:'adv',param:e})}logAdPaused(){this.log({operation:'adv',param:'pause'})}logAdResumed(){this.log({operation:'adv',param:'resume'})}logAdEnded(){this.log({operation:'adv',param:'ended'})}logAdSkipped(){this.log({operation:'adv',param:'skip'})}logAdClicked(){this.log({operation:'adv',param:'click'})}log(e){const t=this.crateLogItem(e);this.logger.log(t)}crateLogItem({operation:e,param:t}){const o=Date.now(),s={vid:this.statContext.movieId,quality:this.statContext.quality,dst:this.statContext.destination,ct:this.statContext.contentType,aid:this.statContext.albumId,place:this.statContext.place,cdn_host:this.statContext.cdnHostname,connection_type:this.statContext.connectionType,connection_reused:!0===this.statContext.connectionReused?p.YES:!1===this.statContext.connectionReused?p.NO:void 0,stat_type:!0===this.statContext.autoplay?h.AUTO:!1===this.statContext.autoplay?h.MANUAL:void 0,vk_playlist_id:this.statContext.vkPlaylistId,vk_app_id:this.statContext.vkAppId,track_code:this.statContext.trackCode};return void 0!==t&&(s.param=t),{operation:e,timestamp:o,custom:s}}};
