/**
 * @vkontakte/videoplayer-core v2.0.71
 * Wed, 21 Sep 2022 05:29:45 GMT
 * https://st.mycdn.me/static/vkontakte-videoplayer/2-0-71/doc/
 */
import{ValueSubject as t,Subject as e,Subscription as i,isNonNullable as s,isNullable as r,fromEvent as a,assertNever as n,merge as o,tap as d,map as u,observableFrom as h,filterChanged as l,assertNonNullable as c,debounce as p,timeout as m,filter as f,mapTo as v,now as S,Observable as g,once as b,combine as y,abortable as T,getExponentialDelay as E,interval as w,throttle as $,Logger as k}from'@vkontakte/videoplayer-shared/es2018.esm.js';export{Observable,Subject,Subscription,ValueSubject}from'@vkontakte/videoplayer-shared/es2018.esm.js';import A from'lodash/debounce.js';var P,R,D,_,C,I,L;!function(t){t.STOPPED='stopped',t.PLAYING='playing',t.PAUSED='paused'}(P||(P={})),function(t){t.MPEG='MPEG',t.DASH='DASH',t.DASH_SEP='DASH_SEP',t.DASH_SEP_VK='DASH_SEP',t.DASH_WEBM='DASH_WEBM',t.DASH_WEBM_VK='DASH_WEBM',t.DASH_ONDEMAND='DASH_ONDEMAND',t.DASH_ONDEMAND_VK='DASH_ONDEMAND',t.DASH_LIVE='DASH_LIVE',t.DASH_LIVE_WEBM='DASH_LIVE_WEBM',t.HLS='HLS',t.HLS_ONDEMAND='HLS_ONDEMAND',t.HLS_JS='HLS',t.HLS_LIVE='HLS_LIVE',t.WEB_RTC_LIVE='WEB_RTC_LIVE'}(R||(R={})),function(t){t.SCREEN='SCREEN',t.CHROMECAST='CHROMECAST'}(D||(D={})),function(t){t.NOT_AVAILABLE='NOT_AVAILABLE',t.AVAILABLE='AVAILABLE',t.CONNECTING='CONNECTING',t.CONNECTED='CONNECTED'}(_||(_={})),function(t){t.SuccessWithSound='success_with_sound',t.SuccessWithoutSound='success_without_sound',t.Failed='failed'}(C||(C={})),function(t){t.HTTP1='http1',t.HTTP2='http2',t.QUIC='quic'}(I||(I={})),function(t){t.None='none',t.Requested='requested',t.Applying='applying'}(L||(L={}));class x{constructor(r){var a;this.connection$=new t(void 0),this.castState$=new t(_.NOT_AVAILABLE),this.errorEvent$=new e,this.realCastState$=new t(_.NOT_AVAILABLE),this.subscription=new i,this.params=r,this.log=this.params.dependencies.logger.createComponentLog('ChromecastInitializer');const n='chrome'in window;if(this.log({message:`[constructor] receiverApplicationId: ${this.params.receiverApplicationId}, isDisabled: ${this.params.isDisabled}, isSupported: ${n}`}),r.isDisabled||!n)return;var o;s(null===(a=window.chrome)||void 0===a?void 0:a.cast)?this.initializeCastApi():(window.__onGCastApiAvailable=t=>{t&&this.initializeCastApi()},(o='https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1',new Promise(((t,e)=>{const i=document.createElement('script');i.setAttribute('src',o),i.onload=()=>t,i.onerror=()=>e,document.body.appendChild(i)}))).catch((()=>this.errorEvent$.next({id:'ChromecastLoading',message:'Script loading failed!'}))))}connect(){var t;null===(t=cast.framework.CastContext.getInstance())||void 0===t||t.requestSession()}disconnect(){var t,e;null===(e=null===(t=cast.framework.CastContext.getInstance())||void 0===t?void 0:t.getCurrentSession())||void 0===e||e.endSession(!0)}stopMedia(){return new Promise(((t,e)=>{var i,s,r;null===(r=null===(s=null===(i=cast.framework.CastContext.getInstance())||void 0===i?void 0:i.getCurrentSession())||void 0===s?void 0:s.getMediaSession())||void 0===r||r.stop(new chrome.cast.media.StopRequest,t,e)}))}toggleConnection(){s(this.connection$.getValue())?this.disconnect():this.connect()}setVolume(t){const e=this.connection$.getValue();r(e)||(e.remotePlayer.volumeLevel=t,e.remotePlayerController.setVolumeLevel())}setMuted(t){const e=this.connection$.getValue();r(e)||t!==e.remotePlayer.isMuted&&e.remotePlayerController.muteOrUnmute()}destroy(){this.subscription.unsubscribe()}initListeners(){const t=new cast.framework.RemotePlayer,e=new cast.framework.RemotePlayerController(t),i=cast.framework.CastContext.getInstance();this.subscription.add(a(i,cast.framework.CastContextEventType.SESSION_STATE_CHANGED).subscribe((t=>{var e,s;switch(t.sessionState){case cast.framework.SessionState.SESSION_STARTED:case cast.framework.SessionState.SESSION_STARTING:case cast.framework.SessionState.SESSION_RESUMED:this.contentId=null===(s=null===(e=i.getCurrentSession())||void 0===e?void 0:e.getMediaSession())||void 0===s?void 0:s.media.contentId;break;case cast.framework.SessionState.NO_SESSION:case cast.framework.SessionState.SESSION_ENDING:case cast.framework.SessionState.SESSION_ENDED:case cast.framework.SessionState.SESSION_START_FAILED:this.contentId=void 0;break;default:return n(t.sessionState)}}))).add(o(a(i,cast.framework.CastContextEventType.CAST_STATE_CHANGED).pipe(d((t=>{this.log({message:`[cast.framework.RemotePlayerEventType.CAST_STATE_CHANGED]: ${JSON.stringify(t)}`})})),u((t=>t.castState))),h([i.getCastState()])).pipe(l(),u(N),d((t=>{this.log({message:`realCastState$: ${t}`})}))).subscribe(this.realCastState$)).add(this.realCastState$.subscribe((a=>{var n;const o=a===_.CONNECTED,d=s(this.connection$.getValue());if(o&&!d){const s=i.getCurrentSession();c(s);const a=s.getCastDevice(),o=null===(n=s.getMediaSession())||void 0===n?void 0:n.media.contentId;(r(o)||o===this.contentId)&&(this.log({message:'connection created'}),this.connection$.next({remotePlayer:t,remotePlayerController:e,session:s,castDevice:a}))}else!o&&d&&(this.log({message:'connection destroyed'}),this.connection$.next(void 0));this.castState$.next(a===_.CONNECTED?s(this.connection$.getValue())?_.CONNECTED:_.AVAILABLE:a)})))}initializeCastApi(){var t;let e,i,s;try{e=cast.framework.CastContext.getInstance(),i=chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,s=chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED}catch(t){return}try{e.setOptions({receiverApplicationId:null!==(t=this.params.receiverApplicationId)&&void 0!==t?t:i,autoJoinPolicy:s}),this.initListeners()}catch(t){this.errorEvent$.next({id:'ChromecastInitializer',message:'[initializeCastApi] failed',thrown:t})}}}const N=t=>{switch(t){case cast.framework.CastState.NO_DEVICES_AVAILABLE:return _.NOT_AVAILABLE;case cast.framework.CastState.NOT_CONNECTED:return _.AVAILABLE;case cast.framework.CastState.CONNECTING:return _.CONNECTING;case cast.framework.CastState.CONNECTED:return _.CONNECTED;default:return n(t)}};var O;!function(t){t[t.OFFSET_P=0]='OFFSET_P',t[t.PLAYBACK_SHIFT=1]='PLAYBACK_SHIFT'}(O||(O={}));var B,M=(t,e=0,i=O.OFFSET_P)=>{switch(i){case O.OFFSET_P:return t.replace('_offset_p',0===e?'':'_'+e.toFixed(0));case O.PLAYBACK_SHIFT:{if(0===e)return t;const i=new URL(t);return i.searchParams.append('playback_shift',e.toFixed(0)),i.toString()}default:n(i)}return t},U=(t,e,i=!1)=>{const s=t.getTransition();!i&&s&&s.to!==e||t.setState(e)};!function(t){t.INVARIANT='Invariant quality',t.Q_144P='144p',t.Q_240P='240p',t.Q_360P='360p',t.Q_480P='480p',t.Q_720P='720p',t.Q_1080P='1080p',t.Q_1440P='1440p',t.Q_2160P='2160p',t.Q_4320P='4320p'}(B||(B={}));const V={[B.Q_144P]:{width:256,height:144},[B.Q_240P]:{width:428,height:240},[B.Q_360P]:{width:640,height:360},[B.Q_480P]:{width:856,height:480},[B.Q_720P]:{width:1280,height:720},[B.Q_1080P]:{width:1920,height:1080},[B.Q_1440P]:{width:2560,height:1440},[B.Q_2160P]:{width:3840,height:2160},[B.Q_4320P]:{width:7680,height:4320}},q=(t,e)=>V[t].height>V[e].height,F=(t,e)=>V[t].height<V[e].height,H=Object.keys(V).sort(((t,e)=>F(t,e)?-1:1)),G=({width:t,height:e})=>{const i=Math.min(t,e),s=Math.max(t,e);return H.find((t=>{const e=V[t];return e.width>=s&&e.height>=i}))},Y=t=>t===B.INVARIANT;class z{constructor(t){this.transitionStarted$=new e,this.transitionEnded$=new e,this.transitionUpdated$=new e,this.forceChanged$=new e,this.stateChangeStarted$=o(this.transitionStarted$,this.transitionUpdated$),this.stateChangeEnded$=o(this.transitionEnded$,this.forceChanged$),this.state=t}setState(t){const e=this.transition,i=this.state;this.transition=void 0,this.state=t,e?e.to===t?this.transitionEnded$.next(e):this.forceChanged$.next({from:e.from,to:t,canceledTransition:e}):this.forceChanged$.next({from:i,to:t,canceledTransition:e})}startTransitionTo(t){const e=this.transition,i=this.state;i===t||s(e)&&e.to===t||(this.state=t,e?(this.transition={from:e.from,to:t,canceledTransition:e},this.transitionUpdated$.next(this.transition)):(this.transition={from:i,to:t},this.transitionStarted$.next(this.transition)))}getTransition(){return this.transition}getState(){return this.state}}var Q;!function(t){t.STOPPED='stopped',t.READY='ready',t.PLAYING='playing',t.PAUSED='paused'}(Q||(Q={}));class j{constructor(t){this.subscription=new i,this.loadMediaTimeoutSubscription=new i,this.videoState=new z(Q.STOPPED),this.syncPlayback=()=>{const t=this.videoState.getState(),e=this.videoState.getTransition(),i=this.params.desiredState.playbackState.getState(),s=this.params.desiredState.playbackState.getTransition(),r=this.params.desiredState.seekState.getState();if(this.log({message:`[syncPlayback] videoState: ${t}; videoTransition: ${JSON.stringify(e)}; desiredPlaybackState: ${i}; desiredPlaybackStateTransition: ${this.params.desiredState.playbackState.getTransition()}; seekState: ${JSON.stringify(r)};`}),i!==P.STOPPED){if(!e)if((null==s?void 0:s.to)===P.PAUSED||r.state!==L.Requested||t===Q.STOPPED)switch(i){case P.PLAYING:switch(t){case Q.PLAYING:break;case Q.PAUSED:case Q.READY:this.videoState.startTransitionTo(Q.PLAYING),this.params.connection.remotePlayerController.playOrPause();break;case Q.STOPPED:this.videoState.startTransitionTo(Q.READY),this.prepare();break;default:n(t)}break;case P.PAUSED:switch(t){case Q.PLAYING:this.videoState.startTransitionTo(Q.PAUSED),this.params.connection.remotePlayerController.playOrPause();break;case Q.PAUSED:break;case Q.READY:this.videoState.startTransitionTo(Q.PAUSED),this.videoState.setState(Q.PAUSED);break;case Q.STOPPED:this.videoState.startTransitionTo(Q.READY),this.prepare();break;default:n(t)}break;default:n(i)}else this.seek(r.position)}else t!==Q.STOPPED&&(this.videoState.startTransitionTo(Q.STOPPED),this.stop())},this.params=t,this.log=this.params.dependencies.logger.createComponentLog('ChromecastProvider'),this.log({message:`constructor, format: ${t.format}`}),this.params.output.isLive$.next((t=>{switch(t){case R.MPEG:case R.DASH:case R.DASH_SEP:case R.DASH_ONDEMAND:case R.DASH_WEBM:case R.HLS:case R.HLS_ONDEMAND:return!1;case R.HLS_LIVE:case R.DASH_LIVE:case R.DASH_LIVE_WEBM:case R.WEB_RTC_LIVE:return!0;default:return n(t)}})(t.format)),this.handleRemoteVolumeChange({volume:this.params.connection.remotePlayer.volumeLevel,muted:this.params.connection.remotePlayer.isMuted});const e=this.params.connection.session.getMediaSession();e&&this.restoreSession(e),this.subscribe()}destroy(){this.log({message:'[destroy]'}),this.subscription.unsubscribe()}subscribe(){this.subscription.add(this.loadMediaTimeoutSubscription);const t=new i;this.subscription.add(t),this.subscription.add(o(this.videoState.stateChangeStarted$.pipe(u((t=>`stateChangeStarted$ ${JSON.stringify(t)}`))),this.videoState.stateChangeEnded$.pipe(u((t=>`stateChangeEnded$ ${JSON.stringify(t)}`)))).subscribe((t=>this.log({message:`[videoState] ${t}`}))));const s=(t,e)=>this.subscription.add(t.subscribe(e));if(this.params.output.isLive$.getValue())this.params.output.position$.next(0),this.params.output.duration$.next(0);else{const i=new e;t.add(i.pipe(p(500)).subscribe((()=>{this.params.output.seekedEvent$.next()})));let s=NaN;t.add(a(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.CURRENT_TIME_CHANGED).subscribe((t=>{this.logRemoteEvent(t);const e=t.value;this.params.output.position$.next(e);(this.params.desiredState.seekState.getState().state===L.Applying||Math.abs(e-s)>5)&&i.next(e),s=e}))),t.add(a(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.DURATION_CHANGED).subscribe((t=>{this.logRemoteEvent(t),this.params.output.duration$.next(t.value)})))}s(a(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.IS_MEDIA_LOADED_CHANGED),(e=>{this.logRemoteEvent(e),e.value?this.handleRemoteReady():(this.handleRemoteStop(),t.unsubscribe())})),s(a(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.IS_PAUSED_CHANGED),(t=>{this.logRemoteEvent(t),t.value?this.handleRemotePause():this.handleRemotePlay()})),s(a(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.PLAYER_STATE_CHANGED),(t=>{this.logRemoteEvent(t);const{remotePlayer:e}=this.params.connection,i=t.value,s=this.params.output.isBuffering$.getValue(),r=i===chrome.cast.media.PlayerState.BUFFERING;switch(s!==r&&this.params.output.isBuffering$.next(r),i){case chrome.cast.media.PlayerState.IDLE:!this.params.output.isLive$.getValue()&&e.duration-e.currentTime<5&&this.params.output.endedEvent$.next(),this.handleRemoteStop(),U(this.params.desiredState.playbackState,P.STOPPED);break;case chrome.cast.media.PlayerState.PAUSED:this.handleRemotePause();break;case chrome.cast.media.PlayerState.PLAYING:this.handleRemotePlay();break;case chrome.cast.media.PlayerState.BUFFERING:break;default:n(i)}})),s(a(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.VOLUME_LEVEL_CHANGED),(t=>{this.logRemoteEvent(t),this.handleRemoteVolumeChange({volume:t.value})})),s(a(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.IS_MUTED_CHANGED),(t=>{this.logRemoteEvent(t),this.handleRemoteVolumeChange({muted:t.value})}));s(o(this.params.desiredState.playbackState.stateChangeStarted$,this.params.desiredState.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,h(['init'])).pipe(p(0)),this.syncPlayback)}restoreSession(t){this.log({message:'restoreSession'});const{remotePlayer:e}=this.params.connection;if(t.playerState!==chrome.cast.media.PlayerState.IDLE){e.isPaused?(this.videoState.setState(Q.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED)):(this.videoState.setState(Q.PLAYING),U(this.params.desiredState.playbackState,P.PLAYING));const t=this.params.output.isLive$.getValue();this.params.output.duration$.next(t?0:e.duration),this.params.output.position$.next(t?0:e.currentTime),this.params.desiredState.seekState.setState({state:L.None})}}prepare(){const t=this.params.format;this.log({message:`[prepare] format: ${t}`});const e=this.createMediaInfo(t),i=this.createLoadRequest(e);this.loadMedia(i)}handleRemotePause(){const t=this.videoState.getState(),e=this.videoState.getTransition();(null==e?void 0:e.to)!==Q.PAUSED&&t!==Q.PLAYING||(this.videoState.setState(Q.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED))}handleRemotePlay(){const t=this.videoState.getState(),e=this.videoState.getTransition();(null==e?void 0:e.to)!==Q.PLAYING&&t!==Q.PAUSED||(this.videoState.setState(Q.PLAYING),U(this.params.desiredState.playbackState,P.PLAYING))}handleRemoteReady(){const t=this.videoState.getTransition();(null==t?void 0:t.to)===Q.READY&&this.videoState.setState(Q.READY)}handleRemoteStop(){this.videoState.getState()!==Q.STOPPED&&this.videoState.setState(Q.STOPPED)}handleRemoteVolumeChange(t){var e,i;const s=this.params.output.volume$.getValue(),r={volume:null!==(e=t.volume)&&void 0!==e?e:s.volume,muted:null!==(i=t.muted)&&void 0!==i?i:s.muted};r.volume===s.volume&&r.muted==r.muted||this.params.output.volume$.next(r)}seek(t){this.params.output.willSeekEvent$.next();const{remotePlayer:e,remotePlayerController:i}=this.params.connection;e.currentTime=t,i.seek()}stop(){const{remotePlayerController:t}=this.params.connection;t.stop()}createMediaInfo(t){var e;const i=this.params.source;let r,a,o;switch(t){case R.MPEG:{const e=i[t];c(e);const s=Object.keys(e).sort(((t,e)=>t===e?0:t===B.INVARIANT?1:e===B.INVARIANT?-1:F(t,e)?1:-1))[0];c(s);const n=e[s];c(n),r=n,a='video/mp4',o=chrome.cast.media.StreamType.BUFFERED;break}case R.HLS:case R.HLS_ONDEMAND:{const e=i[t];c(e),r=e.url,a='application/x-mpegurl',o=chrome.cast.media.StreamType.BUFFERED;break}case R.DASH_SEP:case R.DASH_ONDEMAND:case R.DASH_WEBM:{const e=i[t];c(e),r=e.url,a='application/dash+xml',o=chrome.cast.media.StreamType.BUFFERED;break}case R.HLS_LIVE:{const e=i[t];c(e),r=M(e.url),a='application/x-mpegurl',o=chrome.cast.media.StreamType.LIVE;break}case R.DASH:case R.DASH_LIVE:case R.WEB_RTC_LIVE:{const t='Unsupported format for Chromecast',e=new Error(t);throw this.params.output.error$.next({id:'ChromecastProvider.createMediaInfo()',message:t,thrown:e}),e}case R.DASH_LIVE_WEBM:throw new Error('DASH_LIVE_WEBM is no longer supported');default:return n(t)}const d=new chrome.cast.media.MediaInfo(null!==(e=this.params.meta.videoId)&&void 0!==e?e:r,a);d.contentUrl=r,d.streamType=o,d.metadata=new chrome.cast.media.GenericMediaMetadata;const{title:u,subtitle:h}=this.params.meta;return s(u)&&(d.metadata.title=u),s(h)&&(d.metadata.subtitle=h),d}createLoadRequest(t){const e=new chrome.cast.media.LoadRequest(t);e.autoplay=!1;const i=this.params.desiredState.seekState.getState();return i.state===L.Applying||i.state===L.Requested?e.currentTime=this.params.output.isLive$.getValue()?0:i.position/1e3:e.currentTime=0,e}loadMedia(t){const e=this.params.connection.session.loadMedia(t),i=new Promise(((t,e)=>{this.loadMediaTimeoutSubscription.add(m(7e3).subscribe((()=>e('timeout(7000)'))))}));Promise.race([e,i]).then((()=>{this.log({message:`[loadMedia] completed, format: ${this.params.format}`});this.params.desiredState.seekState.getState().state===L.Applying&&this.params.output.seekedEvent$.next(),this.handleRemoteReady()}),(t=>{const e=`[prepare] loadMedia failed, format: ${this.params.format}, reason: ${t}`;this.log({message:e}),this.params.output.error$.next({id:'ChromecastProvider.loadMedia',message:e,thrown:t})})).finally((()=>{this.loadMediaTimeoutSubscription.unsubscribe()}))}logRemoteEvent(t){this.log({message:`[remoteEvent] ${JSON.stringify(t)}`})}}class W{constructor(){Object.defineProperty(this,'listeners',{value:{},writable:!0,configurable:!0})}addEventListener(t,e,i){t in this.listeners||(this.listeners[t]=[]),this.listeners[t].push({callback:e,options:i})}removeEventListener(t,e){if(!(t in this.listeners))return;const i=this.listeners[t];for(let t=0,s=i.length;t<s;t++)if(i[t].callback===e)return void i.splice(t,1)}dispatchEvent(t){if(!(t.type in this.listeners))return;const e=this.listeners[t.type].slice();for(let i=0,s=e.length;i<s;i++){const s=e[i];try{s.callback.call(this,t)}catch(t){Promise.resolve().then((()=>{throw t}))}s.options&&s.options.once&&this.removeEventListener(t.type,s.callback)}return!t.defaultPrevented}}class J extends W{constructor(){super(),this.listeners||W.call(this),Object.defineProperty(this,'aborted',{value:!1,writable:!0,configurable:!0}),Object.defineProperty(this,'onabort',{value:null,writable:!0,configurable:!0})}toString(){return'[object AbortSignal]'}dispatchEvent(t){'abort'===t.type&&(this.aborted=!0,'function'==typeof this.onabort&&this.onabort.call(this,t)),super.dispatchEvent(t)}}class X{constructor(){Object.defineProperty(this,'signal',{value:new J,writable:!0,configurable:!0})}abort(){let t;try{t=new Event('abort')}catch(e){'undefined'!=typeof document?document.createEvent?(t=document.createEvent('Event'),t.initEvent('abort',!1,!1)):(t=document.createEventObject(),t.type='abort'):t={type:'abort',bubbles:!1,cancelable:!1}}this.signal.dispatchEvent(t)}toString(){return'[object AbortController]'}}function K(t){return t.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL?(console.log('__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL=true is set, will force install polyfill'),!0):'function'==typeof t.Request&&!t.Request.prototype.hasOwnProperty('signal')||!t.AbortController}'undefined'!=typeof Symbol&&Symbol.toStringTag&&(X.prototype[Symbol.toStringTag]='AbortController',J.prototype[Symbol.toStringTag]='AbortSignal');const Z=K({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}),tt=Z?function(t){'function'==typeof t&&(t={fetch:t});const{fetch:e,Request:i=e.Request,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:r=!1}=t;if(!K({fetch:e,Request:i,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:r}))return{fetch:e,Request:a};let a=i;(a&&!a.prototype.hasOwnProperty('signal')||r)&&(a=function(t,e){let s;e&&e.signal&&(s=e.signal,delete e.signal);const r=new i(t,e);return s&&Object.defineProperty(r,'signal',{writable:!1,enumerable:!1,configurable:!0,value:s}),r},a.prototype=i.prototype);const n=e;return{fetch:(t,e)=>{const i=a&&a.prototype.isPrototypeOf(t)?t.signal:e?e.signal:void 0;if(i){let s;try{s=new DOMException('Aborted','AbortError')}catch(t){s=new Error('Aborted'),s.name='AbortError'}if(i.aborted)return Promise.reject(s);const r=new Promise(((t,e)=>{i.addEventListener('abort',(()=>e(s)),{once:!0})}));return e&&e.signal&&delete e.signal,Promise.race([r,n(t,e)])}return n(t,e)},Request:a}}({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}):void 0,et=Z?tt.fetch:window.fetch;Z?tt.Request:window.Request;const it=Z?X:window.AbortController,st=t=>t.range?t.range.split('-').map((t=>parseInt(t,10))):[NaN,NaN];class rt{constructor(t){this.params=t,this.dashJsRequestQueue=new Map,this.activeRequests=new Map}setMetrics(t){this.dashMetrics=t}queueDashJSRequest(t){var e;const{url:i}=t.request,s=null!==(e=this.dashJsRequestQueue.get(i))&&void 0!==e?e:[];s.push(t),this.dashJsRequestQueue.set(i,s)}async executeNextRequests(){for(const[t,e]of this.dashJsRequestQueue.entries()){const i=this.activeRequests.get(t);if(i){e.length&&this.onBigRequestProgress(i);const s=e[0];if(!s||!s.request.range)continue;const[r,a]=st(s.request);if(r>=i.from&&a<=i.to)continue;this.activeRequests.delete(t)}if(e.length){const i=this.sendBigRequest(t,e.map((({request:t})=>t)));this.activeRequests.set(t,i)}}}abort(t){var e;if(t){const{request:i}=t,s=(null!==(e=this.dashJsRequestQueue.get(i.url))&&void 0!==e?e:[]).includes(t),r=this.activeRequests.get(i.url);s&&r&&r.abortController.abort()}else for(const{abortController:t}of this.activeRequests.values())t.abort()}destroy(){this.abort(),this.dashMetrics=void 0,this.dashJsRequestQueue.clear(),this.activeRequests.clear()}sendBigRequest(t,e){const i=e.map(st),s=i[0][0];let r=i[0][1];for(let t=1;t<i.length&&r<this.params.minDataSize;t++){const e=i[t][1];e-s<=2*this.params.minDataSize&&(r=Math.max(r,e))}r=0===s?Math.max(r,s+this.params.minInitSize):Math.max(r,s+this.params.minDataSize);const a=new URL(t,location.href);a.searchParams.append('bytes',`${s}-${r}`);const n=a.toString(),o=new it,d=o.signal,u={url:t,from:s,to:r,loaded:0,data:null,abortController:o};d.addEventListener('abort',(()=>this.onBigRequestAbort(u)));const h=t=>{var e,i;throw null===(i=(e=this.params).onError)||void 0===i||i.call(e,{id:'BigRequestParsing',message:'Error parsing response data',thrown:t}),t};return et(n,{signal:d}).then((t=>{var e,i,a;if(u.response=t,!t.ok||!t.body)return void this.onBigRequestError(u);const[n,o]=t.body.tee();null===(i=(e=this.params).onDownloadStream)||void 0===i||i.call(e,o);const d=n.getReader(),l=parseInt(null!==(a=t.headers.get('Content-Length'))&&void 0!==a?a:'',10)||r-s+1;u.data=new ArrayBuffer(l);const c=new Uint8Array(u.data),p=async({done:t,value:e})=>{t?this.onBigRequestProgress(u):e&&(c.set(e,u.loaded),u.loaded+=e.byteLength,this.onBigRequestProgress(u),await(null==d?void 0:d.read().then(p,rt.suppressStreamErrors).catch(h)))};null==d||d.read().then(p,rt.suppressStreamErrors).catch(h)}),rt.suppressAbort).catch((t=>this.onBigRequestError(u,t))),u}onBigRequestProgress({url:t,from:e,to:i,loaded:s,data:r,response:a}){var n,o,d,u,h,l,c,p;if(!this.activeRequests.has(t)||!r)return;const m=null!==(n=this.dashJsRequestQueue.get(t))&&void 0!==n?n:[];for(const n of m){const{request:m}=n,[f,v]=st(m),S=f>=e&&v<=e+s,g=e>=f&&e+s<v,b=r.slice(f-e,Math.min(v-e+1,s));if((S||g)&&(m.requestStartDate=null!==(o=m.requestStartDate)&&void 0!==o?o:new Date,m.firstByteDate=null!==(d=m.firstByteDate)&&void 0!==d?d:new Date,m.bytesLoaded=b.byteLength,m.bytesTotal=i-e),S){m.requestEndDate=new Date,this.dashJsRequestQueue.set(t,(null!==(u=this.dashJsRequestQueue.get(t))&&void 0!==u?u:[]).filter((t=>t!==n))),null===(h=n.success)||void 0===h||h.call(n,b,'',t);const e=a?Array.from(a.headers.entries()).map((([t,e])=>`${t}: ${e}`)).join('\r\n'):'';null===(l=this.dashMetrics)||void 0===l||l.addHttpRequest(m,t,null!==(c=null==a?void 0:a.status)&&void 0!==c?c:200,e,[])}else g&&(null===(p=n.progress)||void 0===p||p.call(n,{loaded:s,total:i-e,lengthComputable:!0,stream:!0}))}}onBigRequestError({url:t,from:e,to:i},s){var r,a,n,o;if(null===(a=(r=this.params).onError)||void 0===a||a.call(r,{id:'BigRequest',message:'Download error',thrown:s}),!this.activeRequests.has(t))return;const d=null!==(n=this.dashJsRequestQueue.get(t))&&void 0!==n?n:[];for(const t of d){const[r,a]=st(t.request);(r>=e&&r<i||a>e&&a<=i)&&(null===(o=null==t?void 0:t.error)||void 0===o||o.call(t,t.request,String(s)))}if(this.activeRequests.delete(t),s)throw s}onBigRequestAbort({url:t,from:e,to:i}){var s,r;if(!this.activeRequests.has(t))return;const a=null!==(s=this.dashJsRequestQueue.get(t))&&void 0!==s?s:[];for(const t of a){const[s,a]=st(t.request);(s>=e&&s<i||a>e&&a<=i)&&(null===(r=null==t?void 0:t.abort)||void 0===r||r.call(t,t.request))}this.activeRequests.delete(t)}static suppressAbort(t){if(!(t instanceof DOMException)||'AbortError'!==t.name&&20!==t.code)throw t}static suppressStreamErrors(){}}class at{constructor(t,e,i){this.baseLoader=t,this.config=i,this.bigRequest=e,e.setMetrics(i.dashMetrics)}static shouldDelegateToBase(t){return'download'!==t.action||'text'===t.mediaType||!t.range||'arraybuffer'!==t.responseType}load(t){const{request:e}=t;if(at.shouldDelegateToBase(e))return this.baseLoader.load(t);this.bigRequest.queueDashJSRequest(t),this.bigRequest.executeNextRequests()}abort(t){if(!t)return this.baseLoader.abort(),void this.bigRequest.abort();const{request:e}=t;at.shouldDelegateToBase(e)?this.baseLoader.abort(t):this.bigRequest.abort(t)}}const nt=(t,e)=>{const i=new rt(e);return t.extend('SchemeLoaderFactory',(function(){const{parent:t}=this,e=t.getLoader;return{getLoader:t=>((t,e)=>i=>({create:s=>{const r=t(i).create(s);return new at(r,e,s)}}))(e(t),i)}}),!0),()=>i.destroy()};var ot=t=>{let e,i=!1,s=!1;t.on('playbackTimeUpdated',(({timeToEnd:t})=>{s=t<=3,i&&s&&(null==e||e())})),t.extend('MediaSourceController',(function(){const{parent:t}=this,r=t.signalEndOfStream;return{signalEndOfStream:t=>{i=!0,e=()=>r(t),i&&s&&(null==e||e())}}}),!0)},dt='undefined'!=typeof globalThis?globalThis:'undefined'!=typeof window?window:'undefined'!=typeof global?global:'undefined'!=typeof self?self:{},ut=function(t){try{return!!t()}catch(t){return!0}},ht=!ut((function(){var t=function(){}.bind();return'function'!=typeof t||t.hasOwnProperty('prototype')})),lt=ht,ct=Function.prototype,pt=ct.bind,mt=ct.call,ft=lt&&pt.bind(mt,mt),vt=lt?function(t){return t&&ft(t)}:function(t){return t&&function(){return mt.apply(t,arguments)}},St=vt,gt=St({}.toString),bt=St(''.slice),yt=function(t){return bt(gt(t),8,-1)},Tt=ut,Et=yt,wt=Object,$t=vt(''.split),kt=Tt((function(){return!wt('z').propertyIsEnumerable(0)}))?function(t){return'String'==Et(t)?$t(t,''):wt(t)}:wt,At=TypeError,Pt=function(t){if(null==t)throw At('Can\'t call method on '+t);return t},Rt=kt,Dt=Pt,_t=function(t){return Rt(Dt(t))},Ct={},It=function(t){return t&&t.Math==Math&&t},Lt=It('object'==typeof globalThis&&globalThis)||It('object'==typeof window&&window)||It('object'==typeof self&&self)||It('object'==typeof dt&&dt)||function(){return this}()||Function('return this')(),xt=function(t){return'function'==typeof t},Nt=Lt,Ot=Object.defineProperty,Bt=function(t,e){try{Ot(Nt,t,{value:e,configurable:!0,writable:!0})}catch(i){Nt[t]=e}return e},Mt=Lt['__core-js_shared__']||Bt('__core-js_shared__',{}),Ut=xt,Vt=Mt,qt=vt(Function.toString);Ut(Vt.inspectSource)||(Vt.inspectSource=function(t){return qt(t)});var Ft,Ht,Gt=xt,Yt=Vt.inspectSource,zt=Lt.WeakMap,Qt=Gt(zt)&&/native code/.test(Yt(zt)),jt=xt,Wt=function(t){return'object'==typeof t?null!==t:jt(t)},Jt=!ut((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),Xt={},Kt=Wt,Zt=Lt.document,te=Kt(Zt)&&Kt(Zt.createElement),ee=function(t){return te?Zt.createElement(t):{}},ie=ee,se=!Jt&&!ut((function(){return 7!=Object.defineProperty(ie('div'),'a',{get:function(){return 7}}).a})),re=Jt&&ut((function(){return 42!=Object.defineProperty((function(){}),'prototype',{value:42,writable:!1}).prototype})),ae=Wt,ne=String,oe=TypeError,de=function(t){if(ae(t))return t;throw oe(ne(t)+' is not an object')},ue=ht,he=Function.prototype.call,le=ue?he.bind(he):function(){return he.apply(he,arguments)},ce={},pe=ce,me=Lt,fe=xt,ve=function(t){return fe(t)?t:void 0},Se=function(t,e){return arguments.length<2?ve(pe[t])||ve(me[t]):pe[t]&&pe[t][e]||me[t]&&me[t][e]},ge=vt({}.isPrototypeOf),be=Lt,ye=Se('navigator','userAgent')||'',Te=be.process,Ee=be.Deno,we=Te&&Te.versions||Ee&&Ee.version,$e=we&&we.v8;$e&&(Ht=(Ft=$e.split('.'))[0]>0&&Ft[0]<4?1:+(Ft[0]+Ft[1])),!Ht&&ye&&(!(Ft=ye.match(/Edge\/(\d+)/))||Ft[1]>=74)&&(Ft=ye.match(/Chrome\/(\d+)/))&&(Ht=+Ft[1]);var ke=Ht,Ae=ut,Pe=!!Object.getOwnPropertySymbols&&!Ae((function(){var t=Symbol();return!String(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&ke&&ke<41})),Re=Pe&&!Symbol.sham&&'symbol'==typeof Symbol.iterator,De=Se,_e=xt,Ce=ge,Ie=Object,Le=Re?function(t){return'symbol'==typeof t}:function(t){var e=De('Symbol');return _e(e)&&Ce(e.prototype,Ie(t))},xe=String,Ne=function(t){try{return xe(t)}catch(t){return'Object'}},Oe=xt,Be=Ne,Me=TypeError,Ue=function(t){if(Oe(t))return t;throw Me(Be(t)+' is not a function')},Ve=Ue,qe=function(t,e){var i=t[e];return null==i?void 0:Ve(i)},Fe=le,He=xt,Ge=Wt,Ye=TypeError,ze={exports:{}},Qe=Mt;(ze.exports=function(t,e){return Qe[t]||(Qe[t]=void 0!==e?e:{})})('versions',[]).push({version:'3.24.1',mode:'pure',copyright:'Â© 2014-2022 Denis Pushkarev (zloirock.ru)',license:'https://github.com/zloirock/core-js/blob/v3.24.1/LICENSE',source:'https://github.com/zloirock/core-js'});var je=Pt,We=Object,Je=function(t){return We(je(t))},Xe=Je,Ke=vt({}.hasOwnProperty),Ze=Object.hasOwn||function(t,e){return Ke(Xe(t),e)},ti=vt,ei=0,ii=Math.random(),si=ti(1..toString),ri=function(t){return'Symbol('+(void 0===t?'':t)+')_'+si(++ei+ii,36)},ai=Lt,ni=ze.exports,oi=Ze,di=ri,ui=Pe,hi=Re,li=ni('wks'),ci=ai.Symbol,pi=ci&&ci.for,mi=hi?ci:ci&&ci.withoutSetter||di,fi=function(t){if(!oi(li,t)||!ui&&'string'!=typeof li[t]){var e='Symbol.'+t;ui&&oi(ci,t)?li[t]=ci[t]:li[t]=hi&&pi?pi(e):mi(e)}return li[t]},vi=le,Si=Wt,gi=Le,bi=qe,yi=function(t,e){var i,s;if('string'===e&&He(i=t.toString)&&!Ge(s=Fe(i,t)))return s;if(He(i=t.valueOf)&&!Ge(s=Fe(i,t)))return s;if('string'!==e&&He(i=t.toString)&&!Ge(s=Fe(i,t)))return s;throw Ye('Can\'t convert object to primitive value')},Ti=TypeError,Ei=fi('toPrimitive'),wi=function(t,e){if(!Si(t)||gi(t))return t;var i,s=bi(t,Ei);if(s){if(void 0===e&&(e='default'),i=vi(s,t,e),!Si(i)||gi(i))return i;throw Ti('Can\'t convert object to primitive value')}return void 0===e&&(e='number'),yi(t,e)},$i=Le,ki=function(t){var e=wi(t,'string');return $i(e)?e:e+''},Ai=Jt,Pi=se,Ri=re,Di=de,_i=ki,Ci=TypeError,Ii=Object.defineProperty,Li=Object.getOwnPropertyDescriptor;Xt.f=Ai?Ri?function(t,e,i){if(Di(t),e=_i(e),Di(i),'function'==typeof t&&'prototype'===e&&'value'in i&&'writable'in i&&!i.writable){var s=Li(t,e);s&&s.writable&&(t[e]=i.value,i={configurable:'configurable'in i?i.configurable:s.configurable,enumerable:'enumerable'in i?i.enumerable:s.enumerable,writable:!1})}return Ii(t,e,i)}:Ii:function(t,e,i){if(Di(t),e=_i(e),Di(i),Pi)try{return Ii(t,e,i)}catch(t){}if('get'in i||'set'in i)throw Ci('Accessors not supported');return'value'in i&&(t[e]=i.value),t};var xi,Ni,Oi,Bi=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},Mi=Xt,Ui=Bi,Vi=Jt?function(t,e,i){return Mi.f(t,e,Ui(1,i))}:function(t,e,i){return t[e]=i,t},qi=ze.exports,Fi=ri,Hi=qi('keys'),Gi=function(t){return Hi[t]||(Hi[t]=Fi(t))},Yi={},zi=Qt,Qi=Lt,ji=vt,Wi=Wt,Ji=Vi,Xi=Ze,Ki=Mt,Zi=Gi,ts=Yi,es=Qi.TypeError,is=Qi.WeakMap;if(zi||Ki.state){var ss=Ki.state||(Ki.state=new is),rs=ji(ss.get),as=ji(ss.has),ns=ji(ss.set);xi=function(t,e){if(as(ss,t))throw new es('Object already initialized');return e.facade=t,ns(ss,t,e),e},Ni=function(t){return rs(ss,t)||{}},Oi=function(t){return as(ss,t)}}else{var os=Zi('state');ts[os]=!0,xi=function(t,e){if(Xi(t,os))throw new es('Object already initialized');return e.facade=t,Ji(t,os,e),e},Ni=function(t){return Xi(t,os)?t[os]:{}},Oi=function(t){return Xi(t,os)}}var ds={set:xi,get:Ni,has:Oi,enforce:function(t){return Oi(t)?Ni(t):xi(t,{})},getterFor:function(t){return function(e){var i;if(!Wi(e)||(i=Ni(e)).type!==t)throw es('Incompatible receiver, '+t+' required');return i}}},us=ht,hs=Function.prototype,ls=hs.apply,cs=hs.call,ps='object'==typeof Reflect&&Reflect.apply||(us?cs.bind(ls):function(){return cs.apply(ls,arguments)}),ms={},fs={},vs={}.propertyIsEnumerable,Ss=Object.getOwnPropertyDescriptor,gs=Ss&&!vs.call({1:2},1);fs.f=gs?function(t){var e=Ss(this,t);return!!e&&e.enumerable}:vs;var bs=Jt,ys=le,Ts=fs,Es=Bi,ws=_t,$s=ki,ks=Ze,As=se,Ps=Object.getOwnPropertyDescriptor;ms.f=bs?Ps:function(t,e){if(t=ws(t),e=$s(e),As)try{return Ps(t,e)}catch(t){}if(ks(t,e))return Es(!ys(Ts.f,t,e),t[e])};var Rs=ut,Ds=xt,_s=/#|\.prototype\./,Cs=function(t,e){var i=Ls[Is(t)];return i==Ns||i!=xs&&(Ds(e)?Rs(e):!!e)},Is=Cs.normalize=function(t){return String(t).replace(_s,'.').toLowerCase()},Ls=Cs.data={},xs=Cs.NATIVE='N',Ns=Cs.POLYFILL='P',Os=Cs,Bs=Ue,Ms=ht,Us=vt(vt.bind),Vs=function(t,e){return Bs(t),void 0===e?t:Ms?Us(t,e):function(){return t.apply(e,arguments)}},qs=Lt,Fs=ps,Hs=vt,Gs=xt,Ys=ms.f,zs=Os,Qs=ce,js=Vs,Ws=Vi,Js=Ze,Xs=function(t){var e=function(i,s,r){if(this instanceof e){switch(arguments.length){case 0:return new t;case 1:return new t(i);case 2:return new t(i,s)}return new t(i,s,r)}return Fs(t,this,arguments)};return e.prototype=t.prototype,e},Ks=function(t,e){var i,s,r,a,n,o,d,u,h=t.target,l=t.global,c=t.stat,p=t.proto,m=l?qs:c?qs[h]:(qs[h]||{}).prototype,f=l?Qs:Qs[h]||Ws(Qs,h,{})[h],v=f.prototype;for(r in e)i=!zs(l?r:h+(c?'.':'#')+r,t.forced)&&m&&Js(m,r),n=f[r],i&&(o=t.dontCallGetSet?(u=Ys(m,r))&&u.value:m[r]),a=i&&o?o:e[r],i&&typeof n==typeof a||(d=t.bind&&i?js(a,qs):t.wrap&&i?Xs(a):p&&Gs(a)?Hs(a):a,(t.sham||a&&a.sham||n&&n.sham)&&Ws(d,'sham',!0),Ws(f,r,d),p&&(Js(Qs,s=h+'Prototype')||Ws(Qs,s,{}),Ws(Qs[s],r,a),t.real&&v&&!v[r]&&Ws(v,r,a)))},Zs=Jt,tr=Ze,er=Function.prototype,ir=Zs&&Object.getOwnPropertyDescriptor,sr=tr(er,'name'),rr={EXISTS:sr,PROPER:sr&&'something'===function(){}.name,CONFIGURABLE:sr&&(!Zs||Zs&&ir(er,'name').configurable)},ar={},nr=Math.ceil,or=Math.floor,dr=Math.trunc||function(t){var e=+t;return(e>0?or:nr)(e)},ur=function(t){var e=+t;return e!=e||0===e?0:dr(e)},hr=ur,lr=Math.max,cr=Math.min,pr=ur,mr=Math.min,fr=function(t){return t>0?mr(pr(t),9007199254740991):0},vr=function(t){return fr(t.length)},Sr=_t,gr=function(t,e){var i=hr(t);return i<0?lr(i+e,0):cr(i,e)},br=vr,yr=function(t){return function(e,i,s){var r,a=Sr(e),n=br(a),o=gr(s,n);if(t&&i!=i){for(;n>o;)if((r=a[o++])!=r)return!0}else for(;n>o;o++)if((t||o in a)&&a[o]===i)return t||o||0;return!t&&-1}},Tr={includes:yr(!0),indexOf:yr(!1)},Er=Ze,wr=_t,$r=Tr.indexOf,kr=Yi,Ar=vt([].push),Pr=['constructor','hasOwnProperty','isPrototypeOf','propertyIsEnumerable','toLocaleString','toString','valueOf'],Rr=function(t,e){var i,s=wr(t),r=0,a=[];for(i in s)!Er(kr,i)&&Er(s,i)&&Ar(a,i);for(;e.length>r;)Er(s,i=e[r++])&&(~$r(a,i)||Ar(a,i));return a},Dr=Pr,_r=Object.keys||function(t){return Rr(t,Dr)},Cr=Jt,Ir=re,Lr=Xt,xr=de,Nr=_t,Or=_r;ar.f=Cr&&!Ir?Object.defineProperties:function(t,e){xr(t);for(var i,s=Nr(e),r=Or(e),a=r.length,n=0;a>n;)Lr.f(t,i=r[n++],s[i]);return t};var Br,Mr=Se('document','documentElement'),Ur=de,Vr=ar,qr=Pr,Fr=Yi,Hr=Mr,Gr=ee,Yr=Gi('IE_PROTO'),zr=function(){},Qr=function(t){return'<script>'+t+'<\/script>'},jr=function(t){t.write(Qr('')),t.close();var e=t.parentWindow.Object;return t=null,e},Wr=function(){try{Br=new ActiveXObject('htmlfile')}catch(t){}var t,e;Wr='undefined'!=typeof document?document.domain&&Br?jr(Br):((e=Gr('iframe')).style.display='none',Hr.appendChild(e),e.src=String('javascript:'),(t=e.contentWindow.document).open(),t.write(Qr('document.F=Object')),t.close(),t.F):jr(Br);for(var i=qr.length;i--;)delete Wr.prototype[qr[i]];return Wr()};Fr[Yr]=!0;var Jr,Xr,Kr,Zr=Object.create||function(t,e){var i;return null!==t?(zr.prototype=Ur(t),i=new zr,zr.prototype=null,i[Yr]=t):i=Wr(),void 0===e?i:Vr.f(i,e)},ta=!ut((function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype})),ea=Ze,ia=xt,sa=Je,ra=ta,aa=Gi('IE_PROTO'),na=Object,oa=na.prototype,da=ra?na.getPrototypeOf:function(t){var e=sa(t);if(ea(e,aa))return e[aa];var i=e.constructor;return ia(i)&&e instanceof i?i.prototype:e instanceof na?oa:null},ua=Vi,ha=function(t,e,i,s){return s&&s.enumerable?t[e]=i:ua(t,e,i),t},la=ut,ca=xt,pa=Zr,ma=da,fa=ha,va=fi('iterator'),Sa=!1;[].keys&&('next'in(Kr=[].keys())?(Xr=ma(ma(Kr)))!==Object.prototype&&(Jr=Xr):Sa=!0);var ga=null==Jr||la((function(){var t={};return Jr[va].call(t)!==t}));ca((Jr=ga?{}:pa(Jr))[va])||fa(Jr,va,(function(){return this}));var ba={IteratorPrototype:Jr,BUGGY_SAFARI_ITERATORS:Sa},ya={};ya[fi('toStringTag')]='z';var Ta='[object z]'===String(ya),Ea=Ta,wa=xt,$a=yt,ka=fi('toStringTag'),Aa=Object,Pa='Arguments'==$a(function(){return arguments}()),Ra=Ea?$a:function(t){var e,i,s;return void 0===t?'Undefined':null===t?'Null':'string'==typeof(i=function(t,e){try{return t[e]}catch(t){}}(e=Aa(t),ka))?i:Pa?$a(e):'Object'==(s=$a(e))&&wa(e.callee)?'Arguments':s},Da=Ra,_a=Ta?{}.toString:function(){return'[object '+Da(this)+']'},Ca=Ta,Ia=Xt.f,La=Vi,xa=Ze,Na=_a,Oa=fi('toStringTag'),Ba=function(t,e,i,s){if(t){var r=i?t:t.prototype;xa(r,Oa)||Ia(r,Oa,{configurable:!0,value:e}),s&&!Ca&&La(r,'toString',Na)}},Ma=ba.IteratorPrototype,Ua=Zr,Va=Bi,qa=Ba,Fa=Ct,Ha=function(){return this},Ga=(TypeError,vt);Object.setPrototypeOf||'__proto__'in{}&&function(){var t,e=!1,i={};try{(t=Ga(Object.getOwnPropertyDescriptor(Object.prototype,'__proto__').set))(i,[]),e=i instanceof Array}catch(t){}}();var Ya=Ks,za=le,Qa=function(t,e,i,s){var r=e+' Iterator';return t.prototype=Ua(Ma,{next:Va(+!s,i)}),qa(t,r,!1,!0),Fa[r]=Ha,t},ja=da,Wa=Ba,Ja=ha,Xa=Ct,Ka=rr.PROPER,Za=ba.BUGGY_SAFARI_ITERATORS,tn=fi('iterator'),en=function(){return this},sn=_t,rn=Ct,an=ds;Xt.f;var nn=function(t,e,i,s,r,a,n){Qa(i,e,s);var o,d,u,h=function(t){if(t===r&&f)return f;if(!Za&&t in p)return p[t];switch(t){case'keys':case'values':case'entries':return function(){return new i(this,t)}}return function(){return new i(this)}},l=e+' Iterator',c=!1,p=t.prototype,m=p[tn]||p['@@iterator']||r&&p[r],f=!Za&&m||h(r),v='Array'==e&&p.entries||m;if(v&&(o=ja(v.call(new t)))!==Object.prototype&&o.next&&(Wa(o,l,!0,!0),Xa[l]=en),Ka&&'values'==r&&m&&'values'!==m.name&&(c=!0,f=function(){return za(m,this)}),r)if(d={values:h('values'),keys:a?f:h('keys'),entries:h('entries')},n)for(u in d)(Za||c||!(u in p))&&Ja(p,u,d[u]);else Ya({target:e,proto:!0,forced:Za||c},d);return n&&p[tn]!==f&&Ja(p,tn,f,{name:r}),Xa[e]=f,d},on=an.set,dn=an.getterFor('Array Iterator');nn(Array,'Array',(function(t,e){on(this,{type:'Array Iterator',target:sn(t),index:0,kind:e})}),(function(){var t=dn(this),e=t.target,i=t.kind,s=t.index++;return!e||s>=e.length?(t.target=void 0,{value:void 0,done:!0}):'keys'==i?{value:s,done:!1}:'values'==i?{value:e[s],done:!1}:{value:[s,e[s]],done:!1}}),'values'),rn.Arguments=rn.Array;var un=Ct,hn=fi('iterator'),ln=Array.prototype,cn=Ra,pn=qe,mn=Ct,fn=fi('iterator'),vn=function(t){if(null!=t)return pn(t,fn)||pn(t,'@@iterator')||mn[cn(t)]},Sn=le,gn=Ue,bn=de,yn=Ne,Tn=vn,En=TypeError,wn=le,$n=de,kn=qe,An=Vs,Pn=le,Rn=de,Dn=Ne,_n=function(t){return void 0!==t&&(un.Array===t||ln[hn]===t)},Cn=vr,In=ge,Ln=function(t,e){var i=arguments.length<2?Tn(t):e;if(gn(i))return bn(Sn(i,t));throw En(yn(t)+' is not iterable')},xn=vn,Nn=function(t,e,i){var s,r;$n(t);try{if(!(s=kn(t,'return'))){if('throw'===e)throw i;return i}s=wn(s,t)}catch(t){r=!0,s=t}if('throw'===e)throw i;if(r)throw s;return $n(s),i},On=TypeError,Bn=function(t,e){this.stopped=t,this.result=e},Mn=Bn.prototype,Un=ki,Vn=Xt,qn=Bi,Fn=function(t,e,i){var s,r,a,n,o,d,u,h=i&&i.that,l=!(!i||!i.AS_ENTRIES),c=!(!i||!i.IS_RECORD),p=!(!i||!i.IS_ITERATOR),m=!(!i||!i.INTERRUPTED),f=An(e,h),v=function(t){return s&&Nn(s,'normal',t),new Bn(!0,t)},S=function(t){return l?(Rn(t),m?f(t[0],t[1],v):f(t[0],t[1])):m?f(t,v):f(t)};if(c)s=t.iterator;else if(p)s=t;else{if(!(r=xn(t)))throw On(Dn(t)+' is not iterable');if(_n(r)){for(a=0,n=Cn(t);n>a;a++)if((o=S(t[a]))&&In(Mn,o))return o;return new Bn(!1)}s=Ln(t,r)}for(d=c?t.next:s.next;!(u=Pn(d,s)).done;){try{o=S(u.value)}catch(t){Nn(s,'throw',t)}if('object'==typeof o&&o&&In(Mn,o))return o}return new Bn(!1)},Hn=function(t,e,i){var s=Un(e);s in t?Vn.f(t,s,qn(0,i)):t[s]=i};Ks({target:'Object',stat:!0},{fromEntries:function(t){var e={};return Fn(t,(function(t,i){Hn(e,t,i)}),{AS_ENTRIES:!0}),e}});var Gn=ce.Object.fromEntries,Yn={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},zn=Lt,Qn=Ra,jn=Vi,Wn=Ct,Jn=fi('toStringTag');for(var Xn in Yn){var Kn=zn[Xn],Zn=Kn&&Kn.prototype;Zn&&Qn(Zn)!==Jn&&jn(Zn,Jn,Xn),Wn[Xn]=Wn.Array}var to=Gn,eo=i=>{const r=new t(1/0),a=new e,n=new t(void 0),o=new t(void 0);let d=NaN,u=!1;return i.extend('XHRLoader',(function(){const{parent:t}=this,e=t.load.bind(t);return{load:function(t){if('MPD'===t.request.type){const e=t.onload,i=t.progress;t.onload=function(...t){return(t=>{var e,i,a,d,u;const h=to(t.getAllResponseHeaders().trim().split(/[\n\r]+/).map((t=>t.split(': '))));if('x-playback-duration'in h||'x-playback-duration-millis'in h){const n=parseInt(null!==(e=t.getResponseHeader('X-Playback-Duration'))&&void 0!==e?e:'',10),o=parseInt(null!==(i=t.getResponseHeader('X-Playback-Duration-Millis'))&&void 0!==i?i:'',10),d=null!==(a=null!=o?o:1e3*n)&&void 0!==a?a:NaN;s(d)&&!isNaN(d)&&r.next(d)}const l=null!==(d=h['x-delivery-type'])&&void 0!==d?d:I.HTTP1,c=null!==(u={1:!0,0:!1}[h['x-reused']])&&void 0!==u?u:void 0;n.next(l),o.next(c)})(this),e(...t)},t.progress=function(...t){return this.readyState>=2&&!u&&(u=!0,a.next(Date.now()-d)),i(...t)},d=Date.now(),u=!1}return e(t)}}}),!0),{playbackDuration$:r,ping$:a,connectionReused$:o,connectionType$:n}},io=t=>{const e=new URL(t);return e.searchParams.set('quic','1'),e.toString()},so=t=>{t.extend('HTTPLoader',(function(){const{parent:t}=this,e=t.load;return{load:t=>{if(t.request&&t.request.range){const[e,i]=t.request.range.split('-').map((t=>parseInt(t,10))),s=new URL(t.request.url,location.href);s.searchParams.append('bytes',`${e}-${i}`),t.request.url=s.toString(),t.request.range=void 0}e(t)}}}),!0)};const ro=(t,e,s,{equal:a=((t,e)=>t===e),changed$:n,onError:o}={})=>{const d=t.getState(),u=e(),h=r(n),l=new i;return n&&l.add(n.subscribe((e=>{const i=t.getState();a(e,i)&&t.setState(e)}),o)),a(u,d)||(s(d),h&&t.setState(d)),l.add(t.stateChangeStarted$.subscribe((e=>{s(e.to),h&&t.setState(e.to)}),o)),l},ao=(t,e,i)=>ro(e,(()=>t.loop),(e=>{s(e)&&(t.loop=e)}),{onError:i}),no=(t,e,i,r)=>ro(e,(()=>({muted:t.muted,volume:t.volume})),(e=>{s(e)&&(t.muted=e.muted,t.volume=e.volume)}),{equal:(t,e)=>t===e||(null==t?void 0:t.muted)===(null==e?void 0:e.muted)&&(null==t?void 0:t.volume)===(null==e?void 0:e.volume),changed$:i,onError:r}),oo=(t,e,i,r)=>ro(e,(()=>t.playbackRate),(e=>{s(e)&&(t.playbackRate=e)}),{changed$:i,onError:r}),uo=(t,e)=>{if(t.id===e)return!0;const[i,s,r]=e.split('|');return t.language===s&&t.label===r};class ho{constructor(){this.available$=new e,this.current$=new t(void 0),this.error$=new e,this.subscription=new i,this.externalTracks=new Map}connect(t,e,i){this.video=t,this.cueSettings=e.textTrackCuesSettings,this.subscribe();const r=t=>{this.error$.next({id:'TextTracksManager',message:'Generic HtmlVideoTextTrackManager error',thrown:t})};this.subscription.add(this.available$.subscribe(i.availableTextTracks$)),this.subscription.add(this.current$.subscribe(i.currentTextTrack$)),this.subscription.add(this.error$.subscribe(i.error$)),this.subscription.add(ro(e.externalTextTracks,(()=>Object.values(this.externalTracks)),(t=>{s(t)&&this.setExternal(t)}),{equal:(t,e)=>s(t)&&s(e)&&t.length===e.length&&t.every((({id:t},i)=>t===e[i].id)),changed$:this.available$.pipe(u((t=>t.filter((({type:t})=>'external'===t))))),onError:r})),this.subscription.add(ro(e.currentTextTrack,(()=>{if(this.video)return;const t=this.htmlTextTracksAsArray().find((({mode:t})=>'showing'===t));return t&&this.htmlTextTrackToITextTrack(t).id}),(t=>this.select(t)),{changed$:this.current$,onError:r})),this.subscription.add(ro(e.textTrackCuesSettings,(()=>({})),(()=>{if(this.video)for(const t of this.htmlTextTracksAsArray())this.applyCueSettings(t.cues),this.applyCueSettings(t.activeCues)})))}subscribe(){c(this.video);const{textTracks:t}=this.video;this.subscription.add(a(t,'addtrack').subscribe((()=>{const t=this.current$.getValue();this.select(t)}))),this.subscription.add(o(a(t,'addtrack'),a(t,'removetrack'),h(['init'])).pipe(u((()=>this.htmlTextTracksAsArray().map((t=>this.htmlTextTrackToITextTrack(t))))),l(((t,e)=>t.length===e.length&&t.every((({id:t},i)=>t===e[i].id))))).subscribe(this.available$)),this.subscription.add(o(a(t,'change'),h(['init'])).pipe(u((()=>this.htmlTextTracksAsArray().find((({mode:t})=>'showing'===t)))),u((t=>t&&this.htmlTextTrackToITextTrack(t).id)),l()).subscribe(this.current$));const e=t=>{var e,i;return this.applyCueSettings(null!==(i=null===(e=t.target)||void 0===e?void 0:e.activeCues)&&void 0!==i?i:null)};this.subscription.add(a(t,'addtrack').subscribe((t=>{var i,s;null===(i=t.track)||void 0===i||i.addEventListener('cuechange',e);const r=t=>{var e,i,s,a,n;const o=null!==(i=null===(e=t.target)||void 0===e?void 0:e.cues)&&void 0!==i?i:null;o&&o.length&&(this.applyCueSettings(null!==(a=null===(s=t.target)||void 0===s?void 0:s.cues)&&void 0!==a?a:null),null===(n=t.target)||void 0===n||n.removeEventListener('cuechange',r))};null===(s=t.track)||void 0===s||s.addEventListener('cuechange',r)}))),this.subscription.add(a(t,'removetrack').subscribe((t=>{var i;null===(i=t.track)||void 0===i||i.removeEventListener('cuechange',e)})))}applyCueSettings(t){if(!t||!t.length)return;const e=this.cueSettings.getState();for(const i of Array.from(t)){const t=i;s(e.align)&&(t.align=e.align),s(e.position)&&(t.position=e.position),s(e.size)&&(t.size=e.size),s(e.line)&&(t.line=e.line)}}htmlTextTracksAsArray(t=!1){c(this.video);const e=[...this.video.textTracks];return t?e:e.filter(ho.isHealthyTrack)}htmlTextTrackToITextTrack(t){const{language:e,label:i}=t,s=''!==t.id?t.id:(t=>['__',t.language,t.label].join('|'))(t);return this.externalTracks.has(s)?{id:s,type:'external',language:e,label:i,url:this.externalTracks.get(s).url}:{id:s,type:'internal',language:e,label:i}}static isHealthyTrack(t){return'metadata'!==t.kind&&(''!==t.id||''!==t.label||''!==t.language)}setExternal(t){t.filter((({id:t})=>!this.externalTracks.has(t))).forEach((t=>this.attach(t))),Array.from(this.externalTracks.keys()).filter((e=>!t.find((t=>t.id===e)))).forEach((t=>this.detach(t)))}select(t){c(this.video);for(const e of this.htmlTextTracksAsArray(!0))s(t)&&uo(e,t)?e.mode='showing':e.mode='disabled'}destroy(){if(this.subscription.unsubscribe(),this.video)for(const t of Array.from(this.video.getElementsByTagName('track'))){const e=t.getAttribute('id');e&&this.externalTracks.has(e)&&this.video.removeChild(t)}this.externalTracks.clear()}attach(t){c(this.video);const e=document.createElement('track');e.setAttribute('src',t.url),e.setAttribute('id',t.id),t.label&&e.setAttribute('label',t.label),t.language&&e.setAttribute('srclang',t.language),this.externalTracks.set(t.id,t),this.video.appendChild(e)}detach(t){c(this.video);const e=Array.prototype.find.call(this.video.getElementsByTagName('track'),(e=>e.getAttribute('id')===t));e&&this.video.removeChild(e),this.externalTracks.delete(t)}}var lo=t=>{const e=document.createElement('video');return e.setAttribute('crossorigin','anonymous'),e.setAttribute('playsinline','playsinline'),t.appendChild(e),e};class co{constructor(){this.pausedTime=0,this.streamOffset=0,this.pauseTimestamp=0}getTotalPausedTime(){return this.pausedTime+this.getCurrentPausedTime()}getCurrentPausedTime(){return this.pauseTimestamp>0?Date.now()-this.pauseTimestamp:0}getStreamOffset(){return this.streamOffset}getTotalOffset(){return this.getTotalPausedTime()+this.streamOffset}pause(){0===this.pauseTimestamp&&(this.pauseTimestamp=Date.now())}resume(){this.pauseTimestamp>0&&(this.pausedTime+=this.getCurrentPausedTime(),this.pauseTimestamp=0)}resetTo(t){this.streamOffset=t,this.pauseTimestamp=0,this.pausedTime=0}}class po{constructor(t){this._buffer=[],this._source=t}fill(){this._buffer=[];const t=this._source.currentTime;for(let e=0,i=this._source.buffered.length;e<i;e++){let i=this._source.buffered.start(e);const s=this._source.buffered.end(e);i>t&&i-t<3&&(i=t),this._buffer.push({from:i,to:s,i:e})}return this._buffer.sort((function(t,e){return t.from-e.from})),this._buffer}getByTime(t){return this._buffer.find((e=>t>=e.from&&t<e.to))}getNextWithGap(t,e){const i=this.getNext(t);if(i&&i.from-t.to<(e||3))return i}getNext(t){let e=this._buffer.indexOf(t);if(~e&&this._buffer.length-1>e)return this._buffer[++e]}smartRemove(t,e,i){this._buffer.forEach((({from:s,to:r})=>{const a=s>=t&&s<e,n=r>=t&&r<e;a&&n||(a?i(e,r):n?i(s,t):s<t&&r>e?(i(e,r),i(s,t)):i(s,r))}))}destroy(){this._buffer=[]}}var mo=(t,e,i=3)=>{let s=0,r=0;for(let a=0;a<t.length;a++){const n=t.start(a),o=t.end(a);if(n<=e&&e<=o){if(s=n,r=o,!i)return{from:s,to:r};for(let e=a-1;e>=0;e--)t.end(e)+i>=s&&(s=t.start(e));for(let e=a+1;e<t.length;e++)t.start(e)-i<=r&&(r=t.end(e))}}return{from:s,to:r}};const fo=t=>{const i=e=>a(t,e).pipe(v(void 0)),r=o(...['waiting','pause','canplay','play','canplaythrough','playing','seeking','seeked','ended'].map((e=>a(t,e)))).pipe(u((()=>t.readyState<3)),l()),n=o(a(t,'progress'),a(t,'timeupdate')).pipe(u((()=>mo(t.buffered,t.currentTime)))),d=a(t,'volumechange').pipe(p(0),u((()=>({muted:t.muted,volume:t.volume})))),h=a(t,'ratechange').pipe(u((()=>t.playbackRate))),c=a(t,'error').pipe(u((()=>{const e=t.error;return{id:e?`MediaError#${e.code}`:'HtmlVideoError',message:e?e.message:'Error event from HTML video element'}}))),m=a(t,'timeupdate').pipe(u((()=>t.currentTime))),S=new e;let g;return m.subscribe((e=>{t.loop&&s(g)&&s(e)&&g>=t.duration-.3&&e<=.3&&S.next(g),g=e})),{playing$:i('playing'),pause$:i('pause').pipe(f((()=>!t.error))),canplay$:i('canplay'),ended$:i('ended'),looped$:S,error$:c,seeked$:i('seeked'),seeking$:i('seeking'),progress$:i('progress'),loadStart$:i('loadstart'),loadedMetadata$:i('loadedmetadata'),loadedData$:i('loadeddata'),timeUpdate$:m,durationChange$:a(t,'durationchange').pipe(u((()=>t.duration))),isBuffering$:r,currentBuffer$:n,volumeState$:d,playbackRateState$:h}},vo=t=>{if(t.includes('/')){const e=t.split('/');return parseInt(e[0])/parseInt(e[1])}return parseFloat(t)};var So=Je,go=vr,bo=ur;Ks({target:'Array',proto:!0},{at:function(t){var e=So(this),i=go(e),s=bo(t),r=s>=0?s:i+s;return r<0||r>=i?void 0:e[r]}});var yo=Se('Array','at');let To=!1,Eo={};const wo=t=>{t(Eo)},$o=(t,e)=>{var i;To&&(Eo.meta=null!==(i=Eo.meta)&&void 0!==i?i:{},Eo.meta[t]=e)};class ko{constructor(t){this.name=t}next(t){var e,i;if(!To)return;Eo.series=null!==(e=Eo.series)&&void 0!==e?e:{};const s=null!==(i=Eo.series[this.name])&&void 0!==i?i:[];s.push([Date.now(),t]),Eo.series[this.name]=s}}const Ao=new ko('best_bitrate');class Po{constructor(){this.history={}}recordSelection(t){this.history[t.id]=S()}recordSwitch(t){this.last=t}clear(){this.last=void 0,this.history={}}}const Ro=(t,{container:e,throughput:i,tuning:a,limits:n,reserve:o=0,forwardBufferHealth:d,playbackRate:u,current:h,history:l})=>{var c,p,m,f;const v=a.usePixelRatio&&null!==(c=window.devicePixelRatio)&&void 0!==c?c:1,g=a.limitByContainer&&e&&e.width>0&&e.height>0&&{width:e.width*v*a.containerSizeFactor,height:e.height*v*a.containerSizeFactor},b=g&&G(g),y=a.considerPlaybackRate&&s(u)?u:1,T=t.filter((t=>!Y(t.quality))).sort(((t,e)=>q(t.quality,e.quality)?-1:1)),E=null===(p=yo(T,-1))||void 0===p?void 0:p.quality,w=null===(m=yo(T,0))||void 0===m?void 0:m.quality,$=r(n)||s(n.min)&&s(n.max)&&F(n.max,n.min)||s(n.min)&&w&&q(n.min,w)||s(n.max)&&E&&F(n.max,E),k=y*(A=null!=d?d:.5,P=a.bitrateFactorAtEmptyBuffer,R=a.bitrateFactorAtFullBuffer,(P-R)*Math.pow(2,-10*A)+R);var A,P,R;const D=T.filter((t=>{const e=!b||F(t.quality,b),u=!(s(i)&&isFinite(i)&&s(t.bitrate))||i-o>=t.bitrate*k,l=a.lazyQualitySwitch&&s(a.minBufferToSwitchUp)&&h&&!Y(h.quality)&&(null!=d?d:0)<a.minBufferToSwitchUp&&q(t.quality,h.quality),c=$||(r(n.max)||(p=t.quality,m=n.max,V[p].height<=V[m].height))&&(r(n.min)||((t,e)=>V[t].height>=V[e].height)(t.quality,n.min));var p,m;return e&&u&&!l&&c}))[0];D&&D.bitrate&&Ao.next(D.bitrate);const _=null!==(f=null!=D?D:T[Math.ceil((T.length-1)/2)])&&void 0!==f?f:t[0],C=_&&l&&l.history[_.id]&&S()-l.history[_.id]<=a.trackCooldown&&(!l.last||_.id!==l.last.id);if((null==_?void 0:_.id)&&l&&!C&&l.recordSelection(_),C&&(null==l?void 0:l.last)){const t=l.last;return null==l||l.recordSwitch(t),t}return null==l||l.recordSwitch(_),_};var Do=t=>new URL(t).hostname;const _o=(t,e=300)=>new g((i=>{const{width:r,height:a}=t.getBoundingClientRect();if(i.next({width:r,height:a}),!window.ResizeObserver)return;const n=new ResizeObserver(A((t=>{const e=t[0];if(!e)return;let r,a;e.contentBoxSize&&e.contentBoxSize[0]?(a=e.contentBoxSize[0].blockSize,r=e.contentBoxSize[0].inlineSize):e.contentRect&&(r=e.contentRect.width,a=e.contentRect.height),s(r)&&s(a)&&i.next({width:r,height:a})}),e));return n.observe(t),()=>n.disconnect()})),Co={};var Io;!function(t){t.DOWNLOADING_LIB='downloading_lib',t.STOPPED='stopped',t.STREAM_INITIALIZED='stream_initialized',t.READY='ready',t.PLAYING='playing',t.PAUSED='paused'}(Io||(Io={}));const Lo=(t,e)=>new g((i=>{const s=t=>i.next(t);return t.on(e,s),()=>t.off(e,s)}));class xo{constructor(e){this.subscription=new i,this.videoState=new z(Io.DOWNLOADING_LIB),this.textTracksManager=new ho,this.videoTracks=[],this.frameRatesByFrameHeight={},this.isLive$=new t(void 0),this.maxSeekBackTime$=new t(1/0),this.availableFrom$=new t(void 0),this.elementSize$=new t(void 0),this.liveOffset=new co,this.syncPlayback=()=>{const t=this.videoState.getState(),e=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),s=this.params.desiredState.seekState.getState(),r=this.isLive$.getValue();if(!this.videoState.getTransition()&&t!==Io.DOWNLOADING_LIB&&t!==Io.STREAM_INITIALIZED)switch((null==i?void 0:i.to)!==P.PAUSED&&s.state===L.Requested&&t!==Io.STOPPED&&e!==P.STOPPED&&(r?this.seek(s.position-this.liveOffset.getTotalPausedTime()):this.seek(s.position)),e){case P.STOPPED:switch(t){case Io.STOPPED:break;case Io.PLAYING:case Io.PAUSED:case Io.READY:this.stop();break;default:n(t)}break;case P.PLAYING:switch(t){case Io.PLAYING:break;case Io.PAUSED:r&&(this.liveOffset.getTotalPausedTime()<this.params.config.maxPausedTime&&this.liveOffset.getTotalOffset()<this.maxSeekBackTime$.getValue()?(this.liveOffset.resume(),this.params.output.position$.next(-this.liveOffset.getTotalOffset()/1e3)):this.seek(-this.liveOffset.getTotalOffset())),this.play();break;case Io.READY:this.play();break;case Io.STOPPED:this.prepare();break;default:n(t)}break;case P.PAUSED:switch(t){case Io.PLAYING:this.pause(),this.liveOffset.pause();break;case Io.PAUSED:break;case Io.READY:this.videoState.setState(Io.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED);break;case Io.STOPPED:this.prepare();break;default:n(t)}break;default:n(e)}},this.video=lo(e.container),this.params=e,this.params.output.element$.next(this.video),this.params.output.availableVideoTracks$.next([]),this.params.output.hostname$.next(Do(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.loadDashJs()}loadDashJs(){let t=!1;const e=e=>{var i;t||this.params.output.error$.next({id:'timeout'===e?'DashJSTimedOut':'DashJSLoadingError',message:`Dash.js failed to load: ${null===(i=null==e?void 0:e.toString)||void 0===i?void 0:i.call(e)}`,thrown:e}),t=!0},i=window.setTimeout((()=>e('timeout')),5e3);import('dashjs/dist/dash.mediaplayer.min.js').then((e=>{t||(Co.MediaPlayer=e.MediaPlayer,Co.Debug=e.Debug,this.init())}),e).finally((()=>{window.clearTimeout(i),t=!0}))}init(){c(Co.MediaPlayer,'dashjs not loaded'),c(Co.Debug,'dashjs not loaded'),this.player=Co.MediaPlayer().create(),this.player.updateSettings({debug:{logLevel:3},streaming:{buffer:{fastSwitchEnabled:!0},abr:{limitBitrateByPortal:this.params.tuning.autoTrackSelection.limitByContainer,usePixelRatioInLimitBitrateByPortal:this.params.tuning.autoTrackSelection.usePixelRatio,additionalAbrRules:{insufficientBufferRule:!1}},utcSynchronization:{useManifestDateHeaderTimeSource:!0}}}),this.player.registerCustomCapabilitiesFilter((t=>(t.height&&(this.frameRatesByFrameHeight[t.height]=t.frameRate?vo(t.frameRate+''):void 0),!0)));(this.params.format===R.DASH_WEBM||this.params.format===R.DASH_LIVE_WEBM)&&this.params.tuning.useWebmBigRequest?this.destroyBigRequest=nt(this.player,{minInitSize:this.params.tuning.bigRequestMinInitSize,minDataSize:this.params.tuning.bigRequestMinDataSize,onError:t=>this.params.output.error$.next(t),onDownloadStream:t=>this.params.dependencies.throughputEstimator.trackStream(t)}):this.params.tuning.stripRangeHeader&&so(this.player),ot(this.player),this.params.tuning.requestQuick&&this.player.extend('RequestModifier',(()=>({modifyRequestURL:io})),!0),this.player.clearDefaultUTCTimingSources(),this.subscribe(),this.videoState.setState(Io.STOPPED)}subscribe(){const{output:t,desiredState:e}=this.params,i=e=>{t.error$.next({id:'DashIFProvider',message:'DashIFProvider internal logic error',thrown:e})},a=(t,e)=>this.subscription.add(t.subscribe(e,i));a(_o(this.video),this.elementSize$),a(Lo(this.player,'error').pipe(u((t=>({id:`DashJS#${'object'==typeof t.error?t.error.code:t.error}`,message:'object'==typeof t.error?t.error.message:void 0})))),t.error$),a(Lo(this.player,'playbackError').pipe(u((t=>({id:'DashJSPlayback',message:t.error})))),t.error$);const n=Lo(this.player,'qualityChangeRendered').pipe(f((({mediaType:t})=>'video'===t)),u((({newQuality:t})=>{var e;return null===(e=this.videoTracks.find((({bitrateInfo:e})=>e.qualityIndex===t)))||void 0===e?void 0:e.track})));n.pipe(f(s)).subscribe(t.currentVideoTrack$),this.subscription.add(this.videoState.transitionEnded$.pipe(f((({to:t})=>t===Io.STREAM_INITIALIZED)),b()).subscribe((()=>{this.subscription.add(ro(e.videoTrack,(()=>{var t,e;const i=this.player.getQualityFor('video');return null===(e=null===(t=this.videoTracks.find((({bitrateInfo:t})=>t.qualityIndex===i)))||void 0===t?void 0:t.track)||void 0===e?void 0:e.id}),(t=>{var e;if(r(t))return;const i=null===(e=this.videoTracks.find((({track:e})=>e.id===t)))||void 0===e?void 0:e.bitrateInfo;i&&this.player.setQualityFor('video',i.qualityIndex)}),{changed$:n.pipe(u((t=>null==t?void 0:t.id))),onError:i}))}),i)),this.subscription.add(ro(e.autoVideoTrackSwitching,(()=>{var t,e,i;return null===(i=null===(e=null===(t=this.player.getSettings().streaming)||void 0===t?void 0:t.abr)||void 0===e?void 0:e.autoSwitchBitrate)||void 0===i?void 0:i.video}),(t=>this.player.updateSettings({streaming:{abr:{autoSwitchBitrate:{video:t}}}})),{onError:i})),a(Lo(this.player,'bufferStateChanged').pipe(f((({mediaType:t})=>'video'===t)),u((({state:t})=>'bufferStalled'===t))),t.isBuffering$),a(Lo(this.player,'fragmentLoadingStarted'),(({mediaType:e,request:{url:i}})=>{var s,r;const a=this.player.getDashMetrics(),n=a.getLatestFragmentRequestHeaderValueByID(e,'X-Reused'),o=null!==(s=a.getLatestFragmentRequestHeaderValueByID(e,'X-Delivery-Type'))&&void 0!==s?s:I.HTTP1,d=null!==(r={1:!0,0:!1}[n])&&void 0!==r?r:void 0;this.params.output.httpConnectionType$.next(o),this.params.output.httpConnectionReused$.next(d),t.hostname$.next(Do(i))})),a(Lo(this.player,'streamInitialized'),(({streamInfo:{duration:e,manifestInfo:{isDynamic:i,availableFrom:s}}})=>{this.isLive$.next(i),this.availableFrom$.next(s.getTime()),i||t.duration$.next(e),this.videoTracks=[];const r=this.player.getQualityFor('video');let a;for(const t of this.player.getBitrateInfoListFor('video')){const e=t.qualityIndex.toString(10),i=G(t),s=t.bitrate/1e3,n={width:t.width,height:t.height},o=this.frameRatesByFrameHeight[t.height];if(i){const d={id:e,quality:i,bitrate:s,size:n,fps:o};this.videoTracks.push({track:d,bitrateInfo:t}),t.qualityIndex===r&&(a=d)}}t.availableVideoTracks$.next(this.videoTracks.map((({track:t})=>t))),a&&t.currentVideoTrack$.next(a),this.videoState.setState(Io.STREAM_INITIALIZED),this.videoState.startTransitionTo(Io.READY)})),a(Lo(this.player,'fragmentLoadingCompleted'),(({request:t})=>{if(!t.requestEndDate||!t.firstByteDate||!t.bytesLoaded)return;const e=t.requestEndDate.getTime()-t.firstByteDate.getTime(),i=t.bytesLoaded;this.params.dependencies.throughputEstimator.addRawSpeed(i,e)})),a(o(this.params.dependencies.throughputEstimator.throughput$,this.elementSize$,e.autoVideoTrackLimits.stateChangeEnded$),(()=>{if(!this.params.desiredState.autoVideoTrackSwitching.getState()||!this.videoTracks.length)return;const t=this.params.dependencies.throughputEstimator.throughput$.getValue(),i=Ro(this.videoTracks.map((({track:t})=>t)),{container:this.elementSize$.getValue(),throughput:t,tuning:this.params.tuning.autoTrackSelection,limits:e.autoVideoTrackLimits.getState()}),s=this.videoTracks.find((({track:t})=>t===i));(null==s?void 0:s.bitrateInfo)&&this.player.setQualityFor('video',null==s?void 0:s.bitrateInfo.qualityIndex,!1)})),a(y({maxSeekBackTime:this.maxSeekBackTime$,isLive:this.isLive$.pipe(f(s))}).pipe(f((({isLive:t})=>t)),u((({maxSeekBackTime:t})=>-t/1e3))),this.params.output.duration$);const d=Lo(this.player,'playbackTimeUpdated').pipe(u((({time:t})=>null!=t?t:0)));a(y({availableFrom:this.availableFrom$.pipe(f(s)),currentTime:d}),(({availableFrom:t,currentTime:e})=>this.params.output.liveTime$.next(t+1e3*e))),a(d.pipe(f((()=>!1===this.isLive$.getValue()))),t.position$),a(Lo(this.player,'playbackSeeked'),(()=>t.seekedEvent$.next())),a(Lo(this.player,'playbackEnded'),t.endedEvent$),a(Lo(this.player,'playbackProgress').pipe(u((()=>mo(this.video.buffered,this.video.currentTime)))),t.currentBuffer$),a(Lo(this.player,'playbackPlaying'),(()=>{this.videoState.setState(Io.PLAYING),U(e.playbackState,P.PLAYING)})),a(Lo(this.player,'playbackNotAllowed'),(()=>{this.player.isMuted()?(this.player.setMute(!1),this.videoState.setState(Io.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED,!0)):(this.player.setMute(!0),this.player.play())})),a(Lo(this.player,'playbackPaused'),(()=>{this.videoState.setState(Io.PAUSED),U(e.playbackState,P.PAUSED)})),a(Lo(this.player,'canPlay'),(()=>{var t;(null===(t=this.videoState.getTransition())||void 0===t?void 0:t.to)===Io.READY&&this.videoState.setState(Io.READY)})),a(this.isLive$,t.isLive$),a(_o(this.video),(()=>{this.player.isReady()&&this.player.updatePortalSize()}));a(o(e.playbackState.stateChangeStarted$,e.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,h(['init'])).pipe(p(0)),this.syncPlayback);const{playbackDuration$:l,ping$:c,connectionType$:m,connectionReused$:S}=eo(this.player);a(m,this.params.output.httpConnectionType$),a(S,this.params.output.httpConnectionReused$),a(l,this.maxSeekBackTime$),a(c.pipe(b()),t.firstBytesEvent$),a(Lo(this.player,'canPlay'),t.canplay$),this.params.tuning.flushShortLoopedBuffers&&a(y({isLive:this.isLive$,isShort:t.duration$.pipe(u((t=>t<60)))}),(({isLive:t,isShort:e})=>{const i=!t&&e;this.player.updateSettings({streaming:{buffer:{flushBufferAtTrackSwitch:i}}})})),a(d.pipe(f((t=>t>this.params.tuning.insufficientBufferRuleMargin)),b()),(()=>this.player.updateSettings({streaming:{abr:{additionalAbrRules:{insufficientBufferRule:!0}}}}))),this.textTracksManager.connect(this.video,e,t),this.subscription.add(Lo(this.player,'manifestLoaded').pipe(b()).subscribe((()=>{this.subscription.add(Lo(this.player,'playbackPlaying').pipe(b(),v(void 0)).subscribe(t.firstFrameEvent$,i))}),i)),this.subscription.add(ao(this.video,e.isLooped,i));const{volumeState$:g,looped$:T,playbackRateState$:E}=fo(this.video);this.subscription.add(no(this.video,e.volume,g,i)),this.subscription.add(g.subscribe(t.volume$,i)),this.subscription.add(T.subscribe(t.loopedEvent$)),this.subscription.add(oo(this.video,e.playbackRate,E,i))}stop(){this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.player.attachSource(null),this.player.attachView(null),this.player.initialize(),this.player.clearDefaultUTCTimingSources(),this.videoState.setState(Io.STOPPED),U(this.params.desiredState.playbackState,P.STOPPED,!0)}prepare(){this.videoState.startTransitionTo(Io.STREAM_INITIALIZED),this.player.initialize(),this.player.clearDefaultUTCTimingSources(),this.player.attachView(this.video),this.player.attachSource(this.params.source.url)}seek(t){if(this.params.output.willSeekEvent$.next(),this.isLive$.getValue()){const e=-t,i=e<this.maxSeekBackTime$.getValue()?e:0;this.liveOffset.resetTo(i),this.params.output.position$.next(-i/1e3);const s=M(this.params.source.url,this.liveOffset.getTotalOffset()/1e3,O.PLAYBACK_SHIFT);this.player.attachSource(s)}else this.player.seek(t/1e3)}play(){this.videoState.startTransitionTo(Io.PLAYING),this.player.play()}pause(){this.videoState.startTransitionTo(Io.PAUSED),this.video.pause()}destroy(){var t,e;this.subscription.unsubscribe(),this.textTracksManager.destroy();try{null===(t=this.player)||void 0===t||t.destroy()}catch(t){}this.video.remove(),this.params.output.element$.next(void 0),null===(e=this.destroyBigRequest)||void 0===e||e.call(this)}}var No=t=>{switch(t){case'mobile':return B.Q_144P;case'lowest':return B.Q_240P;case'low':return B.Q_360P;case'sd':case'medium':return B.Q_480P;case'hd':case'high':return B.Q_720P;case'fullhd':case'full':return B.Q_1080P;case'quadhd':case'quad':return B.Q_1440P;case'ultrahd':case'ultra':return B.Q_2160P}},Oo=async t=>{const e=t.muted;try{await t.play()}catch(i){if(i instanceof DOMException&&(20===i.code||'AbortError'===i.name))return!1;if(e)return console.warn(i),!1;t.muted=!0;try{await t.play()}catch(e){return t.muted=!1,console.warn(e),!1}}return!0};function Bo(){return S()}function Mo(t){return Bo()-t}function Uo(t){const e=t.split('/'),i=e.slice(0,e.length-1).join('/'),s=/^([a-z]+:)?\/\//i;return{resolve:(t,e,r=!1)=>{(t=>s.test(t))(t)||(t.startsWith('/')||(t='/'+t),t=i+t);let a=t.indexOf('?')>-1?'&':'?';return r&&(t+=a+'lowLat=1',a='&'),e&&(t+=a+'_rnd='+Math.floor(999999999*Math.random())),t}}}function Vo(t,e,i,r){const a=window.XMLHttpRequest;let n,o,d,u,h,l=!1,p=0,m=!1,f='arraybuffer',v=7e3,S=2e3,g=()=>{if(l)return;c(u);const t=Mo(u);let e;if(t<S)return e=S-t,void setTimeout(g,e);S*=2,S>v&&(S=v),o&&o.abort(),o=new a,y()};const b=()=>{if(!l){if(--p>=0)return g(),void(r&&r());l=!0,h&&h(),i&&i()}},y=()=>{u=Bo(),o=new a,o.open('get',t);let i,s=0,r=0;const p=()=>(c(u),Math.max(u,Math.max(i||0,r||0)));if(n&&o.addEventListener('progress',(t=>{const e=Bo();n.updateChunk&&t.loaded>s&&(n.updateChunk(p(),t.loaded-s),s=t.loaded,i=e)})),d&&(o.timeout=d,o.addEventListener('timeout',(()=>b()))),o.addEventListener('load',(()=>{if(l)return;c(o);const t=o.status;if(t>=200&&t<300){if(o.response.byteLength&&n){const t=o.response.byteLength-s;t&&n.updateChunk&&n.updateChunk(p(),t)}h&&h(),o&&e(o.response)}else b()})),o.addEventListener('error',(()=>{b()})),m){const t=()=>{c(o),o.readyState===XMLHttpRequest.HEADERS_RECEIVED&&(r=Bo(),o.removeEventListener('readystatechange',t))};o.addEventListener('readystatechange',t)}return o.responseType=f,o.send(),T},T={withBitrateReporting:t=>(n=t,T),withParallel:t=>(m=t,T),withJSONResponse:()=>(f='json',T),withRetryCount:t=>(p=t,T),withRetryInterval:(t,e)=>(s(t)&&(S=t),s(e)&&(v=e),T),withTimeout:t=>(d=t,T),withFinally:t=>(h=t,T),send:y,abort:()=>{o&&(o.abort(),o=void 0),l=!0,h&&h()}};return T}class qo{constructor(t){this.intervals=[],this.currentRate=0,this.logger=t}_updateRate(t){let e=.2;this.currentRate&&(t<.1*this.currentRate?e=.8:t<.5*this.currentRate?e=.5:t<.7*this.currentRate&&(e=.3)),t=Math.max(1,Math.min(t,104857600)),this.currentRate=this.currentRate?this.currentRate*(1-e)+t*e:t}_createInterval(t,e,i){return{start:t,end:e,bytes:i}}_doMergeIntervals(t,e){t.start=Math.min(e.start,t.start),t.end=Math.max(e.end,t.end),t.bytes+=e.bytes}_mergeIntervals(t,e){return t.start<=e.end&&e.start<=t.end&&(this._doMergeIntervals(t,e),!0)}_flushIntervals(){if(!this.intervals.length)return!1;const t=this.intervals[0].start,e=this.intervals[this.intervals.length-1].end-500;if(e-t>2e3){let i=0,s=0;for(;this.intervals.length>0;){const t=this.intervals[0];if(t.end<=e)i+=t.end-t.start,s+=t.bytes,this.intervals.splice(0,1);else{if(t.start>=e)break;{const r=e-t.start,a=t.end-t.start;i+=r;const n=t.bytes*r/a;s+=n,t.start=e,t.bytes-=n}}}if(s>0&&i>0){const r=8*s/(i/1e3);return this._updateRate(r),this.logger(`rate updated, new=${Math.round(r/1024)}K; average=${Math.round(this.currentRate/1024)}K bytes/ms=${Math.round(s)}/${Math.round(i)} interval=${Math.round(e-t)}`),!0}}return!1}_joinIntervals(){let t;do{t=!1;for(let e=0;e<this.intervals.length-1;++e)this._mergeIntervals(this.intervals[e],this.intervals[e+1])&&(this.intervals.splice(e+1,1),t=!0)}while(t)}addInterval(t,e,i){return this.intervals.push(this._createInterval(t,e,i)),this._joinIntervals(),this.intervals.length>100&&(this.logger(`too many intervals (${this.intervals.length}); will merge`,{type:'warn'}),this._doMergeIntervals(this.intervals[1],this.intervals[0]),this.intervals.splice(0,1)),this._flushIntervals()}getBitRate(){return this.currentRate}}class Fo{constructor(t,e,i,s,r){this.pendingQueue=[],this.activeRequests={},this.completeRequests={},this.averageSegmentDuration=2e3,this.lastPrefetchStart=0,this.throttleTimeout=null,this.RETRY_COUNT=t,this.TIMEOUT=e,this.BITRATE_ESTIMATOR=i,this.MAX_PARALLEL_REQUESTS=s,this.logger=r}limitCompleteCount(){let t;for(;(t=Object.keys(this.completeRequests)).length>this._getParallelRequestCount()+2;){const e=t[Math.floor(Math.random()*t.length)];this.logger(`Dropping completed request for url ${e}`,{type:'warn'}),delete this.completeRequests[e]}}_sendRequest(t,e){const i=Bo(),s=i=>{delete this.activeRequests[e],this.limitCompleteCount(),this.completeRequests[e]=t,this._sendPending(),t._error=1,t._errorMsg=i,t._errorCB?t._errorCB(i):(this.limitCompleteCount(),this.completeRequests[e]=t)};t._request=Vo(e,(s=>{t._complete=1,t._responseData=s,t._downloadTime=Bo()-i,delete this.activeRequests[e],this._sendPending(),t._cb?t._cb(s,t._downloadTime):(this.limitCompleteCount(),this.completeRequests[e]=t)}),(()=>s('error')),(()=>{t._retry=1,t._retryCB&&t._retryCB()})),t._request.withRetryCount(this.RETRY_COUNT).withTimeout(this.TIMEOUT).withBitrateReporting(this.BITRATE_ESTIMATOR).withParallel(this._getParallelRequestCount()>1).withFinally((()=>{t._finallyCB&&t._finallyCB()})),this.activeRequests[e]=t,t._request.send(),this.lastPrefetchStart=Bo()}_getParallelRequestCount(){return Math.min(this.MAX_PARALLEL_REQUESTS,this.averageSegmentDuration<3e3?3:2)}_getPrefetchDelay(){return Math.max(100,Math.min(5e3,this.averageSegmentDuration/3))}_canSendPending(){const t=this._getParallelRequestCount(),e=Bo();if(Object.keys(this.activeRequests).length>=t)return!1;const i=this._getPrefetchDelay()-(e-this.lastPrefetchStart);return this.throttleTimeout&&clearTimeout(this.throttleTimeout),!(i>0)||(this.throttleTimeout=window.setTimeout((()=>this._sendPending()),i),!1)}_sendPending(){for(;this._canSendPending();){const t=this.pendingQueue.pop();if(!t)return;this.activeRequests[t]||this.completeRequests[t]||(this.logger(`Submitting pending request url=${t}`),this._sendRequest({},t))}}_removeFromActive(t){delete this.completeRequests[t],delete this.activeRequests[t]}abortAll(){Object.values(this.activeRequests).forEach((t=>{t&&t._request&&t._request.abort()})),this.activeRequests={},this.pendingQueue=[],this.completeRequests={}}requestData(t,e,i,s){const r={};return r.send=()=>{const a=this.activeRequests[t]||this.completeRequests[t];if(a)a._cb=e,a._errorCB=i,a._retryCB=s,a._finallyCB=r._finallyCB,a._error||a._complete?(this._removeFromActive(t),setTimeout((()=>{a._complete?(this.logger(`Requested url already prefetched, url=${t}`),e(a._responseData,a._downloadTime)):(this.logger(`Requested url already prefetched with error, url=${t}`),i(a._errorMsg)),r._finallyCB&&r._finallyCB()}),0)):this.logger(`Attached to active request, url=${t}`);else{const e=this.pendingQueue.indexOf(t);-1!==e&&this.pendingQueue.splice(e,1),this.logger(`Request not prefetched, starting new request, url=${t}${-1===e?'':'; removed pending'}`),this._sendRequest(r,t)}},r._cb=e,r._errorCB=i,r._retryCB=s,r.abort=function(){r.request&&r.request.abort()},r.withFinally=t=>(r._finallyCB=t,r),r}prefetch(t){this.activeRequests[t]||this.completeRequests[t]?this.logger(`Request already active for url=${t}`):(this.logger(`Added to pending queue; url=${t}`),this.pendingQueue.unshift(t),this._sendPending())}optimizeForSegDuration(t){this.averageSegmentDuration=t}}class Ho{constructor(t){this.paused=!1,this.autoQuality=!0,this.maxAutoQuality=void 0,this.buffering=!0,this.destroyed=!1,this.videoPlayStarted=!1,this.lowLatency=!1,this.bitrate=0,this.manifest=[],this.sourceBuffer=0,this.bufferStates=[],this.sourceJitter=-1,this.params=t,this.chunkRateEstimator=new qo(this.params.logger),this._initVideo()}attachSource(t){this.manifestUrl=t,this.urlResolver=Uo(t),this.bitrateSwitcher=this._initBitrateSwitcher(),this._initManifest()}setAutoQualityEnabled(t){this.autoQuality=t}setMaxAutoQuality(t){this.maxAutoQuality=t}switchByName(t){let e;for(let i=0;i<this.manifest.length;++i)if(e=this.manifest[i],e.name===t)return void this._switchToQuality(e)}catchUp(){this.rep&&this.rep.stop(),this.currentManifestEntry&&(this.paused=!1,this._initPlayerWith(this.currentManifestEntry),this._notifyBuffering(!0))}stop(){this.params.videoElement.pause(),this.rep&&(this.rep.stop(),this.rep=null)}pause(){this.paused=!0,this.params.videoElement.pause(),this.videoPlayStarted=!1,this._notifyBuffering(!1)}play(t){this.paused=!1;const e=this.lowLatency&&this._getBufferSizeSec()>this.sourceJitter+5;this.rep&&!e?(this.bufferStates=[],this.videoPlayStarted=!1,this.shouldPlay()?this._playVideoElement(t):this._notifyBuffering(!0)):this.catchUp()}startPlay(t,e){this.autoQuality=e,this._initPlayerWith(t)}destroy(){this.destroyed=!0,this.rep&&(this.rep.stop(),this.rep=null),this.manifestRequest&&this.manifestRequest.abort(),this.manifestRefetchTimer&&(clearTimeout(this.manifestRefetchTimer),this.manifestRefetchTimer=void 0)}reinit(t){this.manifestUrl=t,this.urlResolver=Uo(t),this.catchUp()}_handleNetworkError(){this.params.logger('Fatal network error'),this.params.playerCallback({name:'error',type:'network'})}_retryCallback(){this.params.playerCallback({name:'retry'})}_getBufferSizeSec(){const t=this.params.videoElement;let e=0;const i=t.buffered.length;return 0!==i&&(e=t.buffered.end(i-1)-Math.max(t.currentTime,t.buffered.start(0))),e}_notifyBuffering(t){this.destroyed||(this.params.logger(`buffering: ${t}`),this.params.playerCallback({name:'buffering',isBuffering:t}),this.buffering=t)}_initVideo(){const{videoElement:t,logger:e}=this.params;t.addEventListener('error',(i=>{var s;this.destroyed||(e(`Video element error: ${null===(s=t.error)||void 0===s?void 0:s.code}`),this.params.playerCallback({name:'error',type:'media'}))})),t.addEventListener('timeupdate',(()=>{const e=this._getBufferSizeSec();!this.paused&&e<.3?this.buffering||(this.buffering=!0,window.setTimeout((()=>{!this.paused&&this.buffering&&this._notifyBuffering(!0),t.pause(),this.videoPlayStarted=!1}),1e3*(e+.1))):this.buffering&&this.videoPlayStarted&&this._notifyBuffering(!1)})),t.addEventListener('playing',(()=>{e('playing')})),t.addEventListener('stalled',(()=>this._fixupStall())),t.addEventListener('waiting',(()=>this._fixupStall()))}_fixupStall(){const{logger:t,videoElement:e}=this.params,i=e.buffered.length;let s;0!==i&&(s=e.buffered.start(i-1),e.currentTime<s&&(t('Fixup stall'),e.currentTime=s))}_selectQuality(t){const{videoElement:e}=this.params;let i,s,r;const a=e&&1.62*(window.devicePixelRatio||1)*e.offsetHeight||520;for(let e=0;e<this.manifest.length;++e)r=this.manifest[e],this.maxAutoQuality&&r.video.height>this.maxAutoQuality||(r.bitrate<t&&a>Math.min(r.video.height,r.video.width)?(!s||r.bitrate>s.bitrate)&&(s=r):(!i||i.bitrate>r.bitrate)&&(i=r));return s||i}shouldPlay(){if(this.paused)return!1;const t=this._getBufferSizeSec()-Math.max(1,this.sourceJitter);return t>3||s(this.downloadRate)&&(this.downloadRate>1.5&&t>2||this.downloadRate>2&&t>1)}_setVideoSrc(t,e){const{logger:i,videoElement:s,playerCallback:r}=this.params;this.mediaSource=new window.MediaSource,i('setting video src'),s.src=URL.createObjectURL(this.mediaSource),this.mediaSource.addEventListener('sourceopen',(()=>{this.mediaSource&&(this.sourceBuffer=this.mediaSource.addSourceBuffer(t.codecs),this.bufferStates=[],e())})),this.videoPlayStarted=!1,s.addEventListener('canplay',(()=>{this.shouldPlay()&&(this.videoPlayStarted=!0,this._playVideoElement())}));const a=()=>{!function(t,e,i){const s=(...r)=>{i.apply(null,r),t.removeEventListener(e,s)};t.addEventListener(e,s)}(s,'progress',(()=>{s.buffered.length?(s.currentTime=s.buffered.start(0),r({name:'playing'})):a()}))};a()}_initPlayerWith(t){this.bitrate=0,this.rep=0,this.sourceBuffer=0,this.bufferStates=[],this.filesFetcher&&this.filesFetcher.abortAll(),this.filesFetcher=new Fo(3,1e4,this.bitrateSwitcher,this.params.config.maxParallelRequests,this.params.logger),this._setVideoSrc(t,(()=>this._switchToQuality(t)))}_representation(t){const{logger:e,videoElement:i,playerCallback:a}=this.params;let n=!1,o=null,d=null,u=null,h=null,l=!1;const p=()=>{const t=n&&(!l||l===this.rep);return t||e('Not running!'),t},m=(t,e,i)=>{u&&u.abort(),u=Vo(this.urlResolver.resolve(t,!1),e,i,(()=>this._retryCallback())).withTimeout(1e4).withBitrateReporting(this.bitrateSwitcher).withRetryCount(3).withFinally((()=>{u=null})).send()},f=(t,e,i)=>{c(this.filesFetcher),null==d||d.abort(),d=this.filesFetcher.requestData(this.urlResolver.resolve(t,!1),e,i,(()=>this._retryCallback())).withFinally((()=>{d=null})).send()},v=t=>{const s=i.playbackRate;i.playbackRate!==t&&(e(`Playback rate switch: ${s}=>${t}`),i.playbackRate=t)},S=t=>{this.lowLatency=t,e(`lowLatency changed to ${t}`),g()},g=()=>{if(this.lowLatency){let t=this._getBufferSizeSec();if(this.bufferStates.length<5)return void v(1);const i=Bo()-6e4;let s=0;for(let e=0;e<this.bufferStates.length;e++){const r=this.bufferStates[e];t=Math.min(t,r.buf),r.ts<i&&s++}this.bufferStates.splice(0,s),e(`update playback rate;  minBuffer=${t} drop=${s} jitter=${this.sourceJitter}`);let r=t-1;this.sourceJitter>=0?r-=this.sourceJitter/2:this.sourceJitter-=1,v(r>3?1.15:r>1?1.1:r>.3?1.01:1)}else v(1)},b=t=>{let i;const r=()=>i&&i.start?i.start.length:0,n=t=>i.start[t]/1e3,o=t=>i.dur[t]/1e3,d=t=>i.fragIndex+t,u=(t,e)=>({chunkIdx:d(t),startTS:n(t),dur:o(t),discontinuity:e}),l=()=>{let t=0;if(i&&i.dur){let e=this.lowLatency?this.params.config.lowLatencyMinBuffer:this.params.config.minBuffer,s=this.lowLatency?this.params.config.lowLatencyMinBufferSegments:this.params.config.minBufferSegments,r=e;this.sourceJitter>1&&(r+=this.sourceJitter-1);let a=i.dur.length-1;for(;a>=0&&(r-=i.dur[a],!(r<=0));--a);t=Math.min(a,i.dur.length-1-s),t=Math.max(t,0)}return u(t,!0)},m=(t,e,i)=>{h&&h.abort(),h=Vo(this.urlResolver.resolve(t,!0,this.lowLatency),e,i,(()=>this._retryCallback())).withTimeout(1e4).withRetryCount(3).withFinally((()=>{h=null})).withJSONResponse().send()};return{seek:(e,o)=>{m(t,(t=>{if(!p())return;i=t;const d=Boolean(i.lowLatency);d!==this.lowLatency&&S(d);let h=0;for(let t=0;t<i.dur.length;++t)h+=i.dur[t];h>0&&(c(this.filesFetcher),this.filesFetcher.optimizeForSegDuration(h/i.dur.length)),a({name:'index',zeroTime:i.zeroTime,shiftDuration:i.shiftDuration}),this.sourceJitter=i.hasOwnProperty('jitter')?Math.min(10,Math.max(.01,i.jitter/1e3)):1,e((t=>{const e=r();if(!(e<=0)){if(s(t))for(let i=0;i<e;i++)if(n(i)>t)return u(i);return l()}})(o))}),(()=>this._handleNetworkError()))},nextChunk:t=>{const s=r(),a=t?t.chunkIdx+1:0,n=a-i.fragIndex;if(!(s<=0)){if(!t||n<0||n-s>10)return e(`Resync: offset=${n} bChunks=${s} chunk=`+JSON.stringify(t)),l();if(!(n>=s))return u(a-i.fragIndex,!1)}}}},y=()=>{n=!1,d&&d.abort(),u&&u.abort(),h&&h.abort(),c(this.filesFetcher),this.filesFetcher.abortAll()};return l={start:e=>{const{videoElement:i,logger:s}=this.params;let a,d,u,l,v,S,T,E=b(t.jidxUrl),w=0;const $=()=>{v&&(clearTimeout(v),v=void 0);const t=Math.max(500,1e3*(this._getBufferSizeSec()-this.sourceJitter-5)),e=w+t,i=Bo(),s=Math.min(1e4,e-i);w=i;const r=()=>{h||p()&&E.seek((()=>{p()&&(w=Bo(),k(),$())}))};s>0?v=window.setTimeout((()=>{this.paused?$():r()}),s):r()},k=()=>{let e;for(;e=E.nextChunk(l);)l=e,_(e);const i=E.nextChunk(u);if(i){if(u&&i.discontinuity)return s('Detected discontinuity; restarting playback'),void(this.paused?$():(y(),this._initPlayerWith(t)));D(i)}else $()},A=(t,e)=>{if(!p()||!this.sourceBuffer)return;let r,a,n;const o=i=>{window.setTimeout((()=>{p()&&A(t,e)}),i)};if(this.sourceBuffer.updating)s('Source buffer is updating; delaying appendBuffer'),o(100);else{const d=Bo(),u=i.currentTime;!this.paused&&i.buffered.length>1&&S===u&&d-T>500&&(s('Stall suspected; trying to fix'),this._fixupStall()),S!==u&&(S=u,T=d);const h=this._getBufferSizeSec();if(h>30)s(`Buffered ${h} seconds; delaying appendBuffer`),o(2e3);else try{this.sourceBuffer.appendBuffer(t),this.videoPlayStarted?(this.bufferStates.push({ts:d,buf:h}),g(),this.bufferStates.length>200&&this.bufferStates.shift()):this.shouldPlay()&&(this.videoPlayStarted=!0,this._playVideoElement()),e&&e()}catch(t){if('QuotaExceededError'!==t.name)throw t;s('QuotaExceededError; delaying appendBuffer'),n=this.sourceBuffer.buffered.length,0!==n&&(r=this.sourceBuffer.buffered.start(0),a=u,a-r>4&&this.sourceBuffer.remove(r,a-3)),o(1e3)}}},P=()=>{d&&a&&(s([`Appending chunk, sz=${d.byteLength}:`,JSON.stringify(u)]),A(d,(function(){d=null,k()})))},R=e=>t.fragUrlTemplate.replace('%%id%%',e.chunkIdx),D=t=>{p()&&f(R(t),((e,i)=>{if(p()){if(i/=1e3,d=e,u=t,o=t.startTS,i){const e=Math.min(10,t.dur/i);this.downloadRate=this.downloadRate?.7*this.downloadRate+.3*e:e}P()}}),(()=>this._handleNetworkError()))},_=t=>{p()&&(c(this.filesFetcher),this.filesFetcher.prefetch(this.urlResolver.resolve(R(t),!1)))},C=e=>{p()&&(t.cachedHeader=e,A(e,(()=>{a=!0,P()})))};n=!0,E.seek((t=>{p()&&(w=Bo(),t?(l=t,!r(e)||t.startTS>e?D(t):(u=t,k())):$())}),e),t.cachedHeader?C(t.cachedHeader):m(t.headerUrl,C,(()=>this._handleNetworkError()))},stop:y,getTimestampSec:()=>o},l}_switchToQuality(t){const{logger:e,playerCallback:i}=this.params;let r;t.bitrate!==this.bitrate&&(this.rep&&(r=this.rep.getTimestampSec(),s(r)&&(r+=.1),this.rep.stop()),this.currentManifestEntry=t,this.rep=this._representation(t),e(`switch to quality: codecs=${t.codecs}; headerUrl=${t.headerUrl}; bitrate=${t.bitrate}`),this.bitrate=t.bitrate,c(this.bitrateSwitcher),this.bitrateSwitcher.notifySwitch(this.bitrate),this.rep.start(r),i({name:'qualitySwitch',quality:t}))}_qualityAvailable(t){return s(this.manifest.find((e=>e.name===t)))}_initBitrateSwitcher(){const{logger:t,playerCallback:e}=this.params,i=e=>{if(!this.autoQuality)return;let i,s,r;this.currentManifestEntry&&this._qualityAvailable(this.currentManifestEntry.name)&&e<this.bitrate&&(s=this._getBufferSizeSec(),r=e/this.bitrate,s>10&&r>.8||s>15&&r>.5||s>20&&r>.3)?t(`Not switching: buffer=${Math.floor(s)}; bitrate=${this.bitrate}; newRate=${Math.floor(e)}`):(i=this._selectQuality(e),i?this._switchToQuality(i):t(`Could not find quality by bitrate ${e}`))},s=(()=>({updateChunk:(t,i)=>{const s=Bo();if(this.chunkRateEstimator.addInterval(t,s,i)){const r=this.chunkRateEstimator.getBitRate();return e({name:'bandwidth',size:i,duration:s-t,speed:r}),!0}},get:()=>{const t=this.chunkRateEstimator.getBitRate();return t?.85*t:0}}))();let r,a=-1/0,n=!0;const o=()=>{let t=s.get();if(t&&r&&this.autoQuality){if(n&&t>r&&Mo(a)<3e4)return;i(t)}n=this.autoQuality};return{updateChunk:(t,e)=>{const i=s.updateChunk(t,e);return i&&o(),i},notifySwitch:t=>{const e=Bo();t<r&&(a=e),r=t}}}_fetchManifest(t,e,i){this.manifestRequest=Vo(this.urlResolver.resolve(t,!0),e,i,(()=>this._retryCallback())).withJSONResponse().withTimeout(1e4).withRetryCount(3).withRetryInterval(300,2e3).send().withFinally((()=>{this.manifestRequest=void 0}))}_playVideoElement(t){const{videoElement:e}=this.params;Oo(e).then((e=>{e||null==t||t()}))}_handleManifestUpdate(t){const{logger:e,playerCallback:i,videoElement:s}=this.params;this.manifest=(t=>{const e=[];return(null==t?void 0:t.length)?(t.forEach(((t,i)=>{t.video&&s.canPlayType(t.codecs).replace(/no/,'')&&window.MediaSource.isTypeSupported(t.codecs)&&(t.index=i,e.push(t))})),e.sort((function(t,e){return t.video&&e.video?e.video.height-t.video.height:e.bitrate-t.bitrate})),e):(this.params.playerCallback({name:'error',type:'partial_metadata'}),[])})(t),e(`Valid manifest entries: ${this.manifest.length}/${t.length}`),i({name:'manifest',manifest:this.manifest})}_refetchManifest(t){this.destroyed||(this.manifestRefetchTimer&&clearTimeout(this.manifestRefetchTimer),this.manifestRefetchTimer=window.setTimeout((()=>{this._fetchManifest(t,(e=>{this.destroyed||(this._handleManifestUpdate(e),this._refetchManifest(t))}),(()=>this._refetchManifest(t)))}),6e4))}_initManifest(){this._fetchManifest(this.manifestUrl,(t=>{this.destroyed||(this._handleManifestUpdate(t),this._refetchManifest(this.manifestUrl))}),(()=>this._handleNetworkError()))}}var Go;!function(t){t.STOPPED='stopped',t.MANIFEST_READY='manifest_ready',t.READY='ready',t.PLAYING='playing',t.PAUSED='paused'}(Go||(Go={}));const Yo=[Go.PAUSED,Go.PLAYING,Go.READY],zo=[Go.PAUSED,Go.PLAYING,Go.READY];class Qo{constructor(e){this.subscription=new i,this.videoState=new z(Go.STOPPED),this.representations$=new t([]),this.textTracksManager=new ho,this.maxSeekBackTime$=new t(1/0),this.zeroTime$=new t(void 0),this.liveOffset=new co,this._dashCb=t=>{var e,i,r,a;switch(t.name){case'buffering':{const e=t.isBuffering;this.params.output.isBuffering$.next(e);break}case'error':this.params.output.error$.next({id:`DashLiveProviderInternal:${t.type}`,message:'LiveDashPlayer reported error'});break;case'manifest':{const s=t.manifest,a=[];for(const t of s){const s=null!==(e=t.name)&&void 0!==e?e:t.index.toString(10),r=null!==(i=No(t.name))&&void 0!==i?i:G(t.video),n=t.bitrate/1e3,o={...t.video};if(!r)continue;const d={id:s,quality:r,bitrate:n,size:o};a.push({track:d,representation:t})}this.representations$.next(a),this.params.output.availableVideoTracks$.next(a.map((({track:t})=>t))),(null===(r=this.videoState.getTransition())||void 0===r?void 0:r.to)===Go.MANIFEST_READY&&this.videoState.setState(Go.MANIFEST_READY);break}case'qualitySwitch':{const e=t.quality,i=null===(a=this.representations$.getValue().find((({representation:t})=>t===e)))||void 0===a?void 0:a.track;this.params.output.hostname$.next(new URL(e.headerUrl,this.params.source.url).hostname),s(i)&&this.params.output.currentVideoTrack$.next(i);break}case'bandwidth':{const{size:e,duration:i}=t;this.params.dependencies.throughputEstimator.addRawSpeed(e,i);break}case'index':this.maxSeekBackTime$.next(t.shiftDuration),this.zeroTime$.next(t.zeroTime)}},this.syncPlayback=()=>{var t;const e=this.videoState.getState(),i=this.videoState.getTransition(),r=this.params.desiredState.playbackState.getState(),a=this.params.desiredState.playbackState.getTransition(),o=this.params.desiredState.seekState.getState();if(this.log({message:`[syncPlayback] videoState: ${e}; videoTransition: ${JSON.stringify(i)}; desiredPlaybackState: ${r}; seekState: ${JSON.stringify(o)};`}),r!==P.STOPPED){if(!i){if(zo.includes(e)){const e=null===(t=this.params.desiredState.videoTrack.getTransition())||void 0===t?void 0:t.to;s(e)&&this.setVideoTrack(e);const i=this.params.desiredState.autoVideoTrackSwitching.getTransition();i&&this.setAutoQuality(i.to)}if((null==a?void 0:a.to)!==P.PAUSED&&o.state===L.Requested&&Yo.includes(e))this.seek(o.position-this.liveOffset.getTotalPausedTime());else switch(e){case Go.STOPPED:return this.videoState.startTransitionTo(Go.MANIFEST_READY),void this.dash.attachSource(M(this.params.source.url));case Go.MANIFEST_READY:this.videoState.startTransitionTo(Go.READY),this.prepare();break;case Go.READY:return void(r===P.PAUSED?this.videoState.setState(Go.PAUSED):r===P.PLAYING&&(this.videoState.startTransitionTo(Go.PLAYING),this.dash.play((()=>{this.liveOffset.pause(),this.videoState.setState(Go.PAUSED)}))));case Go.PLAYING:return void(r===P.PAUSED&&(this.videoState.startTransitionTo(Go.PAUSED),this.liveOffset.pause(),this.dash.pause()));case Go.PAUSED:return void(r===P.PLAYING&&(this.videoState.startTransitionTo(Go.PLAYING),this.liveOffset.getTotalPausedTime()<this.params.config.maxPausedTime&&this.liveOffset.getTotalOffset()<this.maxSeekBackTime$.getValue()?(this.liveOffset.resume(),this.dash.play((()=>{this.liveOffset.pause(),this.videoState.setState(Go.PAUSED)})),this.params.output.position$.next(-this.liveOffset.getTotalOffset()/1e3)):this.seek(-this.liveOffset.getTotalOffset())));default:return n(e)}}}else e!==Go.STOPPED&&(this.videoState.startTransitionTo(Go.STOPPED),this.dash.destroy(),this.video.setAttribute('src',''),this.video.load(),this.videoState.setState(Go.STOPPED))},this.params=e,this.log=this.params.dependencies.logger.createComponentLog('DashLiveProvider');const r=t=>{e.output.error$.next({id:'DashLiveProvider',message:'DashLiveProvider internal logic error',thrown:t})};o(this.videoState.stateChangeStarted$.pipe(u((t=>({transition:t,type:'start'})))),this.videoState.stateChangeEnded$.pipe(u((t=>({transition:t,type:'end'}))))).subscribe((({transition:t,type:e})=>{this.log({message:`[videoState change] ${e}: ${JSON.stringify(t)}`})})),this.video=lo(e.container),this.params.output.element$.next(this.video),this.dash=this.createLiveDashPlayer(),this.params.output.duration$.next(1/0),this.params.output.position$.next(0),this.params.output.isLive$.next(!0),this.params.output.hostname$.next(Do(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.textTracksManager.connect(this.video,this.params.desiredState,this.params.output);const a=fo(this.video);this.subscription.add(a.canplay$.subscribe((()=>{var t;(null===(t=this.videoState.getTransition())||void 0===t?void 0:t.to)===Go.READY&&this.videoState.setState(Go.READY)}),r)).add(a.pause$.subscribe((()=>{this.videoState.setState(Go.PAUSED)}),r)).add(a.playing$.subscribe((()=>{this.params.desiredState.seekState.getState().state===L.Applying&&this.params.output.seekedEvent$.next(),this.videoState.setState(Go.PLAYING)}),r)).add(a.error$.subscribe(this.params.output.error$)).add(this.maxSeekBackTime$.pipe(l(),u((t=>-t/1e3))).subscribe(this.params.output.duration$)).add(y({zeroTime:this.zeroTime$.pipe(f(s)),position:a.timeUpdate$}).subscribe((({zeroTime:t,position:e})=>this.params.output.liveTime$.next(t+1e3*e)),r)).add(ao(this.video,this.params.desiredState.isLooped,r)).add(no(this.video,this.params.desiredState.volume,a.volumeState$,r)).add(a.volumeState$.subscribe(this.params.output.volume$,r)).add(oo(this.video,this.params.desiredState.playbackRate,a.playbackRateState$,r)).add(a.loadStart$.subscribe(this.params.output.firstBytesEvent$)).add(a.playing$.subscribe(this.params.output.firstFrameEvent$)).add(a.canplay$.subscribe(this.params.output.canplay$)).add(this.params.desiredState.autoVideoTrackLimits.stateChangeEnded$.subscribe((({to:{max:t}})=>{const e=t&&V[t].height;this.dash.setMaxAutoQuality(e)}))).add(this.videoState.stateChangeEnded$.subscribe((t=>{switch(t.to){case Go.STOPPED:this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.desiredState.playbackState.setState(P.STOPPED);break;case Go.MANIFEST_READY:case Go.READY:break;case Go.PAUSED:this.params.desiredState.playbackState.setState(P.PAUSED);break;case Go.PLAYING:this.params.desiredState.playbackState.setState(P.PLAYING);break;default:return n(t.to)}}),r)).add(o(e.desiredState.playbackState.stateChangeStarted$,e.desiredState.seekState.stateChangeEnded$,e.desiredState.videoTrack.stateChangeStarted$,e.desiredState.autoVideoTrackSwitching.stateChangeStarted$,this.videoState.stateChangeEnded$,h(['init'])).pipe(p(0)).subscribe(this.syncPlayback,r))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.video.remove(),this.params.output.element$.next(void 0),this.dash.destroy()}createLiveDashPlayer(){const t=new Ho({videoElement:this.video,config:{maxParallelRequests:this.params.config.maxParallelRequests,minBuffer:this.params.tuning.live.minBuffer,minBufferSegments:this.params.tuning.live.minBufferSegments,lowLatencyMinBuffer:this.params.tuning.live.lowLatencyMinBuffer,lowLatencyMinBufferSegments:this.params.tuning.live.lowLatencyMinBufferSegments},playerCallback:this._dashCb,logger:t=>{this.params.dependencies.logger.log({message:String(t),component:'LiveDashPlayer'})}});return t.pause(),t}prepare(){var t,e,i,r,a,n;const o=this.representations$.getValue(),d=null!==(e=null===(t=this.params.desiredState.videoTrack.getTransition())||void 0===t?void 0:t.to)&&void 0!==e?e:this.params.desiredState.videoTrack.getState(),u=null!==(r=null===(i=this.params.desiredState.autoVideoTrackSwitching.getTransition())||void 0===i?void 0:i.to)&&void 0!==r?r:this.params.desiredState.autoVideoTrackSwitching.getState(),h=!u&&s(d)?d:null===(a=Ro(o.map((({track:t})=>t)),{container:{width:this.video.offsetWidth,height:this.video.offsetHeight},throughput:this.params.dependencies.throughputEstimator.throughput$.getValue(),tuning:this.params.tuning.autoTrackSelection,limits:this.params.desiredState.autoVideoTrackLimits.getState()}))||void 0===a?void 0:a.id,l=null===(n=o.find((({track:t})=>t.id===h)))||void 0===n?void 0:n.representation;c(l,'Representations missing'),this.dash.startPlay(l,u),this.params.desiredState.videoTrack.getTransition()&&this.params.desiredState.videoTrack.setState(h),this.params.desiredState.autoVideoTrackSwitching.getTransition()&&this.params.desiredState.autoVideoTrackSwitching.setState(u)}setVideoTrack(t){var e;const i=null===(e=this.representations$.getValue().find((({track:e})=>e.id===t)))||void 0===e?void 0:e.representation;c(i,`No such representation ${t}`),this.dash.switchByName(i.name),this.params.desiredState.videoTrack.setState(t)}setAutoQuality(t){this.dash.setAutoQualityEnabled(t),this.params.desiredState.autoVideoTrackSwitching.setState(t)}seek(t){this.log({message:`[seek] position: ${t}`}),this.params.output.willSeekEvent$.next();const e=-t,i=e<this.maxSeekBackTime$.getValue()?e:0;this.liveOffset.resetTo(i),this.dash.reinit(M(this.params.source.url,i))}}var jo=t=>{var e,i;const s=t.get('X-Delivery-Type'),r=t.get('X-Reused');return{type:null===s?I.HTTP1:null!==(e=s)&&void 0!==e?e:void 0,reused:null===r?void 0:null!==(i={1:!0,0:!1}[r])&&void 0!==i?i:void 0}},Wo=(t,e)=>{let i=0;for(let s=0;s<t.length;s++){const r=1e3*t.start(s),a=1e3*t.end(s);r<=e&&e<=a&&(i=a)}return Math.max(i-e,0)};class Jo{constructor(t,e=[],i,s,r,a){this._failoverIndex=0,this._failoverCount=0,this._xhr=null,this._retryTimeout=0,this._url=t,this._failoverHosts=e,this._completeCb=i,this._progressCb=s,this._headersCb=r,this._errorCb=a,this._request()}_request(){this._xhr=new XMLHttpRequest,this._xhr.open('GET',this._url,!0),this._xhr.overrideMimeType('text/plain; charset=x-user-defined');let t=!1;this._xhr.onreadystatechange=()=>{var e,i,s,r,a,n,o,d;if(c(this._xhr),(null===(e=this._xhr)||void 0===e?void 0:e.status)>=400)return null===(i=this._errorCb)||void 0===i||i.call(this,`Http${null===(s=this._xhr)||void 0===s?void 0:s.status}`,`XHR response code ${null===(r=this._xhr)||void 0===r?void 0:r.status}`),void this.abort();if(4!==this._xhr.readyState||0!==this._xhr.status)try{if(this._xhr.readyState>=2&&!t){t=!0;const e=to(this._xhr.getAllResponseHeaders().trim().split(/[\n\r]+/).map((t=>t.split(':').map((t=>t.trim())))));null===(a=this._headersCb)||void 0===a||a.call(this,new Headers(e))}else 4===this._xhr.readyState?null===(n=this._completeCb)||void 0===n||n.call(this,this._xhr.response):3===this._xhr.readyState&&(null===(o=this._progressCb)||void 0===o||o.call(this,this._xhr.response))}catch(t){throw null===(d=this._errorCb)||void 0===d||d.call(this,'XHR2CallbackError',`xhr2 callback threw ${String(t)}`,t),t}},this._xhr.onerror=()=>{var t;null===(t=this._xhr)||void 0===t||t.abort(),this._retryTimeout=window.setTimeout((()=>{var t;if(this._xhr)if(++this._failoverCount>=30)this._xhr=null,null===(t=this._errorCb)||void 0===t||t.call(this,'XHR2Failover','XHR failed, retrying failover host');else{let t;this._failoverIndex>=this._failoverHosts.length?(t=this._url,this._failoverIndex=0):(t=this._url.replace((t=>{const e=document.createElement('a');return e.href=t,e.host})(this._url),this._failoverHosts[this._failoverIndex]),this._failoverIndex++),this._xhr.open('GET',t,!0),this._xhr.send(null)}}),500)},this._xhr.send(null)}abort(){window.clearTimeout(this._retryTimeout),this._completeCb=this._progressCb=this._errorCb=void 0,this._xhr&&(this._xhr.abort(),this._xhr=null)}}class Xo{constructor(t){this._maxBufferDuration=Number.POSITIVE_INFINITY,this._isFull=!1,this._params=t,this._mediaSource=t.mediaSource,this._sourceBuffer=t.sourceBuffer,this._onDashCallback=t.onDashCallback}_appendBuffer(t,e){try{this._isFull=!1;(this._sourceBuffer.appendBuffer||this._sourceBuffer.append).bind(this._sourceBuffer)(t),null==e||e()}catch(t){if('QuotaExceededError'!==t.name)throw this._params.onError('AppendBuffer','Unknown Buffer error',t),t;{this._isFull=!0;const t=this._sourceBuffer.buffered;let e=0;for(let i=0,s=t.length;i<s;i++)e+=t.end(i)-t.start(i);e&&(this._maxBufferDuration=Math.round(e))}}}getMaxBufferDuration(){return this._maxBufferDuration}isFull(){return this._isFull}load(t,e,i,s,r,a,n){this.abort((()=>{let o=0;const d=Date.now();let u=0,h=0,l=0;const c=t=>{s(Xo._str2ua(t.substr(o))),o=t.length};let p=t.baseURL+'&bytes='+e+'-'+i;this._params.requestQuic&&(p=io(p)),this._lastXhr=new Jo(p,t.failoverHosts,(t=>{this._lastXhr=void 0,c(t);const e=Date.now()-d;this._params.onBandwidthChange({size:t.length,duration:e,speed:8*t.length/(e/1e3)}),this._onDashCallback('loading',{size:t.length,done:!0}),null==r||r()}),(t=>{if(t.length-o>n&&c(t),0===h)return void(h=Date.now());l=t.length-u;const e=Date.now()-h;l>=102400&&e>=1e3&&(this._params.onBandwidthChange({size:l,duration:e,speed:8*l/(e/1e3)}),l=0,u=t.length,h=Date.now()),this._onDashCallback('loading',{size:t.length,done:!1})}),a,((t,e,i)=>this._params.onError(t,e,i)))}))}abort(t){var e;null===(e=this._lastXhr)||void 0===e||e.abort(),this._lastXhr=void 0,this._sbUpdatingStop(this._lastStreamUpdatingCallback),this._lastStreamUpdatingCallback=this._sbUpdatingWatch((()=>{this._appendPromiseUint8Array&&(this._appendBuffer(this._appendPromiseUint8Array),this._appendPromiseUint8Array=void 0),this._lastStreamUpdatingCallback=this._sbUpdatingWatch((()=>{'open'===this._mediaSource.readyState&&this._sourceBuffer.abort(),null==t||t()}))}))}_sbUpdatingWatch(t){if(this._sourceBuffer.updating){const e=()=>{try{this._sbUpdatingStop(e),this._sbUpdatingWatch(t)}catch(t){throw this._params.onError('SourceBuffer','Source Buffer update error',t),t}};return this._sourceBuffer.addEventListener('updateend',e,!1),e}t()}_sbUpdatingStop(t){t&&this._sourceBuffer.removeEventListener('updateend',t,!1)}append(t,e){this._appendPromiseUint8Array?this._appendPromiseUint8Array=Xo._concatUint8(this._appendPromiseUint8Array,t):(this._appendPromiseUint8Array=t,this._lastStreamUpdatingCallback=this._sbUpdatingWatch((()=>{this._appendPromiseUint8Array&&this._appendBuffer(this._appendPromiseUint8Array,(()=>{this._appendPromiseUint8Array=void 0,e&&this._sbUpdatingWatch(e)}))})))}endOfStream(){'open'===this._mediaSource.readyState&&this._sbUpdatingWatch((()=>this._mediaSource.endOfStream()))}static _concatUint8(t,e){const i=new Uint8Array(t.byteLength+e.byteLength);return i.set(t,0),i.set(e,t.byteLength),i}static _str2ua(t){const e=new Uint8Array(t.length);for(let i=0;i<t.length;i++)e[i]=t.charCodeAt(i);return e}remove(t,e){this._sbUpdatingWatch((()=>{!this._sourceBuffer.updating&&this._sourceBuffer.remove&&this._sourceBuffer.remove(t,e),this._maxBufferDuration=Number.POSITIVE_INFINITY}))}destroy(){var t;null===(t=this._lastXhr)||void 0===t||t.abort(),this._sbUpdatingStop(this._lastStreamUpdatingCallback),'open'===this._mediaSource.readyState&&this._sourceBuffer.abort()}}class Ko{constructor(t){var e;this._representations=[],this._appendVector={},this._cachingPaused=!1,this._duration=0,this.STREAM_END_THRESHOLD=1,this._params=t,this._video=t.video,this._buffer=t.buffer,this._onDashCallback=null!==(e=t.onDashCallback)&&void 0!==e?e:()=>{},this._config=t.config}_parseDurationFromISO8601(t){const e=(t,e)=>{const i=t?parseFloat(t.replace(',','.')):NaN;return(isNaN(i)?0:i)*e},i=/^(-)?P(?:(-?[0-9,.]*)Y)?(?:(-?[0-9,.]*)M)?(?:(-?[0-9,.]*)W)?(?:(-?[0-9,.]*)D)?(?:T(?:(-?[0-9,.]*)H)?(?:(-?[0-9,.]*)M)?(?:(-?[0-9,.]*)S)?)?$/.exec(t),s='-'===(null==i?void 0:i[1])?-1:1;e(null==i?void 0:i[2],s),e(null==i?void 0:i[3],s),e(null==i?void 0:i[4],s),e(null==i?void 0:i[5],s);return 3600*e(null==i?void 0:i[6],s)+60*e(null==i?void 0:i[7],s)+e(null==i?void 0:i[8],s)}getRepresentations(){return this._representations}attachSource(t,e){let i=t;this._config.REQUEST_QUIC&&(i=io(i)),new Jo(i,e,(t=>{this.attachManifest(t,e,(t=>{const e=document.createElement('a');return e.href=t,e.origin})(i))}),void 0,(t=>{this._params.onResponseHeaders(t)}),((t,e,i)=>this._params.onError(t,e,i)))}attachManifest(t,e,i){const s=(new DOMParser).parseFromString(t,'text/xml').documentElement,r=(t,e)=>{const i=t.attributes.getNamedItem(e);return i?i.value:null};this._duration=this._parseDurationFromISO8601(String(r(s,'mediaPresentationDuration')));const a=[],n=[];Array.prototype.forEach.call(s.getElementsByTagName('Representation'),(t=>{var s,o,d,u,h,l,c,p,m,f,v,S,g,b,y,T,E,w,$;const k=t.getElementsByTagName('SegmentBase')[0],A=k&&r(k,'indexRange').split('-'),P=k&&k.getElementsByTagName('Initialization')[0],R=P&&r(P,'range').split('-');if(!R||!A){const e=t.parentElement;if('text'===(null==e?void 0:e.getAttribute('contentType'))){const r=null!==(s=t.getAttribute('id'))&&void 0!==s?s:void 0,a=(i?i+'/':'')+(null===(h=null===(u=null===(d=null===(o=t.getElementsByTagName('BaseURL'))||void 0===o?void 0:o[0])||void 0===d?void 0:d.childNodes)||void 0===u?void 0:u[0])||void 0===h?void 0:h.data),c=null!==(l=e.getAttribute('lang'))&&void 0!==l?l:void 0;a&&n.push({id:r,url:a,language:c})}return}const D=Number(null===(c=t.attributes.getNamedItem('bandwidth'))||void 0===c?void 0:c.value),_=(i?i+'/':'')+t.getElementsByTagName('BaseURL')[0].childNodes[0].data;let C;const I=null!==(m=null===(p=t.attributes.getNamedItem('frameRate'))||void 0===p?void 0:p.value)&&void 0!==m?m:void 0;C=I?vo(I):void 0,a.push({width:Number(null===(f=t.attributes.getNamedItem('width'))||void 0===f?void 0:f.value),height:Number(null===(v=t.attributes.getNamedItem('height'))||void 0===v?void 0:v.value),bandwidth:D,baseURL:_,failoverHosts:e,indexFrom:Number(A[0]),indexTo:Number(A[1]),initFrom:Number(R[0]),initTo:Number(R[1]),codecs:null!==(g=null===(S=t.attributes.getNamedItem('codecs'))||void 0===S?void 0:S.value)&&void 0!==g?g:void 0,mimeType:null!==(y=null===(b=t.attributes.getNamedItem('mimeType'))||void 0===b?void 0:b.value)&&void 0!==y?y:void 0,fps:C,bufferSize:.1*D/8,bufferLength:.1,name:null!==(E=null===(T=t.attributes.getNamedItem('okQuality'))||void 0===T?void 0:T.value)&&void 0!==E?E:void 0,id:null!==($=null===(w=t.attributes.getNamedItem('id'))||void 0===w?void 0:w.value)&&void 0!==$?$:void 0})})),a.length?(this._representations=a,n.forEach((({id:t,language:e,url:i})=>{const s=document.createElement('track');s.setAttribute('src',i),t&&s.setAttribute('id',t),e&&s.setAttribute('srclang',e),this._video.appendChild(s)})),this._representations.sort(((t,e)=>e.bandwidth-t.bandwidth)),this._params.onManifestReady(this._representations)):this._onDashCallback('error')}_loadInitAndSidx(t,e){if(t===this._currentRepresentation)return void(e&&e());if(t.refs)return void this._stream.abort((()=>{this._stream.append(t.initMessage,e)}));const i=Date.now();this._stream.load(t,t.initFrom,t.indexTo,(i=>{let s=t.initTo-t.initFrom+1;if(!i.byteLength)return void this._params.onError('EmptyResponse','Empty response');t.initMessage=new Uint8Array(i.buffer,0,s);const r=new DataView(i.buffer);s+=12;const a=r.getUint32(s+4,!1);s+=8;let n=r.getUint32(s,!1),o=r.getUint32(s+4,!1)+(t.indexTo+1);s+=8;const d=r.getUint16(s+2,!1);s+=4,t.refs=[];for(let e=0;e<d;e+=1){const e=o+(2147483647&r.getUint32(s,!1)),i=n+r.getUint32(s+4,!1);s+=12,t.refs.push({fromTime:n/a,toTime:i/a,fromOffset:o,toOffset:e-1}),o=e,n=i}const u=t.refs[t.refs.length-1];u.toTime-u.fromTime<.3&&t.refs.pop(),this._stream.append(t.initMessage,e)}),void 0,(t=>{this._params.onResponseHeaders(t),this._params.onIdxRequestPing(Date.now()-i)}),t.indexTo-t.initFrom+1)}startPlay(t){const e=window.MediaSource||window.WebKitMediaSource;if(!e)return void this._params.onError('MediaSourceNotSupported','MediaSource is not supported');const i=new e;let s,r;const a=()=>{const e=this._findRef(this._video.currentTime);if(!e||this._video.paused)return;if(!this._cachingPaused&&void 0!==this._lastLoadOffset&&this._lastLoadOffset-this._video.currentTime<this._config.FRONT_CACHE_DURATION&&this._lastLoadOffset-this._video.currentTime<this._stream.getMaxBufferDuration()){const t=this._stream.isFull()?this._findBufferRangeEnd(this._video.currentTime):this._lastLoadOffset;this._loadRef(this._params.selectRepresentation(this._representations),t)}const i=this._appendVector[String(e.fromTime)];let a;i!==s&&(s=i,this._params.onRepresentationPlay(i));if(this._findRef(e.toTime)){const e=this._buffer.getByTime(this._video.currentTime);if(!e)return void this._onDashCallback('buffering');a=e.to-this._video.currentTime,a<t.bufferLength&&(this._onDashCallback('buffering'),r!==e.to&&(r=e.to,window.setTimeout((()=>{try{const t=this._buffer.getNextWithGap(e);t&&(this._video.currentTime=t.from)}catch(t){throw this._params.onError('GapSyncError',`Seek Error ${String(t)}`,t),t}}),1e3*a)))}},n=()=>{this._loopTimeout=window.setTimeout((()=>{try{a()}catch(t){throw this._params.onError('LoopError',`Dash Loop exception ${String(t)}`,t),t}n()}),250)},o=()=>{if(!this._stream)try{const e=i.addSourceBuffer(`${t.mimeType}; codecs="${t.codecs}"`);this._stream=new Xo({mediaSource:i,sourceBuffer:e,requestQuic:this._params.config.REQUEST_QUIC,onBandwidthChange:this._params.onBandwidthChange,onError:this._params.onError,onDashCallback:this._onDashCallback})}catch(t){throw this._params.onError('DashSourceOpen',`Source open exception ${String(t)}`,t),t}this._loadInitAndSidx(t),i.duration||(i.duration=this._duration),this._loopTimeout||n(),i.removeEventListener('sourceopen',o),i.removeEventListener('webkitsourceopen',o)};i.addEventListener('sourceopen',o,!1),i.addEventListener('webkitsourceopen',o,!1),this._video&&(this._video.src=window.URL.createObjectURL(i),this._video.addEventListener('waiting',(()=>{const t=this._video&&this._video.played.length;t&&!this._video.currentTime&&this._video.loop?this._video.duration-this._video.played.end(t-1)<this.STREAM_END_THRESHOLD&&this.seek(0):this._video.duration-this._video.currentTime<this.STREAM_END_THRESHOLD&&this._stream.endOfStream()})))}_loadRef(t,e,i=!1,s=!1){this._lastLoadOffset=void 0,this._loadInitAndSidx(t,(()=>{this._currentRepresentation=t;const r=this._findRef(e);if(r){if(i){this._isLastRef(r)&&e>=r.toTime&&(e=r.fromTime);const t=this._findRef(this._video.currentTime),i=Math.abs(this._video.currentTime-e),a=s||this._video.duration<this._config.SEEK_IN_SEGMENT_THRESHOLD/1e3||r===t||i<=this._config.SEEK_IN_SEGMENT_DELTA/1e3;this._video.currentTime=a?e:r.fromTime}this._appendVector[String(r.fromTime)]=t,this._stream.load(t,r.fromOffset,r.toOffset,((t,e)=>this._stream.append(t,e)),(()=>{this._lastLoadOffset=r.toTime,this._video.duration-this._lastLoadOffset<this.STREAM_END_THRESHOLD&&this._stream.endOfStream()}),(t=>this._params.onResponseHeaders(t)),t.bufferSize)}}))}setQualityByRepresentation(t,e=!1){const i=this._buffer.getByTime(this._video.currentTime),s=this._findRef(this._video.currentTime);if(!i||!s)return void(this._video.currentTime&&e&&this._loadRef(t,this._video.currentTime));const r=.1;if(s.toTime<i.to+r){const e=this._findRef(s.toTime);e&&e.toTime<i.to+r?(this._buffer.smartRemove(s.fromTime-r,e.toTime+r,((t,e)=>this._stream.remove(t,e))),this._loadRef(t,e.toTime)):(this._buffer.smartRemove(s.fromTime-r,s.toTime+r,((t,e)=>this._stream.remove(t,e))),this._loadRef(t,s.toTime))}}setQuality(t){return this.setQualityByRepresentation(this._representations[t])}pauseCaching(){this._cachingPaused=!0}resumeCaching(){this._cachingPaused=!1}seek(t,e){this._stream&&this._buffer.getByTime(t)?this._video.currentTime=t:this._loadRef(this._params.selectRepresentation(this._representations),t,!0,e)}updateRefsForCurrentTime(){const t=this._video.currentTime;this._stream&&!r(this._buffer.getByTime(t))||this._loadRef(this._params.selectRepresentation(this._representations),t,!1)}_findRef(t){var e;const i=null===(e=this._currentRepresentation)||void 0===e?void 0:e.refs;if(!i)return;if(Array.isArray(i)&&0===i.length)return void this._params.onError('emptyrefs','Empty refs');let s;for(let e=0;e<i.length;e++){const r=i[e];if(r.fromTime<=t&&r.toTime>t)return r;r.fromTime>t&&(!s||r.fromTime<s.fromTime)&&(s=r)}if(!s){const e=i[i.length-1];if(t>e.toTime)return e}return s}_isLastRef(t){var e;const i=null===(e=this._currentRepresentation)||void 0===e?void 0:e.refs;if(!i)return!1;const s=i[i.length-1];return t.fromTime===s.fromTime}_findBufferRangeEnd(t){let e=this._video.buffered.length;for(;e-- >0;){const i=this._video.buffered.start(e),s=this._video.buffered.end(e);if(t>i&&t<s)return Math.round(10*s)/10}return t}destroy(){this._stream&&this._stream.destroy(),clearTimeout(this._loopTimeout),this._loopTimeout=void 0}}var Zo;!function(t){t.STOPPED='stopped',t.MANIFEST_LOADED='manifest-loaded',t.INITIAL_REPRESENTATION_SELECTED='initial-representation-selected',t.METADATA_LOADED='metadata-loaded',t.READY='ready',t.PLAYING='playing',t.PAUSED='paused'}(Zo||(Zo={}));const td=[Zo.PAUSED,Zo.PLAYING];class ed{constructor(s){this.videoState=new z(Zo.STOPPED),this.subscription=new i,this.representations$=new t([]),this.currentRepresentation$=new t(void 0),this.textTracksManager=new ho,this.elementSize$=new t(void 0),this.dashLiteEvents={idxRequestPing$:new e,responseHeaders$:new e,manifestReady$:new e,representationPlay$:new e,error$:new e},this.handleManifestReady=t=>{var e,i,s;const r=[];for(const a of t){const t=null!==(i=null!==(e=a.name)&&void 0!==e?e:a.id)&&void 0!==i?i:a.height.toString(10),n=null!==(s=a.name&&No(a.name))&&void 0!==s?s:G(a),o=a.bandwidth/1e3,d={width:a.width,height:a.height},u=a.fps;if(!n)continue;const h={id:t,quality:n,bitrate:o,size:d,fps:u};r.push({track:h,representation:a})}this.representations$.next(r),this.params.output.availableVideoTracks$.next(r.map((({track:t})=>t))),this.videoState.setState(Zo.MANIFEST_LOADED)},this.handleRepresentationPlay=t=>{var e;const i=null===(e=this.representations$.getValue().find((({representation:e})=>e===t)))||void 0===e?void 0:e.track;if(i){this.params.output.currentVideoTrack$.next(i);this.params.desiredState.videoTrack.getTransition()&&this.params.desiredState.videoTrack.setState(i.id)}},this.selectRepresentation=()=>{const t=this.currentRepresentation$.getValue();return c(t,'Can\'t select representation. something went wrong'),t},this.syncPlayback=()=>{const t=this.videoState.getState(),e=this.videoState.getTransition(),i=this.params.desiredState.playbackState.getState(),s=this.params.desiredState.playbackState.getTransition(),r=this.params.desiredState.seekState.getState();if(this.log({message:`[syncPlayback] videoState: ${t}; videoTransition: ${JSON.stringify(e)}; desiredPlaybackState: ${i}; seekState: ${JSON.stringify(r)};`}),i!==P.STOPPED){if(!e)switch((null==s?void 0:s.to)!==P.PAUSED&&r.state===L.Requested&&td.includes(t)&&this.seek(r.position,r.forcePrecise),t){case Zo.STOPPED:return this.videoState.startTransitionTo(Zo.MANIFEST_LOADED),void this.prepare();case Zo.MANIFEST_LOADED:return void this.videoState.startTransitionTo(Zo.INITIAL_REPRESENTATION_SELECTED);case Zo.INITIAL_REPRESENTATION_SELECTED:return this.videoState.startTransitionTo(Zo.METADATA_LOADED),void this.dash.startPlay(this.selectRepresentation());case Zo.METADATA_LOADED:return this.videoState.startTransitionTo(Zo.READY),void this.dash.updateRefsForCurrentTime();case Zo.READY:return void(i===P.PAUSED?(this.videoState.setState(Zo.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED)):i===P.PLAYING&&(this.videoState.startTransitionTo(Zo.PLAYING),this.playIfAllowed()));case Zo.PLAYING:return void(i===P.PAUSED?(this.videoState.startTransitionTo(Zo.PAUSED),this.video.pause()):(null==s?void 0:s.to)===P.PLAYING&&U(this.params.desiredState.playbackState,P.PLAYING));case Zo.PAUSED:return void(i===P.PLAYING?(this.videoState.startTransitionTo(Zo.PLAYING),this.playIfAllowed()):(null==s?void 0:s.to)===P.PAUSED&&U(this.params.desiredState.playbackState,P.PAUSED));default:return n(t)}}else t!==Zo.STOPPED&&(this.videoState.startTransitionTo(Zo.STOPPED),this.dash.destroy(),this.video.setAttribute('src',''),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(Zo.STOPPED),U(this.params.desiredState.playbackState,P.STOPPED,!0))},this.params=s,this.log=this.params.dependencies.logger.createComponentLog('DashProvider'),o(this.videoState.stateChangeStarted$.pipe(u((t=>({transition:t,type:'start'})))),this.videoState.stateChangeEnded$.pipe(u((t=>({transition:t,type:'end'}))))).subscribe((({transition:t,type:e})=>{this.log({message:`[videoState change] ${e}: ${JSON.stringify(t)}`})})),this.video=lo(s.container),this.params.output.element$.next(this.video),this.params.output.isLive$.next(!1),'url'===this.params.source.type&&this.params.output.hostname$.next(Do(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.buffer=new po(this.video),this.dash=new Ko({video:this.video,buffer:this.buffer,selectRepresentation:this.selectRepresentation,onIdxRequestPing:t=>this.dashLiteEvents.idxRequestPing$.next(t),onResponseHeaders:t=>this.dashLiteEvents.responseHeaders$.next(t),onManifestReady:t=>this.dashLiteEvents.manifestReady$.next(t),onRepresentationPlay:t=>this.dashLiteEvents.representationPlay$.next(t),onBandwidthChange:t=>this.params.dependencies.throughputEstimator.addRawSpeed(t.size,t.duration),onError:(t,e,i)=>{this.log({message:`[DashLite error], ${t}`}),this.dashLiteEvents.error$.next({id:t,message:e,thrown:i})},config:{SEEK_IN_SEGMENT_THRESHOLD:this.params.tuning.dashSeekInSegmentDurationThreshold,SEEK_IN_SEGMENT_DELTA:this.params.tuning.dashSeekInSegmentAlwaysSeekDelta,FRONT_CACHE_DURATION:this.params.config.cacheDuration/1e3,REQUEST_QUIC:this.params.tuning.requestQuick}}),this.subscribe()}subscribe(){const{output:t,desiredState:e}=this.params,i=e=>{t.error$.next({id:'DashProvider',message:'DashProvider internal logic error',thrown:e})},n=()=>{const t=this.params.desiredState.autoVideoTrackSwitching.getState(),e=this.params.desiredState.autoVideoTrackSwitching.getTransition();return e?e.to:t},d=fo(this.video),c=(t,e)=>this.subscription.add(t.subscribe(e,i));c(d.timeUpdate$,t.position$),c(d.durationChange$,t.duration$),c(d.ended$,t.endedEvent$),c(d.looped$,t.loopedEvent$),c(d.error$,t.error$),c(d.isBuffering$,t.isBuffering$),c(d.playing$,t.firstFrameEvent$),c(d.canplay$,t.canplay$),this.subscription.add(d.seeking$.subscribe((()=>{r(this.params.desiredState.seekState.getState().state!==L.Applying)&&(this.videoState.getState()===Zo.PLAYING||this.videoState.getState()===Zo.PAUSED)&&this.dash.updateRefsForCurrentTime()}))),this.subscription.add(d.seeked$.subscribe(t.seekedEvent$,i)),this.subscription.add(ao(this.video,e.isLooped,i)),this.subscription.add(no(this.video,e.volume,d.volumeState$,i)),this.subscription.add(d.volumeState$.subscribe(this.params.output.volume$)),this.subscription.add(oo(this.video,e.playbackRate,d.playbackRateState$,i)),this.textTracksManager.connect(this.video,e,t),c(_o(this.video),this.elementSize$),this.subscription.add(d.canplay$.subscribe((()=>{var t;(null===(t=this.videoState.getTransition())||void 0===t?void 0:t.to)===Zo.READY&&this.videoState.setState(Zo.READY)}),i)).add(d.pause$.subscribe((()=>{this.videoState.setState(Zo.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED)}))).add(d.playing$.subscribe((()=>{this.videoState.setState(Zo.PLAYING),U(this.params.desiredState.playbackState,P.PLAYING)}),i)).add(d.loadedMetadata$.subscribe((()=>{this.videoState.setState(Zo.METADATA_LOADED)}),i)).add(d.currentBuffer$.subscribe((e=>{this.buffer.fill(),t.currentBuffer$.next(e)}),i)).add(this.dashLiteEvents.error$.pipe(u((({id:t,message:e,thrown:i})=>({id:`DashLite_${t}`,message:e,thrown:i})))).subscribe(this.params.output.error$)).add(o(this.params.desiredState.videoTrack.transitionStarted$,this.params.desiredState.autoVideoTrackSwitching.transitionStarted$,this.representations$,this.params.dependencies.throughputEstimator.rttAdjustedThroughput$,this.params.desiredState.autoVideoTrackLimits.stateChangeEnded$,this.params.output.element$,this.elementSize$,a(this.video,'progress')).pipe(u((()=>{var t,e,i;const r=this.currentRepresentation$.getValue(),a=this.representations$.getValue(),o=this.params.desiredState.autoVideoTrackSwitching.getTransition(),d=this.params.desiredState.videoTrack.getState(),u=this.params.dependencies.throughputEstimator.rttAdjustedThroughput$.getValue(),h=this.elementSize$.getValue(),l=n();let c;if(o&&this.params.desiredState.autoVideoTrackSwitching.setState(o.to),!l&&s(d))c=d;else{const i=Wo(this.video.buffered,1e3*this.video.currentTime),s=l?this.params.tuning.dash.forwardBufferTargetAuto:this.params.tuning.dash.forwardBufferTargetManual,n=Math.min(i/s,1);c=null===(e=Ro(a.map((({track:t})=>t)),{container:h,throughput:u,tuning:this.params.tuning.autoTrackSelection,limits:this.params.desiredState.autoVideoTrackLimits.getState(),forwardBufferHealth:n,playbackRate:this.video.playbackRate,current:null===(t=a.find((({representation:t})=>t===r)))||void 0===t?void 0:t.track}))||void 0===e?void 0:e.id}return s(c)?null===(i=a.find((({track:t})=>t.id===c)))||void 0===i?void 0:i.representation:void 0})),l()).subscribe(this.currentRepresentation$,i)).add(y({needToSelectRepresentation:this.videoState.stateChangeStarted$.pipe(f((t=>t.to===Zo.INITIAL_REPRESENTATION_SELECTED))),currentRepresentationSelected:this.currentRepresentation$.pipe(f(s))}).pipe(b()).subscribe((()=>this.videoState.setState(Zo.INITIAL_REPRESENTATION_SELECTED)),i)).add(this.currentRepresentation$.pipe(f(s),l(((t,e)=>this.params.tuning.autoTrackSelection.lazyQualitySwitch&&n()?t.height<=e.height:t===e))).subscribe((t=>{const e=Wo(this.video.buffered,1e3*this.video.currentTime),i=Math.min(e/this.params.tuning.dash.forwardBufferTarget,1);(!this.params.tuning.autoTrackSelection.lazyQualitySwitch||i<=.5||!n())&&(this.dash.setQualityByRepresentation(t,!0),this.params.output.hostname$.next(Do(t.baseURL)))}),i)).add(this.dashLiteEvents.responseHeaders$.subscribe((t=>{const{type:e,reused:i}=jo(t);this.params.output.httpConnectionType$.next(e),this.params.output.httpConnectionReused$.next(i)}))).add(this.dashLiteEvents.idxRequestPing$.pipe(b(),v(void 0)).subscribe(this.params.output.firstBytesEvent$)).add(this.dashLiteEvents.idxRequestPing$.subscribe((t=>this.params.dependencies.throughputEstimator.addRawRtt(t)))).add(this.dashLiteEvents.manifestReady$.subscribe(this.handleManifestReady,i)).add(this.dashLiteEvents.representationPlay$.pipe(f(s)).subscribe(this.handleRepresentationPlay,i)).add(o(e.playbackState.stateChangeStarted$,e.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,h(['init'])).pipe(p(0)).subscribe(this.syncPlayback,i))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.video.remove(),this.params.output.element$.next(void 0),this.buffer.destroy(),this.dash.destroy()}prepare(){const t=this.params.source;switch(t.type){case'url':this.dash.attachSource(t.url);break;case'raw':this.dash.attachManifest(t.raw);break;default:return n(t)}}seek(t,e=!1){this.log({message:`[seek] position: ${t}`}),this.params.output.willSeekEvent$.next(),this.dash.seek(t/1e3,e)}playIfAllowed(){Oo(this.video).then((t=>{t||(this.videoState.setState(Zo.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED,!0))}))}}var id,sd,rd,ad,nd;!function(t){t.VIDEO='video',t.AUDIO='audio',t.TEXT='text'}(id||(id={})),function(t){t.WEBM_AS_IN_SPEC='urn:mpeg:dash:profile:webm-on-demand:2012',t.WEBM_AS_IN_FFMPEG='urn:webm:dash:profile:webm-on-demand:2012'}(sd||(sd={})),function(t){t.BYTE_RANGE='byteRange',t.TEMPLATE='template'}(rd||(rd={})),function(t){t.NONE='none',t.DOWNLOADING='downloading',t.DOWNLOADED='downloaded',t.PARTIALLY_FED='partially_fed',t.FED='fed'}(ad||(ad={})),function(t){t.MP4='mp4',t.WEBM='webm'}(nd||(nd={}));var od=(t,e)=>{for(let i=0;i<t.length;i++){if(1e3*t.start(i)<=e&&1e3*t.end(i)>e)return!0}return!1};const dd='function'!=typeof window.requestIdleCallback||'function'!=typeof window.cancelIdleCallback?(t,e={})=>{const i=e.timeout||1,s=performance.now();return window.setTimeout((()=>{t({get didTimeout(){return!e.timeout&&performance.now()-s-1>i},timeRemaining:()=>Math.max(0,performance.now()-s+1)})}),1)}:window.requestIdleCallback;var ud,hd,ld=()=>{const{userAgent:t}=window.navigator;return!/chrome/i.test(t)&&/webkit|safari|khtml/i.test(t)};let cd=!1;try{cd=ld()&&parseInt(null!==(hd=null===(ud=navigator.userAgent.match(/Version\/(\d+)/))||void 0===ud?void 0:ud[1])&&void 0!==hd?hd:'',10)<16}catch(t){console.error(t)}class pd{constructor(t){this.bufferFull$=new e,this.error$=new e,this.queue=[],this.currentTask=null,this.destroyed=!1,this.completeTask=()=>{var t;try{if(this.currentTask){const e=null===(t=this.currentTask.signal)||void 0===t?void 0:t.aborted;this.currentTask.callback(!e),this.currentTask=null}this.queue.length&&this.pull()}catch(t){this.error$.next({id:'BufferTaskQueueUnknown',message:'Buffer appending or removal failed',thrown:t})}},this.buffer=t,this.buffer.addEventListener('updateend',this.completeTask)}async append(t,e){return(!e||!e.aborted)&&new Promise((i=>{const s={operation:'append',data:t,signal:e,callback:i};this.queue.push(s),this.pull()}))}async remove(t,e,i){return(!i||!i.aborted)&&new Promise((s=>{const r={operation:'remove',from:t,to:e,signal:i,callback:s};this.queue.unshift(r),this.pull()}))}async abort(t){return new Promise((e=>{let i;i=cd&&t?{operation:'safariAbort',init:t,callback:e}:{operation:'abort',callback:e};for(const{callback:t}of this.queue)t(!1);i&&(this.queue=[i]),this.pull()}))}destroy(){this.destroyed=!0,this.buffer.removeEventListener('updateend',this.completeTask)}pull(){var t;if(this.buffer.updating||this.currentTask||this.destroyed)return;const e=this.queue.shift();if(!e)return;if(null===(t=e.signal)||void 0===t?void 0:t.aborted)return e.callback(!1),void this.pull();this.currentTask=e;const{operation:i}=this.currentTask;try{this.execute(this.currentTask)}catch(t){t instanceof DOMException&&'QuotaExceededError'===t.name&&'append'===i&&this.bufferFull$.next(this.currentTask.data.byteLength),t instanceof DOMException&&'InvalidStateError'===t.name&&'remove'===i||this.error$.next({id:`BufferTaskQueue:${i}`,message:'Buffer operation failed',thrown:t}),this.currentTask.callback(!1),this.currentTask=null}this.currentTask&&'abort'===this.currentTask.operation&&this.completeTask()}execute(t){const{operation:e}=t;switch(e){case'append':this.buffer.appendBuffer(t.data);break;case'remove':this.buffer.remove(t.from/1e3,t.to/1e3);break;case'abort':this.buffer.abort();break;case'safariAbort':this.buffer.abort(),this.buffer.appendBuffer(t.init);break;default:n(e)}}}var md;!function(t){t[t.HEADER=0]='HEADER',t[t.PARAM=1]='PARAM'}(md||(md={}));class fd{constructor({throughputEstimator:e,requestQuic:s}){this.lastConnectionType$=new t(void 0),this.lastConnectionReused$=new t(void 0),this.lastRequestFirstBytes$=new t(void 0),this.abortAllController=new it,this.subscription=new i,this.fetchManifest=T(this.abortAllController.signal,async function*(t){let e=t;this.requestQuic&&(e=io(e));const i=yield et(e,{signal:this.abortAllController.signal}).catch(vd);return i?(this.onHeadersReceived(i.headers),i.text()):null}.bind(this)),this.fetch=T(this.abortAllController.signal,async function*(t,{rangeMethod:e=md.HEADER,range:i,onProgress:s,priority:r='auto',signal:d,measureThroughput:u=!0}={}){var h,l,c,p;let m=t;const f=new Headers;if(i)switch(e){case md.HEADER:f.append('Range',`${i.from}-${i.to}`);break;case md.PARAM:{const t=new URL(m,location.href);t.searchParams.append('bytes',`${i.from}-${i.to}`),m=t.toString();break}default:n(e)}this.requestQuic&&(m=io(m));let v=this.abortAllController.signal;if(d){const t=new it;if(this.subscription.add(o(a(this.abortAllController.signal,'abort'),a(d,'abort')).subscribe((()=>{try{t.abort()}catch(t){vd(t)}}))),this.abortAllController.signal.aborted||d.aborted)try{t.abort()}catch(t){vd(t)}v=t.signal}const g=S(),b=yield et(m,{priority:r,headers:f,signal:v}).catch(vd),y=S();if(null===(h=this.throughputEstimator)||void 0===h||h.addRawRtt(y-g),!b)return null;if(!b.ok||!b.body)return Promise.reject(new Error(`Fetch error ${b.status}: ${b.statusText}`));this.onHeadersReceived(b.headers);const E=parseInt(null!==(l=b.headers.get('Content-Length'))&&void 0!==l?l:'',10)||i&&i.to-i.from+1||NaN;if(!E){const t=yield b.arrayBuffer();return null===(c=this.throughputEstimator)||void 0===c||c.addRawSpeed(t.byteLength,S()-y),null==s||s(new DataView(t),t.byteLength),t}if(!s&&!u)return b.arrayBuffer();const[w,$]=b.body.tee(),k=w.getReader();u&&(null===(p=this.throughputEstimator)||void 0===p||p.trackStream($));let A=0;const P=new ArrayBuffer(E),R=new Uint8Array(P),D=new DataView(P);let _=!1;const C=t=>{_=!0,vd(t)},I=T(v,async function*({done:t,value:e}){0===A&&this.lastRequestFirstBytes$.next(S()-g),v.aborted||(t?null==s||s(D,A):e&&(R.set(e,A),A+=e.byteLength,null==s||s(D,A),yield null==k?void 0:k.read().then(I,C)))}.bind(this));return yield null==k?void 0:k.read().then(I,C),_?null:P}.bind(this)),this.fetchByteRangeRepresentation=T(this.abortAllController.signal,async function*(t,e,i){if(t.type!==rd.BYTE_RANGE)return null;const{from:s,to:r}=t.initRange;let a,n,o=s,d=r,u=!1;t.indexRange&&(a=t.indexRange.from,n=t.indexRange.to,u=r+1===a,u&&(o=Math.min(a,s),d=Math.max(n,r))),o=Math.min(o,0);const h=yield this.fetch(t.url,{rangeMethod:md.PARAM,range:{from:o,to:d},priority:i,measureThroughput:!1});if(!h)return null;const l=new DataView(h,s-o,r-o+1);if(!e.validateData(l))throw new Error('Invalid media file');const c=e.parseInit(l);let p;if(u&&void 0!==a&&void 0!==n)p=new DataView(h,a-o,n-a+1);else{const s=e.getIndexRange(c);if(s){const e=yield this.fetch(t.url,{rangeMethod:md.PARAM,range:s,priority:i,measureThroughput:!1});if(!e)return null;p=new DataView(e)}}if(!p)throw new ReferenceError('No way to load representation index');const m=e.parseSegments(p,c);return{dataView:new DataView(h),segments:m}}.bind(this)),this.fetchTemplateRepresentation=T(this.abortAllController.signal,async function*(t,e){if(t.type!==rd.TEMPLATE)return null;const i=new URL(t.initUrl,t.baseUrl).toString(),s=yield this.fetch(i,{priority:e,measureThroughput:!1});if(!s)return null;return{segments:t.segments.map((t=>({...t,status:ad.NONE,size:void 0}))),dataView:new DataView(s)}}.bind(this)),this.throughputEstimator=e,this.requestQuic=s}onHeadersReceived(t){const{type:e,reused:i}=jo(t);this.lastConnectionType$.next(e),this.lastConnectionReused$.next(i)}async fetchRepresentation(t,e,i='auto'){var s,r;const{type:a}=t;switch(a){case rd.BYTE_RANGE:return null!==(s=await this.fetchByteRangeRepresentation(t,e,i))&&void 0!==s?s:null;case rd.TEMPLATE:return null!==(r=await this.fetchTemplateRepresentation(t,i))&&void 0!==r?r:null;default:n(a)}}destroy(){this.abortAllController.abort(),this.subscription.unsubscribe()}}const vd=t=>{if(!(t instanceof DOMException)||'AbortError'!==t.name&&20!==t.code)throw t},Sd=new TextDecoder('ascii'),gd=t=>{let e=0,i=t.getUint32(e);e+=4;const s=new DataView(t.buffer,t.byteOffset+e,4),r=Sd.decode(s);e+=4,0===i?i=1/0:1===i&&(e+=8,i=1/0);const a=Math.min(i,t.byteLength)-e;return{id:r,size:i,contents:new DataView(t.buffer,t.byteOffset+e,a)}},bd={validateData:t=>'ftyp'===Sd.decode(new DataView(t.buffer,t.byteOffset+4,4)),parseInit:()=>null,getIndexRange:()=>{},parseSegments:t=>{const e=gd(t),i=[];let s=0;const r=()=>{const t=e.contents.getUint32(s);return s+=4,t};if(0!==(4278190080&r()))throw new SyntaxError('Unsupported sidx version');r();const a=r(),n=r(),o=r(),d=4294967295&r();let u=n/a*1e3,h=t.byteOffset+t.byteLength+o;for(let t=0;t<d;t++){const t=r(),e=t>>>31,s=t<<1>>>1,n=r();if(r(),0!==e)throw new Error('Unsupported multilevel sidx');const o=n/a*1e3;i.push({status:ad.NONE,time:{from:u,to:u+o},byte:{from:h,to:h+s-1}}),u+=o,h+=s}return i},parseFeedableSegmentChunk:t=>{let e=0,i=!1,s=!1;for(;e<=t.byteLength&&!i;){const r=new DataView(t.buffer,t.byteOffset+e);try{const i=gd(r);if(s||(s='mdat'===i.id),!(e+i.size<=t.byteLength))break;e+=i.size}catch(t){i=!0}}return e>0&&e<=t.byteLength&&s?new DataView(t.buffer,t.byteOffset,e):null}};var yd,Td;!function(t){t[t.EBML=440786851]='EBML',t[t.EBMLVersion=17030]='EBMLVersion',t[t.EBMLReadVersion=17143]='EBMLReadVersion',t[t.EBMLMaxIDLength=17138]='EBMLMaxIDLength',t[t.EBMLMaxSizeLength=17139]='EBMLMaxSizeLength',t[t.DocType=17026]='DocType',t[t.DocTypeVersion=17031]='DocTypeVersion',t[t.DocTypeReadVersion=17029]='DocTypeReadVersion',t[t.Void=236]='Void',t[t.Segment=408125543]='Segment',t[t.SeekHead=290298740]='SeekHead',t[t.Seek=19899]='Seek',t[t.SeekID=21419]='SeekID',t[t.SeekPosition=21420]='SeekPosition',t[t.Info=357149030]='Info',t[t.TimestampScale=2807729]='TimestampScale',t[t.Duration=17545]='Duration',t[t.Tracks=374648427]='Tracks',t[t.Chapters=272869232]='Chapters',t[t.Cluster=524531317]='Cluster',t[t.Timestamp=231]='Timestamp',t[t.SilentTracks=22612]='SilentTracks',t[t.SilentTrackNumber=22743]='SilentTrackNumber',t[t.Position=167]='Position',t[t.PrevSize=171]='PrevSize',t[t.SimpleBlock=163]='SimpleBlock',t[t.BlockGroup=160]='BlockGroup',t[t.EncryptedBlock=175]='EncryptedBlock',t[t.Attachments=423732329]='Attachments',t[t.Tags=307544935]='Tags',t[t.Cues=475249515]='Cues',t[t.CuePoint=187]='CuePoint',t[t.CueTime=179]='CueTime',t[t.CueTrackPositions=183]='CueTrackPositions',t[t.CueTrack=247]='CueTrack',t[t.CueClusterPosition=241]='CueClusterPosition',t[t.CueRelativePosition=240]='CueRelativePosition',t[t.CueDuration=178]='CueDuration',t[t.CueBlockNumber=21368]='CueBlockNumber',t[t.CueCodecState=234]='CueCodecState',t[t.CueReference=219]='CueReference',t[t.CueRefTime=150]='CueRefTime'}(yd||(yd={})),function(t){t.SignedInteger='int',t.UnsignedInteger='uint',t.Float='float',t.String='string',t.UTF8='utf8',t.Date='date',t.Master='master',t.Binary='binary'}(Td||(Td={}));const Ed={[yd.EBML]:{type:Td.Master},[yd.EBMLVersion]:{type:Td.UnsignedInteger},[yd.EBMLReadVersion]:{type:Td.UnsignedInteger},[yd.EBMLMaxIDLength]:{type:Td.UnsignedInteger},[yd.EBMLMaxSizeLength]:{type:Td.UnsignedInteger},[yd.DocType]:{type:Td.String},[yd.DocTypeVersion]:{type:Td.UnsignedInteger},[yd.DocTypeReadVersion]:{type:Td.UnsignedInteger},[yd.Void]:{type:Td.Binary},[yd.Segment]:{type:Td.Master},[yd.SeekHead]:{type:Td.Master},[yd.Seek]:{type:Td.Master},[yd.SeekID]:{type:Td.Binary},[yd.SeekPosition]:{type:Td.UnsignedInteger},[yd.Info]:{type:Td.Master},[yd.TimestampScale]:{type:Td.UnsignedInteger},[yd.Duration]:{type:Td.Float},[yd.Tracks]:{type:Td.Master},[yd.Chapters]:{type:Td.Master},[yd.Cluster]:{type:Td.Master},[yd.Timestamp]:{type:Td.UnsignedInteger},[yd.SilentTracks]:{type:Td.Master},[yd.SilentTrackNumber]:{type:Td.UnsignedInteger},[yd.Position]:{type:Td.UnsignedInteger},[yd.PrevSize]:{type:Td.UnsignedInteger},[yd.SimpleBlock]:{type:Td.Binary},[yd.BlockGroup]:{type:Td.Master},[yd.EncryptedBlock]:{type:Td.Binary},[yd.Attachments]:{type:Td.Master},[yd.Tags]:{type:Td.Master},[yd.Cues]:{type:Td.Master},[yd.CuePoint]:{type:Td.Master},[yd.CueTime]:{type:Td.UnsignedInteger},[yd.CueTrackPositions]:{type:Td.Master},[yd.CueTrack]:{type:Td.UnsignedInteger},[yd.CueClusterPosition]:{type:Td.UnsignedInteger},[yd.CueRelativePosition]:{type:Td.UnsignedInteger},[yd.CueDuration]:{type:Td.UnsignedInteger},[yd.CueBlockNumber]:{type:Td.UnsignedInteger},[yd.CueCodecState]:{type:Td.UnsignedInteger},[yd.CueReference]:{type:Td.Master},[yd.CueRefTime]:{type:Td.UnsignedInteger}},wd=t=>{const e=t.getUint8(0);let i=0;128&e?i=1:64&e?i=2:32&e?i=3:16&e&&(i=4);const s=$d(t,i),r=s in Ed,a=r?Ed[s].type:Td.Binary,n=t.getUint8(i);let o=0;128&n?o=1:64&n?o=2:32&n?o=3:16&n?o=4:8&n?o=5:4&n?o=6:2&n?o=7:1&n&&(o=8);const d=new DataView(t.buffer,t.byteOffset+i+1,o-1),u=((n&255>>o)<<8*(o-1))+$d(d),h=i+o;let l;return l=h+u>t.byteLength?new DataView(t.buffer,t.byteOffset+h):new DataView(t.buffer,t.byteOffset+h,u),{tag:r?s:'0x'+s.toString(16).toUpperCase(),type:a,tagHeaderSize:h,tagSize:h+u,value:l,valueSize:u}},$d=(t,e=t.byteLength)=>{switch(e){case 1:return t.getUint8(0);case 2:return t.getUint16(0);case 3:return t.getUint16(0)<<8|t.getUint8(2);case 4:return t.getUint32(0);case 5:return t.getUint32(0)<<8|t.getUint8(4);case 6:return t.getUint32(0)<<16|t.getUint16(4);case 7:return t.getUint32(0)<<32|t.getUint16(4)<<8|t.getUint8(6);case 8:return t.getUint32(0)<<32|t.getUint32(4)}return 0},kd=(t,e)=>{switch(e){case Td.SignedInteger:return t.getInt8(0);case Td.UnsignedInteger:return $d(t);case Td.Float:return 4===t.byteLength?t.getFloat32(0):t.getFloat64(0);case Td.String:return new TextDecoder('ascii').decode(t);case Td.UTF8:return new TextDecoder('utf-8').decode(t);case Td.Date:return new Date(Date.UTC(2001,0)+t.getInt8(0)).getTime();case Td.Master:case Td.Binary:return t;default:n(e)}},Ad=(t,e)=>{let i=0;for(;i<t.byteLength;){const s=new DataView(t.buffer,t.byteOffset+i),r=wd(s);if(!e(r))return;r.type===Td.Master&&Ad(r.value,e),i=r.value.byteOffset-t.byteOffset+r.valueSize}},Pd=[yd.Info,yd.SeekHead,yd.Tracks,yd.Chapters,yd.Cluster,yd.Cues,yd.Attachments,yd.Tags],Rd=[yd.Timestamp,yd.SilentTracks,yd.SilentTrackNumber,yd.Position,yd.PrevSize,yd.SimpleBlock,yd.BlockGroup,yd.EncryptedBlock],Dd={validateData:t=>{if(t.getUint32(0)!==yd.EBML)return!1;let e,i,s;const r=wd(t);return Ad(r.value,(({tag:t,type:r,value:a})=>(t===yd.EBMLReadVersion?e=kd(a,r):t===yd.DocType?i=kd(a,r):t===yd.DocTypeReadVersion&&(s=kd(a,r)),!0))),(void 0===e||e<=1)&&void 0!==i&&'webm'===i&&(void 0===s||s<=2)},parseInit:t=>{let e,i,s,r,a,n,o=!1,d=!1,u=!1;return Ad(t,(({tag:t,type:h,value:l,valueSize:c})=>{if(t===yd.SeekID){const t=kd(l,h);n=$d(t)}else t!==yd.SeekPosition&&(n=void 0);return t===yd.Segment?(e=l.byteOffset,i=l.byteOffset+c):t===yd.Info?o=!0:t===yd.SeekHead?d=!0:t===yd.TimestampScale?s=kd(l,h):t===yd.Duration?r=kd(l,h):t===yd.SeekPosition&&n===yd.Cues?a=kd(l,h):o&&d&&Pd.includes(t)&&(u=!0),!u})),c(e,'Failed to parse webm Segment start'),c(i,'Failed to parse webm Segment end'),c(r,'Failed to parse webm Segment duration'),s=null!=s?s:1e6,{segmentStart:Math.round(e/1e9*s*1e3),segmentEnd:Math.round(i/1e9*s*1e3),timeScale:s,segmentDuration:Math.round(r/1e9*s*1e3),cuesSeekPosition:a}},getIndexRange:t=>{if(r(t.cuesSeekPosition))return;const e=t.segmentStart+t.cuesSeekPosition;return{from:e,to:e+1048576}},parseSegments:(t,e)=>{let i=!1,r=!1;const a=t=>s(t.time)&&s(t.position),n=[];let o;return Ad(t,(({tag:t,type:e,value:s})=>{switch(t){case yd.Cues:i=!0;break;case yd.CuePoint:o&&a(o)&&n.push(o),o={};break;case yd.CueTime:o&&(o.time=kd(s,e));break;case yd.CueTrackPositions:break;case yd.CueClusterPosition:o&&(o.position=kd(s,e));break;default:i&&Pd.includes(t)&&(r=!0)}return!(i&&r)})),o&&a(o)&&n.push(o),n.map(((t,i)=>{const{time:s,position:r}=t,a=n[i+1];return{status:ad.NONE,time:{from:s,to:a?a.time:e.segmentDuration},byte:{from:e.segmentStart+r,to:a?e.segmentStart+a.position-1:e.segmentEnd-1}}}))},parseFeedableSegmentChunk:t=>{let e=0,i=!1;try{Ad(t,(s=>s.tag===yd.Cluster?s.tagSize<=t.byteLength?(e=s.tagSize,!1):(e+=s.tagHeaderSize,!0):!!Rd.includes(s.tag)&&(e+s.tagSize<=t.byteLength&&(e+=s.tagSize,i||(i=[yd.SimpleBlock,yd.BlockGroup,yd.EncryptedBlock].includes(s.tag))),!0)))}catch(t){}return e>0&&e<=t.byteLength&&i?new DataView(t.buffer,t.byteOffset,e):null}};class _d{constructor(o,d,u,h,{fetcher:l,tuning:p,getCurrentPosition:m}){switch(this.onLastSegment$=new t(!1),this.fullyBuffered$=new t(!1),this.playingRepresentation$=new t(void 0),this.error$=new e,this.gaps=[],this.subscription=new i,this.allInitsLoaded=!1,this.activeSegments=new Set,this.downloadAbortController=new it,this.destroyAbortController=new it,this.bufferLimit=1/0,this.failedDownloads=0,this.startWith=T(this.destroyAbortController.signal,async function*(t){const e=this.representations.get(t);c(e,`Cannot find representation ${t}`),this.playingRepresentationId=t,this.downloadingRepresentationId=t,this.sourceBuffer=this.mediaSource.addSourceBuffer(`${e.mime}; codecs="${e.codecs}"`),this.sourceBufferTaskQueue=new pd(this.sourceBuffer),this.subscription.add(a(this.sourceBuffer,'updateend').subscribe((()=>this.checkEjectedSegments()),(t=>this.error$.next({id:'SegmentEjection',message:'Error when trying to clear segments ejected by browser',thrown:t})))),this.subscription.add(a(this.sourceBuffer,'error').subscribe((()=>this.error$.next({id:'SourceBuffer',message:'SourceBuffer Error event fired'})))),this.subscription.add(this.sourceBufferTaskQueue.bufferFull$.subscribe((t=>this.pruneBuffer(t)))),this.subscription.add(this.sourceBufferTaskQueue.error$.subscribe((t=>this.error$.next(t)))),yield this.loadInit(e,'high',!0);const i=this.initData.get(e.id),r=this.segments.get(e.id);if(c(i,'No init buffer for starting representation'),c(r,'No segments for starting representation'),!(i instanceof ArrayBuffer))return;let n=0;for(const t of r)t.time.from-n>=300&&this.gaps.push({representation:e.id,from:n,to:t.time.from}),n=t.time.to;s(e.duration)&&e.duration-n>=300&&this.gaps.push({representation:e.id,from:n,to:e.duration}),yield this.sourceBufferTaskQueue.append(i,this.destroyAbortController.signal),this.playingRepresentation$.next(this.playingRepresentationId)}.bind(this)),this.switchTo=T(this.destroyAbortController.signal,async function*(t){if(t===this.downloadingRepresentationId||t===this.switchingToRepresentationId)return;this.switchingToRepresentationId=t;const e=this.representations.get(t);c(e,`No such representation ${t}`);let i=this.initData.get(t);if(r(i)?yield this.loadInit(e,'high',!1):i instanceof Promise&&(yield i),i=this.initData.get(t),!(i&&i instanceof ArrayBuffer&&this.sourceBuffer))return;this.switchingToRepresentationId=void 0,this.downloadingRepresentationId=t,this.abort(),yield this.sourceBufferTaskQueue.append(i,this.downloadAbortController.signal);const a=this.getCurrentPosition();s(a)&&this.maintain(a)}.bind(this)),this.fetcher=l,this.tuning=p,this.forwardBufferTarget=p.dash.forwardBufferTargetAuto,this.getCurrentPosition=m,this.container=u,u){case nd.MP4:this.containerParser=bd;break;case nd.WEBM:this.containerParser=Dd;break;default:n(u)}this.initData=new Map(h.map((t=>[t.id,null]))),this.segments=new Map,this.representations=new Map(h.map((t=>[t.id,t]))),this.kind=o,this.mediaSource=d,this.sourceBuffer=null}abort(){for(const t of this.activeSegments)this.abortSegment(t.segment);this.activeSegments.clear(),this.downloadAbortController.abort(),this.downloadAbortController=new it,this.abortBuffer()}maintain(t){if(r(this.downloadingRepresentationId)||r(this.playingRepresentationId)||r(this.sourceBuffer))return;const e=this.representations.get(this.downloadingRepresentationId),i=this.segments.get(this.downloadingRepresentationId);if(c(e,`No such representation ${this.downloadingRepresentationId}`),!i)return;const s=i.find((e=>t>=e.time.from&&t<e.time.to));let a=t;if(this.playingRepresentationId!==this.downloadingRepresentationId){const e=100,i=Wo(this.sourceBuffer.buffered,t),r=s?s.time.to+e:-1/0;s&&i>=s.time.to-t+e&&(a=r)}let n=[];if(isFinite(this.bufferLimit)&&(t=>{let e=0;for(let i=0;i<t.length;i++)e+=t.end(i)-t.start(i);return 1e3*e})(this.sourceBuffer.buffered)>=.8*this.bufferLimit)this.pruneBuffer(1/0);else if(!this.activeSegments.size&&(n=this.selectForwardBufferSegments(i,e.segmentReference.type,a),n.length)){let t='auto';if(this.tuning.dash.useFetchPriorityHints&&s)if(n.includes(s))t='high';else{const e=yo(n,0);e&&e.time.from-s.time.to>=this.forwardBufferTarget/2&&(t='low')}this.loadSegments(n,e,t)}!this.allInitsLoaded&&s&&s.status===ad.FED&&!n.length&&Wo(this.sourceBuffer.buffered,t)>3e3&&this.loadNextInit();const o=yo(i,-1);o&&o.status===ad.FED&&(this.fullyBuffered$.next(!0),this.onLastSegment$.next(s===o))}findSegmentStartTime(t){var e,i,s;const r=null!==(i=null!==(e=this.switchingToRepresentationId)&&void 0!==e?e:this.downloadingRepresentationId)&&void 0!==i?i:this.playingRepresentationId;if(!r)return;const a=this.segments.get(r);if(!a)return;const n=a.find((e=>e.time.from<=t&&e.time.to>=t));return null!==(s=null==n?void 0:n.time.from)&&void 0!==s?s:void 0}setTarget(t){this.forwardBufferTarget=t}destroy(){var t;this.initData.clear(),this.segments.clear(),this.representations.clear(),null===(t=this.sourceBufferTaskQueue)||void 0===t||t.destroy(),this.gapDetectionIdleCallback&&window.cancelIdleCallback&&window.cancelIdleCallback(this.gapDetectionIdleCallback),this.initLoadIdleCallback&&window.cancelIdleCallback&&window.cancelIdleCallback(this.initLoadIdleCallback),this.subscription.unsubscribe(),this.sourceBuffer&&'open'===this.mediaSource.readyState&&(this.abortBuffer(),this.mediaSource.removeSourceBuffer(this.sourceBuffer)),this.sourceBuffer=null,this.downloadAbortController.abort(),this.destroyAbortController.abort()}selectForwardBufferSegments(t,e,i){const s=t.findIndex((({status:t,time:{from:e,to:s}})=>t===ad.NONE&&(e>i||e<=i&&s>=i)&&s<=i+this.forwardBufferTarget));if(-1===s)return[];if(e!==rd.BYTE_RANGE)return t.slice(s,s+1);const r=t;let a=0;const n=[];for(let t=s;t<r.length&&a<=this.tuning.dash.segmentRequestSize;t++){const e=r[t];if(a+=e.byte.to+1-e.byte.from,e.status!==ad.NONE)break;n.push(e)}return n}async loadSegments(t,e,i='auto'){if(!t.length)return;let s,r,a=t;const{type:o}=e.segmentReference;switch(o){case rd.BYTE_RANGE:s=e.segmentReference.url,r={from:yo(t,0).byte.from,to:yo(t,-1).byte.to};break;case rd.TEMPLATE:{const i=yo(t,0);s=new URL(i.url,e.segmentReference.baseUrl).toString(),a=[i];break}default:n(o)}for(const t of a)t.status=ad.DOWNLOADING,this.activeSegments.add({segment:t,loadedBytes:0,fedBytes:0,representationId:e.id});const{signal:d}=this.downloadAbortController;if(this.failedDownloads&&(await T(d,async function*(){const t=E(this.failedDownloads,this.tuning.downloadBackoff);yield new Promise((e=>setTimeout(e,t)))}.bind(this))(),d.aborted))for(const e of this.activeSegments)t.includes(e.segment)&&this.abortSegment(e.segment);this.fetcher.fetch(s,{rangeMethod:md.PARAM,range:r,onProgress:(t,i)=>{if(!d.aborted)try{this.onSomeDataLoaded(t,e.id,r?r.from:0,i,d)}catch(t){this.error$.next({id:'SegmentFeeding',message:'Error when feeding segments',thrown:t})}},signal:d,priority:i}).then((()=>this.failedDownloads=0),(e=>{for(const e of this.activeSegments)t.includes(e.segment)&&this.abortSegment(e.segment);this.onSegmentDownloadError(e)}))}onSegmentDownloadError(t){var e;let i=!1;const r=this.getCurrentPosition();if(this.sourceBuffer&&s(r)){i=Wo(null===(e=this.sourceBuffer)||void 0===e?void 0:e.buffered,r)>=this.tuning.downloadBackoff.bufferThreshold}this.failedDownloads++,i||this.error$.next({id:'SegmentDownload',message:'Error when fetching segments',thrown:t})}onSomeDataLoaded(t,e,i,s,r){if(!this.activeSegments.size)return;const a=t=>{this.abortSegment(t.segment)},n=t=>{var i;this.playingRepresentationId=e,this.playingRepresentation$.next(this.playingRepresentationId),t.segment.status=ad.FED,'size'in t.segment&&(t.segment.size=t.fedBytes);for(const s of this.representations.values())if(s.id!==e)for(const e of null!==(i=this.segments.get(s.id))&&void 0!==i?i:[])e.status===ad.FED&&e.time.from===t.segment.time.from&&e.time.to===t.segment.time.to&&(e.status=ad.NONE);this.activeSegments.delete(t),this.detectGapsWhenIdle(e,[t.segment])},o=this.representations.get(e);if(!o)return;const d=o.segmentReference.type,u=t.byteLength;for(const o of this.activeSegments){const{segment:h}=o,l=d===rd.BYTE_RANGE,c=l?h.byte.to-h.byte.from+1:u;if(o.representationId!==e)continue;if(!(!l||h.byte.from>=i&&h.byte.to<i+t.byteLength))continue;if(r.aborted){a(o);continue}const p=l?h.byte.from-i:0,m=p<s,f=(l?h.byte.to-i:t.byteLength)<=s;if(h.status===ad.DOWNLOADING&&m&&f){h.status=ad.DOWNLOADED,this.activeSegments.delete(o);const e=new DataView(t.buffer,t.byteOffset+p,c);this.sourceBufferTaskQueue.append(e,r).then((t=>t&&!r.aborted?n(o):a(o)))}else if(this.tuning.dash.enableSubSegmentBufferFeeding&&m&&(o.loadedBytes=Math.min(c,s-p),o.loadedBytes>o.fedBytes)){const e=new DataView(t.buffer,t.byteOffset+p+o.fedBytes,o.loadedBytes-o.fedBytes),i=o.loadedBytes===c?e:this.containerParser.parseFeedableSegmentChunk(e);(null==i?void 0:i.byteLength)&&(h.status=ad.PARTIALLY_FED,o.fedBytes+=i.byteLength,this.sourceBufferTaskQueue.append(i,r).then((t=>{!t||r.aborted?a(o):o.fedBytes===c&&n(o)})))}}}abortSegment(t){t.status===ad.PARTIALLY_FED?(this.sourceBufferTaskQueue.remove(t.time.from,t.time.to).then((()=>t.status=ad.NONE)),t.status=ad.NONE):t.status=ad.NONE;for(const e of this.activeSegments.values())if(e.segment===t){this.activeSegments.delete(e);break}}loadNextInit(){if(this.allInitsLoaded||this.initLoadIdleCallback)return;let t=null,e=!1;for(const[i,s]of this.initData.entries()){const r=s instanceof Promise;e||(e=r),null===s&&(t=i)}if(!t)return void(this.allInitsLoaded=!0);if(e)return;const i=this.representations.get(t);i&&(this.initLoadIdleCallback=dd((()=>this.loadInit(i,'low',!1).finally((()=>this.initLoadIdleCallback=null)))))}async loadInit(t,e='auto',i=!1){const s=this.tuning.dash.useFetchPriorityHints?e:'auto',r=(!i&&this.failedDownloads>0?T(this.destroyAbortController.signal,async function*(){const t=E(this.failedDownloads,this.tuning.downloadBackoff);yield new Promise((e=>setTimeout(e,t)))}.bind(this))():Promise.resolve()).then((()=>this.fetcher.fetchRepresentation(t.segmentReference,this.containerParser,s))).then((e=>{if(!e)return;const{dataView:i,segments:s}=e,r=i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength);this.initData.set(t.id,r),this.segments.set(t.id,s)})).then((()=>this.failedDownloads=0),(e=>{this.initData.set(t.id,null),i&&this.error$.next({id:'LoadInits',message:'loadInit threw',thrown:e})}));return this.initData.set(t.id,r),r}async pruneBuffer(t){const e=this.getCurrentPosition();if(!this.sourceBuffer||!this.playingRepresentationId||r(e))return!1;if(this.sourceBuffer.updating)return!1;const i=this.segments.get(this.playingRepresentationId);if(!i)return!1;let s=0,a=1/0,n=-1/0,o=!1;const d=t=>{var e;a=Math.min(a,t.time.from),n=Math.max(n,t.time.to);const i='size'in t?null!==(e=t.size)&&void 0!==e?e:0:t.byte.to-t.byte.from;s+=i};for(const r of i){if(r.time.to>=e||s>=t)break;r.status===ad.FED&&d(r)}if(o=isFinite(a)&&isFinite(n),!o){s=0,a=1/0,n=-1/0;for(const r of i){if(r.time.from<e+this.forwardBufferTarget||s>t)break;r.status===ad.FED&&d(r)}}return o=isFinite(a)&&isFinite(n),!!o&&this.sourceBufferTaskQueue.remove(a/1e3,n/1e3)}abortBuffer(){if(!this.sourceBuffer||'open'!==this.mediaSource.readyState)return;const t=this.playingRepresentationId&&this.initData.get(this.playingRepresentationId),e=t instanceof ArrayBuffer?t:void 0;this.sourceBufferTaskQueue.abort(e)}detectGaps(t,e){if(this.sourceBuffer)for(const i of e){let e={representation:t,from:i.time.from,to:i.time.to};for(let t=0;t<this.sourceBuffer.buffered.length;t++){const s=1e3*this.sourceBuffer.buffered.start(t),r=1e3*this.sourceBuffer.buffered.end(t);if(!(r<=i.time.from||s>=i.time.to)){if(s<=i.time.from&&r>=i.time.to){e=void 0;break}r>i.time.from&&r<i.time.to&&(e.from=r),s<i.time.to&&s>i.time.from&&(e.to=s)}}e&&e.to-e.from>=1&&this.gaps.push(e)}}detectGapsWhenIdle(t,e){this.gapDetectionIdleCallback||(this.gapDetectionIdleCallback=dd((()=>{try{this.detectGaps(t,e)}catch(t){this.error$.next({id:'GapDetection',message:'detectGaps threw',thrown:t})}finally{this.gapDetectionIdleCallback=null}})))}checkEjectedSegments(){if(r(this.sourceBuffer)||r(this.playingRepresentationId))return;const t=[];for(let e=0;e<this.sourceBuffer.buffered.length;e++){const i=1e3*this.sourceBuffer.buffered.start(e),s=1e3*this.sourceBuffer.buffered.end(e);t.push({from:i,to:s})}const e=this.tuning.dash.segmentTimelineTolerance;for(const i of this.segments.values())for(const s of i){const i=t.some((t=>t.from-e<=s.time.from&&t.to+e>=s.time.to));s.status!==ad.FED||i||(s.status=ad.NONE)}}}const Cd=t=>{if(!t.startsWith('P'))return;const e=(t,e)=>{const i=t?parseFloat(t.replace(',','.')):NaN;return(isNaN(i)?0:i)*e},i=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/.exec(t),s='-'===(null==i?void 0:i[1])?-1:1;return 24*e(null==i?void 0:i[5],s)*60*60*1e3+60*e(null==i?void 0:i[6],s)*60*1e3+60*e(null==i?void 0:i[7],s)*1e3+1e3*e(null==i?void 0:i[8],s)},Id=(t,e)=>{let i=t;i=i.replaceAll('$$','$');const s={RepresentationID:e.representationId,Number:e.segmentNumber,Bandwidth:e.bandwidth,Time:e.segmentTime};for(const[t,e]of Object.entries(s)){const s=new RegExp(`\\$${t}(?:%0(\\d+)d)?\\$`,'g');i=i.replaceAll(s,((t,i)=>r(e)?t:r(i)?e:e.padStart(parseInt(i,10),'0')))}return i},Ld=['timeupdate','progress','play','seeked','stalled'];var xd,Nd;!function(t){t.NONE='none',t.MANIFEST_LOADED='manifest_loaded',t.REPRESENTATION_SELECTED='representation_selected'}(xd||(xd={}));class Od{constructor(r){this.element=null,this.source=null,this.manifest=null,this.subscription=new i,this.state$=new z(xd.NONE),this.currentVideoRepresentation$=new t(void 0),this.error$=new e,this.lastConnectionType$=new t(void 0),this.lastConnectionReused$=new t(void 0),this.lastRequestFirstBytes$=new t(void 0),this.forceEnded$=new e,this.gapWatchdogStarted=!1,this.destroyController=new it,this.initManifest=T(this.destroyController.signal,async function*(t,e){this.element=t,this.state$.startTransitionTo(xd.MANIFEST_LOADED);const i=yield this.fetcher.fetchManifest(e).catch((t=>this.error$.next({id:'LoadManifest',message:'Failed to load manifest',thrown:t})));if(!i)return null;let r;try{r=((t,e)=>{var i,r,a,n,o,d,u,h,l,c,p,m,f,v,S,g,b,y,T,E,w,$,k,A,P,R,D,_,C,I,L,x,N,O,B;const M={video:[],audio:[],text:[]},U=(new DOMParser).parseFromString(t,'application/xml').children[0],V=U.getElementsByTagName('Period')[0],q=V.children;let F;const H=U.getAttribute('mediaPresentationDuration'),G=V.getAttribute('duration');if(H)F=Cd(H);else if(G){const t=Cd(G);s(t)&&(F=t)}let Y=0;const z=null!==(r=null===(i=U.getAttribute('profiles'))||void 0===i?void 0:i.split(','))&&void 0!==r?r:[],Q=z.includes(sd.WEBM_AS_IN_FFMPEG)||z.includes(sd.WEBM_AS_IN_SPEC)?nd.WEBM:nd.MP4;for(const t of q){const i=t.getAttribute('mimeType'),s=t.getAttribute('codecs'),r=null!==(a=t.getAttribute('contentType'))&&void 0!==a?a:null==i?void 0:i.split('/')[0],U=null!==(o=null===(n=t.getAttribute('profiles'))||void 0===n?void 0:n.split(','))&&void 0!==o?o:[],V=t.querySelectorAll('Representation');if('text'!==r)for(const a of V){const n=null!==(d=a.getAttribute('mimeType'))&&void 0!==d?d:i,o=null!==(h=null!==(u=a.getAttribute('codecs'))&&void 0!==u?u:s)&&void 0!==h?h:'',V=null!==(c=null!==(l=a.getAttribute('contentType'))&&void 0!==l?l:null==n?void 0:n.split('/')[0])&&void 0!==c?c:r,q=null!==(m=null===(p=t.getAttribute('profiles'))||void 0===p?void 0:p.split(','))&&void 0!==m?m:[],H=parseInt(null!==(f=a.getAttribute('width'))&&void 0!==f?f:'',10),G=parseInt(null!==(v=a.getAttribute('height'))&&void 0!==v?v:'',10),Q=parseInt(null!==(S=a.getAttribute('bandwidth'))&&void 0!==S?S:'',10)/1e3,j=null!==(g=a.getAttribute('frameRate'))&&void 0!==g?g:'',W=null!==(b=a.getAttribute('quality'))&&void 0!==b?b:void 0,J=j?vo(j):void 0,X=`${null!==(y=a.getAttribute('id'))&&void 0!==y?y:(Y++).toString(10)}@${'video'===V?`${G}p`:'audio'===V?`${Q}Kbps`:o}`,K=null!==(w=null===(E=null===(T=a.querySelector('BaseURL'))||void 0===T?void 0:T.textContent)||void 0===E?void 0:E.trim())&&void 0!==w?w:'',Z=new URL(K,e).toString(),tt=[...z,...U,...q];let et;const it=a.querySelector('SegmentBase'),st=a.querySelector('SegmentTemplate');if(it){const t=null!==(k=null===($=a.querySelector('SegmentBase Initialization'))||void 0===$?void 0:$.getAttribute('range'))&&void 0!==k?k:'',[e,i]=t.split('-').map((t=>parseInt(t,10))),s={from:e,to:i},r=null===(A=a.querySelector('SegmentBase'))||void 0===A?void 0:A.getAttribute('indexRange'),[n,o]=r?r.split('-').map((t=>parseInt(t,10))):[],d=r?{from:n,to:o}:void 0;et={type:rd.BYTE_RANGE,url:Z,initRange:s,indexRange:d}}else{if(!st)throw new ReferenceError('Unknown MPD segment referencing type');{const t={representationId:null!==(P=a.getAttribute('id'))&&void 0!==P?P:void 0,bandwidth:null!==(R=a.getAttribute('bandwidth'))&&void 0!==R?R:void 0},e=parseInt(null!==(D=st.getAttribute('timescale'))&&void 0!==D?D:'',10),i=null!==(_=st.getAttribute('initialization'))&&void 0!==_?_:'',s=st.getAttribute('media'),r=null!==(I=parseInt(null!==(C=st.getAttribute('startNumber'))&&void 0!==C?C:'',10))&&void 0!==I?I:1,n=Id(i,t);if(!s)throw new ReferenceError('No media attribute in SegmentTemplate');const o=null!==(L=st.querySelectorAll('SegmentTimeline S'))&&void 0!==L?L:[],d=[];let u=r,h=0;for(const i of o){const r=1e3*parseInt(null!==(x=i.getAttribute('d'))&&void 0!==x?x:'',10),a=parseInt(null!==(N=i.getAttribute('r'))&&void 0!==N?N:'',10)||0,n=null!==(B=parseInt(null!==(O=i.getAttribute('t'))&&void 0!==O?O:'',10))&&void 0!==B?B:void 0;for(let i=0;i<a+1;i++){const i=Id(s,{...t,segmentNumber:u.toString(10),segmentTime:n.toString(10)}),a=n?n/e:h;h+=r/e;const o=h;u++,d.push({time:{from:a,to:o},url:i})}}et={type:rd.TEMPLATE,baseUrl:Z,initUrl:n,segments:d}}}if(!V||!n)continue;const rt={video:id.VIDEO,audio:id.AUDIO,text:id.TEXT}[V];rt&&M[rt].push({id:X,kind:rt,segmentReference:et,profiles:tt,duration:F,bitrate:Q,mime:n,codecs:o,width:H,height:G,fps:J,quality:W})}}return{duration:F,container:Q,representations:M}})(null!=i?i:'',e)}catch(t){this.error$.next({id:'ManifestParsing',message:'Failed to parse MPD manifest',thrown:t})}if(!r)return null;const a=({mime:e,codecs:i})=>{var s,r,a;return Boolean((null===(s=t.canPlayType)||void 0===s?void 0:s.call(t,e))&&(null===(a=null===(r=window.MediaSource)||void 0===r?void 0:r.isTypeSupported)||void 0===a?void 0:a.call(r,`${e}; codecs="${i}"`)))};return this.manifest={...r,representations:to(Object.entries(r.representations).map((([t,e])=>[t,e.filter(a)])))},this.manifest.representations.video.length?this.state$.setState(xd.MANIFEST_LOADED):this.error$.next({id:'NoRepresentations',message:'No playable video representations'}),this.manifest}.bind(this)),this.initRepresentations=T(this.destroyController.signal,async function*(t,e){c(this.manifest),c(this.element),this.state$.startTransitionTo(xd.REPRESENTATION_SELECTED),this.source=new MediaSource,this.element.src=URL.createObjectURL(this.source);const i={fetcher:this.fetcher,tuning:this.tuning,getCurrentPosition:()=>this.element?1e3*this.element.currentTime:void 0};this.videoBufferManager=new _d(id.VIDEO,this.source,this.manifest.container,this.manifest.representations.video,i),this.bufferManagers=[this.videoBufferManager],s(e)&&(this.audioBufferManager=new _d(id.AUDIO,this.source,this.manifest.container,this.manifest.representations.audio,i),this.bufferManagers.push(this.audioBufferManager)),this.subscription.add(this.fetcher.lastConnectionType$.subscribe(this.lastConnectionType$)),this.subscription.add(this.fetcher.lastConnectionReused$.subscribe(this.lastConnectionReused$)),this.subscription.add(this.fetcher.lastRequestFirstBytes$.subscribe(this.lastRequestFirstBytes$));const r=o(...this.bufferManagers.map((t=>t.fullyBuffered$))).pipe(u((()=>this.bufferManagers.every((t=>t.fullyBuffered$.getValue()))))),n=o(...this.bufferManagers.map((t=>t.onLastSegment$))).pipe(u((()=>this.bufferManagers.some((t=>t.onLastSegment$.getValue())))));this.subscription.add(o(this.forceEnded$,y({allBuffersFull:r,someBufferEnded:n}).pipe(f((({allBuffersFull:t,someBufferEnded:e})=>t&&e)))).subscribe((()=>{var t;if(this.source&&'open'===this.source.readyState&&Array.from(this.source.sourceBuffers).every((t=>!t.updating)))try{null===(t=this.source)||void 0===t||t.endOfStream()}catch(t){this.error$.next({id:'EndOfStream',message:'Failed to end MediaSource stream',thrown:t})}}))),this.subscription.add(o(...this.bufferManagers.map((t=>t.error$))).subscribe(this.error$)),this.subscription.add(this.videoBufferManager.playingRepresentation$.subscribe(this.currentVideoRepresentation$)),'open'!==this.source.readyState&&(yield new Promise((t=>{var e;return null===(e=this.source)||void 0===e?void 0:e.addEventListener('sourceopen',t)}))),s(this.manifest.duration)&&(this.source.duration=this.manifest.duration/1e3),this.audioBufferManager&&s(e)?yield Promise.all([this.videoBufferManager.startWith(t),this.audioBufferManager.startWith(e)]):yield this.videoBufferManager.startWith(t),this.state$.setState(xd.REPRESENTATION_SELECTED),c(this.element),this.subscription.add(o(...Ld.map((t=>a(this.element,t))),a(window,'online')).subscribe(this.tick,(t=>{this.error$.next({id:'DashVKPlayer',message:'Internal logic error',thrown:t})}))),this.subscription.add(a(this.element,'progress').subscribe((()=>{this.element&&2===this.element.readyState&&!this.element.seeking&&(this.element.currentTime=this.element.currentTime)}))),this.subscription.add(a(this.element,'waiting').subscribe((()=>{this.element&&2===this.element.readyState&&!this.element.seeking&&od(this.element.buffered,1e3*this.element.currentTime)&&(this.element.currentTime=this.element.currentTime)}))),this.tick()}.bind(this)),this.tick=()=>{var t,e;if(!this.element||!this.videoBufferManager)return;const i=1e3*this.element.currentTime;this.videoBufferManager.maintain(i),null===(t=this.audioBufferManager)||void 0===t||t.maintain(i),!this.videoBufferManager.gaps.length&&!(null===(e=this.audioBufferManager)||void 0===e?void 0:e.gaps.length)||this.gapWatchdogStarted||(this.gapWatchdogStarted=!0,this.gapWatchdogSubscription=w(this.tuning.gapWatchdogInterval).subscribe((()=>this.jumGap()),(t=>{this.error$.next({id:'GapWatchdog',message:'Error handling gaps',thrown:t})})),this.subscription.add(this.gapWatchdogSubscription))},this.throughputEstimator=r.throughputEstimator,this.tuning=r.tuning,this.fetcher=new fd({throughputEstimator:this.throughputEstimator,requestQuic:this.tuning.requestQuick})}async switchRepresentation(t,e){const i={[id.VIDEO]:this.videoBufferManager,[id.AUDIO]:this.audioBufferManager,[id.TEXT]:null}[t];return null==i?void 0:i.switchTo(e)}seek(t,e){var i,s,r,a,n;let o;c(this.element),c(this.videoBufferManager),o=e||1e3*this.element.duration<=this.tuning.dashSeekInSegmentDurationThreshold||Math.abs(1e3*this.element.currentTime-t)<=this.tuning.dashSeekInSegmentAlwaysSeekDelta?t:Math.max(null!==(i=this.videoBufferManager.findSegmentStartTime(t))&&void 0!==i?i:t,null!==(r=null===(s=this.audioBufferManager)||void 0===s?void 0:s.findSegmentStartTime(t))&&void 0!==r?r:t),od(this.element.buffered,o)||(this.videoBufferManager.abort(),null===(a=this.audioBufferManager)||void 0===a||a.abort()),this.videoBufferManager.maintain(o),null===(n=this.audioBufferManager)||void 0===n||n.maintain(o),this.element.currentTime=o/1e3}stop(){var t,e;this.element=null,this.source=null,this.manifest=null,this.currentVideoRepresentation$.next(void 0),null===(t=this.videoBufferManager)||void 0===t||t.destroy(),this.videoBufferManager=null,null===(e=this.audioBufferManager)||void 0===e||e.destroy(),this.audioBufferManager=null,this.bufferManagers=[],this.state$.setState(xd.NONE)}setBufferTarget(t){for(const e of this.bufferManagers)e.setTarget(t)}destroy(){this.subscription.unsubscribe(),this.destroyController.abort(),this.fetcher.destroy(),this.stop(),this.source=null}jumGap(){if(!this.element||!this.videoBufferManager)return;const t=1e3*this.element.currentTime,e=1===this.element.readyState?this.tuning.endGapTolerance:0;for(const i of this.bufferManagers)for(const s of i.gaps)if(i.playingRepresentation$.getValue()===s.representation&&s.from-e<=t&&s.to+e>t){if(1e3*this.element.duration-s.to<this.tuning.endGapTolerance)return this.forceEnded$.next(),this.gapWatchdogSubscription.unsubscribe(),void(this.gapWatchdogStarted=!1);this.element.currentTime=s.to/1e3;break}}}!function(t){t.STOPPED='stopped',t.READY='ready',t.PLAYING='playing',t.PAUSED='paused'}(Nd||(Nd={}));const Bd=({id:t,width:e,height:i,bitrate:s,fps:r,quality:a})=>{var n;const o=null!==(n=a?No(a):void 0)&&void 0!==n?n:G({width:e,height:i});return o&&{id:t,quality:o,bitrate:s,size:{width:e,height:i},fps:r}},Md=(t,e,i)=>{var s;const r=e.indexOf(i);return null!==(s=yo(t,Math.round(t.length*r/e.length)))&&void 0!==s?s:yo(t,-1)};class Ud{constructor(e){this.subscription=new i,this.videoState=new z(Nd.STOPPED),this.elementSize$=new t(void 0),this.textTracksManager=new ho,this.videoTracks=[],this.audioRepresentations=new Map,this.videoTrackSwitchHistory=new Po,this.syncPlayback=()=>{const t=this.videoState.getState(),e=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),s=this.params.desiredState.seekState.getState();if(!this.videoState.getTransition())if(s.state===L.Requested&&(null==i?void 0:i.to)!==P.PAUSED&&t!==Nd.STOPPED&&e!==P.STOPPED&&this.seek(s.position,s.forcePrecise),e!==P.STOPPED){if(t===Nd.STOPPED)return this.videoState.startTransitionTo(Nd.READY),void this.prepare();switch(t){case Nd.READY:return void(e===P.PAUSED?(this.videoState.setState(Nd.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED)):e===P.PLAYING&&(this.videoState.startTransitionTo(Nd.PLAYING),this.playIfAllowed()));case Nd.PLAYING:return void(e===P.PAUSED?(this.videoState.startTransitionTo(Nd.PAUSED),this.video.pause()):(null==i?void 0:i.to)===P.PLAYING&&U(this.params.desiredState.playbackState,P.PLAYING));case Nd.PAUSED:return void(e===P.PLAYING?(this.videoState.startTransitionTo(Nd.PLAYING),this.playIfAllowed()):(null==i?void 0:i.to)===P.PAUSED&&U(this.params.desiredState.playbackState,P.PAUSED));default:return n(t)}}else t!==Nd.STOPPED&&(this.videoState.startTransitionTo(Nd.STOPPED),this.player.stop(),this.video.setAttribute('src',''),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(Nd.STOPPED),U(this.params.desiredState.playbackState,P.STOPPED,!0))},this.params=e,this.video=lo(this.params.container),this.params.output.element$.next(this.video),this.params.output.availableVideoTracks$.next([]),this.params.output.hostname$.next(Do(this.params.source.url)),this.params.output.isLive$.next(!1),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.player=new Od({throughputEstimator:this.params.dependencies.throughputEstimator,tuning:this.params.tuning}),this.subscribe()}subscribe(){const{output:t,desiredState:e}=this.params,i=fo(this.video),r=e=>{t.error$.next({id:'DashVKProvider',message:'DashVKProvider internal logic error',thrown:e})},n=(t,e)=>this.subscription.add(t.subscribe(e,r));n(i.timeUpdate$,t.position$),n(i.durationChange$,t.duration$),n(i.ended$,t.endedEvent$),n(i.looped$,t.loopedEvent$),n(i.error$,t.error$),n(i.isBuffering$,t.isBuffering$),n(i.currentBuffer$,t.currentBuffer$),n(i.playing$,t.firstFrameEvent$),n(i.canplay$,t.canplay$),n(this.player.error$,t.error$),n(this.player.lastConnectionType$,t.httpConnectionType$),n(this.player.lastConnectionReused$,t.httpConnectionReused$),n(this.player.lastRequestFirstBytes$.pipe(f(s),b(),v(void 0)),t.firstBytesEvent$),this.subscription.add(i.seeked$.subscribe(t.seekedEvent$,r)),this.subscription.add(ao(this.video,e.isLooped,r)),this.subscription.add(no(this.video,e.volume,i.volumeState$,r)),this.subscription.add(i.volumeState$.subscribe(this.params.output.volume$,r)),this.subscription.add(oo(this.video,e.playbackRate,i.playbackRateState$,r)),n(_o(this.video),this.elementSize$),this.subscription.add(i.playing$.subscribe((()=>{this.videoState.setState(Nd.PLAYING),U(e.playbackState,P.PLAYING)}),r)).add(i.pause$.subscribe((()=>{this.videoState.setState(Nd.PAUSED),U(e.playbackState,P.PAUSED)}),r)).add(i.canplay$.subscribe((()=>{this.videoState.getState()===Nd.PLAYING&&this.playIfAllowed()}),r)),this.subscription.add(this.player.state$.stateChangeEnded$.pipe(f((({to:t})=>t===xd.REPRESENTATION_SELECTED))).subscribe((()=>{this.videoState.setState(Nd.READY)})));const d=e=>t.error$.next({id:'RepresentationSwitch',message:'Switching representations threw',thrown:e});this.subscription.add(o(this.player.state$.stateChangeEnded$,e.videoTrack.stateChangeStarted$,e.autoVideoTrackSwitching.transitionStarted$,this.params.dependencies.throughputEstimator.rttAdjustedThroughput$,e.autoVideoTrackLimits.stateChangeEnded$,this.elementSize$,a(this.video,'progress')).subscribe((()=>{var i,s,r,a,n,o,u,h;const l=this.player.state$.getState(),p=this.player.state$.getTransition();if(l===xd.NONE||!this.videoTracks.length)return;const m=l===xd.MANIFEST_LOADED&&!p,f=l===xd.REPRESENTATION_SELECTED&&!p,v=e.autoVideoTrackSwitching.getState(),S=e.videoTrack.getState(),g=null===(i=this.videoTracks.find((({track:{id:t}})=>t===S)))||void 0===i?void 0:i.track,b=t.currentVideoTrack$.getValue(),y=Wo(this.video.buffered,1e3*this.video.currentTime),T=v?this.params.tuning.dash.forwardBufferTargetAuto:this.params.tuning.dash.forwardBufferTargetManual,E=Math.min(y/Math.min(T,(1e3*this.video.duration||1/0)-1e3*this.video.currentTime),1),w=Math.max(g&&!v&&null!==(r=null===(s=this.audioRepresentations.get(g.id))||void 0===s?void 0:s.bitrate)&&void 0!==r?r:0,b&&null!==(n=null===(a=this.audioRepresentations.get(b.id))||void 0===a?void 0:a.bitrate)&&void 0!==n?n:0),$=Ro(this.videoTracks.map((({track:t})=>t)),{container:this.elementSize$.getValue(),throughput:this.params.dependencies.throughputEstimator.rttAdjustedThroughput$.getValue(),tuning:this.params.tuning.autoTrackSelection,limits:e.autoVideoTrackLimits.getState(),reserve:w,forwardBufferHealth:E,current:b,history:this.videoTrackSwitchHistory,playbackRate:this.video.playbackRate}),k=v?null!=$?$:g:null!=g?g:$;if(e.autoVideoTrackSwitching.getTransition()&&(e.autoVideoTrackSwitching.setState(v),this.player.setBufferTarget(T)),m){const t=k&&(null===(o=this.videoTracks.find((({track:t})=>t===k)))||void 0===o?void 0:o.representation);c(t),this.player.initRepresentations(t.id,null===(u=this.audioRepresentations.get(t.id))||void 0===u?void 0:u.id)}else if(f){const t=k&&(null===(h=this.videoTracks.find((({track:t})=>t===k)))||void 0===h?void 0:h.representation);if(t){const e=this.audioRepresentations.get(t.id);this.player.switchRepresentation(id.VIDEO,t.id).catch(d),e&&this.player.switchRepresentation(id.AUDIO,e.id).catch(d)}}}),r)),this.subscription.add(this.player.currentVideoRepresentation$.pipe(l(),u((t=>{var e;return t&&(null===(e=this.videoTracks.find((({representation:{id:e}})=>e===t)))||void 0===e?void 0:e.track)}))).subscribe(t.currentVideoTrack$,r)),this.textTracksManager.connect(this.video,e,t);const m=o(e.playbackState.stateChangeStarted$,e.videoTrack.stateChangeStarted$,e.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,h(['init'])).pipe(p(0));this.subscription.add(m.subscribe(this.syncPlayback,r))}async prepare(){const t=await this.player.initManifest(this.video,this.params.source.url);if(!t)return;this.videoTracks=[];const e=Array.from(t.representations.audio).sort(((t,e)=>e.bitrate-t.bitrate)),i=Array.from(t.representations.video).sort(((t,e)=>e.bitrate-t.bitrate));for(const t of i){const s=Bd(t);if(s){this.videoTracks.push({track:s,representation:t});const r=Md(e,i,t);r&&this.audioRepresentations.set(t.id,r)}}this.params.output.availableVideoTracks$.next(this.videoTracks.map((({track:t})=>t)))}seek(t,e){this.params.output.willSeekEvent$.next(),this.player.seek(t,e)}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.video.remove(),this.params.output.element$.next(void 0),this.player.destroy()}playIfAllowed(){Oo(this.video).then((t=>{t||(this.videoState.setState(Nd.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED,!0))}))}}const Vd={};var qd;!function(t){t.INITIALIZING='initializing',t.STOPPED='stopped',t.READY='ready',t.PLAYING='playing',t.PAUSED='paused'}(qd||(qd={}));const Fd=(t,e)=>new g((i=>{const s=(t,e)=>i.next(e);return t.on(e,s),()=>t.off(e,s)}));class Hd{constructor(t){this.subscription=new i,this.videoState=new z(qd.INITIALIZING),this.textTracksManager=new ho,this.trackLevels=new Map,this.syncPlayback=()=>{const t=this.videoState.getState(),e=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),s=this.params.desiredState.seekState.getState();if(t!==qd.INITIALIZING)switch((null==i?void 0:i.to)!==P.PAUSED&&s.state===L.Requested&&this.seek(s.position),e){case P.STOPPED:switch(t){case qd.STOPPED:break;case qd.READY:case qd.PLAYING:case qd.PAUSED:this.stop();break;default:n(t)}break;case P.PLAYING:switch(t){case qd.PLAYING:break;case qd.STOPPED:this.prepare();break;case qd.READY:case qd.PAUSED:this.playIfAllowed();break;default:n(t)}break;case P.PAUSED:switch(t){case qd.PAUSED:break;case qd.STOPPED:this.prepare();break;case qd.READY:this.videoState.setState(qd.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED);break;case qd.PLAYING:this.pause();break;default:n(t)}break;default:n(e)}},this.video=lo(t.container),this.params=t,this.params.output.element$.next(this.video),this.params.output.isLive$.next(!1),this.params.output.hostname$.next(Do(this.params.source.url)),this.loadHlsJs()}destroy(){var t,e;this.subscription.unsubscribe(),this.trackLevels.clear(),this.textTracksManager.destroy(),null===(t=this.hls)||void 0===t||t.detachMedia(),null===(e=this.hls)||void 0===e||e.destroy(),this.video.remove(),this.params.output.element$.next(void 0)}loadHlsJs(){let t=!1;const e=e=>{t||this.params.output.error$.next({id:'timeout'===e?'HlsJsTimeout':'HlsJsLoadError',message:'Failed to load Hls.js',thrown:e}),t=!0},i=window.setTimeout((()=>e('timeout')),5e3);import('hls.js').then((e=>{t||(Vd.Hls=e.default,Vd.Events=e.default.Events,this.init())}),e).finally((()=>{window.clearTimeout(i),t=!0}))}init(){c(Vd.Hls,'hls.js not loaded'),this.hls=new Vd.Hls({fragLoadingMaxRetry:5,levelLoadingMaxRetry:2,manifestLoadingMaxRetry:2,fragLoadingMaxRetryTimeout:16e3,manifestLoadingMaxRetryTimeout:2e3,levelLoadingMaxRetryTimeout:2e3}),this.subscribe(),this.videoState.setState(qd.STOPPED)}subscribe(){c(Vd.Events,'hls.js not loaded');const{desiredState:t,output:e}=this.params,i=t=>{e.error$.next({id:'HlsJsProvider',message:'HlsJsProvider internal logic error',thrown:t})},a=fo(this.video),n=(t,e)=>this.subscription.add(t.subscribe(e,i));n(a.timeUpdate$,e.position$),n(a.durationChange$,e.duration$),n(a.ended$,e.endedEvent$),n(a.looped$,e.loopedEvent$),n(a.error$,e.error$),n(a.isBuffering$,e.isBuffering$),n(a.currentBuffer$,e.currentBuffer$),n(a.loadStart$,e.firstBytesEvent$),n(a.playing$,e.firstFrameEvent$),n(a.canplay$,e.canplay$),n(a.seeked$,e.seekedEvent$),this.subscription.add(ao(this.video,t.isLooped,i)),this.subscription.add(no(this.video,t.volume,a.volumeState$,i)),this.subscription.add(a.volumeState$.subscribe(this.params.output.volume$)),this.subscription.add(oo(this.video,t.playbackRate,a.playbackRateState$,i)),this.subscription.add(Fd(this.hls,Vd.Events.ERROR).subscribe((t=>{var i;t.fatal&&e.error$.next({id:['HlsJsFatal',t.type,t.details].join('_'),message:`HlsJs fatal ${t.type} ${t.details}, ${null===(i=t.err)||void 0===i?void 0:i.message} ${t.reason}`,thrown:t.error})}))),this.subscription.add(a.playing$.subscribe((()=>{this.videoState.setState(qd.PLAYING),U(t.playbackState,P.PLAYING)}),i)).add(a.pause$.subscribe((()=>{this.videoState.setState(qd.PAUSED),U(t.playbackState,P.PAUSED)}),i)).add(a.canplay$.subscribe((()=>{var t;(null===(t=this.videoState.getTransition())||void 0===t?void 0:t.to)===qd.READY&&this.videoState.setState(qd.READY),this.videoState.getState()===qd.PLAYING&&this.playIfAllowed()}),i)),n(Fd(this.hls,Vd.Events.MANIFEST_PARSED).pipe(u((({levels:t})=>t.reduce(((t,e)=>{var i,s;const r=e.name||e.height.toString(10),{width:a,height:n}=e,o=null!==(s=No(null!==(i=e.attrs.QUALITY)&&void 0!==i?i:''))&&void 0!==s?s:G({width:a,height:n});if(!o)return t;const d=e.attrs['FRAME-RATE']?parseFloat(e.attrs['FRAME-RATE']):void 0,u={id:r.toString(),quality:o,bitrate:e.bitrate/1e3,size:{width:a,height:n},fps:d};return this.trackLevels.set(r,{track:u,level:e}),t.push(u),t}),[])))),e.availableVideoTracks$),n(Fd(this.hls,Vd.Events.LEVEL_LOADING).pipe(u((({url:t})=>Do(t)))),e.hostname$),this.subscription.add(ro(t.autoVideoTrackSwitching,(()=>this.hls.autoLevelEnabled),(t=>{this.hls.nextLevel=t?-1:this.hls.currentLevel,this.hls.loadLevel=t?-1:this.hls.loadLevel}),{onError:i}));const d=t=>{var e;return null===(e=Array.from(this.trackLevels.values()).find((({level:e})=>e===t)))||void 0===e?void 0:e.track},l=Fd(this.hls,Vd.Events.LEVEL_SWITCHED).pipe(u((({level:t})=>d(this.hls.levels[t]))));l.pipe(f(s)).subscribe(e.currentVideoTrack$,i),this.subscription.add(ro(t.videoTrack,(()=>{var t;return null===(t=d(this.hls.levels[this.hls.currentLevel]))||void 0===t?void 0:t.id}),(t=>{var e;if(r(t))return;const i=null===(e=this.trackLevels.get(t))||void 0===e?void 0:e.level;if(!i)return;const s=this.hls.levels.indexOf(i),a=this.hls.currentLevel,n=this.hls.levels[a];!n||i.bitrate>n.bitrate?this.hls.nextLevel=s:(this.hls.loadLevel=s,this.hls.loadLevel=s)}),{changed$:l.pipe(u((t=>null==t?void 0:t.id))),onError:i})),n(a.progress$,(()=>{this.params.dependencies.throughputEstimator.addRawThroughput(this.hls.bandwidthEstimate/1e3)})),this.textTracksManager.connect(this.video,t,e);const m=o(t.playbackState.stateChangeStarted$,t.videoTrack.stateChangeStarted$,t.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,h(['init'])).pipe(p(0));this.subscription.add(m.subscribe(this.syncPlayback,i))}prepare(){this.videoState.startTransitionTo(qd.READY),this.hls.attachMedia(this.video),this.hls.loadSource(this.params.source.url)}async playIfAllowed(){this.videoState.startTransitionTo(qd.PLAYING);await Oo(this.video)||(this.videoState.setState(qd.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED,!0))}pause(){this.videoState.startTransitionTo(qd.PAUSED),this.video.pause()}seek(t){this.params.output.willSeekEvent$.next(),this.video.currentTime=t/1e3}stop(){this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.hls.stopLoad(),this.hls.detachMedia(),this.video.setAttribute('src',''),this.video.load(),this.videoState.setState(qd.STOPPED),U(this.params.desiredState.playbackState,P.STOPPED,!0)}}const Gd=t=>{let e=null;if(t.QUALITY&&(e=No(t.QUALITY)),!e&&t.RESOLUTION){const[i,s]=t.RESOLUTION.split('x').map((t=>parseInt(t,10)));e=G({width:i,height:s})}return null!=e?e:null},Yd=async(t,e=t)=>{var i;const s=await et(t),r=(await s.text()).split('\n'),a=[];for(let t=0;t<r.length;t++){const s=r[t].match(/^#EXT-X-STREAM-INF:(.+)/);if(!s)continue;const n=to(s[1].split(',').map((t=>t.split('=')))),o=null!==(i=n.QUALITY)&&void 0!==i?i:`stream-${n.BANDWIDTH}`,d=Gd(n);let u;n.BANDWIDTH&&(u=parseInt(n.BANDWIDTH,10)/1e3||void 0),!u&&n['AVERAGE-BANDWIDTH']&&(u=parseInt(n['AVERAGE-BANDWIDTH'],10)/1e3||void 0);const h=n['FRAME-RATE']?parseFloat(n['FRAME-RATE']):void 0;let l;if(n.RESOLUTION){const[t,e]=n.RESOLUTION.split('x').map((t=>parseInt(t,10)));t&&e&&(l={width:t,height:e})}const c=new URL(r[++t],e).toString();d&&a.push({id:o,quality:d,url:c,bandwidth:u,size:l,fps:h})}return a};var zd,Qd,jd;!function(t){t.STOPPED='stopped',t.READY='ready',t.PLAYING='playing',t.CHANGING_MANIFEST='changing_manifest',t.PAUSED='paused'}(zd||(zd={}));class Wd{constructor(e){var s;this.subscription=new i,this.videoState=new z(zd.STOPPED),this.textTracksManager=new ho,this.manifests$=new t([]),this.liveOffset=new co,this.manifestStartTime$=new t(void 0),this.syncPlayback=()=>{const t=this.videoState.getState(),e=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),s=this.params.desiredState.videoTrack.getTransition(),r=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(e===P.STOPPED)return void(t!==zd.STOPPED&&(this.videoState.startTransitionTo(zd.STOPPED),this.video.setAttribute('src',''),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(zd.STOPPED),U(this.params.desiredState.playbackState,P.STOPPED,!0)));if(this.videoState.getTransition())return;const a=this.params.desiredState.seekState.getState();if(t===zd.STOPPED)return this.videoState.startTransitionTo(zd.READY),void this.prepare();if(s||r){const t=this.videoState.getState();return this.videoState.setState(zd.CHANGING_MANIFEST),this.videoState.startTransitionTo(t),this.prepare(),void(a.state===L.None&&this.params.desiredState.seekState.setState({state:L.Requested,position:-this.liveOffset.getTotalOffset(),forcePrecise:!0}))}if((null==i?void 0:i.to)!==P.PAUSED&&a.state===L.Requested)return this.videoState.startTransitionTo(zd.READY),this.seek(a.position-this.liveOffset.getTotalPausedTime()),void this.prepare();switch(t){case zd.READY:return void(e===P.PAUSED?(this.videoState.setState(zd.PAUSED),this.liveOffset.pause(),U(this.params.desiredState.playbackState,P.PAUSED)):e===P.PLAYING&&(this.videoState.startTransitionTo(zd.PLAYING),this.playIfAllowed()));case zd.PLAYING:return void(e===P.PAUSED?(this.videoState.startTransitionTo(zd.PAUSED),this.liveOffset.pause(),this.video.pause()):(null==i?void 0:i.to)===P.PLAYING&&U(this.params.desiredState.playbackState,P.PLAYING));case zd.PAUSED:return void(e===P.PLAYING?(this.videoState.startTransitionTo(zd.PLAYING),this.liveOffset.getTotalPausedTime()<this.params.config.maxPausedTime&&this.liveOffset.getTotalOffset()<this.maxSeekBackTime$.getValue()?(this.liveOffset.resume(),this.playIfAllowed(),this.params.output.position$.next(-this.liveOffset.getTotalOffset()/1e3)):this.seek(-this.liveOffset.getTotalOffset())):(null==i?void 0:i.to)===P.PAUSED&&(U(this.params.desiredState.playbackState,P.PAUSED),this.liveOffset.pause()));case zd.CHANGING_MANIFEST:break;default:return n(t)}},this.params=e,this.video=lo(e.container),this.params.output.element$.next(this.video);const r={id:'master',quality:B.INVARIANT,url:this.params.source.url};this.manifests$.next([r]),Yd(M(this.params.source.url),this.params.source.url).then((t=>{this.manifests$.next([r,...t])}),(t=>this.params.output.error$.next({id:'ExtractHlsQualities',message:'Error fetching manifest and extracting qualities',thrown:t}))),this.params.output.isLive$.next(!0),this.params.output.hostname$.next(Do(this.params.source.url)),this.maxSeekBackTime$=new t(null!==(s=e.source.maxSeekBackTime)&&void 0!==s?s:1/0),this.subscribe()}selectManifest(){var t,e;const{autoVideoTrackSwitching:i,videoTrack:s}=this.params.desiredState,r=i.getState(),a=s.getTransition(),n=null!==(e=null!==(t=null==a?void 0:a.to)&&void 0!==t?t:s.getState())&&void 0!==e?e:'master',o=this.manifests$.getValue();if(!o)return;const d=r?'master':n;return r&&!a&&s.startTransitionTo('master'),o.find((t=>t.id===d))}subscribe(){const{output:t,desiredState:e}=this.params,i=e=>{t.error$.next({id:'HlsLiveProvider',message:'HlsLiveProvider internal logic error',thrown:e})},r=fo(this.video),a=(t,e)=>this.subscription.add(t.subscribe(e,i));a(r.ended$,t.endedEvent$),a(r.error$,t.error$),a(r.isBuffering$,t.isBuffering$),a(r.currentBuffer$,t.currentBuffer$),a(r.loadedMetadata$,t.firstBytesEvent$),a(r.playing$,t.firstFrameEvent$),a(r.canplay$,t.canplay$),this.subscription.add(e.isLooped.stateChangeStarted$.subscribe((()=>e.isLooped.setState(!1)),i)),this.subscription.add(no(this.video,e.volume,r.volumeState$,i)),this.subscription.add(r.volumeState$.subscribe(this.params.output.volume$,i)),this.subscription.add(oo(this.video,e.playbackRate,r.playbackRateState$,i)),this.textTracksManager.connect(this.video,e,t),this.subscription.add(r.playing$.subscribe((()=>{this.videoState.setState(zd.PLAYING),U(e.playbackState,P.PLAYING)}),i)).add(r.pause$.subscribe((()=>{this.videoState.setState(zd.PAUSED),U(e.playbackState,P.PAUSED)}),i)).add(r.canplay$.subscribe((()=>{var t;(null===(t=this.videoState.getTransition())||void 0===t?void 0:t.to)===zd.READY&&this.videoState.setState(zd.READY),this.videoState.getState()===zd.PLAYING&&this.playIfAllowed()}),i)),this.subscription.add(this.maxSeekBackTime$.pipe(l(),u((t=>-t/1e3))).subscribe(this.params.output.duration$,i)),this.subscription.add(r.loadedMetadata$.subscribe((()=>{const t=this.params.desiredState.seekState.getState(),e=this.videoState.getTransition(),i=this.params.desiredState.videoTrack.getTransition(),r=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(i&&s(i.to)){const t=i.to;this.params.desiredState.videoTrack.setState(t);const e=this.manifests$.getValue().find((e=>e.id===t));e&&(this.params.output.currentVideoTrack$.next(e),this.params.output.hostname$.next(Do(e.url)))}r&&this.params.desiredState.autoVideoTrackSwitching.setState(r.to),e&&e.from===zd.CHANGING_MANIFEST&&this.videoState.setState(e.to),t&&t.state===L.Requested&&this.seek(t.position)}),i)),this.subscription.add(r.loadedData$.subscribe((()=>{var t,e;const i=null===(e=null===(t=this.video)||void 0===t?void 0:t.getStartDate())||void 0===e?void 0:e.getTime();this.manifestStartTime$.next(i||void 0)}),i)),this.subscription.add(y({startTime:this.manifestStartTime$.pipe(f(s)),currentTime:r.timeUpdate$}).subscribe((({startTime:t,currentTime:e})=>this.params.output.liveTime$.next(t+1e3*e)),i)),this.subscription.add(this.manifests$.pipe(u((t=>t.map((({id:t,quality:e,size:i,bandwidth:s,fps:r})=>({id:t,quality:e,size:i,fps:r,bitrate:s})))))).subscribe(this.params.output.availableVideoTracks$,i));const n=o(e.playbackState.stateChangeStarted$,e.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,e.videoTrack.stateChangeStarted$,e.autoVideoTrackSwitching.stateChangeStarted$,h(['init'])).pipe(p(0));this.subscription.add(n.subscribe(this.syncPlayback,i))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.video.remove(),this.params.output.element$.next(void 0)}prepare(){const t=this.selectManifest();if(r(t))return;const e=M(t.url,this.liveOffset.getTotalOffset());this.video.setAttribute('src',e),this.video.load(),(async t=>{const e=await et(t,{method:'HEAD'});return e.headers.has('X-Playback-Duration')?parseInt(e.headers.get('X-Playback-Duration'),10):void 0})(e).then((t=>{r(t)||this.maxSeekBackTime$.next(t)}))}playIfAllowed(){Oo(this.video).then((t=>{t||(this.videoState.setState(zd.PAUSED),this.liveOffset.pause(),U(this.params.desiredState.playbackState,P.PAUSED,!0))}))}seek(t){this.params.output.willSeekEvent$.next();const e=-t,i=e<this.maxSeekBackTime$.getValue()?e:0;this.liveOffset.resetTo(i),this.params.output.position$.next(-i/1e3),this.params.output.seekedEvent$.next()}}!function(t){t.STOPPED='stopped',t.READY='ready',t.PLAYING='playing',t.CHANGING_MANIFEST='changing_manifest',t.PAUSED='paused'}(Qd||(Qd={}));class Jd{constructor(e){this.subscription=new i,this.videoState=new z(Qd.STOPPED),this.textTracksManager=new ho,this.manifests$=new t([]),this.syncPlayback=()=>{const t=this.videoState.getState(),e=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),s=this.params.desiredState.videoTrack.getTransition(),r=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(e===P.STOPPED)return void(t!==Qd.STOPPED&&(this.videoState.startTransitionTo(Qd.STOPPED),this.video.setAttribute('src',''),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(Qd.STOPPED),U(this.params.desiredState.playbackState,P.STOPPED,!0)));if(this.videoState.getTransition())return;const a=this.params.desiredState.seekState.getState();if(t===Qd.STOPPED)return this.videoState.startTransitionTo(Qd.READY),void this.prepare();if(s||r){const t=this.videoState.getState();this.videoState.setState(Qd.CHANGING_MANIFEST),this.videoState.startTransitionTo(t);const{currentTime:e}=this.video;return this.prepare(),void(a.state===L.None&&this.params.desiredState.seekState.setState({state:L.Requested,position:1e3*e,forcePrecise:!0}))}switch((null==i?void 0:i.to)!==P.PAUSED&&a.state===L.Requested&&this.seek(a.position),t){case Qd.READY:return void(e===P.PAUSED?(this.videoState.setState(Qd.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED)):e===P.PLAYING&&(this.videoState.startTransitionTo(Qd.PLAYING),this.playIfAllowed()));case Qd.PLAYING:return void(e===P.PAUSED?(this.videoState.startTransitionTo(Qd.PAUSED),this.video.pause()):(null==i?void 0:i.to)===P.PLAYING&&U(this.params.desiredState.playbackState,P.PLAYING));case Qd.PAUSED:return void(e===P.PLAYING?(this.videoState.startTransitionTo(Qd.PLAYING),this.playIfAllowed()):(null==i?void 0:i.to)===P.PAUSED&&U(this.params.desiredState.playbackState,P.PAUSED));case Qd.CHANGING_MANIFEST:break;default:return n(t)}},this.params=e,this.video=lo(e.container),this.params.output.element$.next(this.video);const s={id:'master',quality:B.INVARIANT,url:this.params.source.url};this.manifests$.next([s]),this.params.output.isLive$.next(!1),this.params.output.hostname$.next(Do(this.params.source.url)),Yd(this.params.source.url).then((t=>{this.manifests$.next([s,...t])}),(t=>this.params.output.error$.next({id:'ExtractHlsQualities',message:'Error fetching manifest and extracting qualities',thrown:t}))),this.subscribe()}selectManifest(){var t,e;const{autoVideoTrackSwitching:i,videoTrack:s}=this.params.desiredState,r=i.getState(),a=s.getTransition(),n=null!==(e=null!==(t=null==a?void 0:a.to)&&void 0!==t?t:s.getState())&&void 0!==e?e:'master',o=this.manifests$.getValue();if(!o)return;const d=r?'master':n;return r&&!a&&s.startTransitionTo('master'),o.find((t=>t.id===d))}subscribe(){const{output:t,desiredState:e}=this.params,i=e=>{t.error$.next({id:'HlsProvider',message:'HlsProvider internal logic error',thrown:e})},r=fo(this.video),a=(t,e)=>this.subscription.add(t.subscribe(e));a(r.timeUpdate$,t.position$),a(r.durationChange$,t.duration$),a(r.ended$,t.endedEvent$),a(r.looped$,t.loopedEvent$),a(r.error$,t.error$),a(r.isBuffering$,t.isBuffering$),a(r.currentBuffer$,t.currentBuffer$),a(r.loadedMetadata$,t.firstBytesEvent$),a(r.playing$,t.firstFrameEvent$),a(r.canplay$,t.canplay$),a(r.seeked$,t.seekedEvent$),this.subscription.add(ao(this.video,e.isLooped,i)),this.subscription.add(no(this.video,e.volume,r.volumeState$,i)),this.subscription.add(r.volumeState$.subscribe(this.params.output.volume$,i)),this.subscription.add(oo(this.video,e.playbackRate,r.playbackRateState$,i)),this.textTracksManager.connect(this.video,e,t),this.subscription.add(r.playing$.subscribe((()=>{this.videoState.setState(Qd.PLAYING),U(e.playbackState,P.PLAYING)}),i)).add(r.pause$.subscribe((()=>{this.videoState.setState(Qd.PAUSED),U(e.playbackState,P.PAUSED)}),i)).add(r.canplay$.subscribe((()=>{var t;(null===(t=this.videoState.getTransition())||void 0===t?void 0:t.to)===Qd.READY&&this.videoState.setState(Qd.READY),this.videoState.getState()===Qd.PLAYING&&this.playIfAllowed()}),i).add(r.loadedMetadata$.subscribe((()=>{const t=this.params.desiredState.seekState.getState(),e=this.videoState.getTransition(),i=this.params.desiredState.videoTrack.getTransition(),r=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(i&&s(i.to)){const t=i.to;this.params.desiredState.videoTrack.setState(t);const e=this.manifests$.getValue().find((e=>e.id===t));e&&(this.params.output.currentVideoTrack$.next(e),this.params.output.hostname$.next(Do(e.url)))}r&&this.params.desiredState.autoVideoTrackSwitching.setState(r.to),e&&e.from===Qd.CHANGING_MANIFEST&&this.videoState.setState(e.to),t.state===L.Requested&&this.seek(t.position)}),i))),this.subscription.add(this.manifests$.pipe(u((t=>t.map((({id:t,quality:e,size:i,bandwidth:s,fps:r})=>({id:t,quality:e,size:i,fps:r,bitrate:s})))))).subscribe(this.params.output.availableVideoTracks$,i));const n=o(e.playbackState.stateChangeStarted$,e.seekState.stateChangeEnded$,e.videoTrack.stateChangeStarted$,e.autoVideoTrackSwitching.stateChangeStarted$,this.videoState.stateChangeEnded$,h(['init'])).pipe(p(0));this.subscription.add(n.subscribe(this.syncPlayback,i))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.video.remove(),this.params.output.element$.next(void 0)}prepare(){const t=this.selectManifest();r(t)||(this.video.setAttribute('src',t.url),this.video.load())}playIfAllowed(){Oo(this.video).then((t=>{t||(this.videoState.setState(Qd.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED,!0))}))}seek(t){this.params.output.willSeekEvent$.next(),this.video.currentTime=t/1e3}}!function(t){t.STOPPED='stopped',t.READY='ready',t.PLAYING='playing',t.PAUSED='paused'}(jd||(jd={}));class Xd{constructor(t){this.subscription=new i,this.videoState=new z(jd.STOPPED),this.trackUrls={},this.textTracksManager=new ho,this.syncPlayback=()=>{const t=this.videoState.getState(),e=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition();if(e===P.STOPPED)return void(t!==jd.STOPPED&&(this.videoState.startTransitionTo(jd.STOPPED),this.video.setAttribute('src',''),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(jd.STOPPED),U(this.params.desiredState.playbackState,P.STOPPED,!0)));if(this.videoState.getTransition())return;const s=this.params.desiredState.videoTrack.getTransition(),r=this.params.desiredState.seekState.getState();if(t===jd.STOPPED)return this.videoState.startTransitionTo(jd.READY),void this.prepare();if(s){const{currentTime:t}=this.video;return this.prepare(),void(r.state===L.None&&this.params.desiredState.seekState.setState({state:L.Requested,position:1e3*t,forcePrecise:!0}))}switch((null==i?void 0:i.to)!==P.PAUSED&&r.state===L.Requested&&this.seek(r.position),t){case jd.READY:return void(e===P.PAUSED?(this.videoState.setState(jd.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED)):e===P.PLAYING&&(this.videoState.startTransitionTo(jd.PLAYING),this.playIfAllowed()));case jd.PLAYING:return void(e===P.PAUSED?(this.videoState.startTransitionTo(jd.PAUSED),this.video.pause()):(null==i?void 0:i.to)===P.PLAYING&&U(this.params.desiredState.playbackState,P.PLAYING));case jd.PAUSED:return void(e===P.PLAYING?(this.videoState.startTransitionTo(jd.PLAYING),this.playIfAllowed()):(null==i?void 0:i.to)===P.PAUSED&&U(this.params.desiredState.playbackState,P.PAUSED));default:return n(t)}},this.params=t,this.video=lo(t.container),this.params.output.element$.next(this.video),Object.entries(this.params.source).forEach((([t,e],i)=>{const s=i.toString(10);this.trackUrls[s]={track:{quality:t,id:s},url:e}})),this.params.output.availableVideoTracks$.next(Object.values(this.trackUrls).map((({track:t})=>t))),this.params.output.isLive$.next(!1),this.subscribe()}subscribe(){const{output:t,desiredState:e}=this.params,i=e=>{t.error$.next({id:'MpegProvider',message:'MpegProvider internal logic error',thrown:e})},r=fo(this.video),a=(t,e)=>this.subscription.add(t.subscribe(e,i));a(r.timeUpdate$,t.position$),a(r.durationChange$,t.duration$),a(r.ended$,t.endedEvent$),a(r.looped$,t.loopedEvent$),a(r.error$,t.error$),a(r.isBuffering$,t.isBuffering$),a(r.currentBuffer$,t.currentBuffer$),a(r.loadedMetadata$,t.firstBytesEvent$),a(r.playing$,t.firstFrameEvent$),a(r.canplay$,t.canplay$),a(r.seeked$,t.seekedEvent$),this.subscription.add(ao(this.video,e.isLooped,i)),this.subscription.add(no(this.video,e.volume,r.volumeState$,i)),this.subscription.add(r.volumeState$.subscribe(this.params.output.volume$,i)),this.subscription.add(oo(this.video,e.playbackRate,r.playbackRateState$,i)),this.subscription.add(r.playing$.subscribe((()=>{this.videoState.setState(jd.PLAYING),U(e.playbackState,P.PLAYING)}),i)).add(r.pause$.subscribe((()=>{this.videoState.setState(jd.PAUSED),U(e.playbackState,P.PAUSED)}),i)).add(r.canplay$.subscribe((()=>{var t;(null===(t=this.videoState.getTransition())||void 0===t?void 0:t.to)===jd.READY&&this.videoState.setState(jd.READY);const e=this.params.desiredState.videoTrack.getTransition();e&&s(e.to)&&(this.params.desiredState.videoTrack.setState(e.to),this.params.output.currentVideoTrack$.next(this.trackUrls[e.to].track)),this.videoState.getState()===jd.PLAYING&&this.playIfAllowed()}),i)),this.subscription.add(e.autoVideoTrackSwitching.stateChangeStarted$.subscribe((()=>e.autoVideoTrackSwitching.setState(!1)),i)),this.textTracksManager.connect(this.video,e,t);const n=o(e.playbackState.stateChangeStarted$,e.videoTrack.stateChangeStarted$,e.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,h(['init'])).pipe(p(0));this.subscription.add(n.subscribe(this.syncPlayback,i))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.trackUrls={},this.video.remove(),this.params.output.element$.next(void 0)}prepare(){var t,e;const i=null!==(e=null===(t=this.params.desiredState.videoTrack.getTransition())||void 0===t?void 0:t.to)&&void 0!==e?e:this.params.desiredState.videoTrack.getState();c(i,'MpegProvider: track is not selected');let{url:s}=this.trackUrls[i];c(s,`MpegProvider: No url for ${i}`),this.params.tuning.requestQuick&&(s=io(s)),this.video.setAttribute('src',s),this.video.load(),this.params.output.hostname$.next(Do(s))}playIfAllowed(){Oo(this.video).then((t=>{t||(this.videoState.setState(jd.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED,!0))}))}seek(t){this.params.output.willSeekEvent$.next(),this.video.currentTime=t/1e3}}const Kd=['stun:videostun.mycdn.me:80'],Zd=()=>null;class tu{constructor(t,e){this.ws=null,this.peerConnection=null,this.serverUrl='',this.streamKey='',this.stream=null,this.signalingType='JOIN',this.retryCount=0,this.externalStartCallback=Zd,this.externalStopCallback=Zd,this.externalErrorCallback=Zd,this.options=this.normalizeOptions(e);const i=t.split('/');this.serverUrl=i.slice(0,i.length-1).join('/'),this.streamKey=i[i.length-1]}onStart(t){try{this.externalStartCallback=t}catch(t){this.handleSystemError(t)}}onStop(t){try{this.externalStopCallback=t}catch(t){this.handleSystemError(t)}}onError(t){try{this.externalErrorCallback=t}catch(t){this.handleSystemError(t)}}connect(){this.connectWS()}disconnect(){try{this.externalStopCallback(),this.closeConnections()}catch(t){this.handleSystemError(t)}}connectWS(){this.ws||(this.ws=new WebSocket(this.serverUrl),this.ws.onopen=this.onSocketOpen.bind(this),this.ws.onmessage=this.onSocketMessage.bind(this),this.ws.onclose=this.onSocketClose.bind(this),this.ws.onerror=this.onSocketError.bind(this))}onSocketOpen(){this.handleLogin()}onSocketClose(t){try{if(!this.ws)return;this.ws=null,t.code>1e3?(this.retryCount++,this.retryCount>this.options.maxRetryNumber?this.handleNetworkError():this.scheduleRetry()):this.externalStopCallback()}catch(t){this.handleRTCError(t)}}onSocketError(t){try{this.externalErrorCallback(new Error(t.toString()))}catch(t){this.handleRTCError(t)}}onSocketMessage(t){try{const e=this.parseMessage(t.data);switch(e.type){case'JOIN':case'CALL_JOIN':this.handleJoinMessage(e);break;case'UPDATE':this.handleUpdateMessage(e);break;case'STATUS':this.handleStatusMessage(e)}}catch(t){this.handleRTCError(t)}}handleJoinMessage(t){switch(t.inviteType){case'ANSWER':this.handleAnswer(t.sdp);break;case'CANDIDATE':this.handleCandidate(t.candidate)}}handleStatusMessage(t){switch(t.status){case'UNPUBLISHED':this.handleUnpublished()}}async handleUpdateMessage(t){try{const e=await this.createOffer();this.peerConnection&&await this.peerConnection.setLocalDescription(e),this.handleAnswer(t.sdp)}catch(t){this.handleRTCError(t)}}async handleLogin(){try{const t={iceServers:[{urls:Kd}]};this.peerConnection=new RTCPeerConnection(t),this.peerConnection.ontrack=this.onPeerConnectionStream.bind(this),this.peerConnection.onicecandidate=this.onPeerConnectionIceCandidate.bind(this),this.peerConnection.oniceconnectionstatechange=this.onPeerConnectionIceConnectionStateChange.bind(this);const e=await this.createOffer();await this.peerConnection.setLocalDescription(e),this.send({type:this.signalingType,inviteType:'OFFER',streamKey:this.streamKey,sdp:e.sdp,callSupport:!1})}catch(t){this.handleRTCError(t)}}async handleAnswer(t){try{this.peerConnection&&await this.peerConnection.setRemoteDescription(new RTCSessionDescription({type:'answer',sdp:t}))}catch(t){this.handleRTCError(t)}}async handleCandidate(t){if(t)try{this.peerConnection&&await this.peerConnection.addIceCandidate(t)}catch(t){this.handleRTCError(t)}}handleUnpublished(){try{this.closeConnections(),this.externalStopCallback()}catch(t){this.handleRTCError(t)}}handleSystemError(t){this.options.errorChanel&&this.options.errorChanel.next({id:'webrtc-provider-error',message:t.message})}async onPeerConnectionStream(t){const e=t.streams[0];this.stream&&this.stream.id===e.id||(this.stream=e,this.externalStartCallback(this.stream))}onPeerConnectionIceCandidate(t){t.candidate&&this.send({type:this.signalingType,inviteType:'CANDIDATE',candidate:t.candidate})}onPeerConnectionIceConnectionStateChange(){if(this.peerConnection){const t=this.peerConnection.iceConnectionState;['failed','closed'].indexOf(t)>-1&&(this.retryCount++,this.retryCount>this.options.maxRetryNumber?this.handleNetworkError():(this.closeConnections(),this.scheduleRetry()))}}async createOffer(){if(!this.peerConnection)throw new Error('Can not create offer - no peer connection instance ');const t=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0,voiceActivityDetection:!1}),e=t.sdp||'';if(!/^a=rtpmap:\d+ H264\/\d+$/m.test(e))throw new Error('No h264 codec support error');return t}handleRTCError(t){try{this.externalErrorCallback(t||new Error('RTC connection error'))}catch(t){this.handleSystemError(t)}}handleNetworkError(){try{this.externalErrorCallback(new Error('Network error'))}catch(t){this.handleSystemError(t)}}send(t){this.ws&&this.ws.send(JSON.stringify(t))}parseMessage(t){try{return JSON.parse(t)}catch(t){throw new Error('Can not parse socket message')}}closeConnections(){const t=this.ws;t&&(this.ws=null,t.close(1e3)),this.removePeerConnection()}removePeerConnection(){let t=this.peerConnection;t&&(this.peerConnection=null,t.close(),t.ontrack=null,t.onicecandidate=null,t.oniceconnectionstatechange=null,t=null)}scheduleRetry(){this.retryTimeout=setTimeout(this.connectWS.bind(this),1e3)}normalizeOptions(t={}){const e={stunServerList:Kd,maxRetryNumber:3,errorChanel:null};return t.stunServerList&&(e.stunServerList=t.stunServerList),t.maxRetryNumber&&t.maxRetryNumber>0&&(e.maxRetryNumber=t.maxRetryNumber),e}}var eu,iu,su,ru,au,nu,ou,du,uu,hu,lu,cu,pu,mu,fu,vu,Su,gu;!function(t){t.STOPPED='stopped',t.READY='ready',t.PLAYING='playing',t.PAUSED='paused'}(eu||(eu={}));class bu{constructor(e){this.videoState=new z(eu.STOPPED),this.maxSeekBackTime$=new t(0),this.syncPlayback=()=>{const t=this.videoState.getState(),e=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition();if(e===P.STOPPED)return void(t!==eu.STOPPED&&(this.videoState.startTransitionTo(eu.STOPPED),this.video.pause(),this.video.srcObject=null,this.params.output.position$.next(0),this.params.output.duration$.next(0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(eu.STOPPED),U(this.params.desiredState.playbackState,P.STOPPED,!0)));if(this.videoState.getTransition())return;const s=this.params.desiredState.videoTrack.getTransition();if(t===eu.STOPPED)return this.videoState.startTransitionTo(eu.READY),void this.prepare();if(s)this.prepare();else switch(t){case eu.READY:return void(e===P.PAUSED?(this.videoState.setState(eu.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED)):e===P.PLAYING&&(this.videoState.startTransitionTo(eu.PLAYING),this.playIfAllowed()));case eu.PLAYING:return void(e===P.PAUSED?(this.videoState.startTransitionTo(eu.PAUSED),this.video.pause()):(null==i?void 0:i.to)===P.PLAYING&&U(this.params.desiredState.playbackState,P.PLAYING));case eu.PAUSED:return void(e===P.PLAYING?(this.videoState.startTransitionTo(eu.PLAYING),this.playIfAllowed()):(null==i?void 0:i.to)===P.PAUSED&&U(this.params.desiredState.playbackState,P.PAUSED));default:return n(t)}},this.subscription=new i,this.params=e,this.log=this.params.dependencies.logger.createComponentLog('WebRTCLiveProvider'),this.video=lo(e.container),this.liveStreamClient=new tu(this.params.source.url,{maxRetryNumber:this.params.tuning.webrtc.connectionRetryMaxNumber,errorChanel:this.params.output.error$}),this.liveStreamClient.onStart(this.onLiveStreamStart.bind(this)),this.liveStreamClient.onStop(this.onLiveStreamStop.bind(this)),this.liveStreamClient.onError(this.onLiveStreamError.bind(this)),this.subscribe()}destroy(){this.subscription.unsubscribe(),this.video.remove(),this.params.output.element$.next(void 0),this.liveStreamClient.disconnect()}subscribe(){const{output:t,desiredState:e}=this.params,i=e=>{t.error$.next({id:'WebRTCLiveProvider',message:'WebRTCLiveProvider internal logic error',thrown:e})};o(this.videoState.stateChangeStarted$.pipe(u((t=>({transition:t,type:'start'})))),this.videoState.stateChangeEnded$.pipe(u((t=>({transition:t,type:'end'}))))).subscribe((({transition:t,type:e})=>{this.log({message:`[videoState change] ${e}: ${JSON.stringify(t)}`})}));const s=fo(this.video),r=(t,e)=>this.subscription.add(t.subscribe(e,i));r(s.timeUpdate$,t.liveTime$),r(s.ended$,t.endedEvent$),r(s.looped$,t.loopedEvent$),r(s.error$,t.error$),r(s.isBuffering$,t.isBuffering$),r(s.currentBuffer$,t.currentBuffer$),this.subscription.add(s.durationChange$.subscribe((e=>{t.duration$.next(e===1/0?0:e)}))).add(s.canplay$.subscribe((()=>{var t;(null===(t=this.videoState.getTransition())||void 0===t?void 0:t.to)===eu.READY&&this.videoState.setState(eu.READY)}),i)).add(s.pause$.subscribe((()=>{this.videoState.setState(eu.PAUSED)}),i)).add(s.playing$.subscribe((()=>{this.videoState.setState(eu.PLAYING)}),i)).add(s.error$.subscribe(t.error$)).add(this.maxSeekBackTime$.subscribe(this.params.output.duration$)).add(no(this.video,e.volume,s.volumeState$,i)).add(s.volumeState$.subscribe(t.volume$,i)).add(this.videoState.stateChangeEnded$.subscribe((i=>{switch(i.to){case eu.STOPPED:t.position$.next(0),t.duration$.next(0),e.playbackState.setState(P.STOPPED);break;case eu.READY:break;case eu.PAUSED:e.playbackState.setState(P.PAUSED);break;case eu.PLAYING:e.playbackState.setState(P.PLAYING);break;default:return n(i.to)}}),i)).add(o(e.playbackState.stateChangeStarted$,this.videoState.stateChangeEnded$,h(['init'])).pipe(p(0)).subscribe(this.syncPlayback.bind(this),i)),this.subscription.add(e.isLooped.stateChangeStarted$.subscribe((()=>e.isLooped.setState(!1)),i)),this.subscription.add(e.autoVideoTrackSwitching.stateChangeStarted$.subscribe((()=>e.autoVideoTrackSwitching.setState(!1)),i))}onLiveStreamStart(t){this.params.output.element$.next(this.video),this.params.output.duration$.next(0),this.params.output.position$.next(0),this.params.output.isLive$.next(!0),this.params.output.hostname$.next(Do(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!1),this.params.output.availableVideoTracks$.next([]),this.params.output.currentVideoTrack$.next({id:'webrtc',quality:B.INVARIANT}),this.video.srcObject=t,U(this.params.desiredState.playbackState,P.PLAYING)}onLiveStreamStop(){this.videoState.startTransitionTo(eu.STOPPED),this.syncPlayback(),this.params.output.position$.next(0),this.params.output.duration$.next(0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.params.output.endedEvent$.next()}onLiveStreamError(t){this.onLiveStreamStop(),this.params.output.error$.next({id:'WebRTC stream runtime error',message:t.message,thrown:t})}playIfAllowed(){Oo(this.video).then((t=>{t||(this.videoState.setState(eu.PAUSED),U(this.params.desiredState.playbackState,P.PAUSED,!0))}))}prepare(){this.liveStreamClient.connect()}}class yu{constructor(t){this.iterator=t[Symbol.iterator](),this.next()}next(){this.current=this.iterator.next()}getValue(){if(this.current.done)throw new Error('Iterable is completed');return this.current.value}isCompleted(){return Boolean(this.current.done)}}const Tu=ld(),Eu=(null===(iu=null===navigator||void 0===navigator?void 0:navigator.userAgentData)||void 0===iu?void 0:iu.mobile)||/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(navigator.appVersion),wu=document.createElement('video'),$u={mse:Boolean(window.MediaSource&&window.MediaStreamTrack&&(null===(ru=null===(su=window.SourceBuffer)||void 0===su?void 0:su.prototype)||void 0===ru?void 0:ru.appendBuffer)),hls:Boolean((null===(au=wu.canPlayType)||void 0===au?void 0:au.call(wu,'application/x-mpegurl'))||(null===(nu=wu.canPlayType)||void 0===nu?void 0:nu.call(wu,'vnd.apple.mpegURL'))),webrtc:Boolean(window.RTCPeerConnection)},ku={mp4:Boolean(null===(ou=wu.canPlayType)||void 0===ou?void 0:ou.call(wu,'video/mp4')),webm:Boolean(null===(du=wu.canPlayType)||void 0===du?void 0:du.call(wu,'video/webm'))},Au={h264:Boolean(null===(hu=null===(uu=window.MediaSource)||void 0===uu?void 0:uu.isTypeSupported)||void 0===hu?void 0:hu.call(uu,'video/mp4; codecs="avc1.42000a,mp4a.40.2"')),h265:Boolean(null===(cu=null===(lu=window.MediaSource)||void 0===lu?void 0:lu.isTypeSupported)||void 0===cu?void 0:cu.call(lu,'video/mp4; codecs="hev1.1.6.L93.B0"')),vp9:Boolean(null===(mu=null===(pu=window.MediaSource)||void 0===pu?void 0:pu.isTypeSupported)||void 0===mu?void 0:mu.call(pu,'video/webm; codecs="vp9"')),aac:Boolean(null===(vu=null===(fu=window.MediaSource)||void 0===fu?void 0:fu.isTypeSupported)||void 0===vu?void 0:vu.call(fu,'audio/mp4; codecs="mp4a.40.2"')),opus:Boolean(null===(gu=null===(Su=window.MediaSource)||void 0===Su?void 0:Su.isTypeSupported)||void 0===gu?void 0:gu.call(Su,'audio/webm; codecs="opus"'))},Pu=(Au.h264||Au.h265)&&Au.aac,Ru=!Tu,Du=$u.hls&&ku.mp4&&(Eu||Tu),_u=Boolean(window.WebSocket);const Cu=3e4,Iu=18e4,Lu=3,xu=100,Nu={cacheDuration:12e4},Ou={maxPausedTime:3e4,chunkDuration:5e3,maxParallelRequests:5},Bu={maxPausedTime:3e4},Mu={maxPausedTime:3e4};class Uu{constructor(r){this.current$=new t({type:void 0}),this.providerError$=new e,this.noAvailableProvidersError$=new e,this.providerOutput={position$:new t(0),duration$:new t(1/0),volume$:new t({muted:!1,volume:1}),currentVideoTrack$:new t(void 0),availableVideoTracks$:new t([]),autoVideoTrackLimitingAvailable$:new t(!1),currentBuffer$:new t(void 0),isBuffering$:new t(!0),error$:new e,willSeekEvent$:new e,seekedEvent$:new e,loopedEvent$:new e,endedEvent$:new e,firstBytesEvent$:new e,firstFrameEvent$:new e,canplay$:new e,isLive$:new t(void 0),liveTime$:new t(void 0),availableTextTracks$:new t([]),currentTextTrack$:new t(void 0),hostname$:new t(void 0),httpConnectionType$:new t(void 0),httpConnectionReused$:new t(void 0),element$:new t(void 0)},this.subscription=new i,this.params=r,this.log=this.params.dependencies.logger.createComponentLog('ProviderContainer');const{formatsToAvoid:a}=this.params.tuning,o=a.length?[...r.screenFormatsPriority.filter((t=>!a.includes(t))),...r.screenFormatsPriority.filter((t=>a.includes(t)))]:r.screenFormatsPriority;this.screenFormatsIterator=new yu(((t,e=!1)=>t.filter((t=>{switch(t){case R.DASH:return $u.mse&&ku.mp4&&Pu&&Ru;case R.DASH_SEP:return $u.mse&&ku.mp4&&Pu;case R.DASH_WEBM:return $u.mse&&ku.webm&&Au.vp9&&Au.opus;case R.DASH_LIVE:case R.DASH_ONDEMAND:return $u.mse&&ku.mp4&&Pu;case R.HLS:case R.HLS_LIVE:case R.HLS_ONDEMAND:return Du||e&&$u.mse&&ku.mp4&&Pu;case R.MPEG:return ku.mp4;case R.DASH_LIVE_WEBM:return!1;case R.WEB_RTC_LIVE:return $u.webrtc&&_u&&Au.h264&&(ku.mp4||ku.webm);default:return n(t)}})))(o.filter((t=>s(r.sources[t]))),this.params.tuning.useHlsJs)),this.chromecastFormatsIterator=new yu(r.chromecastFormatsPriority.filter((t=>s(r.sources[t]))))}init(){this.subscription.add(this.initProviderErrorHandling()),this.subscription.add(this.params.dependencies.chromecastInitializer.connection$.subscribe((()=>{this.reinitProvider()})))}destroy(){this.destroyProvider(),this.current$.next({type:void 0}),this.subscription.unsubscribe()}initProvider(){const t=this.chooseDestination(),e=this.chooseFormat(t);if(r(e))return void this.handleNoFormatsError(t);let i;try{i=this.createProvider(t,e)}catch(t){this.providerError$.next({id:'ProviderNotConstructed',message:'Failed to create provider',thrown:t})}i?this.current$.next({type:e,provider:i,destination:t}):this.switchToNextProvider()}reinitProvider(){this.destroyProvider(),this.initProvider()}switchToNextProvider(){this.destroyProvider();const t=this.current$.getValue().destination;c(t,'No current provider'),this.skipFormat(t),this.initProvider()}destroyProvider(){const t=this.current$.getValue().provider;if(!t)return;this.log({message:'destroyProvider'});const e=1e3*this.providerOutput.position$.getValue(),i=this.params.desiredState.seekState.getState(),s=i.state!==L.None;this.params.desiredState.seekState.setState({state:L.Requested,position:s?i.position:e,forcePrecise:!!s&&i.forcePrecise}),t.destroy();const r=this.providerOutput.isBuffering$;r.getValue()||r.next(!0)}createProvider(t,e){switch(this.log({message:`createProvider: ${t}:${e}`}),t){case D.SCREEN:return this.createScreenProvider(e);case D.CHROMECAST:return this.createChromecastProvider(e);default:return n(t)}}createScreenProvider(t){const{sources:e,container:i,desiredState:s}=this.params,r=this.providerOutput,a={container:i,source:null,desiredState:s,output:r,dependencies:this.params.dependencies,tuning:this.params.tuning};switch(t){case R.DASH:{const i=e[t];return c(i),new ed({...a,source:i,config:Nu})}case R.DASH_SEP:case R.DASH_WEBM:case R.DASH_ONDEMAND:{const i=e[t];return c(i),this.params.tuning.useDashJs?new xo({...a,source:i,format:t,config:Mu}):new Ud({...a,source:i})}case R.HLS:case R.HLS_ONDEMAND:{const i=e[t];return c(i),Du||!this.params.tuning.useHlsJs?new Jd({...a,source:i}):new Hd({...a,source:i})}case R.HLS_LIVE:{const i=e[t];return c(i),new Wd({...a,source:i,config:Bu})}case R.MPEG:{const i=e[t];return c(i),new Xd({...a,source:i})}case R.DASH_LIVE:{const i=e[t];return c(i),new Qo({...a,source:i,config:Ou})}case R.WEB_RTC_LIVE:{const a=e[t];return c(a),new bu({container:i,source:a,desiredState:s,output:r,dependencies:this.params.dependencies,tuning:this.params.tuning})}case R.DASH_LIVE_WEBM:throw new Error('DASH_LIVE_WEBM is no longer supported');default:return n(t)}}createChromecastProvider(t){const{sources:e,container:i,desiredState:s,meta:r}=this.params,a=this.providerOutput,n=this.params.dependencies.chromecastInitializer.connection$.getValue();return c(n),new j({connection:n,meta:r,container:i,source:e,format:t,desiredState:s,output:a,dependencies:this.params.dependencies,tuning:this.params.tuning})}chooseDestination(){return this.params.dependencies.chromecastInitializer.connection$.getValue()?D.CHROMECAST:D.SCREEN}chooseFormat(t){switch(t){case D.SCREEN:return this.screenFormatsIterator.isCompleted()?void 0:this.screenFormatsIterator.getValue();case D.CHROMECAST:return this.chromecastFormatsIterator.isCompleted()?void 0:this.chromecastFormatsIterator.getValue();default:return n(t)}}skipFormat(t){switch(t){case D.SCREEN:return this.screenFormatsIterator.next();case D.CHROMECAST:return this.chromecastFormatsIterator.next();default:return n(t)}}handleNoFormatsError(t){switch(t){case D.SCREEN:return this.noAvailableProvidersError$.next(),void this.current$.next({type:void 0});case D.CHROMECAST:return void this.params.dependencies.chromecastInitializer.disconnect();default:return n(t)}}initProviderErrorHandling(){let t=[],r=0;const a=new i;var n;return a.add(o(this.providerOutput.error$,(n={desiredPlaybackState$:this.params.desiredState.playbackState,maxTransitionInterval:Cu,position$:this.providerOutput.position$,providerChanged$:this.current$.pipe(f((({type:t})=>void 0!==t)))},new g((t=>{const s=new i,r=n.desiredPlaybackState$.stateChangeStarted$.pipe(u((({from:t,to:e})=>`${t}-${e}`))),a=n.desiredPlaybackState$.stateChangeEnded$,o=n.providerChanged$,d=new e;let h=0,l='unknown';return s.add(r.subscribe((t=>{h&&window.clearTimeout(h),l=t,h=window.setTimeout((()=>d.next(t)),n.maxTransitionInterval)}))),s.add(a.subscribe((()=>{window.clearTimeout(h),l='provider change',h=0}))),s.add(o.subscribe((()=>{h&&(window.clearTimeout(h),h=window.setTimeout((()=>d.next(l)),n.maxTransitionInterval))}))),s.add(d.subscribe(t)),()=>{window.clearTimeout(h),s.unsubscribe()}}))).pipe(u((t=>({id:`ProviderHangup:${t}`,message:`A ${t} transition failed to complete within reasonable time`}))))).subscribe(this.providerError$)),a.add(this.providerError$.pipe($(xu,{leading:!1,trailing:!0})).subscribe((()=>{const e=Date.now();this.current$.getValue().destination===D.CHROMECAST?(this.destroyProvider(),this.params.dependencies.chromecastInitializer.stopMedia().then((()=>{this.switchToNextProvider()}),(()=>{this.params.dependencies.chromecastInitializer.disconnect()}))):s(t[r])&&e<t[r]+Iu?(t=[],this.switchToNextProvider()):(t[r]=e,this.reinitProvider()),r=(r+1)%Lu}))),a}}const Vu=(t,e,i)=>i*e+(1-i)*t;class qu{constructor(e){var i;this.prevReported=void 0,this.pastMeasures=[],this.measuresCursor=0,this.params=e,this.pastMeasures=Array(e.deviationDepth),this.slow=this.fast=this.smoothed=this.prevReported=e.initial,this.smoothed$=new t(e.initial),this.debounced$=new t(e.initial);const s=null!==(i=e.label)&&void 0!==i?i:'value'+Math.random().toString(16).substring(2,6);this.rawSeries$=new ko(`raw_${s}`),this.smoothedSeries$=new ko(`smoothed_${s}`),this.reportedSeries$=new ko(`reported_${s}`),this.rawSeries$.next(e.initial),this.smoothedSeries$.next(e.initial),this.reportedSeries$.next(e.initial)}next(t){let e=0,i=0;for(let t=0;t<this.pastMeasures.length;t++)void 0!==this.pastMeasures[t]&&(e+=(this.pastMeasures[t]-this.smoothed)**2,i++);e/=i;const s=Math.sqrt(e),a=this.smoothed+this.params.deviationFactor*s,n=this.smoothed-this.params.deviationFactor*s;this.pastMeasures[this.measuresCursor]=t,this.measuresCursor=(this.measuresCursor+1)%this.pastMeasures.length,this.rawSeries$.next(t),this.slow=Vu(this.slow,t,this.params.emaAlphaSlow),this.fast=Vu(this.fast,t,this.params.emaAlphaFast);const o=this.params.fastDirection>0?Math.max:Math.min;this.smoothed=o(this.slow,this.fast),this.smoothed$.next(this.smoothed),this.smoothedSeries$.next(this.smoothed),this.smoothed>a||this.smoothed<n||(r(this.prevReported)||Math.abs(this.smoothed-this.prevReported)/this.prevReported>=this.params.changeThreshold)&&(this.prevReported=this.smoothed,this.debounced$.next(this.smoothed),this.reportedSeries$.next(this.smoothed))}}var Fu;!function(t){t[t.LOCAL_STORAGE=0]='LOCAL_STORAGE',t[t.SESSION_STORAGE=1]='SESSION_STORAGE',t[t.RUNTIME=2]='RUNTIME'}(Fu||(Fu={}));const Hu=new Map;let Gu=Fu.RUNTIME;const Yu=`vk-videoplayer-dummy-key-${Math.random()}`;(()=>{try{localStorage.setItem(Yu,'test'),localStorage.removeItem(Yu),Gu=Fu.LOCAL_STORAGE}catch(t){if(!(t instanceof DOMException||t instanceof TypeError))throw t;try{sessionStorage.getItem(Yu),Gu=Fu.SESSION_STORAGE}catch(t){if(!(t instanceof DOMException||t instanceof TypeError))throw t;Gu=Fu.RUNTIME}}})();const zu=(t,e)=>{switch(Gu){case Fu.LOCAL_STORAGE:try{localStorage.setItem(t,e)}catch(t){if(!(t instanceof DOMException))throw t;console.error(t)}break;case Fu.SESSION_STORAGE:try{sessionStorage.setItem(t,e)}catch(t){if(!(t instanceof DOMException))throw t;console.error(t)}break;case Fu.RUNTIME:return void Hu.set(t,e);default:n(Gu)}},Qu=window.navigator.connection,ju=()=>{const t=null==Qu?void 0:Qu.downlink;if(s(t)&&10!==t)return 1e3*t},Wu=()=>{const t=null==Qu?void 0:Qu.rtt;if(s(t)&&3e3!==t)return t},Ju=(t,e,i)=>{const s=8*i;return s/(s/t+e)};class Xu{constructor(e){var r,n;this.subscription=new i,this.concurrentDownloads=new Set,this.tuningConfig=e;const o=Xu.load('one_video_throughput')||(e.useBrowserEstimation?ju():void 0)||5e3,d=null!==(n=null!==(r=Xu.load('one_video_rtt'))&&void 0!==r?r:e.useBrowserEstimation?Wu():void 0)&&void 0!==n?n:0;if(this.throughput$=new t(o),this.rtt$=new t(d),this.rttAdjustedThroughput$=new t(Ju(o,d,e.rttPenaltyRequestSize)),this.throughput=new qu({initial:o,emaAlphaSlow:e.emaAlphaSlow,emaAlphaFast:e.emaAlphaFast,changeThreshold:e.changeThreshold,fastDirection:-1,deviationDepth:e.deviationDepth,deviationFactor:e.deviationFactor,label:'throughput'}),this.rtt=new qu({initial:d,emaAlphaSlow:e.emaAlphaSlow,emaAlphaFast:e.emaAlphaFast,changeThreshold:e.changeThreshold,fastDirection:1,deviationDepth:e.deviationDepth,deviationFactor:e.deviationFactor,label:'rtt'}),e.useBrowserEstimation){const t=()=>{const t=ju();t&&this.throughput.next(t);const e=Wu();s(e)&&this.rtt.next(e)};Qu&&'onchange'in Qu&&this.subscription.add(a(Qu,'change').subscribe(t)),t()}this.subscription.add(this.throughput.smoothed$.subscribe((t=>{zu('one_video_throughput',t.toFixed(0))}))),this.subscription.add(this.rtt.smoothed$.subscribe((t=>{zu('one_video_rtt',t.toFixed(0))}))),this.subscription.add(this.throughput.debounced$.subscribe(this.throughput$)),this.subscription.add(this.rtt.debounced$.subscribe(this.rtt$)),this.subscription.add(y({throughput:this.throughput.smoothed$,rtt:this.rtt.smoothed$}).pipe(u((({throughput:t,rtt:i})=>Ju(t,i,e.rttPenaltyRequestSize))),f((t=>{const i=this.rttAdjustedThroughput$.getValue()||0;return Math.abs(t-i)/i>=e.changeThreshold}))).subscribe(this.rttAdjustedThroughput$))}destroy(){this.concurrentDownloads.clear(),this.subscription.unsubscribe()}trackXHR(t){let e=0,s=S();const r=new i;switch(this.subscription.add(r),this.concurrentDownloads.add(t),t.readyState){case 4:break;case 3:case 2:r.add(a(t,'progress').pipe(b()).subscribe((t=>{e=t.loaded,s=S()})));break;case 1:case 0:r.add(a(t,'loadstart').subscribe((()=>{e=0,s=S()})))}r.add(a(t,'loadend').subscribe((i=>{if(200===t.status){const t=i.loaded,r=S(),a=t-e,n=r-s;this.addRawSpeed(a,n,1)}this.concurrentDownloads.delete(t),r.unsubscribe()})))}trackStream(t){const e=t.getReader();if(!e)return void t.cancel('Could not get reader');let i=0;const s=S();let r=0,a=S();const n=i=>{this.concurrentDownloads.delete(t),e.releaseLock(),t.cancel(`Throughput Estimator error: ${i}`).catch((()=>{}))},o=async({done:d,value:u})=>{d?(this.addRawSpeed(i,S()-s,1),this.concurrentDownloads.delete(t)):u&&(i+=u.byteLength,r+=u.byteLength,r>=this.tuningConfig.streamMinSampleSize&&S()-a>=this.tuningConfig.streamMinSampleTime&&(this.addRawSpeed(r,S()-a,this.concurrentDownloads.size),r=0,a=S()),await(null==e?void 0:e.read().then(o,n)))};this.concurrentDownloads.add(t),null==e||e.read().then(o,n)}addRawSpeed(t,e,i=1){if(Xu.sanityCheck(t,e)){const s=8*t/e;this.throughput.next(s*i)}}addRawThroughput(t){this.throughput.next(t)}addRawRtt(t){this.rtt.next(t)}static sanityCheck(t,e){const i=8*t/e;return!(!i||!isFinite(i))&&(!(i>1e6)&&(!(i<30)&&(!(t<10240)&&!(e<=20))))}static load(t){var e;const i=(t=>{var e,i;switch(Gu){case Fu.LOCAL_STORAGE:return null!==(e=localStorage.getItem(t))&&void 0!==e?e:void 0;case Fu.SESSION_STORAGE:return null!==(i=sessionStorage.getItem(t))&&void 0!==i?i:void 0;case Fu.RUNTIME:return Hu.get(t);default:n(Gu)}})(t);if(s(i))return null!==(e=parseInt(i,10))&&void 0!==e?e:void 0}}const Ku={throughputEstimator:{emaAlphaSlow:.2,emaAlphaFast:.7,changeThreshold:.05,useBrowserEstimation:!0,rttPenaltyRequestSize:1048576,streamMinSampleSize:10240,streamMinSampleTime:300,deviationDepth:10,deviationFactor:.5},autoTrackSelection:{bitrateFactorAtEmptyBuffer:1.8,bitrateFactorAtFullBuffer:1.2,usePixelRatio:!0,limitByContainer:!0,containerSizeFactor:2,lazyQualitySwitch:!0,minBufferToSwitchUp:.3,considerPlaybackRate:!1,trackCooldown:3e3},dash:{forwardBufferTarget:6e4,forwardBufferTargetAuto:6e4,forwardBufferTargetManual:3e5,segmentRequestSize:1048576,representationSwitchForwardBufferGap:3e3,enableSubSegmentBufferFeeding:!0,segmentTimelineTolerance:100,useFetchPriorityHints:!0},live:{minBuffer:3e3,minBufferSegments:3,lowLatencyMinBuffer:1e3,lowLatencyMinBufferSegments:1},downloadBackoff:{bufferThreshold:100,start:100,factor:2,max:3e3,random:.1},enableTelemetryAtStart:!1,formatsToAvoid:[],disableChromecast:!1,chromecastReceiverId:void 0,useWebmBigRequest:!0,bigRequestMinInitSize:51200,bigRequestMinDataSize:1048576,stripRangeHeader:!0,flushShortLoopedBuffers:!0,insufficientBufferRuleMargin:1e4,dashSeekInSegmentDurationThreshold:18e4,dashSeekInSegmentAlwaysSeekDelta:1e4,endGapTolerance:300,stallIgnoreThreshold:33,gapWatchdogInterval:50,requestQuick:!1,useDashJs:!1,useHlsJs:!0,webrtc:{connectionRetryMaxNumber:3}};const Zu=({playbackState:t,seekState:e,playbackAbort$:a,looped$:n,position$:d})=>new g((h=>{let l;const c=t.transitionEnded$.pipe(f((t=>(t.from===P.PAUSED||t.from===P.STOPPED)&&t.to===P.PLAYING))),p=t.stateChangeEnded$.pipe(f((t=>t.from===P.PLAYING&&t.to===P.PAUSED))),m=e.stateChangeEnded$.pipe(f((({to:e})=>{var i,s;return e.state===L.Requested&&(null!==(s=null===(i=t.getTransition())||void 0===i?void 0:i.from)&&void 0!==s?s:t.getState())===P.PLAYING}))),v=e.stateChangeEnded$.pipe(f((({from:e,to:i})=>{var s,r;return e.state===L.Applying&&i.state===L.None&&(null!==(r=null===(s=t.getTransition())||void 0===s?void 0:s.from)&&void 0!==r?r:t.getState())===P.PLAYING}))),S=o(c,v).pipe(u((()=>d.getValue())),f(s)),g=o(o(p,m,a),n).pipe(u((()=>d.getValue())),f(s));return(new i).add(S.subscribe((t=>{l=t}))).add(g.subscribe((t=>{if(r(l)||l===t)return;const e={from:l,to:t};l=void 0,h.next(e)})))})),th={[D.SCREEN]:{vod:[...Du?[R.HLS,R.HLS_ONDEMAND]:[],R.DASH_WEBM,R.DASH_SEP,R.DASH,R.DASH_ONDEMAND,...Du?[]:[R.HLS,R.HLS_ONDEMAND],R.MPEG],live:Du?[R.WEB_RTC_LIVE,R.HLS_LIVE,R.DASH_LIVE]:[R.WEB_RTC_LIVE,R.DASH_LIVE,R.HLS_LIVE]},[D.CHROMECAST]:{vod:[R.DASH_WEBM,R.DASH_SEP,R.DASH_ONDEMAND,R.HLS,R.HLS_ONDEMAND,R.MPEG],live:[R.HLS_LIVE]}};class eh{constructor(s={}){if(this.subscription=new i,this.logger=new k,this.isPlaybackStarted=!1,this.desiredState={playbackState:new z(P.STOPPED),seekState:new z({state:L.None}),volume:new z({volume:1,muted:!1}),videoTrack:new z(void 0),autoVideoTrackSwitching:new z(!0),autoVideoTrackLimits:new z({}),isLooped:new z(!1),playbackRate:new z(1),externalTextTracks:new z([]),currentTextTrack:new z(void 0),textTrackCuesSettings:new z({})},this.info={playbackState$:new t(P.STOPPED),position$:new t(0),duration$:new t(1/0),muted$:new t(!1),volume$:new t(1),availableQualities$:new t([]),availableQualitiesFps$:new t({}),currentQuality$:new t(void 0),isAutoQualityEnabled$:new t(!0),autoQualityLimitingAvailable$:new t(!1),autoQualityLimits$:new t({}),currentPlaybackRate$:new t(1),currentBuffer$:new t({start:0,end:0}),isBuffering$:new t(!0),isStalled$:new t(!1),isEnded$:new t(!1),isLooped$:new t(!1),isLive$:new t(void 0),liveTime$:new t(void 0),currentFormat$:new t(void 0),availableTextTracks$:new t([]),currentTextTrack$:new t(void 0),throughputEstimation$:new t(void 0),rttEstimation$:new t(void 0),videoBitrate$:new t(void 0),hostname$:new t(void 0),httpConnectionType$:new t(void 0),httpConnectionReused$:new t(void 0),chromecastState$:new t(_.NOT_AVAILABLE),chromecastDeviceName$:new t(void 0),intrinsicVideoSize$:new t(void 0)},this.events={inited$:new e,started$:new e,startAttempt$:new e,willPause$:new e,willResume$:new e,willDestruct$:new e,watchCoverageRecord$:new e,watchCoverageLive$:new e,managedError$:new e,fatalError$:new e,ended$:new e,looped$:new e,seeked$:new e,willSeek$:new e,firstBytes$:new e,firstFrame$:new e,canplay$:new e,log$:new e},this.experimental={element$:new t(void 0),enableDebugTelemetry$:new t(!1),dumpTelemetry:wo},this.initLogs(),this.tuning=(t=>{const e={};for(const i of Object.keys(Ku)){const s=Ku[i],r=t[i];Array.isArray(s)&&Array.isArray(r)?e[i]=r:e[i]='object'==typeof s&&'object'==typeof r?{...s,...r}:null!=r?r:s}return e})(s),this.chromecastInitializer=new x({receiverApplicationId:s.chromecastReceiverId,isDisabled:s.disableChromecast,dependencies:{logger:this.logger}}),this.throughputEstimator=new Xu(this.tuning.throughputEstimator),this.initChromecastSubscription(),this.initDesiredStateSubscriptions(),Proxy&&Reflect)return new Proxy(this,{get:(t,e,i)=>{const s=Reflect.get(t,e,i);return'function'!=typeof s?s:(...i)=>{try{return s.apply(t,i)}catch(t){const s=i.map((t=>JSON.stringify(t,((t,e)=>{const i=typeof e;return['number','string','boolean'].includes(i)?e:null===e?null:`<${i}>`})))),r=`Player.${String(e)}`,a=`Exception calling ${r} (${s.join(', ')})`;throw this.events.fatalError$.next({id:r,message:a,thrown:t}),t}}}})}initVideo(t){var e,i;return this.config=t,this.domContainer=(t=>{const e='string'==typeof t.container?document.getElementById(t.container):t.container;return c(e,`Wrong container or containerId {${t.container}}`),e})(t),this.chromecastInitializer.contentId=null===(e=t.meta)||void 0===e?void 0:e.videoId,this.providerContainer=new Uu({screenFormatsPriority:[...th[D.SCREEN].live,...th[D.SCREEN].vod],chromecastFormatsPriority:[...th[D.CHROMECAST].live,...th[D.CHROMECAST].vod],sources:t.sources,meta:null!==(i=t.meta)&&void 0!==i?i:{},container:this.domContainer,desiredState:this.desiredState,dependencies:{throughputEstimator:this.throughputEstimator,chromecastInitializer:this.chromecastInitializer,logger:this.logger},tuning:this.tuning}),this.initProviderContainerSubscription(this.providerContainer),this.initStartingVideoTrack(this.providerContainer),this.providerContainer.init(),this.initDebugTelemetry(),this}destroy(){var t;this.events.willDestruct$.next(),null===(t=this.providerContainer)||void 0===t||t.destroy(),this.throughputEstimator.destroy(),this.chromecastInitializer.destroy(),this.subscription.unsubscribe()}play(){const t=this.desiredState.playbackState;return t.getState()!==P.PLAYING&&t.startTransitionTo(P.PLAYING),this}pause(){const t=this.desiredState.playbackState;return t.getState()!==P.PAUSED&&t.startTransitionTo(P.PAUSED),this}stop(){const t=this.desiredState.playbackState;return t.getState()!==P.STOPPED&&t.startTransitionTo(P.STOPPED),this}seekTime(t,e=!0){return this.events.willSeek$.next({from:this.getExactTime(),to:t}),this.desiredState.seekState.setState({state:L.Requested,position:1e3*t,forcePrecise:e}),this}seekPercent(t){const e=this.info.duration$.getValue();return isFinite(e)&&this.seekTime(Math.abs(e)*t),this}setVolume(t){return this.chromecastInitializer.castState$.getValue()===_.CONNECTED?this.chromecastInitializer.setVolume(t):this.desiredState.volume.startTransitionTo({volume:t,muted:this.desiredState.volume.getState().muted}),this}setMuted(t){return this.chromecastInitializer.castState$.getValue()===_.CONNECTED?this.chromecastInitializer.setMuted(t):this.desiredState.volume.startTransitionTo({volume:this.desiredState.volume.getState().volume,muted:t}),this}setQuality(t){c(this.providerContainer);const e=this.providerContainer.providerOutput.availableVideoTracks$.getValue();e.length||(this.explicitInitialQuality=t);const i=e.find((e=>e.quality===t));return i&&this.desiredState.videoTrack.startTransitionTo(i.id),this}setAutoQuality(t){return this.desiredState.autoVideoTrackSwitching.startTransitionTo(t),this}setAutoQualityLimits(t){return this.desiredState.autoVideoTrackLimits.setState(t),this}setPlaybackRate(t){var e;c(this.providerContainer);const i=null===(e=this.providerContainer)||void 0===e?void 0:e.providerOutput.element$.getValue();return i&&(this.desiredState.playbackRate.setState(t),i.playbackRate=t),this}setExternalTextTracks(t){return this.desiredState.externalTextTracks.startTransitionTo(t.map((t=>({type:'external',...t})))),this}selectTextTrack(t){var e;return(void 0===t||(null===(e=this.providerContainer)||void 0===e?void 0:e.providerOutput.availableTextTracks$.getValue().find((e=>e.id===t))))&&this.desiredState.currentTextTrack.startTransitionTo(t),this}setTextTrackCueSettings(t){return this.desiredState.textTrackCuesSettings.startTransitionTo(t),this}setLooped(t){return this.desiredState.isLooped.startTransitionTo(t),this}toggleChromecast(){this.chromecastInitializer.toggleConnection()}getExactTime(){c(this.providerContainer);const t=this.providerContainer.providerOutput.element$.getValue();if(r(t))return this.info.position$.getValue();const e=this.desiredState.seekState.getState(),i=e.state===L.None?void 0:e.position;return s(i)?i/1e3:t.currentTime}getAllLogs(){return this.logger.getAllLogs()}initDesiredStateSubscriptions(){this.subscription.add(o(this.desiredState.playbackState.stateChangeStarted$,this.desiredState.playbackState.forceChanged$).pipe(u((t=>t.to))).subscribe(this.info.playbackState$)).add(this.desiredState.isLooped.stateChangeEnded$.pipe(u((t=>t.to))).subscribe(this.info.isLooped$)).add(this.desiredState.playbackRate.stateChangeEnded$.pipe(u((t=>t.to))).subscribe(this.info.currentPlaybackRate$)).add(this.desiredState.autoVideoTrackSwitching.stateChangeEnded$.pipe(u((t=>t.to))).subscribe(this.info.isAutoQualityEnabled$)).add(this.desiredState.autoVideoTrackLimits.stateChangeEnded$.pipe(u((t=>t.to))).subscribe(this.info.autoQualityLimits$));const t=new i;this.subscription.add(t),this.subscription.add(this.desiredState.playbackState.stateChangeStarted$.pipe(f((t=>t.to===P.PLAYING)),f((()=>!this.isPlaybackStarted))).subscribe((()=>{this.initedAt=S(),this.events.inited$.next(),t.unsubscribe(),t.add(this.desiredState.playbackState.stateChangeEnded$.pipe(f((t=>t.to===P.PLAYING||t.to===P.PAUSED)),p(0),b()).subscribe((t=>{const e=t.to===P.PLAYING,i=this.info.muted$.getValue(),s=e?i?C.SuccessWithoutSound:C.SuccessWithSound:C.Failed;this.events.startAttempt$.next(s)})))}))),this.subscription.add(this.desiredState.playbackState.stateChangeEnded$.pipe(f((t=>t.to===P.PLAYING))).subscribe((()=>{if(!this.isPlaybackStarted){const t=this.info.muted$.getValue();this.isPlaybackStarted=!0,this.events.started$.next(t)}}))).add(this.desiredState.playbackState.stateChangeStarted$.subscribe((t=>{switch(t.to){case P.PAUSED:this.events.willPause$.next();break;case P.PLAYING:this.isPlaybackStarted&&this.events.willResume$.next()}})))}initProviderContainerSubscription(e){this.subscription.add(e.providerOutput.willSeekEvent$.subscribe((()=>{const t=this.desiredState.seekState.getState();t.state===L.Requested?this.desiredState.seekState.setState({...t,state:L.Applying}):this.events.managedError$.next({id:`WillSeekIn${t.state}`,message:'Received unexpeceted willSeek$'})}))).add(e.providerOutput.seekedEvent$.subscribe((()=>{this.desiredState.seekState.getState().state===L.Applying&&(this.desiredState.seekState.setState({state:L.None}),this.events.seeked$.next())}))).add(e.current$.pipe(u((t=>t.type))).subscribe(this.info.currentFormat$)).add(e.current$.pipe(u((t=>t.destination)),l()).subscribe((()=>{this.isPlaybackStarted=!1}))).add(e.providerOutput.availableVideoTracks$.pipe(u((t=>t.map((({quality:t})=>t)).sort(((t,e)=>Y(t)?1:Y(e)?-1:q(e,t)?1:-1))))).subscribe(this.info.availableQualities$)).add(e.providerOutput.availableVideoTracks$.subscribe((t=>{const e={};for(const i of t)i.fps&&(e[i.quality]=i.fps);this.info.availableQualitiesFps$.next(e)}))).add(e.providerOutput.currentVideoTrack$.subscribe((t=>{this.info.currentQuality$.next(null==t?void 0:t.quality),this.info.videoBitrate$.next(null==t?void 0:t.bitrate);const i=e.providerOutput.element$.getValue();i&&this.info.intrinsicVideoSize$.next({width:i.videoWidth,height:i.videoHeight})}))).add(e.providerOutput.hostname$.pipe(l()).subscribe(this.info.hostname$)).add(e.providerOutput.httpConnectionType$.pipe(l()).subscribe(this.info.httpConnectionType$)).add(e.providerOutput.httpConnectionReused$.pipe(l()).subscribe(this.info.httpConnectionReused$)).add(e.providerOutput.currentTextTrack$.subscribe(this.info.currentTextTrack$)).add(e.providerOutput.availableTextTracks$.subscribe(this.info.availableTextTracks$)).add(e.providerOutput.autoVideoTrackLimitingAvailable$.subscribe(this.info.autoQualityLimitingAvailable$)).add(e.providerOutput.currentBuffer$.pipe(u((t=>t?{start:t.from,end:t.to}:{start:0,end:0}))).subscribe(this.info.currentBuffer$)).add(e.providerOutput.duration$.subscribe(this.info.duration$)).add(e.providerOutput.isBuffering$.subscribe(this.info.isBuffering$)).add(e.providerOutput.isLive$.subscribe(this.info.isLive$)).add(e.providerOutput.liveTime$.subscribe(this.info.liveTime$)).add(e.providerOutput.volume$.pipe(u((t=>t.muted)),l()).subscribe(this.info.muted$)).add(e.providerOutput.volume$.pipe(u((t=>t.volume)),l()).subscribe(this.info.volume$)).add((({seekState:t,position$:e})=>o(t.stateChangeEnded$.pipe(u((({to:t})=>{var e;return t.state===L.None?void 0:(null!==(e=t.position)&&void 0!==e?e:NaN)/1e3})),f(s)),e.pipe(f((()=>t.getState().state===L.None)))))({seekState:this.desiredState.seekState,position$:e.providerOutput.position$}).subscribe(this.info.position$)).add(o(e.providerOutput.endedEvent$.pipe(v(!0)),e.providerOutput.seekedEvent$.pipe(v(!1))).pipe(l()).subscribe(this.info.isEnded$)).add(e.providerOutput.endedEvent$.subscribe(this.events.ended$)).add(e.providerOutput.loopedEvent$.subscribe(this.events.looped$)).add(e.providerError$.subscribe(this.events.managedError$)).add(e.noAvailableProvidersError$.pipe(u((t=>({id:'NoProviders',message:'No suitable providers or all providers failed'})))).subscribe(this.events.fatalError$)).add(e.providerOutput.element$.subscribe(this.experimental.element$)).add(e.providerOutput.firstBytesEvent$.pipe(b(),u((()=>S()-this.initedAt))).subscribe(this.events.firstBytes$)).add(e.providerOutput.firstFrameEvent$.pipe(b(),u((()=>S()-this.initedAt))).subscribe(this.events.firstFrame$)).add(e.providerOutput.canplay$.pipe(b(),u((()=>S()-this.initedAt))).subscribe(this.events.canplay$)).add(this.throughputEstimator.throughput$.subscribe(this.info.throughputEstimation$)).add(this.throughputEstimator.rtt$.subscribe(this.info.rttEstimation$));const r=new t(!1);this.subscription.add(e.providerOutput.seekedEvent$.subscribe((()=>r.next(!1)))).add(e.providerOutput.willSeekEvent$.subscribe((()=>r.next(!0))));const n=new t(!0);this.subscription.add(e.current$.subscribe((()=>n.next(!0)))).add(this.desiredState.playbackState.stateChangeEnded$.pipe(f((({to:t})=>t===P.PLAYING)),b()).subscribe((()=>n.next(!1))));let d=0;const h=o(e.providerOutput.isBuffering$,r,n).pipe(u((()=>{const t=e.providerOutput.isBuffering$.getValue(),i=r.getValue()||n.getValue();return t&&!i})),l());this.subscription.add(h.subscribe((t=>{t?d=window.setTimeout((()=>this.info.isStalled$.next(!0)),this.tuning.stallIgnoreThreshold):(window.clearTimeout(d),this.info.isStalled$.next(!1))})));const p=new i;this.subscription.add(p);const m=o(a(window,'beforeunload'),this.events.willDestruct$,e.current$.pipe(f((t=>Boolean(null==t?void 0:t.provider)))));e.providerOutput.isLive$.pipe(l()).subscribe((t=>{switch(c(this.providerContainer),p.unsubscribe(),t){case!0:p.add(Zu({seekState:this.desiredState.seekState,playbackState:this.desiredState.playbackState,playbackAbort$:m,looped$:this.events.looped$,position$:this.providerContainer.providerOutput.liveTime$}).pipe(u((({from:t,to:e})=>({start:t,end:e})))).subscribe(this.events.watchCoverageLive$));break;case!1:p.add(Zu({seekState:this.desiredState.seekState,playbackState:this.desiredState.playbackState,looped$:this.events.looped$,playbackAbort$:m,position$:this.providerContainer.providerOutput.position$}).pipe(u((({from:t,to:e})=>({start:t,end:e})))).subscribe(this.events.watchCoverageRecord$))}}))}initChromecastSubscription(){this.subscription.add(this.chromecastInitializer.castState$.subscribe(this.info.chromecastState$)),this.subscription.add(this.chromecastInitializer.connection$.pipe(u((t=>null==t?void 0:t.castDevice.friendlyName))).subscribe(this.info.chromecastDeviceName$)),this.subscription.add(this.chromecastInitializer.errorEvent$.subscribe(this.events.managedError$))}initStartingVideoTrack(t){const e=new i;this.subscription.add(e),this.subscription.add(t.current$.pipe(l(((t,e)=>t.provider===e.provider))).subscribe((()=>{e.unsubscribe(),e.add(t.providerOutput.availableVideoTracks$.pipe(f((t=>t.length>0)),b()).subscribe((t=>{this.setStartingVideoTrack(t)})))})))}setStartingVideoTrack(t){let e;this.explicitInitialQuality&&(e=t.find((({quality:t})=>t===this.explicitInitialQuality)),this.explicitInitialQuality=void 0),e||(e=Ro(t,{container:this.domContainer.getBoundingClientRect(),throughput:this.throughputEstimator.throughput$.getValue(),tuning:this.tuning.autoTrackSelection,limits:this.desiredState.autoVideoTrackLimits.getState(),playbackRate:this.info.currentPlaybackRate$.getValue(),forwardBufferHealth:0})),this.desiredState.videoTrack.startTransitionTo(e.id),this.info.currentQuality$.next(e.quality),this.info.videoBitrate$.next(e.bitrate)}initLogs(){this.subscription.add(o(this.desiredState.videoTrack.stateChangeStarted$.pipe(u((t=>({transition:t,entity:'quality',type:'start'})))),this.desiredState.videoTrack.stateChangeEnded$.pipe(u((t=>({transition:t,entity:'quality',type:'end'})))),this.desiredState.autoVideoTrackSwitching.stateChangeStarted$.pipe(u((t=>({transition:t,entity:'autoQualityEnabled',type:'start'})))),this.desiredState.autoVideoTrackSwitching.stateChangeEnded$.pipe(u((t=>({transition:t,entity:'autoQualityEnabled',type:'end'})))),this.desiredState.seekState.stateChangeStarted$.pipe(u((t=>({transition:t,entity:'seekState',type:'start'})))),this.desiredState.seekState.stateChangeEnded$.pipe(u((t=>({transition:t,entity:'seekState',type:'end'})))),this.desiredState.playbackState.stateChangeStarted$.pipe(u((t=>({transition:t,entity:'playbackState',type:'start'})))),this.desiredState.playbackState.stateChangeEnded$.pipe(u((t=>({transition:t,entity:'playbackState',type:'end'}))))).pipe(u((t=>({component:'desiredState',message:`[${t.entity} change] ${t.type}: ${JSON.stringify(t.transition)}`})))).subscribe(this.logger.log)),this.subscription.add(this.logger.log$.subscribe(this.events.log$))}initDebugTelemetry(){var t;const e=null===(t=this.providerContainer)||void 0===t?void 0:t.providerOutput;c(this.providerContainer),c(e),Eo={},this.experimental.enableDebugTelemetry$.next(this.tuning.enableTelemetryAtStart),[this.experimental.enableDebugTelemetry$.subscribe((t=>{To=t})),this.providerContainer.current$.subscribe((({type:t})=>$o('provider',t))),e.duration$.subscribe((t=>$o('duration',t))),e.availableVideoTracks$.pipe(f((t=>!!t.length)),b()).subscribe((t=>$o('tracks',t))),this.events.fatalError$.subscribe(new ko('fatalError')),this.events.managedError$.subscribe(new ko('managedError')),e.position$.subscribe(new ko('position')),e.currentVideoTrack$.pipe(u((t=>null==t?void 0:t.quality))).subscribe(new ko('quality')),this.info.currentBuffer$.subscribe(new ko('buffer')),e.isBuffering$.subscribe(new ko('isBuffering'))].forEach((t=>this.subscription.add(t))),$o('codecs',Object.keys(Au).filter((t=>Au[t])))}}const ih='@vkontakte/videoplayer-core@2.0.71';export{_ as ChromecastState,I as HttpConnectionType,P as PlaybackState,eh as Player,ih as SDK_VERSION,C as StartStatus,R as VideoFormat,B as VideoQuality};
