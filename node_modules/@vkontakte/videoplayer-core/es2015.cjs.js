/**
 * @vkontakte/videoplayer-core v2.0.71
 * Wed, 21 Sep 2022 05:29:45 GMT
 * https://st.mycdn.me/static/vkontakte-videoplayer/2-0-71/doc/
 */
'use strict';Object.defineProperty(exports,'__esModule',{value:!0});var t=require('@vkontakte/videoplayer-shared/es2015.cjs.js');function e(t){return t&&'object'==typeof t&&'default'in t?t:{default:t}}function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if('default'!==i){var s=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,s.get?s:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var s=e(require('lodash/debounce.js'));var a,r,n,o,u,d,l;exports.PlaybackState=void 0,(a=exports.PlaybackState||(exports.PlaybackState={})).STOPPED='stopped',a.PLAYING='playing',a.PAUSED='paused',exports.VideoFormat=void 0,(r=exports.VideoFormat||(exports.VideoFormat={})).MPEG='MPEG',r.DASH='DASH',r.DASH_SEP='DASH_SEP',r.DASH_SEP_VK='DASH_SEP',r.DASH_WEBM='DASH_WEBM',r.DASH_WEBM_VK='DASH_WEBM',r.DASH_ONDEMAND='DASH_ONDEMAND',r.DASH_ONDEMAND_VK='DASH_ONDEMAND',r.DASH_LIVE='DASH_LIVE',r.DASH_LIVE_WEBM='DASH_LIVE_WEBM',r.HLS='HLS',r.HLS_ONDEMAND='HLS_ONDEMAND',r.HLS_JS='HLS',r.HLS_LIVE='HLS_LIVE',r.WEB_RTC_LIVE='WEB_RTC_LIVE',function(t){t.SCREEN='SCREEN',t.CHROMECAST='CHROMECAST'}(n||(n={})),exports.ChromecastState=void 0,(o=exports.ChromecastState||(exports.ChromecastState={})).NOT_AVAILABLE='NOT_AVAILABLE',o.AVAILABLE='AVAILABLE',o.CONNECTING='CONNECTING',o.CONNECTED='CONNECTED',exports.StartStatus=void 0,(u=exports.StartStatus||(exports.StartStatus={})).SuccessWithSound='success_with_sound',u.SuccessWithoutSound='success_without_sound',u.Failed='failed',exports.HttpConnectionType=void 0,(d=exports.HttpConnectionType||(exports.HttpConnectionType={})).HTTP1='http1',d.HTTP2='http2',d.QUIC='quic',function(t){t.None='none',t.Requested='requested',t.Applying='applying'}(l||(l={}));class c{constructor(e){var i;this.connection$=new t.ValueSubject(void 0),this.castState$=new t.ValueSubject(exports.ChromecastState.NOT_AVAILABLE),this.errorEvent$=new t.Subject,this.realCastState$=new t.ValueSubject(exports.ChromecastState.NOT_AVAILABLE),this.subscription=new t.Subscription,this.params=e,this.log=this.params.dependencies.logger.createComponentLog('ChromecastInitializer');const s='chrome'in window;if(this.log({message:`[constructor] receiverApplicationId: ${this.params.receiverApplicationId}, isDisabled: ${this.params.isDisabled}, isSupported: ${s}`}),e.isDisabled||!s)return;var a;t.isNonNullable(null===(i=window.chrome)||void 0===i?void 0:i.cast)?this.initializeCastApi():(window.__onGCastApiAvailable=t=>{t&&this.initializeCastApi()},(a='https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1',new Promise(((t,e)=>{const i=document.createElement('script');i.setAttribute('src',a),i.onload=()=>t,i.onerror=()=>e,document.body.appendChild(i)}))).catch((()=>this.errorEvent$.next({id:'ChromecastLoading',message:'Script loading failed!'}))))}connect(){var t;null===(t=cast.framework.CastContext.getInstance())||void 0===t||t.requestSession()}disconnect(){var t,e;null===(e=null===(t=cast.framework.CastContext.getInstance())||void 0===t?void 0:t.getCurrentSession())||void 0===e||e.endSession(!0)}stopMedia(){return new Promise(((t,e)=>{var i,s,a;null===(a=null===(s=null===(i=cast.framework.CastContext.getInstance())||void 0===i?void 0:i.getCurrentSession())||void 0===s?void 0:s.getMediaSession())||void 0===a||a.stop(new chrome.cast.media.StopRequest,t,e)}))}toggleConnection(){t.isNonNullable(this.connection$.getValue())?this.disconnect():this.connect()}setVolume(e){const i=this.connection$.getValue();t.isNullable(i)||(i.remotePlayer.volumeLevel=e,i.remotePlayerController.setVolumeLevel())}setMuted(e){const i=this.connection$.getValue();t.isNullable(i)||e!==i.remotePlayer.isMuted&&i.remotePlayerController.muteOrUnmute()}destroy(){this.subscription.unsubscribe()}initListeners(){const e=new cast.framework.RemotePlayer,i=new cast.framework.RemotePlayerController(e),s=cast.framework.CastContext.getInstance();this.subscription.add(t.fromEvent(s,cast.framework.CastContextEventType.SESSION_STATE_CHANGED).subscribe((e=>{var i,a;switch(e.sessionState){case cast.framework.SessionState.SESSION_STARTED:case cast.framework.SessionState.SESSION_STARTING:case cast.framework.SessionState.SESSION_RESUMED:this.contentId=null===(a=null===(i=s.getCurrentSession())||void 0===i?void 0:i.getMediaSession())||void 0===a?void 0:a.media.contentId;break;case cast.framework.SessionState.NO_SESSION:case cast.framework.SessionState.SESSION_ENDING:case cast.framework.SessionState.SESSION_ENDED:case cast.framework.SessionState.SESSION_START_FAILED:this.contentId=void 0;break;default:return t.assertNever(e.sessionState)}}))).add(t.merge(t.fromEvent(s,cast.framework.CastContextEventType.CAST_STATE_CHANGED).pipe(t.tap((t=>{this.log({message:`[cast.framework.RemotePlayerEventType.CAST_STATE_CHANGED]: ${JSON.stringify(t)}`})})),t.map((t=>t.castState))),t.observableFrom([s.getCastState()])).pipe(t.filterChanged(),t.map(h),t.tap((t=>{this.log({message:`realCastState$: ${t}`})}))).subscribe(this.realCastState$)).add(this.realCastState$.subscribe((a=>{var r;const n=a===exports.ChromecastState.CONNECTED,o=t.isNonNullable(this.connection$.getValue());if(n&&!o){const a=s.getCurrentSession();t.assertNonNullable(a);const n=a.getCastDevice(),o=null===(r=a.getMediaSession())||void 0===r?void 0:r.media.contentId;(t.isNullable(o)||o===this.contentId)&&(this.log({message:'connection created'}),this.connection$.next({remotePlayer:e,remotePlayerController:i,session:a,castDevice:n}))}else!n&&o&&(this.log({message:'connection destroyed'}),this.connection$.next(void 0));this.castState$.next(a===exports.ChromecastState.CONNECTED?t.isNonNullable(this.connection$.getValue())?exports.ChromecastState.CONNECTED:exports.ChromecastState.AVAILABLE:a)})))}initializeCastApi(){var t;let e,i,s;try{e=cast.framework.CastContext.getInstance(),i=chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,s=chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED}catch(t){return}try{e.setOptions({receiverApplicationId:null!==(t=this.params.receiverApplicationId)&&void 0!==t?t:i,autoJoinPolicy:s}),this.initListeners()}catch(t){this.errorEvent$.next({id:'ChromecastInitializer',message:'[initializeCastApi] failed',thrown:t})}}}const h=e=>{switch(e){case cast.framework.CastState.NO_DEVICES_AVAILABLE:return exports.ChromecastState.NOT_AVAILABLE;case cast.framework.CastState.NOT_CONNECTED:return exports.ChromecastState.AVAILABLE;case cast.framework.CastState.CONNECTING:return exports.ChromecastState.CONNECTING;case cast.framework.CastState.CONNECTED:return exports.ChromecastState.CONNECTED;default:return t.assertNever(e)}};var p='undefined'!=typeof globalThis?globalThis:'undefined'!=typeof window?window:'undefined'!=typeof global?global:'undefined'!=typeof self?self:{},m=function(t){return t&&t.Math==Math&&t},f=m('object'==typeof globalThis&&globalThis)||m('object'==typeof window&&window)||m('object'==typeof self&&self)||m('object'==typeof p&&p)||function(){return this}()||Function('return this')(),b=function(t){try{return!!t()}catch(t){return!0}},S=!b((function(){var t=function(){}.bind();return'function'!=typeof t||t.hasOwnProperty('prototype')})),v=S,g=Function.prototype,y=g.apply,T=g.call,E='object'==typeof Reflect&&Reflect.apply||(v?T.bind(y):function(){return T.apply(y,arguments)}),k=S,w=Function.prototype,P=w.bind,$=w.call,A=k&&P.bind($,$),x=k?function(t){return t&&A(t)}:function(t){return t&&function(){return $.apply(t,arguments)}},N=function(t){return'function'==typeof t},R={},D=!b((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),C=S,_=Function.prototype.call,I=C?_.bind(_):function(){return _.apply(_,arguments)},L={},O={}.propertyIsEnumerable,B=Object.getOwnPropertyDescriptor,M=B&&!O.call({1:2},1);L.f=M?function(t){var e=B(this,t);return!!e&&e.enumerable}:O;var V,U,F=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},j=x,q=j({}.toString),H=j(''.slice),G=function(t){return H(q(t),8,-1)},Y=b,Q=G,z=Object,W=x(''.split),J=Y((function(){return!z('z').propertyIsEnumerable(0)}))?function(t){return'String'==Q(t)?W(t,''):z(t)}:z,X=TypeError,K=function(t){if(null==t)throw X('Can\'t call method on '+t);return t},Z=J,tt=K,et=function(t){return Z(tt(t))},it=N,st=function(t){return'object'==typeof t?null!==t:it(t)},at={},rt=at,nt=f,ot=N,ut=function(t){return ot(t)?t:void 0},dt=function(t,e){return arguments.length<2?ut(rt[t])||ut(nt[t]):rt[t]&&rt[t][e]||nt[t]&&nt[t][e]},lt=x({}.isPrototypeOf),ct=dt('navigator','userAgent')||'',ht=f,pt=ct,mt=ht.process,ft=ht.Deno,bt=mt&&mt.versions||ft&&ft.version,St=bt&&bt.v8;St&&(U=(V=St.split('.'))[0]>0&&V[0]<4?1:+(V[0]+V[1])),!U&&pt&&(!(V=pt.match(/Edge\/(\d+)/))||V[1]>=74)&&(V=pt.match(/Chrome\/(\d+)/))&&(U=+V[1]);var vt=U,gt=vt,yt=b,Tt=!!Object.getOwnPropertySymbols&&!yt((function(){var t=Symbol();return!String(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&gt&&gt<41})),Et=Tt&&!Symbol.sham&&'symbol'==typeof Symbol.iterator,kt=dt,wt=N,Pt=lt,$t=Object,At=Et?function(t){return'symbol'==typeof t}:function(t){var e=kt('Symbol');return wt(e)&&Pt(e.prototype,$t(t))},xt=String,Nt=function(t){try{return xt(t)}catch(t){return'Object'}},Rt=N,Dt=Nt,Ct=TypeError,_t=function(t){if(Rt(t))return t;throw Ct(Dt(t)+' is not a function')},It=_t,Lt=function(t,e){var i=t[e];return null==i?void 0:It(i)},Ot=I,Bt=N,Mt=st,Vt=TypeError,Ut={exports:{}},Ft=f,jt=Object.defineProperty,qt=function(t,e){try{jt(Ft,t,{value:e,configurable:!0,writable:!0})}catch(i){Ft[t]=e}return e},Ht=f['__core-js_shared__']||qt('__core-js_shared__',{}),Gt=Ht;(Ut.exports=function(t,e){return Gt[t]||(Gt[t]=void 0!==e?e:{})})('versions',[]).push({version:'3.24.1',mode:'pure',copyright:'Â© 2014-2022 Denis Pushkarev (zloirock.ru)',license:'https://github.com/zloirock/core-js/blob/v3.24.1/LICENSE',source:'https://github.com/zloirock/core-js'});var Yt=K,Qt=Object,zt=function(t){return Qt(Yt(t))},Wt=zt,Jt=x({}.hasOwnProperty),Xt=Object.hasOwn||function(t,e){return Jt(Wt(t),e)},Kt=x,Zt=0,te=Math.random(),ee=Kt(1..toString),ie=function(t){return'Symbol('+(void 0===t?'':t)+')_'+ee(++Zt+te,36)},se=f,ae=Ut.exports,re=Xt,ne=ie,oe=Tt,ue=Et,de=ae('wks'),le=se.Symbol,ce=le&&le.for,he=ue?le:le&&le.withoutSetter||ne,pe=function(t){if(!re(de,t)||!oe&&'string'!=typeof de[t]){var e='Symbol.'+t;oe&&re(le,t)?de[t]=le[t]:de[t]=ue&&ce?ce(e):he(e)}return de[t]},me=I,fe=st,be=At,Se=Lt,ve=function(t,e){var i,s;if('string'===e&&Bt(i=t.toString)&&!Mt(s=Ot(i,t)))return s;if(Bt(i=t.valueOf)&&!Mt(s=Ot(i,t)))return s;if('string'!==e&&Bt(i=t.toString)&&!Mt(s=Ot(i,t)))return s;throw Vt('Can\'t convert object to primitive value')},ge=TypeError,ye=pe('toPrimitive'),Te=function(t,e){if(!fe(t)||be(t))return t;var i,s=Se(t,ye);if(s){if(void 0===e&&(e='default'),i=me(s,t,e),!fe(i)||be(i))return i;throw ge('Can\'t convert object to primitive value')}return void 0===e&&(e='number'),ve(t,e)},Ee=At,ke=function(t){var e=Te(t,'string');return Ee(e)?e:e+''},we=st,Pe=f.document,$e=we(Pe)&&we(Pe.createElement),Ae=function(t){return $e?Pe.createElement(t):{}},xe=Ae,Ne=!D&&!b((function(){return 7!=Object.defineProperty(xe('div'),'a',{get:function(){return 7}}).a})),Re=D,De=I,Ce=L,_e=F,Ie=et,Le=ke,Oe=Xt,Be=Ne,Me=Object.getOwnPropertyDescriptor;R.f=Re?Me:function(t,e){if(t=Ie(t),e=Le(e),Be)try{return Me(t,e)}catch(t){}if(Oe(t,e))return _e(!De(Ce.f,t,e),t[e])};var Ve=b,Ue=N,Fe=/#|\.prototype\./,je=function(t,e){var i=He[qe(t)];return i==Ye||i!=Ge&&(Ue(e)?Ve(e):!!e)},qe=je.normalize=function(t){return String(t).replace(Fe,'.').toLowerCase()},He=je.data={},Ge=je.NATIVE='N',Ye=je.POLYFILL='P',Qe=je,ze=_t,We=S,Je=x(x.bind),Xe=function(t,e){return ze(t),void 0===e?t:We?Je(t,e):function(){return t.apply(e,arguments)}},Ke={},Ze=D&&b((function(){return 42!=Object.defineProperty((function(){}),'prototype',{value:42,writable:!1}).prototype})),ti=st,ei=String,ii=TypeError,si=function(t){if(ti(t))return t;throw ii(ei(t)+' is not an object')},ai=D,ri=Ne,ni=Ze,oi=si,ui=ke,di=TypeError,li=Object.defineProperty,ci=Object.getOwnPropertyDescriptor;Ke.f=ai?ni?function(t,e,i){if(oi(t),e=ui(e),oi(i),'function'==typeof t&&'prototype'===e&&'value'in i&&'writable'in i&&!i.writable){var s=ci(t,e);s&&s.writable&&(t[e]=i.value,i={configurable:'configurable'in i?i.configurable:s.configurable,enumerable:'enumerable'in i?i.enumerable:s.enumerable,writable:!1})}return li(t,e,i)}:li:function(t,e,i){if(oi(t),e=ui(e),oi(i),ri)try{return li(t,e,i)}catch(t){}if('get'in i||'set'in i)throw di('Accessors not supported');return'value'in i&&(t[e]=i.value),t};var hi=Ke,pi=F,mi=D?function(t,e,i){return hi.f(t,e,pi(1,i))}:function(t,e,i){return t[e]=i,t},fi=f,bi=E,Si=x,vi=N,gi=R.f,yi=Qe,Ti=at,Ei=Xe,ki=mi,wi=Xt,Pi=function(t){var e=function(i,s,a){if(this instanceof e){switch(arguments.length){case 0:return new t;case 1:return new t(i);case 2:return new t(i,s)}return new t(i,s,a)}return bi(t,this,arguments)};return e.prototype=t.prototype,e},$i=function(t,e){var i,s,a,r,n,o,u,d,l=t.target,c=t.global,h=t.stat,p=t.proto,m=c?fi:h?fi[l]:(fi[l]||{}).prototype,f=c?Ti:Ti[l]||ki(Ti,l,{})[l],b=f.prototype;for(a in e)i=!yi(c?a:l+(h?'.':'#')+a,t.forced)&&m&&wi(m,a),n=f[a],i&&(o=t.dontCallGetSet?(d=gi(m,a))&&d.value:m[a]),r=i&&o?o:e[a],i&&typeof n==typeof r||(u=t.bind&&i?Ei(r,fi):t.wrap&&i?Pi(r):p&&vi(r)?Si(r):r,(t.sham||r&&r.sham||n&&n.sham)&&ki(u,'sham',!0),ki(f,a,u),p&&(wi(Ti,s=l+'Prototype')||ki(Ti,s,{}),ki(Ti[s],a,r),t.real&&b&&!b[a]&&ki(b,a,r)))},Ai='process'==G(f.process),xi=mi,Ni=function(t,e,i,s){return s&&s.enumerable?t[e]=i:xi(t,e,i),t},Ri=(TypeError,x);Object.setPrototypeOf||'__proto__'in{}&&function(){var t,e=!1,i={};try{(t=Ri(Object.getOwnPropertyDescriptor(Object.prototype,'__proto__').set))(i,[]),e=i instanceof Array}catch(t){}}();var Di={};Di[pe('toStringTag')]='z';var Ci='[object z]'===String(Di),_i=Ci,Ii=N,Li=G,Oi=pe('toStringTag'),Bi=Object,Mi='Arguments'==Li(function(){return arguments}()),Vi=_i?Li:function(t){var e,i,s;return void 0===t?'Undefined':null===t?'Null':'string'==typeof(i=function(t,e){try{return t[e]}catch(t){}}(e=Bi(t),Oi))?i:Mi?Li(e):'Object'==(s=Li(e))&&Ii(e.callee)?'Arguments':s},Ui=Vi,Fi=Ci?{}.toString:function(){return'[object '+Ui(this)+']'},ji=Ci,qi=Ke.f,Hi=mi,Gi=Xt,Yi=Fi,Qi=pe('toStringTag'),zi=function(t,e,i,s){if(t){var a=i?t:t.prototype;Gi(a,Qi)||qi(a,Qi,{configurable:!0,value:e}),s&&!ji&&Hi(a,'toString',Yi)}},Wi=dt,Ji=Ke,Xi=D,Ki=pe('species'),Zi=lt,ts=TypeError,es=N,is=Ht,ss=x(Function.toString);es(is.inspectSource)||(is.inspectSource=function(t){return ss(t)});var as=is.inspectSource,rs=x,ns=b,os=N,us=Vi,ds=as,ls=function(){},cs=[],hs=dt('Reflect','construct'),ps=/^\s*(?:class|function)\b/,ms=rs(ps.exec),fs=!ps.exec(ls),bs=function(t){if(!os(t))return!1;try{return hs(ls,cs,t),!0}catch(t){return!1}},Ss=function(t){if(!os(t))return!1;switch(us(t)){case'AsyncFunction':case'GeneratorFunction':case'AsyncGeneratorFunction':return!1}try{return fs||!!ms(ps,ds(t))}catch(t){return!0}};Ss.sham=!0;var vs,gs,ys,Ts,Es=!hs||ns((function(){var t;return bs(bs.call)||!bs(Object)||!bs((function(){t=!0}))||t}))?Ss:bs,ks=Nt,ws=TypeError,Ps=si,$s=function(t){if(Es(t))return t;throw ws(ks(t)+' is not a constructor')},As=pe('species'),xs=function(t,e){var i,s=Ps(t).constructor;return void 0===s||null==(i=Ps(s)[As])?e:$s(i)},Ns=dt('document','documentElement'),Rs=x([].slice),Ds=TypeError,Cs=/(?:ipad|iphone|ipod).*applewebkit/i.test(ct),_s=f,Is=E,Ls=Xe,Os=N,Bs=Xt,Ms=b,Vs=Ns,Us=Rs,Fs=Ae,js=function(t,e){if(t<e)throw Ds('Not enough arguments');return t},qs=Cs,Hs=Ai,Gs=_s.setImmediate,Ys=_s.clearImmediate,Qs=_s.process,zs=_s.Dispatch,Ws=_s.Function,Js=_s.MessageChannel,Xs=_s.String,Ks=0,Zs={};try{vs=_s.location}catch(t){}var ta=function(t){if(Bs(Zs,t)){var e=Zs[t];delete Zs[t],e()}},ea=function(t){return function(){ta(t)}},ia=function(t){ta(t.data)},sa=function(t){_s.postMessage(Xs(t),vs.protocol+'//'+vs.host)};Gs&&Ys||(Gs=function(t){js(arguments.length,1);var e=Os(t)?t:Ws(t),i=Us(arguments,1);return Zs[++Ks]=function(){Is(e,void 0,i)},gs(Ks),Ks},Ys=function(t){delete Zs[t]},Hs?gs=function(t){Qs.nextTick(ea(t))}:zs&&zs.now?gs=function(t){zs.now(ea(t))}:Js&&!qs?(Ts=(ys=new Js).port2,ys.port1.onmessage=ia,gs=Ls(Ts.postMessage,Ts)):_s.addEventListener&&Os(_s.postMessage)&&!_s.importScripts&&vs&&'file:'!==vs.protocol&&!Ms(sa)?(gs=sa,_s.addEventListener('message',ia,!1)):gs='onreadystatechange'in Fs('script')?function(t){Vs.appendChild(Fs('script')).onreadystatechange=function(){Vs.removeChild(this),ta(t)}}:function(t){setTimeout(ea(t),0)});var aa,ra,na,oa,ua,da,la,ca,ha={set:Gs,clear:Ys},pa=f,ma=/ipad|iphone|ipod/i.test(ct)&&void 0!==pa.Pebble,fa=/web0s(?!.*chrome)/i.test(ct),ba=f,Sa=Xe,va=R.f,ga=ha.set,ya=Cs,Ta=ma,Ea=fa,ka=Ai,wa=ba.MutationObserver||ba.WebKitMutationObserver,Pa=ba.document,$a=ba.process,Aa=ba.Promise,xa=va(ba,'queueMicrotask'),Na=xa&&xa.value;Na||(aa=function(){var t,e;for(ka&&(t=$a.domain)&&t.exit();ra;){e=ra.fn,ra=ra.next;try{e()}catch(t){throw ra?oa():na=void 0,t}}na=void 0,t&&t.enter()},ya||ka||Ea||!wa||!Pa?!Ta&&Aa&&Aa.resolve?((la=Aa.resolve(void 0)).constructor=Aa,ca=Sa(la.then,la),oa=function(){ca(aa)}):ka?oa=function(){$a.nextTick(aa)}:(ga=Sa(ga,ba),oa=function(){ga(aa)}):(ua=!0,da=Pa.createTextNode(''),new wa(aa).observe(da,{characterData:!0}),oa=function(){da.data=ua=!ua}));var Ra=Na||function(t){var e={fn:t,next:void 0};na&&(na.next=e),ra||(ra=e,oa()),na=e},Da=f,Ca=function(t){try{return{error:!1,value:t()}}catch(t){return{error:!0,value:t}}},_a=function(){this.head=null,this.tail=null};_a.prototype={add:function(t){var e={item:t,next:null};this.head?this.tail.next=e:this.head=e,this.tail=e},get:function(){var t=this.head;if(t)return this.head=t.next,this.tail===t&&(this.tail=null),t.item}};var Ia,La,Oa,Ba=_a,Ma=N,Va=as,Ua=f.WeakMap,Fa=Ma(Ua)&&/native code/.test(Va(Ua)),ja=Ut.exports,qa=ie,Ha=ja('keys'),Ga=function(t){return Ha[t]||(Ha[t]=qa(t))},Ya={},Qa=Fa,za=f,Wa=x,Ja=st,Xa=mi,Ka=Xt,Za=Ht,tr=Ga,er=Ya,ir=za.TypeError,sr=za.WeakMap;if(Qa||Za.state){var ar=Za.state||(Za.state=new sr),rr=Wa(ar.get),nr=Wa(ar.has),or=Wa(ar.set);Ia=function(t,e){if(nr(ar,t))throw new ir('Object already initialized');return e.facade=t,or(ar,t,e),e},La=function(t){return rr(ar,t)||{}},Oa=function(t){return nr(ar,t)}}else{var ur=tr('state');er[ur]=!0,Ia=function(t,e){if(Ka(t,ur))throw new ir('Object already initialized');return e.facade=t,Xa(t,ur,e),e},La=function(t){return Ka(t,ur)?t[ur]:{}},Oa=function(t){return Ka(t,ur)}}var dr={set:Ia,get:La,has:Oa,enforce:function(t){return Oa(t)?La(t):Ia(t,{})},getterFor:function(t){return function(e){var i;if(!Ja(e)||(i=La(e)).type!==t)throw ir('Incompatible receiver, '+t+' required');return i}}},lr=f.Promise,cr='object'==typeof Deno&&Deno&&'object'==typeof Deno.version,hr=!cr&&!Ai&&'object'==typeof window&&'object'==typeof document,pr=f,mr=lr,fr=N,br=Qe,Sr=as,vr=pe,gr=hr,yr=cr,Tr=vt,Er=mr&&mr.prototype,kr=vr('species'),wr=!1,Pr=fr(pr.PromiseRejectionEvent),$r={CONSTRUCTOR:br('Promise',(function(){var t=Sr(mr),e=t!==String(mr);if(!e&&66===Tr)return!0;if(!Er.catch||!Er.finally)return!0;if(!Tr||Tr<51||!/native code/.test(t)){var i=new mr((function(t){t(1)})),s=function(t){t((function(){}),(function(){}))};if((i.constructor={})[kr]=s,!(wr=i.then((function(){}))instanceof s))return!0}return!e&&(gr||yr)&&!Pr})),REJECTION_EVENT:Pr,SUBCLASSING:wr},Ar={},xr=_t,Nr=function(t){var e,i;this.promise=new t((function(t,s){if(void 0!==e||void 0!==i)throw TypeError('Bad Promise constructor');e=t,i=s})),this.resolve=xr(e),this.reject=xr(i)};Ar.f=function(t){return new Nr(t)};var Rr,Dr,Cr=$i,_r=Ai,Ir=f,Lr=I,Or=Ni,Br=zi,Mr=function(t){var e=Wi(t),i=Ji.f;Xi&&e&&!e[Ki]&&i(e,Ki,{configurable:!0,get:function(){return this}})},Vr=_t,Ur=N,Fr=st,jr=function(t,e){if(Zi(e,t))return t;throw ts('Incorrect invocation')},qr=xs,Hr=ha.set,Gr=Ra,Yr=function(t,e){var i=Da.console;i&&i.error&&(1==arguments.length?i.error(t):i.error(t,e))},Qr=Ca,zr=Ba,Wr=dr,Jr=lr,Xr=Ar,Kr=$r.CONSTRUCTOR,Zr=$r.REJECTION_EVENT,tn=Wr.getterFor('Promise'),en=Wr.set,sn=Jr&&Jr.prototype,an=Jr,rn=sn,nn=Ir.TypeError,on=Ir.document,un=Ir.process,dn=Xr.f,ln=dn,cn=!!(on&&on.createEvent&&Ir.dispatchEvent),hn=function(t){var e;return!(!Fr(t)||!Ur(e=t.then))&&e},pn=function(t,e){var i,s,a,r=e.value,n=1==e.state,o=n?t.ok:t.fail,u=t.resolve,d=t.reject,l=t.domain;try{o?(n||(2===e.rejection&&vn(e),e.rejection=1),!0===o?i=r:(l&&l.enter(),i=o(r),l&&(l.exit(),a=!0)),i===t.promise?d(nn('Promise-chain cycle')):(s=hn(i))?Lr(s,i,u,d):u(i)):d(r)}catch(t){l&&!a&&l.exit(),d(t)}},mn=function(t,e){t.notified||(t.notified=!0,Gr((function(){for(var i,s=t.reactions;i=s.get();)pn(i,t);t.notified=!1,e&&!t.rejection&&bn(t)})))},fn=function(t,e,i){var s,a;cn?((s=on.createEvent('Event')).promise=e,s.reason=i,s.initEvent(t,!1,!0),Ir.dispatchEvent(s)):s={promise:e,reason:i},!Zr&&(a=Ir['on'+t])?a(s):'unhandledrejection'===t&&Yr('Unhandled promise rejection',i)},bn=function(t){Lr(Hr,Ir,(function(){var e,i=t.facade,s=t.value;if(Sn(t)&&(e=Qr((function(){_r?un.emit('unhandledRejection',s,i):fn('unhandledrejection',i,s)})),t.rejection=_r||Sn(t)?2:1,e.error))throw e.value}))},Sn=function(t){return 1!==t.rejection&&!t.parent},vn=function(t){Lr(Hr,Ir,(function(){var e=t.facade;_r?un.emit('rejectionHandled',e):fn('rejectionhandled',e,t.value)}))},gn=function(t,e,i){return function(s){t(e,s,i)}},yn=function(t,e,i){t.done||(t.done=!0,i&&(t=i),t.value=e,t.state=2,mn(t,!0))},Tn=function(t,e,i){if(!t.done){t.done=!0,i&&(t=i);try{if(t.facade===e)throw nn('Promise can\'t be resolved itself');var s=hn(e);s?Gr((function(){var i={done:!1};try{Lr(s,e,gn(Tn,i,t),gn(yn,i,t))}catch(e){yn(i,e,t)}})):(t.value=e,t.state=1,mn(t,!1))}catch(e){yn({done:!1},e,t)}}};Kr&&(rn=(an=function(t){jr(this,rn),Vr(t),Lr(Rr,this);var e=tn(this);try{t(gn(Tn,e),gn(yn,e))}catch(t){yn(e,t)}}).prototype,(Rr=function(t){en(this,{type:'Promise',done:!1,notified:!1,parent:!1,reactions:new zr,rejection:!1,state:0,value:void 0})}).prototype=Or(rn,'then',(function(t,e){var i=tn(this),s=dn(qr(this,an));return i.parent=!0,s.ok=!Ur(t)||t,s.fail=Ur(e)&&e,s.domain=_r?un.domain:void 0,0==i.state?i.reactions.add(s):Gr((function(){pn(s,i)})),s.promise})),Dr=function(){var t=new Rr,e=tn(t);this.promise=t,this.resolve=gn(Tn,e),this.reject=gn(yn,e)},Xr.f=dn=function(t){return t===an||undefined===t?new Dr(t):ln(t)}),Cr({global:!0,constructor:!0,wrap:!0,forced:Kr},{Promise:an}),Br(an,'Promise',!1,!0),Mr('Promise');var En={},kn=En,wn=pe('iterator'),Pn=Array.prototype,$n=Math.ceil,An=Math.floor,xn=Math.trunc||function(t){var e=+t;return(e>0?An:$n)(e)},Nn=function(t){var e=+t;return e!=e||0===e?0:xn(e)},Rn=Nn,Dn=Math.min,Cn=function(t){return t>0?Dn(Rn(t),9007199254740991):0},_n=function(t){return Cn(t.length)},In=Vi,Ln=Lt,On=En,Bn=pe('iterator'),Mn=function(t){if(null!=t)return Ln(t,Bn)||Ln(t,'@@iterator')||On[In(t)]},Vn=I,Un=_t,Fn=si,jn=Nt,qn=Mn,Hn=TypeError,Gn=I,Yn=si,Qn=Lt,zn=Xe,Wn=I,Jn=si,Xn=Nt,Kn=function(t){return void 0!==t&&(kn.Array===t||Pn[wn]===t)},Zn=_n,to=lt,eo=function(t,e){var i=arguments.length<2?qn(t):e;if(Un(i))return Fn(Vn(i,t));throw Hn(jn(t)+' is not iterable')},io=Mn,so=function(t,e,i){var s,a;Yn(t);try{if(!(s=Qn(t,'return'))){if('throw'===e)throw i;return i}s=Gn(s,t)}catch(t){a=!0,s=t}if('throw'===e)throw i;if(a)throw s;return Yn(s),i},ao=TypeError,ro=function(t,e){this.stopped=t,this.result=e},no=ro.prototype,oo=function(t,e,i){var s,a,r,n,o,u,d,l=i&&i.that,c=!(!i||!i.AS_ENTRIES),h=!(!i||!i.IS_RECORD),p=!(!i||!i.IS_ITERATOR),m=!(!i||!i.INTERRUPTED),f=zn(e,l),b=function(t){return s&&so(s,'normal',t),new ro(!0,t)},S=function(t){return c?(Jn(t),m?f(t[0],t[1],b):f(t[0],t[1])):m?f(t,b):f(t)};if(h)s=t.iterator;else if(p)s=t;else{if(!(a=io(t)))throw ao(Xn(t)+' is not iterable');if(Kn(a)){for(r=0,n=Zn(t);n>r;r++)if((o=S(t[r]))&&to(no,o))return o;return new ro(!1)}s=eo(t,a)}for(u=h?t.next:s.next;!(d=Wn(u,s)).done;){try{o=S(d.value)}catch(t){so(s,'throw',t)}if('object'==typeof o&&o&&to(no,o))return o}return new ro(!1)},uo=pe('iterator'),lo=!1;try{var co=0,ho={next:function(){return{done:!!co++}},return:function(){lo=!0}};ho[uo]=function(){return this},Array.from(ho,(function(){throw 2}))}catch(t){}var po=lr,mo=$r.CONSTRUCTOR||!function(t,e){if(!e&&!lo)return!1;var i=!1;try{var s={};s[uo]=function(){return{next:function(){return{done:i=!0}}}},t(s)}catch(t){}return i}((function(t){po.all(t).then(void 0,(function(){}))})),fo=I,bo=_t,So=Ar,vo=Ca,go=oo;$i({target:'Promise',stat:!0,forced:mo},{all:function(t){var e=this,i=So.f(e),s=i.resolve,a=i.reject,r=vo((function(){var i=bo(e.resolve),r=[],n=0,o=1;go(t,(function(t){var u=n++,d=!1;o++,fo(i,e,t).then((function(t){d||(d=!0,r[u]=t,--o||s(r))}),a)})),--o||s(r)}));return r.error&&a(r.value),i.promise}});var yo=$i,To=$r.CONSTRUCTOR;lr&&lr.prototype,yo({target:'Promise',proto:!0,forced:To,real:!0},{catch:function(t){return this.then(void 0,t)}});var Eo=I,ko=_t,wo=Ar,Po=Ca,$o=oo;$i({target:'Promise',stat:!0,forced:mo},{race:function(t){var e=this,i=wo.f(e),s=i.reject,a=Po((function(){var a=ko(e.resolve);$o(t,(function(t){Eo(a,e,t).then(i.resolve,s)}))}));return a.error&&s(a.value),i.promise}});var Ao=I,xo=Ar;$i({target:'Promise',stat:!0,forced:$r.CONSTRUCTOR},{reject:function(t){var e=xo.f(this);return Ao(e.reject,void 0,t),e.promise}});var No=si,Ro=st,Do=Ar,Co=function(t,e){if(No(t),Ro(e)&&e.constructor===t)return e;var i=Do.f(t);return(0,i.resolve)(e),i.promise},_o=$i,Io=lr,Lo=$r.CONSTRUCTOR,Oo=Co,Bo=dt('Promise'),Mo=!Lo;_o({target:'Promise',stat:!0,forced:true},{resolve:function(t){return Oo(Mo&&this===Bo?Io:this,t)}});var Vo=$i,Uo=lr,Fo=b,jo=dt,qo=N,Ho=xs,Go=Co,Yo=Uo&&Uo.prototype;Vo({target:'Promise',proto:!0,real:!0,forced:!!Uo&&Fo((function(){Yo.finally.call({then:function(){}},(function(){}))}))},{finally:function(t){var e=Ho(this,jo('Promise')),i=qo(t);return this.then(i?function(i){return Go(e,t()).then((function(){return i}))}:t,i?function(i){return Go(e,t()).then((function(){throw i}))}:t)}});var Qo,zo=dt,Wo=zo('Promise','finally');!function(t){t[t.OFFSET_P=0]='OFFSET_P',t[t.PLAYBACK_SHIFT=1]='PLAYBACK_SHIFT'}(Qo||(Qo={}));var Jo,Xo=(e,i=0,s=Qo.OFFSET_P)=>{switch(s){case Qo.OFFSET_P:return e.replace('_offset_p',0===i?'':'_'+i.toFixed(0));case Qo.PLAYBACK_SHIFT:{if(0===i)return e;const t=new URL(e);return t.searchParams.append('playback_shift',i.toFixed(0)),t.toString()}default:t.assertNever(s)}return e},Ko=(t,e,i=!1)=>{const s=t.getTransition();!i&&s&&s.to!==e||t.setState(e)};exports.VideoQuality=void 0,(Jo=exports.VideoQuality||(exports.VideoQuality={})).INVARIANT='Invariant quality',Jo.Q_144P='144p',Jo.Q_240P='240p',Jo.Q_360P='360p',Jo.Q_480P='480p',Jo.Q_720P='720p',Jo.Q_1080P='1080p',Jo.Q_1440P='1440p',Jo.Q_2160P='2160p',Jo.Q_4320P='4320p';const Zo={[exports.VideoQuality.Q_144P]:{width:256,height:144},[exports.VideoQuality.Q_240P]:{width:428,height:240},[exports.VideoQuality.Q_360P]:{width:640,height:360},[exports.VideoQuality.Q_480P]:{width:856,height:480},[exports.VideoQuality.Q_720P]:{width:1280,height:720},[exports.VideoQuality.Q_1080P]:{width:1920,height:1080},[exports.VideoQuality.Q_1440P]:{width:2560,height:1440},[exports.VideoQuality.Q_2160P]:{width:3840,height:2160},[exports.VideoQuality.Q_4320P]:{width:7680,height:4320}},tu=(t,e)=>Zo[t].height>Zo[e].height,eu=(t,e)=>Zo[t].height<Zo[e].height,iu=Object.keys(Zo).sort(((t,e)=>eu(t,e)?-1:1)),su=({width:t,height:e})=>{const i=Math.min(t,e),s=Math.max(t,e);return iu.find((t=>{const e=Zo[t];return e.width>=s&&e.height>=i}))},au=t=>t===exports.VideoQuality.INVARIANT;class ru{constructor(e){this.transitionStarted$=new t.Subject,this.transitionEnded$=new t.Subject,this.transitionUpdated$=new t.Subject,this.forceChanged$=new t.Subject,this.stateChangeStarted$=t.merge(this.transitionStarted$,this.transitionUpdated$),this.stateChangeEnded$=t.merge(this.transitionEnded$,this.forceChanged$),this.state=e}setState(t){const e=this.transition,i=this.state;this.transition=void 0,this.state=t,e?e.to===t?this.transitionEnded$.next(e):this.forceChanged$.next({from:e.from,to:t,canceledTransition:e}):this.forceChanged$.next({from:i,to:t,canceledTransition:e})}startTransitionTo(e){const i=this.transition,s=this.state;s===e||t.isNonNullable(i)&&i.to===e||(this.state=e,i?(this.transition={from:i.from,to:e,canceledTransition:i},this.transitionUpdated$.next(this.transition)):(this.transition={from:s,to:e},this.transitionStarted$.next(this.transition)))}getTransition(){return this.transition}getState(){return this.state}}var nu;!function(t){t.STOPPED='stopped',t.READY='ready',t.PLAYING='playing',t.PAUSED='paused'}(nu||(nu={}));class ou{constructor(e){this.subscription=new t.Subscription,this.loadMediaTimeoutSubscription=new t.Subscription,this.videoState=new ru(nu.STOPPED),this.syncPlayback=()=>{const e=this.videoState.getState(),i=this.videoState.getTransition(),s=this.params.desiredState.playbackState.getState(),a=this.params.desiredState.playbackState.getTransition(),r=this.params.desiredState.seekState.getState();if(this.log({message:`[syncPlayback] videoState: ${e}; videoTransition: ${JSON.stringify(i)}; desiredPlaybackState: ${s}; desiredPlaybackStateTransition: ${this.params.desiredState.playbackState.getTransition()}; seekState: ${JSON.stringify(r)};`}),s!==exports.PlaybackState.STOPPED){if(!i)if((null==a?void 0:a.to)===exports.PlaybackState.PAUSED||r.state!==l.Requested||e===nu.STOPPED)switch(s){case exports.PlaybackState.PLAYING:switch(e){case nu.PLAYING:break;case nu.PAUSED:case nu.READY:this.videoState.startTransitionTo(nu.PLAYING),this.params.connection.remotePlayerController.playOrPause();break;case nu.STOPPED:this.videoState.startTransitionTo(nu.READY),this.prepare();break;default:t.assertNever(e)}break;case exports.PlaybackState.PAUSED:switch(e){case nu.PLAYING:this.videoState.startTransitionTo(nu.PAUSED),this.params.connection.remotePlayerController.playOrPause();break;case nu.PAUSED:break;case nu.READY:this.videoState.startTransitionTo(nu.PAUSED),this.videoState.setState(nu.PAUSED);break;case nu.STOPPED:this.videoState.startTransitionTo(nu.READY),this.prepare();break;default:t.assertNever(e)}break;default:t.assertNever(s)}else this.seek(r.position)}else e!==nu.STOPPED&&(this.videoState.startTransitionTo(nu.STOPPED),this.stop())},this.params=e,this.log=this.params.dependencies.logger.createComponentLog('ChromecastProvider'),this.log({message:`constructor, format: ${e.format}`}),this.params.output.isLive$.next((e=>{switch(e){case exports.VideoFormat.MPEG:case exports.VideoFormat.DASH:case exports.VideoFormat.DASH_SEP:case exports.VideoFormat.DASH_ONDEMAND:case exports.VideoFormat.DASH_WEBM:case exports.VideoFormat.HLS:case exports.VideoFormat.HLS_ONDEMAND:return!1;case exports.VideoFormat.HLS_LIVE:case exports.VideoFormat.DASH_LIVE:case exports.VideoFormat.DASH_LIVE_WEBM:case exports.VideoFormat.WEB_RTC_LIVE:return!0;default:return t.assertNever(e)}})(e.format)),this.handleRemoteVolumeChange({volume:this.params.connection.remotePlayer.volumeLevel,muted:this.params.connection.remotePlayer.isMuted});const i=this.params.connection.session.getMediaSession();i&&this.restoreSession(i),this.subscribe()}destroy(){this.log({message:'[destroy]'}),this.subscription.unsubscribe()}subscribe(){this.subscription.add(this.loadMediaTimeoutSubscription);const e=new t.Subscription;this.subscription.add(e),this.subscription.add(t.merge(this.videoState.stateChangeStarted$.pipe(t.map((t=>`stateChangeStarted$ ${JSON.stringify(t)}`))),this.videoState.stateChangeEnded$.pipe(t.map((t=>`stateChangeEnded$ ${JSON.stringify(t)}`)))).subscribe((t=>this.log({message:`[videoState] ${t}`}))));const i=(t,e)=>this.subscription.add(t.subscribe(e));if(this.params.output.isLive$.getValue())this.params.output.position$.next(0),this.params.output.duration$.next(0);else{const i=new t.Subject;e.add(i.pipe(t.debounce(500)).subscribe((()=>{this.params.output.seekedEvent$.next()})));let s=NaN;e.add(t.fromEvent(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.CURRENT_TIME_CHANGED).subscribe((t=>{this.logRemoteEvent(t);const e=t.value;this.params.output.position$.next(e);(this.params.desiredState.seekState.getState().state===l.Applying||Math.abs(e-s)>5)&&i.next(e),s=e}))),e.add(t.fromEvent(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.DURATION_CHANGED).subscribe((t=>{this.logRemoteEvent(t),this.params.output.duration$.next(t.value)})))}i(t.fromEvent(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.IS_MEDIA_LOADED_CHANGED),(t=>{this.logRemoteEvent(t),t.value?this.handleRemoteReady():(this.handleRemoteStop(),e.unsubscribe())})),i(t.fromEvent(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.IS_PAUSED_CHANGED),(t=>{this.logRemoteEvent(t),t.value?this.handleRemotePause():this.handleRemotePlay()})),i(t.fromEvent(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.PLAYER_STATE_CHANGED),(e=>{this.logRemoteEvent(e);const{remotePlayer:i}=this.params.connection,s=e.value,a=this.params.output.isBuffering$.getValue(),r=s===chrome.cast.media.PlayerState.BUFFERING;switch(a!==r&&this.params.output.isBuffering$.next(r),s){case chrome.cast.media.PlayerState.IDLE:!this.params.output.isLive$.getValue()&&i.duration-i.currentTime<5&&this.params.output.endedEvent$.next(),this.handleRemoteStop(),Ko(this.params.desiredState.playbackState,exports.PlaybackState.STOPPED);break;case chrome.cast.media.PlayerState.PAUSED:this.handleRemotePause();break;case chrome.cast.media.PlayerState.PLAYING:this.handleRemotePlay();break;case chrome.cast.media.PlayerState.BUFFERING:break;default:t.assertNever(s)}})),i(t.fromEvent(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.VOLUME_LEVEL_CHANGED),(t=>{this.logRemoteEvent(t),this.handleRemoteVolumeChange({volume:t.value})})),i(t.fromEvent(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.IS_MUTED_CHANGED),(t=>{this.logRemoteEvent(t),this.handleRemoteVolumeChange({muted:t.value})}));i(t.merge(this.params.desiredState.playbackState.stateChangeStarted$,this.params.desiredState.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,t.observableFrom(['init'])).pipe(t.debounce(0)),this.syncPlayback)}restoreSession(t){this.log({message:'restoreSession'});const{remotePlayer:e}=this.params.connection;if(t.playerState!==chrome.cast.media.PlayerState.IDLE){e.isPaused?(this.videoState.setState(nu.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED)):(this.videoState.setState(nu.PLAYING),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PLAYING));const t=this.params.output.isLive$.getValue();this.params.output.duration$.next(t?0:e.duration),this.params.output.position$.next(t?0:e.currentTime),this.params.desiredState.seekState.setState({state:l.None})}}prepare(){const t=this.params.format;this.log({message:`[prepare] format: ${t}`});const e=this.createMediaInfo(t),i=this.createLoadRequest(e);this.loadMedia(i)}handleRemotePause(){const t=this.videoState.getState(),e=this.videoState.getTransition();(null==e?void 0:e.to)!==nu.PAUSED&&t!==nu.PLAYING||(this.videoState.setState(nu.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED))}handleRemotePlay(){const t=this.videoState.getState(),e=this.videoState.getTransition();(null==e?void 0:e.to)!==nu.PLAYING&&t!==nu.PAUSED||(this.videoState.setState(nu.PLAYING),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PLAYING))}handleRemoteReady(){const t=this.videoState.getTransition();(null==t?void 0:t.to)===nu.READY&&this.videoState.setState(nu.READY)}handleRemoteStop(){this.videoState.getState()!==nu.STOPPED&&this.videoState.setState(nu.STOPPED)}handleRemoteVolumeChange(t){var e,i;const s=this.params.output.volume$.getValue(),a={volume:null!==(e=t.volume)&&void 0!==e?e:s.volume,muted:null!==(i=t.muted)&&void 0!==i?i:s.muted};a.volume===s.volume&&a.muted==a.muted||this.params.output.volume$.next(a)}seek(t){this.params.output.willSeekEvent$.next();const{remotePlayer:e,remotePlayerController:i}=this.params.connection;e.currentTime=t,i.seek()}stop(){const{remotePlayerController:t}=this.params.connection;t.stop()}createMediaInfo(e){var i;const s=this.params.source;let a,r,n;switch(e){case exports.VideoFormat.MPEG:{const i=s[e];t.assertNonNullable(i);const o=Object.keys(i).sort(((t,e)=>t===e?0:t===exports.VideoQuality.INVARIANT?1:e===exports.VideoQuality.INVARIANT?-1:eu(t,e)?1:-1))[0];t.assertNonNullable(o);const u=i[o];t.assertNonNullable(u),a=u,r='video/mp4',n=chrome.cast.media.StreamType.BUFFERED;break}case exports.VideoFormat.HLS:case exports.VideoFormat.HLS_ONDEMAND:{const i=s[e];t.assertNonNullable(i),a=i.url,r='application/x-mpegurl',n=chrome.cast.media.StreamType.BUFFERED;break}case exports.VideoFormat.DASH_SEP:case exports.VideoFormat.DASH_ONDEMAND:case exports.VideoFormat.DASH_WEBM:{const i=s[e];t.assertNonNullable(i),a=i.url,r='application/dash+xml',n=chrome.cast.media.StreamType.BUFFERED;break}case exports.VideoFormat.HLS_LIVE:{const i=s[e];t.assertNonNullable(i),a=Xo(i.url),r='application/x-mpegurl',n=chrome.cast.media.StreamType.LIVE;break}case exports.VideoFormat.DASH:case exports.VideoFormat.DASH_LIVE:case exports.VideoFormat.WEB_RTC_LIVE:{const t='Unsupported format for Chromecast',e=new Error(t);throw this.params.output.error$.next({id:'ChromecastProvider.createMediaInfo()',message:t,thrown:e}),e}case exports.VideoFormat.DASH_LIVE_WEBM:throw new Error('DASH_LIVE_WEBM is no longer supported');default:return t.assertNever(e)}const o=new chrome.cast.media.MediaInfo(null!==(i=this.params.meta.videoId)&&void 0!==i?i:a,r);o.contentUrl=a,o.streamType=n,o.metadata=new chrome.cast.media.GenericMediaMetadata;const{title:u,subtitle:d}=this.params.meta;return t.isNonNullable(u)&&(o.metadata.title=u),t.isNonNullable(d)&&(o.metadata.subtitle=d),o}createLoadRequest(t){const e=new chrome.cast.media.LoadRequest(t);e.autoplay=!1;const i=this.params.desiredState.seekState.getState();return i.state===l.Applying||i.state===l.Requested?e.currentTime=this.params.output.isLive$.getValue()?0:i.position/1e3:e.currentTime=0,e}loadMedia(e){const i=this.params.connection.session.loadMedia(e),s=new Promise(((e,i)=>{this.loadMediaTimeoutSubscription.add(t.timeout(7e3).subscribe((()=>i('timeout(7000)'))))}));Wo(Promise.race([i,s]).then((()=>{this.log({message:`[loadMedia] completed, format: ${this.params.format}`});this.params.desiredState.seekState.getState().state===l.Applying&&this.params.output.seekedEvent$.next(),this.handleRemoteReady()}),(t=>{const e=`[prepare] loadMedia failed, format: ${this.params.format}, reason: ${t}`;this.log({message:e}),this.params.output.error$.next({id:'ChromecastProvider.loadMedia',message:e,thrown:t})})),(()=>{this.loadMediaTimeoutSubscription.unsubscribe()}))}logRemoteEvent(t){this.log({message:`[remoteEvent] ${JSON.stringify(t)}`})}}function uu(t,e,i,s){return new(i||(i=Promise))((function(a,r){function n(t){try{u(s.next(t))}catch(t){r(t)}}function o(t){try{u(s.throw(t))}catch(t){r(t)}}function u(t){var e;t.done?a(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(n,o)}u((s=s.apply(t,e||[])).next())}))}function du(t){return this instanceof du?(this.v=t,this):new du(t)}function lu(t,e,i){if(!Symbol.asyncIterator)throw new TypeError('Symbol.asyncIterator is not defined.');var s,a=i.apply(t,e||[]),r=[];return s={},n('next'),n('throw'),n('return'),s[Symbol.asyncIterator]=function(){return this},s;function n(t){a[t]&&(s[t]=function(e){return new Promise((function(i,s){r.push([t,e,i,s])>1||o(t,e)}))})}function o(t,e){try{(i=a[t](e)).value instanceof du?Promise.resolve(i.value.v).then(u,d):l(r[0][2],i)}catch(t){l(r[0][3],t)}var i}function u(t){o('next',t)}function d(t){o('throw',t)}function l(t,e){t(e),r.shift(),r.length&&o(r[0][0],r[0][1])}}class cu{constructor(){Object.defineProperty(this,'listeners',{value:{},writable:!0,configurable:!0})}addEventListener(t,e,i){t in this.listeners||(this.listeners[t]=[]),this.listeners[t].push({callback:e,options:i})}removeEventListener(t,e){if(!(t in this.listeners))return;const i=this.listeners[t];for(let t=0,s=i.length;t<s;t++)if(i[t].callback===e)return void i.splice(t,1)}dispatchEvent(t){if(!(t.type in this.listeners))return;const e=this.listeners[t.type].slice();for(let i=0,s=e.length;i<s;i++){const s=e[i];try{s.callback.call(this,t)}catch(t){Promise.resolve().then((()=>{throw t}))}s.options&&s.options.once&&this.removeEventListener(t.type,s.callback)}return!t.defaultPrevented}}class hu extends cu{constructor(){super(),this.listeners||cu.call(this),Object.defineProperty(this,'aborted',{value:!1,writable:!0,configurable:!0}),Object.defineProperty(this,'onabort',{value:null,writable:!0,configurable:!0})}toString(){return'[object AbortSignal]'}dispatchEvent(t){'abort'===t.type&&(this.aborted=!0,'function'==typeof this.onabort&&this.onabort.call(this,t)),super.dispatchEvent(t)}}class pu{constructor(){Object.defineProperty(this,'signal',{value:new hu,writable:!0,configurable:!0})}abort(){let t;try{t=new Event('abort')}catch(e){'undefined'!=typeof document?document.createEvent?(t=document.createEvent('Event'),t.initEvent('abort',!1,!1)):(t=document.createEventObject(),t.type='abort'):t={type:'abort',bubbles:!1,cancelable:!1}}this.signal.dispatchEvent(t)}toString(){return'[object AbortController]'}}function mu(t){return t.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL?(console.log('__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL=true is set, will force install polyfill'),!0):'function'==typeof t.Request&&!t.Request.prototype.hasOwnProperty('signal')||!t.AbortController}'undefined'!=typeof Symbol&&Symbol.toStringTag&&(pu.prototype[Symbol.toStringTag]='AbortController',hu.prototype[Symbol.toStringTag]='AbortSignal');const fu=mu({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}),bu=fu?function(t){'function'==typeof t&&(t={fetch:t});const{fetch:e,Request:i=e.Request,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:a=!1}=t;if(!mu({fetch:e,Request:i,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:a}))return{fetch:e,Request:r};let r=i;(r&&!r.prototype.hasOwnProperty('signal')||a)&&(r=function(t,e){let s;e&&e.signal&&(s=e.signal,delete e.signal);const a=new i(t,e);return s&&Object.defineProperty(a,'signal',{writable:!1,enumerable:!1,configurable:!0,value:s}),a},r.prototype=i.prototype);const n=e;return{fetch:(t,e)=>{const i=r&&r.prototype.isPrototypeOf(t)?t.signal:e?e.signal:void 0;if(i){let s;try{s=new DOMException('Aborted','AbortError')}catch(t){s=new Error('Aborted'),s.name='AbortError'}if(i.aborted)return Promise.reject(s);const a=new Promise(((t,e)=>{i.addEventListener('abort',(()=>e(s)),{once:!0})}));return e&&e.signal&&delete e.signal,Promise.race([a,n(t,e)])}return n(t,e)},Request:r}}({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}):void 0,Su=fu?bu.fetch:window.fetch;fu?bu.Request:window.Request;const vu=fu?pu:window.AbortController,gu=t=>t.range?t.range.split('-').map((t=>parseInt(t,10))):[NaN,NaN];class yu{constructor(t){this.params=t,this.dashJsRequestQueue=new Map,this.activeRequests=new Map}setMetrics(t){this.dashMetrics=t}queueDashJSRequest(t){var e;const{url:i}=t.request,s=null!==(e=this.dashJsRequestQueue.get(i))&&void 0!==e?e:[];s.push(t),this.dashJsRequestQueue.set(i,s)}executeNextRequests(){return uu(this,void 0,void 0,(function*(){for(const[t,e]of this.dashJsRequestQueue.entries()){const i=this.activeRequests.get(t);if(i){e.length&&this.onBigRequestProgress(i);const s=e[0];if(!s||!s.request.range)continue;const[a,r]=gu(s.request);if(a>=i.from&&r<=i.to)continue;this.activeRequests.delete(t)}if(e.length){const i=this.sendBigRequest(t,e.map((({request:t})=>t)));this.activeRequests.set(t,i)}}}))}abort(t){var e;if(t){const{request:i}=t,s=(null!==(e=this.dashJsRequestQueue.get(i.url))&&void 0!==e?e:[]).includes(t),a=this.activeRequests.get(i.url);s&&a&&a.abortController.abort()}else for(const{abortController:t}of this.activeRequests.values())t.abort()}destroy(){this.abort(),this.dashMetrics=void 0,this.dashJsRequestQueue.clear(),this.activeRequests.clear()}sendBigRequest(t,e){const i=e.map(gu),s=i[0][0];let a=i[0][1];for(let t=1;t<i.length&&a<this.params.minDataSize;t++){const e=i[t][1];e-s<=2*this.params.minDataSize&&(a=Math.max(a,e))}a=0===s?Math.max(a,s+this.params.minInitSize):Math.max(a,s+this.params.minDataSize);const r=new URL(t,location.href);r.searchParams.append('bytes',`${s}-${a}`);const n=r.toString(),o=new vu,u=o.signal,d={url:t,from:s,to:a,loaded:0,data:null,abortController:o};u.addEventListener('abort',(()=>this.onBigRequestAbort(d)));const l=t=>{var e,i;throw null===(i=(e=this.params).onError)||void 0===i||i.call(e,{id:'BigRequestParsing',message:'Error parsing response data',thrown:t}),t};return Su(n,{signal:u}).then((t=>{var e,i,r;if(d.response=t,!t.ok||!t.body)return void this.onBigRequestError(d);const[n,o]=t.body.tee();null===(i=(e=this.params).onDownloadStream)||void 0===i||i.call(e,o);const u=n.getReader(),c=parseInt(null!==(r=t.headers.get('Content-Length'))&&void 0!==r?r:'',10)||a-s+1;d.data=new ArrayBuffer(c);const h=new Uint8Array(d.data),p=({done:t,value:e})=>uu(this,void 0,void 0,(function*(){t?this.onBigRequestProgress(d):e&&(h.set(e,d.loaded),d.loaded+=e.byteLength,this.onBigRequestProgress(d),yield null==u?void 0:u.read().then(p,yu.suppressStreamErrors).catch(l))}));null==u||u.read().then(p,yu.suppressStreamErrors).catch(l)}),yu.suppressAbort).catch((t=>this.onBigRequestError(d,t))),d}onBigRequestProgress({url:t,from:e,to:i,loaded:s,data:a,response:r}){var n,o,u,d,l,c,h,p;if(!this.activeRequests.has(t)||!a)return;const m=null!==(n=this.dashJsRequestQueue.get(t))&&void 0!==n?n:[];for(const n of m){const{request:m}=n,[f,b]=gu(m),S=f>=e&&b<=e+s,v=e>=f&&e+s<b,g=a.slice(f-e,Math.min(b-e+1,s));if((S||v)&&(m.requestStartDate=null!==(o=m.requestStartDate)&&void 0!==o?o:new Date,m.firstByteDate=null!==(u=m.firstByteDate)&&void 0!==u?u:new Date,m.bytesLoaded=g.byteLength,m.bytesTotal=i-e),S){m.requestEndDate=new Date,this.dashJsRequestQueue.set(t,(null!==(d=this.dashJsRequestQueue.get(t))&&void 0!==d?d:[]).filter((t=>t!==n))),null===(l=n.success)||void 0===l||l.call(n,g,'',t);const e=r?Array.from(r.headers.entries()).map((([t,e])=>`${t}: ${e}`)).join('\r\n'):'';null===(c=this.dashMetrics)||void 0===c||c.addHttpRequest(m,t,null!==(h=null==r?void 0:r.status)&&void 0!==h?h:200,e,[])}else v&&(null===(p=n.progress)||void 0===p||p.call(n,{loaded:s,total:i-e,lengthComputable:!0,stream:!0}))}}onBigRequestError({url:t,from:e,to:i},s){var a,r,n,o;if(null===(r=(a=this.params).onError)||void 0===r||r.call(a,{id:'BigRequest',message:'Download error',thrown:s}),!this.activeRequests.has(t))return;const u=null!==(n=this.dashJsRequestQueue.get(t))&&void 0!==n?n:[];for(const t of u){const[a,r]=gu(t.request);(a>=e&&a<i||r>e&&r<=i)&&(null===(o=null==t?void 0:t.error)||void 0===o||o.call(t,t.request,String(s)))}if(this.activeRequests.delete(t),s)throw s}onBigRequestAbort({url:t,from:e,to:i}){var s,a;if(!this.activeRequests.has(t))return;const r=null!==(s=this.dashJsRequestQueue.get(t))&&void 0!==s?s:[];for(const t of r){const[s,r]=gu(t.request);(s>=e&&s<i||r>e&&r<=i)&&(null===(a=null==t?void 0:t.abort)||void 0===a||a.call(t,t.request))}this.activeRequests.delete(t)}static suppressAbort(t){if(!(t instanceof DOMException)||'AbortError'!==t.name&&20!==t.code)throw t}static suppressStreamErrors(){}}class Tu{constructor(t,e,i){this.baseLoader=t,this.config=i,this.bigRequest=e,e.setMetrics(i.dashMetrics)}static shouldDelegateToBase(t){return'download'!==t.action||'text'===t.mediaType||!t.range||'arraybuffer'!==t.responseType}load(t){const{request:e}=t;if(Tu.shouldDelegateToBase(e))return this.baseLoader.load(t);this.bigRequest.queueDashJSRequest(t),this.bigRequest.executeNextRequests()}abort(t){if(!t)return this.baseLoader.abort(),void this.bigRequest.abort();const{request:e}=t;Tu.shouldDelegateToBase(e)?this.baseLoader.abort(t):this.bigRequest.abort(t)}}const Eu=(t,e)=>{const i=new yu(e);return t.extend('SchemeLoaderFactory',(function(){const{parent:t}=this,e=t.getLoader;return{getLoader:t=>((t,e)=>i=>({create:s=>{const a=t(i).create(s);return new Tu(a,e,s)}}))(e(t),i)}}),!0),()=>i.destroy()};var ku=t=>{let e,i=!1,s=!1;t.on('playbackTimeUpdated',(({timeToEnd:t})=>{s=t<=3,i&&s&&(null==e||e())})),t.extend('MediaSourceController',(function(){const{parent:t}=this,a=t.signalEndOfStream;return{signalEndOfStream:t=>{i=!0,e=()=>a(t),i&&s&&(null==e||e())}}}),!0)},wu=D,Pu=Xt,$u=Function.prototype,Au=wu&&Object.getOwnPropertyDescriptor,xu=Pu($u,'name'),Nu={EXISTS:xu,PROPER:xu&&'something'===function(){}.name,CONFIGURABLE:xu&&(!wu||wu&&Au($u,'name').configurable)},Ru={},Du=Nn,Cu=Math.max,_u=Math.min,Iu=et,Lu=function(t,e){var i=Du(t);return i<0?Cu(i+e,0):_u(i,e)},Ou=_n,Bu=function(t){return function(e,i,s){var a,r=Iu(e),n=Ou(r),o=Lu(s,n);if(t&&i!=i){for(;n>o;)if((a=r[o++])!=a)return!0}else for(;n>o;o++)if((t||o in r)&&r[o]===i)return t||o||0;return!t&&-1}},Mu={includes:Bu(!0),indexOf:Bu(!1)},Vu=Xt,Uu=et,Fu=Mu.indexOf,ju=Ya,qu=x([].push),Hu=['constructor','hasOwnProperty','isPrototypeOf','propertyIsEnumerable','toLocaleString','toString','valueOf'],Gu=function(t,e){var i,s=Uu(t),a=0,r=[];for(i in s)!Vu(ju,i)&&Vu(s,i)&&qu(r,i);for(;e.length>a;)Vu(s,i=e[a++])&&(~Fu(r,i)||qu(r,i));return r},Yu=Hu,Qu=Object.keys||function(t){return Gu(t,Yu)},zu=D,Wu=Ze,Ju=Ke,Xu=si,Ku=et,Zu=Qu;Ru.f=zu&&!Wu?Object.defineProperties:function(t,e){Xu(t);for(var i,s=Ku(e),a=Zu(e),r=a.length,n=0;r>n;)Ju.f(t,i=a[n++],s[i]);return t};var td,ed=si,id=Ru,sd=Hu,ad=Ya,rd=Ns,nd=Ae,od=Ga('IE_PROTO'),ud=function(){},dd=function(t){return'<script>'+t+'<\/script>'},ld=function(t){t.write(dd('')),t.close();var e=t.parentWindow.Object;return t=null,e},cd=function(){try{td=new ActiveXObject('htmlfile')}catch(t){}var t,e;cd='undefined'!=typeof document?document.domain&&td?ld(td):((e=nd('iframe')).style.display='none',rd.appendChild(e),e.src=String('javascript:'),(t=e.contentWindow.document).open(),t.write(dd('document.F=Object')),t.close(),t.F):ld(td);for(var i=sd.length;i--;)delete cd.prototype[sd[i]];return cd()};ad[od]=!0;var hd,pd,md,fd=Object.create||function(t,e){var i;return null!==t?(ud.prototype=ed(t),i=new ud,ud.prototype=null,i[od]=t):i=cd(),void 0===e?i:id.f(i,e)},bd=!b((function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype})),Sd=Xt,vd=N,gd=zt,yd=bd,Td=Ga('IE_PROTO'),Ed=Object,kd=Ed.prototype,wd=yd?Ed.getPrototypeOf:function(t){var e=gd(t);if(Sd(e,Td))return e[Td];var i=e.constructor;return vd(i)&&e instanceof i?i.prototype:e instanceof Ed?kd:null},Pd=b,$d=N,Ad=fd,xd=wd,Nd=Ni,Rd=pe('iterator'),Dd=!1;[].keys&&('next'in(md=[].keys())?(pd=xd(xd(md)))!==Object.prototype&&(hd=pd):Dd=!0);var Cd=null==hd||Pd((function(){var t={};return hd[Rd].call(t)!==t}));$d((hd=Cd?{}:Ad(hd))[Rd])||Nd(hd,Rd,(function(){return this}));var _d={IteratorPrototype:hd,BUGGY_SAFARI_ITERATORS:Dd},Id=_d.IteratorPrototype,Ld=fd,Od=F,Bd=zi,Md=En,Vd=function(){return this},Ud=$i,Fd=I,jd=function(t,e,i,s){var a=e+' Iterator';return t.prototype=Ld(Id,{next:Od(+!s,i)}),Bd(t,a,!1,!0),Md[a]=Vd,t},qd=wd,Hd=zi,Gd=Ni,Yd=En,Qd=Nu.PROPER,zd=_d.BUGGY_SAFARI_ITERATORS,Wd=pe('iterator'),Jd=function(){return this},Xd=et,Kd=En,Zd=dr;Ke.f;var tl=function(t,e,i,s,a,r,n){jd(i,e,s);var o,u,d,l=function(t){if(t===a&&f)return f;if(!zd&&t in p)return p[t];switch(t){case'keys':case'values':case'entries':return function(){return new i(this,t)}}return function(){return new i(this)}},c=e+' Iterator',h=!1,p=t.prototype,m=p[Wd]||p['@@iterator']||a&&p[a],f=!zd&&m||l(a),b='Array'==e&&p.entries||m;if(b&&(o=qd(b.call(new t)))!==Object.prototype&&o.next&&(Hd(o,c,!0,!0),Yd[c]=Jd),Qd&&'values'==a&&m&&'values'!==m.name&&(h=!0,f=function(){return Fd(m,this)}),a)if(u={values:l('values'),keys:r?f:l('keys'),entries:l('entries')},n)for(d in u)(zd||h||!(d in p))&&Gd(p,d,u[d]);else Ud({target:e,proto:!0,forced:zd||h},u);return n&&p[Wd]!==f&&Gd(p,Wd,f,{name:a}),Yd[e]=f,u},el=Zd.set,il=Zd.getterFor('Array Iterator');tl(Array,'Array',(function(t,e){el(this,{type:'Array Iterator',target:Xd(t),index:0,kind:e})}),(function(){var t=il(this),e=t.target,i=t.kind,s=t.index++;return!e||s>=e.length?(t.target=void 0,{value:void 0,done:!0}):'keys'==i?{value:s,done:!1}:'values'==i?{value:e[s],done:!1}:{value:[s,e[s]],done:!1}}),'values'),Kd.Arguments=Kd.Array;var sl=ke,al=Ke,rl=F,nl=oo,ol=function(t,e,i){var s=sl(e);s in t?al.f(t,s,rl(0,i)):t[s]=i};$i({target:'Object',stat:!0},{fromEntries:function(t){var e={};return nl(t,(function(t,i){ol(e,t,i)}),{AS_ENTRIES:!0}),e}});var ul=at.Object.fromEntries,dl={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},ll=f,cl=Vi,hl=mi,pl=En,ml=pe('toStringTag');for(var fl in dl){var bl=ll[fl],Sl=bl&&bl.prototype;Sl&&cl(Sl)!==ml&&hl(Sl,ml,fl),pl[fl]=pl.Array}var vl=ul,gl=e=>{const i=new t.ValueSubject(1/0),s=new t.Subject,a=new t.ValueSubject(void 0),r=new t.ValueSubject(void 0);let n=NaN,o=!1;return e.extend('XHRLoader',(function(){const{parent:e}=this,u=e.load.bind(e);return{load:function(e){if('MPD'===e.request.type){const u=e.onload,d=e.progress;e.onload=function(...e){return(e=>{var s,n,o,u,d;const l=vl(e.getAllResponseHeaders().trim().split(/[\n\r]+/).map((t=>t.split(': '))));if('x-playback-duration'in l||'x-playback-duration-millis'in l){const a=parseInt(null!==(s=e.getResponseHeader('X-Playback-Duration'))&&void 0!==s?s:'',10),r=parseInt(null!==(n=e.getResponseHeader('X-Playback-Duration-Millis'))&&void 0!==n?n:'',10),u=null!==(o=null!=r?r:1e3*a)&&void 0!==o?o:NaN;t.isNonNullable(u)&&!isNaN(u)&&i.next(u)}const c=null!==(u=l['x-delivery-type'])&&void 0!==u?u:exports.HttpConnectionType.HTTP1,h=null!==(d={1:!0,0:!1}[l['x-reused']])&&void 0!==d?d:void 0;a.next(c),r.next(h)})(this),u(...e)},e.progress=function(...t){return this.readyState>=2&&!o&&(o=!0,s.next(Date.now()-n)),d(...t)},n=Date.now(),o=!1}return u(e)}}}),!0),{playbackDuration$:i,ping$:s,connectionReused$:r,connectionType$:a}},yl=t=>{const e=new URL(t);return e.searchParams.set('quic','1'),e.toString()},Tl=t=>{t.extend('HTTPLoader',(function(){const{parent:t}=this,e=t.load;return{load:t=>{if(t.request&&t.request.range){const[e,i]=t.request.range.split('-').map((t=>parseInt(t,10))),s=new URL(t.request.url,location.href);s.searchParams.append('bytes',`${e}-${i}`),t.request.url=s.toString(),t.request.range=void 0}e(t)}}}),!0)};const El=(e,i,s,{equal:a=((t,e)=>t===e),changed$:r,onError:n}={})=>{const o=e.getState(),u=i(),d=t.isNullable(r),l=new t.Subscription;return r&&l.add(r.subscribe((t=>{const i=e.getState();a(t,i)&&e.setState(t)}),n)),a(u,o)||(s(o),d&&e.setState(o)),l.add(e.stateChangeStarted$.subscribe((t=>{s(t.to),d&&e.setState(t.to)}),n)),l},kl=(e,i,s)=>El(i,(()=>e.loop),(i=>{t.isNonNullable(i)&&(e.loop=i)}),{onError:s}),wl=(e,i,s,a)=>El(i,(()=>({muted:e.muted,volume:e.volume})),(i=>{t.isNonNullable(i)&&(e.muted=i.muted,e.volume=i.volume)}),{equal:(t,e)=>t===e||(null==t?void 0:t.muted)===(null==e?void 0:e.muted)&&(null==t?void 0:t.volume)===(null==e?void 0:e.volume),changed$:s,onError:a}),Pl=(e,i,s,a)=>El(i,(()=>e.playbackRate),(i=>{t.isNonNullable(i)&&(e.playbackRate=i)}),{changed$:s,onError:a}),$l=(t,e)=>{if(t.id===e)return!0;const[i,s,a]=e.split('|');return t.language===s&&t.label===a};class Al{constructor(){this.available$=new t.Subject,this.current$=new t.ValueSubject(void 0),this.error$=new t.Subject,this.subscription=new t.Subscription,this.externalTracks=new Map}connect(e,i,s){this.video=e,this.cueSettings=i.textTrackCuesSettings,this.subscribe();const a=t=>{this.error$.next({id:'TextTracksManager',message:'Generic HtmlVideoTextTrackManager error',thrown:t})};this.subscription.add(this.available$.subscribe(s.availableTextTracks$)),this.subscription.add(this.current$.subscribe(s.currentTextTrack$)),this.subscription.add(this.error$.subscribe(s.error$)),this.subscription.add(El(i.externalTextTracks,(()=>Object.values(this.externalTracks)),(e=>{t.isNonNullable(e)&&this.setExternal(e)}),{equal:(e,i)=>t.isNonNullable(e)&&t.isNonNullable(i)&&e.length===i.length&&e.every((({id:t},e)=>t===i[e].id)),changed$:this.available$.pipe(t.map((t=>t.filter((({type:t})=>'external'===t))))),onError:a})),this.subscription.add(El(i.currentTextTrack,(()=>{if(this.video)return;const t=this.htmlTextTracksAsArray().find((({mode:t})=>'showing'===t));return t&&this.htmlTextTrackToITextTrack(t).id}),(t=>this.select(t)),{changed$:this.current$,onError:a})),this.subscription.add(El(i.textTrackCuesSettings,(()=>({})),(()=>{if(this.video)for(const t of this.htmlTextTracksAsArray())this.applyCueSettings(t.cues),this.applyCueSettings(t.activeCues)})))}subscribe(){t.assertNonNullable(this.video);const{textTracks:e}=this.video;this.subscription.add(t.fromEvent(e,'addtrack').subscribe((()=>{const t=this.current$.getValue();this.select(t)}))),this.subscription.add(t.merge(t.fromEvent(e,'addtrack'),t.fromEvent(e,'removetrack'),t.observableFrom(['init'])).pipe(t.map((()=>this.htmlTextTracksAsArray().map((t=>this.htmlTextTrackToITextTrack(t))))),t.filterChanged(((t,e)=>t.length===e.length&&t.every((({id:t},i)=>t===e[i].id))))).subscribe(this.available$)),this.subscription.add(t.merge(t.fromEvent(e,'change'),t.observableFrom(['init'])).pipe(t.map((()=>this.htmlTextTracksAsArray().find((({mode:t})=>'showing'===t)))),t.map((t=>t&&this.htmlTextTrackToITextTrack(t).id)),t.filterChanged()).subscribe(this.current$));const i=t=>{var e,i;return this.applyCueSettings(null!==(i=null===(e=t.target)||void 0===e?void 0:e.activeCues)&&void 0!==i?i:null)};this.subscription.add(t.fromEvent(e,'addtrack').subscribe((t=>{var e,s;null===(e=t.track)||void 0===e||e.addEventListener('cuechange',i);const a=t=>{var e,i,s,r,n;const o=null!==(i=null===(e=t.target)||void 0===e?void 0:e.cues)&&void 0!==i?i:null;o&&o.length&&(this.applyCueSettings(null!==(r=null===(s=t.target)||void 0===s?void 0:s.cues)&&void 0!==r?r:null),null===(n=t.target)||void 0===n||n.removeEventListener('cuechange',a))};null===(s=t.track)||void 0===s||s.addEventListener('cuechange',a)}))),this.subscription.add(t.fromEvent(e,'removetrack').subscribe((t=>{var e;null===(e=t.track)||void 0===e||e.removeEventListener('cuechange',i)})))}applyCueSettings(e){if(!e||!e.length)return;const i=this.cueSettings.getState();for(const s of Array.from(e)){const e=s;t.isNonNullable(i.align)&&(e.align=i.align),t.isNonNullable(i.position)&&(e.position=i.position),t.isNonNullable(i.size)&&(e.size=i.size),t.isNonNullable(i.line)&&(e.line=i.line)}}htmlTextTracksAsArray(e=!1){t.assertNonNullable(this.video);const i=[...this.video.textTracks];return e?i:i.filter(Al.isHealthyTrack)}htmlTextTrackToITextTrack(t){const{language:e,label:i}=t,s=''!==t.id?t.id:(t=>['__',t.language,t.label].join('|'))(t);return this.externalTracks.has(s)?{id:s,type:'external',language:e,label:i,url:this.externalTracks.get(s).url}:{id:s,type:'internal',language:e,label:i}}static isHealthyTrack(t){return'metadata'!==t.kind&&(''!==t.id||''!==t.label||''!==t.language)}setExternal(t){t.filter((({id:t})=>!this.externalTracks.has(t))).forEach((t=>this.attach(t))),Array.from(this.externalTracks.keys()).filter((e=>!t.find((t=>t.id===e)))).forEach((t=>this.detach(t)))}select(e){t.assertNonNullable(this.video);for(const i of this.htmlTextTracksAsArray(!0))t.isNonNullable(e)&&$l(i,e)?i.mode='showing':i.mode='disabled'}destroy(){if(this.subscription.unsubscribe(),this.video)for(const t of Array.from(this.video.getElementsByTagName('track'))){const e=t.getAttribute('id');e&&this.externalTracks.has(e)&&this.video.removeChild(t)}this.externalTracks.clear()}attach(e){t.assertNonNullable(this.video);const i=document.createElement('track');i.setAttribute('src',e.url),i.setAttribute('id',e.id),e.label&&i.setAttribute('label',e.label),e.language&&i.setAttribute('srclang',e.language),this.externalTracks.set(e.id,e),this.video.appendChild(i)}detach(e){t.assertNonNullable(this.video);const i=Array.prototype.find.call(this.video.getElementsByTagName('track'),(t=>t.getAttribute('id')===e));i&&this.video.removeChild(i),this.externalTracks.delete(e)}}var xl=t=>{const e=document.createElement('video');return e.setAttribute('crossorigin','anonymous'),e.setAttribute('playsinline','playsinline'),t.appendChild(e),e};class Nl{constructor(){this.pausedTime=0,this.streamOffset=0,this.pauseTimestamp=0}getTotalPausedTime(){return this.pausedTime+this.getCurrentPausedTime()}getCurrentPausedTime(){return this.pauseTimestamp>0?Date.now()-this.pauseTimestamp:0}getStreamOffset(){return this.streamOffset}getTotalOffset(){return this.getTotalPausedTime()+this.streamOffset}pause(){0===this.pauseTimestamp&&(this.pauseTimestamp=Date.now())}resume(){this.pauseTimestamp>0&&(this.pausedTime+=this.getCurrentPausedTime(),this.pauseTimestamp=0)}resetTo(t){this.streamOffset=t,this.pauseTimestamp=0,this.pausedTime=0}}class Rl{constructor(t){this._buffer=[],this._source=t}fill(){this._buffer=[];const t=this._source.currentTime;for(let e=0,i=this._source.buffered.length;e<i;e++){let i=this._source.buffered.start(e);const s=this._source.buffered.end(e);i>t&&i-t<3&&(i=t),this._buffer.push({from:i,to:s,i:e})}return this._buffer.sort((function(t,e){return t.from-e.from})),this._buffer}getByTime(t){return this._buffer.find((e=>t>=e.from&&t<e.to))}getNextWithGap(t,e){const i=this.getNext(t);if(i&&i.from-t.to<(e||3))return i}getNext(t){let e=this._buffer.indexOf(t);if(~e&&this._buffer.length-1>e)return this._buffer[++e]}smartRemove(t,e,i){this._buffer.forEach((({from:s,to:a})=>{const r=s>=t&&s<e,n=a>=t&&a<e;r&&n||(r?i(e,a):n?i(s,t):s<t&&a>e?(i(e,a),i(s,t)):i(s,a))}))}destroy(){this._buffer=[]}}var Dl=(t,e,i=3)=>{let s=0,a=0;for(let r=0;r<t.length;r++){const n=t.start(r),o=t.end(r);if(n<=e&&e<=o){if(s=n,a=o,!i)return{from:s,to:a};for(let e=r-1;e>=0;e--)t.end(e)+i>=s&&(s=t.start(e));for(let e=r+1;e<t.length;e++)t.start(e)-i<=a&&(a=t.end(e))}}return{from:s,to:a}};const Cl=e=>{const i=i=>t.fromEvent(e,i).pipe(t.mapTo(void 0)),s=t.merge(...['waiting','pause','canplay','play','canplaythrough','playing','seeking','seeked','ended'].map((i=>t.fromEvent(e,i)))).pipe(t.map((()=>e.readyState<3)),t.filterChanged()),a=t.merge(t.fromEvent(e,'progress'),t.fromEvent(e,'timeupdate')).pipe(t.map((()=>Dl(e.buffered,e.currentTime)))),r=t.fromEvent(e,'volumechange').pipe(t.debounce(0),t.map((()=>({muted:e.muted,volume:e.volume})))),n=t.fromEvent(e,'ratechange').pipe(t.map((()=>e.playbackRate))),o=t.fromEvent(e,'error').pipe(t.map((()=>{const t=e.error;return{id:t?`MediaError#${t.code}`:'HtmlVideoError',message:t?t.message:'Error event from HTML video element'}}))),u=t.fromEvent(e,'timeupdate').pipe(t.map((()=>e.currentTime))),d=new t.Subject;let l;return u.subscribe((i=>{e.loop&&t.isNonNullable(l)&&t.isNonNullable(i)&&l>=e.duration-.3&&i<=.3&&d.next(l),l=i})),{playing$:i('playing'),pause$:i('pause').pipe(t.filter((()=>!e.error))),canplay$:i('canplay'),ended$:i('ended'),looped$:d,error$:o,seeked$:i('seeked'),seeking$:i('seeking'),progress$:i('progress'),loadStart$:i('loadstart'),loadedMetadata$:i('loadedmetadata'),loadedData$:i('loadeddata'),timeUpdate$:u,durationChange$:t.fromEvent(e,'durationchange').pipe(t.map((()=>e.duration))),isBuffering$:s,currentBuffer$:a,volumeState$:r,playbackRateState$:n}},_l=t=>{if(t.includes('/')){const e=t.split('/');return parseInt(e[0])/parseInt(e[1])}return parseFloat(t)};var Il=zt,Ll=_n,Ol=Nn;$i({target:'Array',proto:!0},{at:function(t){var e=Il(this),i=Ll(e),s=Ol(t),a=s>=0?s:i+s;return a<0||a>=i?void 0:e[a]}});var Bl=zo('Array','at');let Ml=!1,Vl={};const Ul=t=>{t(Vl)},Fl=(t,e)=>{var i;Ml&&(Vl.meta=null!==(i=Vl.meta)&&void 0!==i?i:{},Vl.meta[t]=e)};class jl{constructor(t){this.name=t}next(t){var e,i;if(!Ml)return;Vl.series=null!==(e=Vl.series)&&void 0!==e?e:{};const s=null!==(i=Vl.series[this.name])&&void 0!==i?i:[];s.push([Date.now(),t]),Vl.series[this.name]=s}}const ql=new jl('best_bitrate');class Hl{constructor(){this.history={}}recordSelection(e){this.history[e.id]=t.now()}recordSwitch(t){this.last=t}clear(){this.last=void 0,this.history={}}}const Gl=(e,{container:i,throughput:s,tuning:a,limits:r,reserve:n=0,forwardBufferHealth:o,playbackRate:u,current:d,history:l})=>{var c,h,p,m;const f=a.usePixelRatio&&null!==(c=window.devicePixelRatio)&&void 0!==c?c:1,b=a.limitByContainer&&i&&i.width>0&&i.height>0&&{width:i.width*f*a.containerSizeFactor,height:i.height*f*a.containerSizeFactor},S=b&&su(b),v=a.considerPlaybackRate&&t.isNonNullable(u)?u:1,g=e.filter((t=>!au(t.quality))).sort(((t,e)=>tu(t.quality,e.quality)?-1:1)),y=null===(h=Bl(g,-1))||void 0===h?void 0:h.quality,T=null===(p=Bl(g,0))||void 0===p?void 0:p.quality,E=t.isNullable(r)||t.isNonNullable(r.min)&&t.isNonNullable(r.max)&&eu(r.max,r.min)||t.isNonNullable(r.min)&&T&&tu(r.min,T)||t.isNonNullable(r.max)&&y&&eu(r.max,y),k=v*(w=null!=o?o:.5,P=a.bitrateFactorAtEmptyBuffer,$=a.bitrateFactorAtFullBuffer,(P-$)*Math.pow(2,-10*w)+$);var w,P,$;const A=g.filter((e=>{const i=!S||eu(e.quality,S),u=!(t.isNonNullable(s)&&isFinite(s)&&t.isNonNullable(e.bitrate))||s-n>=e.bitrate*k,l=a.lazyQualitySwitch&&t.isNonNullable(a.minBufferToSwitchUp)&&d&&!au(d.quality)&&(null!=o?o:0)<a.minBufferToSwitchUp&&tu(e.quality,d.quality),c=E||(t.isNullable(r.max)||(h=e.quality,p=r.max,Zo[h].height<=Zo[p].height))&&(t.isNullable(r.min)||((t,e)=>Zo[t].height>=Zo[e].height)(e.quality,r.min));var h,p;return i&&u&&!l&&c}))[0];A&&A.bitrate&&ql.next(A.bitrate);const x=null!==(m=null!=A?A:g[Math.ceil((g.length-1)/2)])&&void 0!==m?m:e[0],N=x&&l&&l.history[x.id]&&t.now()-l.history[x.id]<=a.trackCooldown&&(!l.last||x.id!==l.last.id);if((null==x?void 0:x.id)&&l&&!N&&l.recordSelection(x),N&&(null==l?void 0:l.last)){const t=l.last;return null==l||l.recordSwitch(t),t}return null==l||l.recordSwitch(x),x};var Yl=t=>new URL(t).hostname;const Ql=(e,i=300)=>new t.Observable((a=>{const{width:r,height:n}=e.getBoundingClientRect();if(a.next({width:r,height:n}),!window.ResizeObserver)return;const o=new ResizeObserver(s.default((e=>{const i=e[0];if(!i)return;let s,r;i.contentBoxSize&&i.contentBoxSize[0]?(r=i.contentBoxSize[0].blockSize,s=i.contentBoxSize[0].inlineSize):i.contentRect&&(s=i.contentRect.width,r=i.contentRect.height),t.isNonNullable(s)&&t.isNonNullable(r)&&a.next({width:s,height:r})}),i));return o.observe(e),()=>o.disconnect()})),zl={};var Wl;!function(t){t.DOWNLOADING_LIB='downloading_lib',t.STOPPED='stopped',t.STREAM_INITIALIZED='stream_initialized',t.READY='ready',t.PLAYING='playing',t.PAUSED='paused'}(Wl||(Wl={}));const Jl=(e,i)=>new t.Observable((t=>{const s=e=>t.next(e);return e.on(i,s),()=>e.off(i,s)}));class Xl{constructor(e){this.subscription=new t.Subscription,this.videoState=new ru(Wl.DOWNLOADING_LIB),this.textTracksManager=new Al,this.videoTracks=[],this.frameRatesByFrameHeight={},this.isLive$=new t.ValueSubject(void 0),this.maxSeekBackTime$=new t.ValueSubject(1/0),this.availableFrom$=new t.ValueSubject(void 0),this.elementSize$=new t.ValueSubject(void 0),this.liveOffset=new Nl,this.syncPlayback=()=>{const e=this.videoState.getState(),i=this.params.desiredState.playbackState.getState(),s=this.params.desiredState.playbackState.getTransition(),a=this.params.desiredState.seekState.getState(),r=this.isLive$.getValue();if(!this.videoState.getTransition()&&e!==Wl.DOWNLOADING_LIB&&e!==Wl.STREAM_INITIALIZED)switch((null==s?void 0:s.to)!==exports.PlaybackState.PAUSED&&a.state===l.Requested&&e!==Wl.STOPPED&&i!==exports.PlaybackState.STOPPED&&(r?this.seek(a.position-this.liveOffset.getTotalPausedTime()):this.seek(a.position)),i){case exports.PlaybackState.STOPPED:switch(e){case Wl.STOPPED:break;case Wl.PLAYING:case Wl.PAUSED:case Wl.READY:this.stop();break;default:t.assertNever(e)}break;case exports.PlaybackState.PLAYING:switch(e){case Wl.PLAYING:break;case Wl.PAUSED:r&&(this.liveOffset.getTotalPausedTime()<this.params.config.maxPausedTime&&this.liveOffset.getTotalOffset()<this.maxSeekBackTime$.getValue()?(this.liveOffset.resume(),this.params.output.position$.next(-this.liveOffset.getTotalOffset()/1e3)):this.seek(-this.liveOffset.getTotalOffset())),this.play();break;case Wl.READY:this.play();break;case Wl.STOPPED:this.prepare();break;default:t.assertNever(e)}break;case exports.PlaybackState.PAUSED:switch(e){case Wl.PLAYING:this.pause(),this.liveOffset.pause();break;case Wl.PAUSED:break;case Wl.READY:this.videoState.setState(Wl.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED);break;case Wl.STOPPED:this.prepare();break;default:t.assertNever(e)}break;default:t.assertNever(i)}},this.video=xl(e.container),this.params=e,this.params.output.element$.next(this.video),this.params.output.availableVideoTracks$.next([]),this.params.output.hostname$.next(Yl(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.loadDashJs()}loadDashJs(){let t=!1;const e=e=>{var i;t||this.params.output.error$.next({id:'timeout'===e?'DashJSTimedOut':'DashJSLoadingError',message:`Dash.js failed to load: ${null===(i=null==e?void 0:e.toString)||void 0===i?void 0:i.call(e)}`,thrown:e}),t=!0},s=window.setTimeout((()=>e('timeout')),5e3);Wo(Promise.resolve().then((function(){return i(require('dashjs/dist/dash.mediaplayer.min.js'))})).then((e=>{t||(zl.MediaPlayer=e.MediaPlayer,zl.Debug=e.Debug,this.init())}),e),(()=>{window.clearTimeout(s),t=!0}))}init(){t.assertNonNullable(zl.MediaPlayer,'dashjs not loaded'),t.assertNonNullable(zl.Debug,'dashjs not loaded'),this.player=zl.MediaPlayer().create(),this.player.updateSettings({debug:{logLevel:3},streaming:{buffer:{fastSwitchEnabled:!0},abr:{limitBitrateByPortal:this.params.tuning.autoTrackSelection.limitByContainer,usePixelRatioInLimitBitrateByPortal:this.params.tuning.autoTrackSelection.usePixelRatio,additionalAbrRules:{insufficientBufferRule:!1}},utcSynchronization:{useManifestDateHeaderTimeSource:!0}}}),this.player.registerCustomCapabilitiesFilter((t=>(t.height&&(this.frameRatesByFrameHeight[t.height]=t.frameRate?_l(t.frameRate+''):void 0),!0)));(this.params.format===exports.VideoFormat.DASH_WEBM||this.params.format===exports.VideoFormat.DASH_LIVE_WEBM)&&this.params.tuning.useWebmBigRequest?this.destroyBigRequest=Eu(this.player,{minInitSize:this.params.tuning.bigRequestMinInitSize,minDataSize:this.params.tuning.bigRequestMinDataSize,onError:t=>this.params.output.error$.next(t),onDownloadStream:t=>this.params.dependencies.throughputEstimator.trackStream(t)}):this.params.tuning.stripRangeHeader&&Tl(this.player),ku(this.player),this.params.tuning.requestQuick&&this.player.extend('RequestModifier',(()=>({modifyRequestURL:yl})),!0),this.player.clearDefaultUTCTimingSources(),this.subscribe(),this.videoState.setState(Wl.STOPPED)}subscribe(){const{output:e,desiredState:i}=this.params,s=t=>{e.error$.next({id:'DashIFProvider',message:'DashIFProvider internal logic error',thrown:t})},a=(t,e)=>this.subscription.add(t.subscribe(e,s));a(Ql(this.video),this.elementSize$),a(Jl(this.player,'error').pipe(t.map((t=>({id:`DashJS#${'object'==typeof t.error?t.error.code:t.error}`,message:'object'==typeof t.error?t.error.message:void 0})))),e.error$),a(Jl(this.player,'playbackError').pipe(t.map((t=>({id:'DashJSPlayback',message:t.error})))),e.error$);const r=Jl(this.player,'qualityChangeRendered').pipe(t.filter((({mediaType:t})=>'video'===t)),t.map((({newQuality:t})=>{var e;return null===(e=this.videoTracks.find((({bitrateInfo:e})=>e.qualityIndex===t)))||void 0===e?void 0:e.track})));r.pipe(t.filter(t.isNonNullable)).subscribe(e.currentVideoTrack$),this.subscription.add(this.videoState.transitionEnded$.pipe(t.filter((({to:t})=>t===Wl.STREAM_INITIALIZED)),t.once()).subscribe((()=>{this.subscription.add(El(i.videoTrack,(()=>{var t,e;const i=this.player.getQualityFor('video');return null===(e=null===(t=this.videoTracks.find((({bitrateInfo:t})=>t.qualityIndex===i)))||void 0===t?void 0:t.track)||void 0===e?void 0:e.id}),(e=>{var i;if(t.isNullable(e))return;const s=null===(i=this.videoTracks.find((({track:t})=>t.id===e)))||void 0===i?void 0:i.bitrateInfo;s&&this.player.setQualityFor('video',s.qualityIndex)}),{changed$:r.pipe(t.map((t=>null==t?void 0:t.id))),onError:s}))}),s)),this.subscription.add(El(i.autoVideoTrackSwitching,(()=>{var t,e,i;return null===(i=null===(e=null===(t=this.player.getSettings().streaming)||void 0===t?void 0:t.abr)||void 0===e?void 0:e.autoSwitchBitrate)||void 0===i?void 0:i.video}),(t=>this.player.updateSettings({streaming:{abr:{autoSwitchBitrate:{video:t}}}})),{onError:s})),a(Jl(this.player,'bufferStateChanged').pipe(t.filter((({mediaType:t})=>'video'===t)),t.map((({state:t})=>'bufferStalled'===t))),e.isBuffering$),a(Jl(this.player,'fragmentLoadingStarted'),(({mediaType:t,request:{url:i}})=>{var s,a;const r=this.player.getDashMetrics(),n=r.getLatestFragmentRequestHeaderValueByID(t,'X-Reused'),o=null!==(s=r.getLatestFragmentRequestHeaderValueByID(t,'X-Delivery-Type'))&&void 0!==s?s:exports.HttpConnectionType.HTTP1,u=null!==(a={1:!0,0:!1}[n])&&void 0!==a?a:void 0;this.params.output.httpConnectionType$.next(o),this.params.output.httpConnectionReused$.next(u),e.hostname$.next(Yl(i))})),a(Jl(this.player,'streamInitialized'),(({streamInfo:{duration:t,manifestInfo:{isDynamic:i,availableFrom:s}}})=>{this.isLive$.next(i),this.availableFrom$.next(s.getTime()),i||e.duration$.next(t),this.videoTracks=[];const a=this.player.getQualityFor('video');let r;for(const t of this.player.getBitrateInfoListFor('video')){const e=t.qualityIndex.toString(10),i=su(t),s=t.bitrate/1e3,n={width:t.width,height:t.height},o=this.frameRatesByFrameHeight[t.height];if(i){const u={id:e,quality:i,bitrate:s,size:n,fps:o};this.videoTracks.push({track:u,bitrateInfo:t}),t.qualityIndex===a&&(r=u)}}e.availableVideoTracks$.next(this.videoTracks.map((({track:t})=>t))),r&&e.currentVideoTrack$.next(r),this.videoState.setState(Wl.STREAM_INITIALIZED),this.videoState.startTransitionTo(Wl.READY)})),a(Jl(this.player,'fragmentLoadingCompleted'),(({request:t})=>{if(!t.requestEndDate||!t.firstByteDate||!t.bytesLoaded)return;const e=t.requestEndDate.getTime()-t.firstByteDate.getTime(),i=t.bytesLoaded;this.params.dependencies.throughputEstimator.addRawSpeed(i,e)})),a(t.merge(this.params.dependencies.throughputEstimator.throughput$,this.elementSize$,i.autoVideoTrackLimits.stateChangeEnded$),(()=>{if(!this.params.desiredState.autoVideoTrackSwitching.getState()||!this.videoTracks.length)return;const t=this.params.dependencies.throughputEstimator.throughput$.getValue(),e=Gl(this.videoTracks.map((({track:t})=>t)),{container:this.elementSize$.getValue(),throughput:t,tuning:this.params.tuning.autoTrackSelection,limits:i.autoVideoTrackLimits.getState()}),s=this.videoTracks.find((({track:t})=>t===e));(null==s?void 0:s.bitrateInfo)&&this.player.setQualityFor('video',null==s?void 0:s.bitrateInfo.qualityIndex,!1)})),a(t.combine({maxSeekBackTime:this.maxSeekBackTime$,isLive:this.isLive$.pipe(t.filter(t.isNonNullable))}).pipe(t.filter((({isLive:t})=>t)),t.map((({maxSeekBackTime:t})=>-t/1e3))),this.params.output.duration$);const n=Jl(this.player,'playbackTimeUpdated').pipe(t.map((({time:t})=>null!=t?t:0)));a(t.combine({availableFrom:this.availableFrom$.pipe(t.filter(t.isNonNullable)),currentTime:n}),(({availableFrom:t,currentTime:e})=>this.params.output.liveTime$.next(t+1e3*e))),a(n.pipe(t.filter((()=>!1===this.isLive$.getValue()))),e.position$),a(Jl(this.player,'playbackSeeked'),(()=>e.seekedEvent$.next())),a(Jl(this.player,'playbackEnded'),e.endedEvent$),a(Jl(this.player,'playbackProgress').pipe(t.map((()=>Dl(this.video.buffered,this.video.currentTime)))),e.currentBuffer$),a(Jl(this.player,'playbackPlaying'),(()=>{this.videoState.setState(Wl.PLAYING),Ko(i.playbackState,exports.PlaybackState.PLAYING)})),a(Jl(this.player,'playbackNotAllowed'),(()=>{this.player.isMuted()?(this.player.setMute(!1),this.videoState.setState(Wl.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED,!0)):(this.player.setMute(!0),this.player.play())})),a(Jl(this.player,'playbackPaused'),(()=>{this.videoState.setState(Wl.PAUSED),Ko(i.playbackState,exports.PlaybackState.PAUSED)})),a(Jl(this.player,'canPlay'),(()=>{var t;(null===(t=this.videoState.getTransition())||void 0===t?void 0:t.to)===Wl.READY&&this.videoState.setState(Wl.READY)})),a(this.isLive$,e.isLive$),a(Ql(this.video),(()=>{this.player.isReady()&&this.player.updatePortalSize()}));a(t.merge(i.playbackState.stateChangeStarted$,i.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,t.observableFrom(['init'])).pipe(t.debounce(0)),this.syncPlayback);const{playbackDuration$:o,ping$:u,connectionType$:d,connectionReused$:l}=gl(this.player);a(d,this.params.output.httpConnectionType$),a(l,this.params.output.httpConnectionReused$),a(o,this.maxSeekBackTime$),a(u.pipe(t.once()),e.firstBytesEvent$),a(Jl(this.player,'canPlay'),e.canplay$),this.params.tuning.flushShortLoopedBuffers&&a(t.combine({isLive:this.isLive$,isShort:e.duration$.pipe(t.map((t=>t<60)))}),(({isLive:t,isShort:e})=>{const i=!t&&e;this.player.updateSettings({streaming:{buffer:{flushBufferAtTrackSwitch:i}}})})),a(n.pipe(t.filter((t=>t>this.params.tuning.insufficientBufferRuleMargin)),t.once()),(()=>this.player.updateSettings({streaming:{abr:{additionalAbrRules:{insufficientBufferRule:!0}}}}))),this.textTracksManager.connect(this.video,i,e),this.subscription.add(Jl(this.player,'manifestLoaded').pipe(t.once()).subscribe((()=>{this.subscription.add(Jl(this.player,'playbackPlaying').pipe(t.once(),t.mapTo(void 0)).subscribe(e.firstFrameEvent$,s))}),s)),this.subscription.add(kl(this.video,i.isLooped,s));const{volumeState$:c,looped$:h,playbackRateState$:p}=Cl(this.video);this.subscription.add(wl(this.video,i.volume,c,s)),this.subscription.add(c.subscribe(e.volume$,s)),this.subscription.add(h.subscribe(e.loopedEvent$)),this.subscription.add(Pl(this.video,i.playbackRate,p,s))}stop(){this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.player.attachSource(null),this.player.attachView(null),this.player.initialize(),this.player.clearDefaultUTCTimingSources(),this.videoState.setState(Wl.STOPPED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.STOPPED,!0)}prepare(){this.videoState.startTransitionTo(Wl.STREAM_INITIALIZED),this.player.initialize(),this.player.clearDefaultUTCTimingSources(),this.player.attachView(this.video),this.player.attachSource(this.params.source.url)}seek(t){if(this.params.output.willSeekEvent$.next(),this.isLive$.getValue()){const e=-t,i=e<this.maxSeekBackTime$.getValue()?e:0;this.liveOffset.resetTo(i),this.params.output.position$.next(-i/1e3);const s=Xo(this.params.source.url,this.liveOffset.getTotalOffset()/1e3,Qo.PLAYBACK_SHIFT);this.player.attachSource(s)}else this.player.seek(t/1e3)}play(){this.videoState.startTransitionTo(Wl.PLAYING),this.player.play()}pause(){this.videoState.startTransitionTo(Wl.PAUSED),this.video.pause()}destroy(){var t,e;this.subscription.unsubscribe(),this.textTracksManager.destroy();try{null===(t=this.player)||void 0===t||t.destroy()}catch(t){}this.video.remove(),this.params.output.element$.next(void 0),null===(e=this.destroyBigRequest)||void 0===e||e.call(this)}}var Kl=t=>{switch(t){case'mobile':return exports.VideoQuality.Q_144P;case'lowest':return exports.VideoQuality.Q_240P;case'low':return exports.VideoQuality.Q_360P;case'sd':case'medium':return exports.VideoQuality.Q_480P;case'hd':case'high':return exports.VideoQuality.Q_720P;case'fullhd':case'full':return exports.VideoQuality.Q_1080P;case'quadhd':case'quad':return exports.VideoQuality.Q_1440P;case'ultrahd':case'ultra':return exports.VideoQuality.Q_2160P}},Zl=t=>uu(void 0,void 0,void 0,(function*(){const e=t.muted;try{yield t.play()}catch(i){if(i instanceof DOMException&&(20===i.code||'AbortError'===i.name))return!1;if(e)return console.warn(i),!1;t.muted=!0;try{yield t.play()}catch(e){return t.muted=!1,console.warn(e),!1}}return!0}));function tc(){return t.now()}function ec(t){return tc()-t}function ic(t){const e=t.split('/'),i=e.slice(0,e.length-1).join('/'),s=/^([a-z]+:)?\/\//i;return{resolve:(t,e,a=!1)=>{(t=>s.test(t))(t)||(t.startsWith('/')||(t='/'+t),t=i+t);let r=t.indexOf('?')>-1?'&':'?';return a&&(t+=r+'lowLat=1',r='&'),e&&(t+=r+'_rnd='+Math.floor(999999999*Math.random())),t}}}function sc(e,i,s,a){const r=window.XMLHttpRequest;let n,o,u,d,l,c=!1,h=0,p=!1,m='arraybuffer',f=7e3,b=2e3,S=()=>{if(c)return;t.assertNonNullable(d);const e=ec(d);let i;if(e<b)return i=b-e,void setTimeout(S,i);b*=2,b>f&&(b=f),o&&o.abort(),o=new r,g()};const v=()=>{if(!c){if(--h>=0)return S(),void(a&&a());c=!0,l&&l(),s&&s()}},g=()=>{d=tc(),o=new r,o.open('get',e);let s,a=0,h=0;const f=()=>(t.assertNonNullable(d),Math.max(d,Math.max(s||0,h||0)));if(n&&o.addEventListener('progress',(t=>{const e=tc();n.updateChunk&&t.loaded>a&&(n.updateChunk(f(),t.loaded-a),a=t.loaded,s=e)})),u&&(o.timeout=u,o.addEventListener('timeout',(()=>v()))),o.addEventListener('load',(()=>{if(c)return;t.assertNonNullable(o);const e=o.status;if(e>=200&&e<300){if(o.response.byteLength&&n){const t=o.response.byteLength-a;t&&n.updateChunk&&n.updateChunk(f(),t)}l&&l(),o&&i(o.response)}else v()})),o.addEventListener('error',(()=>{v()})),p){const e=()=>{t.assertNonNullable(o),o.readyState===XMLHttpRequest.HEADERS_RECEIVED&&(h=tc(),o.removeEventListener('readystatechange',e))};o.addEventListener('readystatechange',e)}return o.responseType=m,o.send(),y},y={withBitrateReporting:t=>(n=t,y),withParallel:t=>(p=t,y),withJSONResponse:()=>(m='json',y),withRetryCount:t=>(h=t,y),withRetryInterval:(e,i)=>(t.isNonNullable(e)&&(b=e),t.isNonNullable(i)&&(f=i),y),withTimeout:t=>(u=t,y),withFinally:t=>(l=t,y),send:g,abort:()=>{o&&(o.abort(),o=void 0),c=!0,l&&l()}};return y}class ac{constructor(t){this.intervals=[],this.currentRate=0,this.logger=t}_updateRate(t){let e=.2;this.currentRate&&(t<.1*this.currentRate?e=.8:t<.5*this.currentRate?e=.5:t<.7*this.currentRate&&(e=.3)),t=Math.max(1,Math.min(t,104857600)),this.currentRate=this.currentRate?this.currentRate*(1-e)+t*e:t}_createInterval(t,e,i){return{start:t,end:e,bytes:i}}_doMergeIntervals(t,e){t.start=Math.min(e.start,t.start),t.end=Math.max(e.end,t.end),t.bytes+=e.bytes}_mergeIntervals(t,e){return t.start<=e.end&&e.start<=t.end&&(this._doMergeIntervals(t,e),!0)}_flushIntervals(){if(!this.intervals.length)return!1;const t=this.intervals[0].start,e=this.intervals[this.intervals.length-1].end-500;if(e-t>2e3){let i=0,s=0;for(;this.intervals.length>0;){const t=this.intervals[0];if(t.end<=e)i+=t.end-t.start,s+=t.bytes,this.intervals.splice(0,1);else{if(t.start>=e)break;{const a=e-t.start,r=t.end-t.start;i+=a;const n=t.bytes*a/r;s+=n,t.start=e,t.bytes-=n}}}if(s>0&&i>0){const a=8*s/(i/1e3);return this._updateRate(a),this.logger(`rate updated, new=${Math.round(a/1024)}K; average=${Math.round(this.currentRate/1024)}K bytes/ms=${Math.round(s)}/${Math.round(i)} interval=${Math.round(e-t)}`),!0}}return!1}_joinIntervals(){let t;do{t=!1;for(let e=0;e<this.intervals.length-1;++e)this._mergeIntervals(this.intervals[e],this.intervals[e+1])&&(this.intervals.splice(e+1,1),t=!0)}while(t)}addInterval(t,e,i){return this.intervals.push(this._createInterval(t,e,i)),this._joinIntervals(),this.intervals.length>100&&(this.logger(`too many intervals (${this.intervals.length}); will merge`,{type:'warn'}),this._doMergeIntervals(this.intervals[1],this.intervals[0]),this.intervals.splice(0,1)),this._flushIntervals()}getBitRate(){return this.currentRate}}class rc{constructor(t,e,i,s,a){this.pendingQueue=[],this.activeRequests={},this.completeRequests={},this.averageSegmentDuration=2e3,this.lastPrefetchStart=0,this.throttleTimeout=null,this.RETRY_COUNT=t,this.TIMEOUT=e,this.BITRATE_ESTIMATOR=i,this.MAX_PARALLEL_REQUESTS=s,this.logger=a}limitCompleteCount(){let t;for(;(t=Object.keys(this.completeRequests)).length>this._getParallelRequestCount()+2;){const e=t[Math.floor(Math.random()*t.length)];this.logger(`Dropping completed request for url ${e}`,{type:'warn'}),delete this.completeRequests[e]}}_sendRequest(t,e){const i=tc(),s=i=>{delete this.activeRequests[e],this.limitCompleteCount(),this.completeRequests[e]=t,this._sendPending(),t._error=1,t._errorMsg=i,t._errorCB?t._errorCB(i):(this.limitCompleteCount(),this.completeRequests[e]=t)};t._request=sc(e,(s=>{t._complete=1,t._responseData=s,t._downloadTime=tc()-i,delete this.activeRequests[e],this._sendPending(),t._cb?t._cb(s,t._downloadTime):(this.limitCompleteCount(),this.completeRequests[e]=t)}),(()=>s('error')),(()=>{t._retry=1,t._retryCB&&t._retryCB()})),t._request.withRetryCount(this.RETRY_COUNT).withTimeout(this.TIMEOUT).withBitrateReporting(this.BITRATE_ESTIMATOR).withParallel(this._getParallelRequestCount()>1).withFinally((()=>{t._finallyCB&&t._finallyCB()})),this.activeRequests[e]=t,t._request.send(),this.lastPrefetchStart=tc()}_getParallelRequestCount(){return Math.min(this.MAX_PARALLEL_REQUESTS,this.averageSegmentDuration<3e3?3:2)}_getPrefetchDelay(){return Math.max(100,Math.min(5e3,this.averageSegmentDuration/3))}_canSendPending(){const t=this._getParallelRequestCount(),e=tc();if(Object.keys(this.activeRequests).length>=t)return!1;const i=this._getPrefetchDelay()-(e-this.lastPrefetchStart);return this.throttleTimeout&&clearTimeout(this.throttleTimeout),!(i>0)||(this.throttleTimeout=window.setTimeout((()=>this._sendPending()),i),!1)}_sendPending(){for(;this._canSendPending();){const t=this.pendingQueue.pop();if(!t)return;this.activeRequests[t]||this.completeRequests[t]||(this.logger(`Submitting pending request url=${t}`),this._sendRequest({},t))}}_removeFromActive(t){delete this.completeRequests[t],delete this.activeRequests[t]}abortAll(){Object.values(this.activeRequests).forEach((t=>{t&&t._request&&t._request.abort()})),this.activeRequests={},this.pendingQueue=[],this.completeRequests={}}requestData(t,e,i,s){const a={};return a.send=()=>{const r=this.activeRequests[t]||this.completeRequests[t];if(r)r._cb=e,r._errorCB=i,r._retryCB=s,r._finallyCB=a._finallyCB,r._error||r._complete?(this._removeFromActive(t),setTimeout((()=>{r._complete?(this.logger(`Requested url already prefetched, url=${t}`),e(r._responseData,r._downloadTime)):(this.logger(`Requested url already prefetched with error, url=${t}`),i(r._errorMsg)),a._finallyCB&&a._finallyCB()}),0)):this.logger(`Attached to active request, url=${t}`);else{const e=this.pendingQueue.indexOf(t);-1!==e&&this.pendingQueue.splice(e,1),this.logger(`Request not prefetched, starting new request, url=${t}${-1===e?'':'; removed pending'}`),this._sendRequest(a,t)}},a._cb=e,a._errorCB=i,a._retryCB=s,a.abort=function(){a.request&&a.request.abort()},a.withFinally=t=>(a._finallyCB=t,a),a}prefetch(t){this.activeRequests[t]||this.completeRequests[t]?this.logger(`Request already active for url=${t}`):(this.logger(`Added to pending queue; url=${t}`),this.pendingQueue.unshift(t),this._sendPending())}optimizeForSegDuration(t){this.averageSegmentDuration=t}}class nc{constructor(t){this.paused=!1,this.autoQuality=!0,this.maxAutoQuality=void 0,this.buffering=!0,this.destroyed=!1,this.videoPlayStarted=!1,this.lowLatency=!1,this.bitrate=0,this.manifest=[],this.sourceBuffer=0,this.bufferStates=[],this.sourceJitter=-1,this.params=t,this.chunkRateEstimator=new ac(this.params.logger),this._initVideo()}attachSource(t){this.manifestUrl=t,this.urlResolver=ic(t),this.bitrateSwitcher=this._initBitrateSwitcher(),this._initManifest()}setAutoQualityEnabled(t){this.autoQuality=t}setMaxAutoQuality(t){this.maxAutoQuality=t}switchByName(t){let e;for(let i=0;i<this.manifest.length;++i)if(e=this.manifest[i],e.name===t)return void this._switchToQuality(e)}catchUp(){this.rep&&this.rep.stop(),this.currentManifestEntry&&(this.paused=!1,this._initPlayerWith(this.currentManifestEntry),this._notifyBuffering(!0))}stop(){this.params.videoElement.pause(),this.rep&&(this.rep.stop(),this.rep=null)}pause(){this.paused=!0,this.params.videoElement.pause(),this.videoPlayStarted=!1,this._notifyBuffering(!1)}play(t){this.paused=!1;const e=this.lowLatency&&this._getBufferSizeSec()>this.sourceJitter+5;this.rep&&!e?(this.bufferStates=[],this.videoPlayStarted=!1,this.shouldPlay()?this._playVideoElement(t):this._notifyBuffering(!0)):this.catchUp()}startPlay(t,e){this.autoQuality=e,this._initPlayerWith(t)}destroy(){this.destroyed=!0,this.rep&&(this.rep.stop(),this.rep=null),this.manifestRequest&&this.manifestRequest.abort(),this.manifestRefetchTimer&&(clearTimeout(this.manifestRefetchTimer),this.manifestRefetchTimer=void 0)}reinit(t){this.manifestUrl=t,this.urlResolver=ic(t),this.catchUp()}_handleNetworkError(){this.params.logger('Fatal network error'),this.params.playerCallback({name:'error',type:'network'})}_retryCallback(){this.params.playerCallback({name:'retry'})}_getBufferSizeSec(){const t=this.params.videoElement;let e=0;const i=t.buffered.length;return 0!==i&&(e=t.buffered.end(i-1)-Math.max(t.currentTime,t.buffered.start(0))),e}_notifyBuffering(t){this.destroyed||(this.params.logger(`buffering: ${t}`),this.params.playerCallback({name:'buffering',isBuffering:t}),this.buffering=t)}_initVideo(){const{videoElement:t,logger:e}=this.params;t.addEventListener('error',(i=>{var s;this.destroyed||(e(`Video element error: ${null===(s=t.error)||void 0===s?void 0:s.code}`),this.params.playerCallback({name:'error',type:'media'}))})),t.addEventListener('timeupdate',(()=>{const e=this._getBufferSizeSec();!this.paused&&e<.3?this.buffering||(this.buffering=!0,window.setTimeout((()=>{!this.paused&&this.buffering&&this._notifyBuffering(!0),t.pause(),this.videoPlayStarted=!1}),1e3*(e+.1))):this.buffering&&this.videoPlayStarted&&this._notifyBuffering(!1)})),t.addEventListener('playing',(()=>{e('playing')})),t.addEventListener('stalled',(()=>this._fixupStall())),t.addEventListener('waiting',(()=>this._fixupStall()))}_fixupStall(){const{logger:t,videoElement:e}=this.params,i=e.buffered.length;let s;0!==i&&(s=e.buffered.start(i-1),e.currentTime<s&&(t('Fixup stall'),e.currentTime=s))}_selectQuality(t){const{videoElement:e}=this.params;let i,s,a;const r=e&&1.62*(window.devicePixelRatio||1)*e.offsetHeight||520;for(let e=0;e<this.manifest.length;++e)a=this.manifest[e],this.maxAutoQuality&&a.video.height>this.maxAutoQuality||(a.bitrate<t&&r>Math.min(a.video.height,a.video.width)?(!s||a.bitrate>s.bitrate)&&(s=a):(!i||i.bitrate>a.bitrate)&&(i=a));return s||i}shouldPlay(){if(this.paused)return!1;const e=this._getBufferSizeSec()-Math.max(1,this.sourceJitter);return e>3||t.isNonNullable(this.downloadRate)&&(this.downloadRate>1.5&&e>2||this.downloadRate>2&&e>1)}_setVideoSrc(t,e){const{logger:i,videoElement:s,playerCallback:a}=this.params;this.mediaSource=new window.MediaSource,i('setting video src'),s.src=URL.createObjectURL(this.mediaSource),this.mediaSource.addEventListener('sourceopen',(()=>{this.mediaSource&&(this.sourceBuffer=this.mediaSource.addSourceBuffer(t.codecs),this.bufferStates=[],e())})),this.videoPlayStarted=!1,s.addEventListener('canplay',(()=>{this.shouldPlay()&&(this.videoPlayStarted=!0,this._playVideoElement())}));const r=()=>{!function(t,e,i){const s=(...a)=>{i.apply(null,a),t.removeEventListener(e,s)};t.addEventListener(e,s)}(s,'progress',(()=>{s.buffered.length?(s.currentTime=s.buffered.start(0),a({name:'playing'})):r()}))};r()}_initPlayerWith(t){this.bitrate=0,this.rep=0,this.sourceBuffer=0,this.bufferStates=[],this.filesFetcher&&this.filesFetcher.abortAll(),this.filesFetcher=new rc(3,1e4,this.bitrateSwitcher,this.params.config.maxParallelRequests,this.params.logger),this._setVideoSrc(t,(()=>this._switchToQuality(t)))}_representation(e){const{logger:i,videoElement:s,playerCallback:a}=this.params;let r=!1,n=null,o=null,u=null,d=null,l=!1;const c=()=>{const t=r&&(!l||l===this.rep);return t||i('Not running!'),t},h=(t,e,i)=>{u&&u.abort(),u=sc(this.urlResolver.resolve(t,!1),e,i,(()=>this._retryCallback())).withTimeout(1e4).withBitrateReporting(this.bitrateSwitcher).withRetryCount(3).withFinally((()=>{u=null})).send()},p=(e,i,s)=>{t.assertNonNullable(this.filesFetcher),null==o||o.abort(),o=this.filesFetcher.requestData(this.urlResolver.resolve(e,!1),i,s,(()=>this._retryCallback())).withFinally((()=>{o=null})).send()},m=t=>{const e=s.playbackRate;s.playbackRate!==t&&(i(`Playback rate switch: ${e}=>${t}`),s.playbackRate=t)},f=t=>{this.lowLatency=t,i(`lowLatency changed to ${t}`),b()},b=()=>{if(this.lowLatency){let t=this._getBufferSizeSec();if(this.bufferStates.length<5)return void m(1);const e=tc()-6e4;let s=0;for(let i=0;i<this.bufferStates.length;i++){const a=this.bufferStates[i];t=Math.min(t,a.buf),a.ts<e&&s++}this.bufferStates.splice(0,s),i(`update playback rate;  minBuffer=${t} drop=${s} jitter=${this.sourceJitter}`);let a=t-1;this.sourceJitter>=0?a-=this.sourceJitter/2:this.sourceJitter-=1,m(a>3?1.15:a>1?1.1:a>.3?1.01:1)}else m(1)},S=e=>{let s;const r=()=>s&&s.start?s.start.length:0,n=t=>s.start[t]/1e3,o=t=>s.dur[t]/1e3,u=t=>s.fragIndex+t,l=(t,e)=>({chunkIdx:u(t),startTS:n(t),dur:o(t),discontinuity:e}),h=()=>{let t=0;if(s&&s.dur){let e=this.lowLatency?this.params.config.lowLatencyMinBuffer:this.params.config.minBuffer,i=this.lowLatency?this.params.config.lowLatencyMinBufferSegments:this.params.config.minBufferSegments,a=e;this.sourceJitter>1&&(a+=this.sourceJitter-1);let r=s.dur.length-1;for(;r>=0&&(a-=s.dur[r],!(a<=0));--r);t=Math.min(r,s.dur.length-1-i),t=Math.max(t,0)}return l(t,!0)},p=(t,e,i)=>{d&&d.abort(),d=sc(this.urlResolver.resolve(t,!0,this.lowLatency),e,i,(()=>this._retryCallback())).withTimeout(1e4).withRetryCount(3).withFinally((()=>{d=null})).withJSONResponse().send()};return{seek:(i,o)=>{p(e,(e=>{if(!c())return;s=e;const u=Boolean(s.lowLatency);u!==this.lowLatency&&f(u);let d=0;for(let t=0;t<s.dur.length;++t)d+=s.dur[t];d>0&&(t.assertNonNullable(this.filesFetcher),this.filesFetcher.optimizeForSegDuration(d/s.dur.length)),a({name:'index',zeroTime:s.zeroTime,shiftDuration:s.shiftDuration}),this.sourceJitter=s.hasOwnProperty('jitter')?Math.min(10,Math.max(.01,s.jitter/1e3)):1,i((e=>{const i=r();if(!(i<=0)){if(t.isNonNullable(e))for(let t=0;t<i;t++)if(n(t)>e)return l(t);return h()}})(o))}),(()=>this._handleNetworkError()))},nextChunk:t=>{const e=r(),a=t?t.chunkIdx+1:0,n=a-s.fragIndex;if(!(e<=0)){if(!t||n<0||n-e>10)return i(`Resync: offset=${n} bChunks=${e} chunk=`+JSON.stringify(t)),h();if(!(n>=e))return l(a-s.fragIndex,!1)}}}},v=()=>{r=!1,o&&o.abort(),u&&u.abort(),d&&d.abort(),t.assertNonNullable(this.filesFetcher),this.filesFetcher.abortAll()};return l={start:i=>{const{videoElement:s,logger:a}=this.params;let o,u,l,m,f,g,y,T=S(e.jidxUrl),E=0;const k=()=>{f&&(clearTimeout(f),f=void 0);const t=Math.max(500,1e3*(this._getBufferSizeSec()-this.sourceJitter-5)),e=E+t,i=tc(),s=Math.min(1e4,e-i);E=i;const a=()=>{d||c()&&T.seek((()=>{c()&&(E=tc(),w(),k())}))};s>0?f=window.setTimeout((()=>{this.paused?k():a()}),s):a()},w=()=>{let t;for(;t=T.nextChunk(m);)m=t,N(t);const i=T.nextChunk(l);if(i){if(l&&i.discontinuity)return a('Detected discontinuity; restarting playback'),void(this.paused?k():(v(),this._initPlayerWith(e)));x(i)}else k()},P=(t,e)=>{if(!c()||!this.sourceBuffer)return;let i,r,n;const o=i=>{window.setTimeout((()=>{c()&&P(t,e)}),i)};if(this.sourceBuffer.updating)a('Source buffer is updating; delaying appendBuffer'),o(100);else{const u=tc(),d=s.currentTime;!this.paused&&s.buffered.length>1&&g===d&&u-y>500&&(a('Stall suspected; trying to fix'),this._fixupStall()),g!==d&&(g=d,y=u);const l=this._getBufferSizeSec();if(l>30)a(`Buffered ${l} seconds; delaying appendBuffer`),o(2e3);else try{this.sourceBuffer.appendBuffer(t),this.videoPlayStarted?(this.bufferStates.push({ts:u,buf:l}),b(),this.bufferStates.length>200&&this.bufferStates.shift()):this.shouldPlay()&&(this.videoPlayStarted=!0,this._playVideoElement()),e&&e()}catch(t){if('QuotaExceededError'!==t.name)throw t;a('QuotaExceededError; delaying appendBuffer'),n=this.sourceBuffer.buffered.length,0!==n&&(i=this.sourceBuffer.buffered.start(0),r=d,r-i>4&&this.sourceBuffer.remove(i,r-3)),o(1e3)}}},$=()=>{u&&o&&(a([`Appending chunk, sz=${u.byteLength}:`,JSON.stringify(l)]),P(u,(function(){u=null,w()})))},A=t=>e.fragUrlTemplate.replace('%%id%%',t.chunkIdx),x=t=>{c()&&p(A(t),((e,i)=>{if(c()){if(i/=1e3,u=e,l=t,n=t.startTS,i){const e=Math.min(10,t.dur/i);this.downloadRate=this.downloadRate?.7*this.downloadRate+.3*e:e}$()}}),(()=>this._handleNetworkError()))},N=e=>{c()&&(t.assertNonNullable(this.filesFetcher),this.filesFetcher.prefetch(this.urlResolver.resolve(A(e),!1)))},R=t=>{c()&&(e.cachedHeader=t,P(t,(()=>{o=!0,$()})))};r=!0,T.seek((e=>{c()&&(E=tc(),e?(m=e,!t.isNullable(i)||e.startTS>i?x(e):(l=e,w())):k())}),i),e.cachedHeader?R(e.cachedHeader):h(e.headerUrl,R,(()=>this._handleNetworkError()))},stop:v,getTimestampSec:()=>n},l}_switchToQuality(e){const{logger:i,playerCallback:s}=this.params;let a;e.bitrate!==this.bitrate&&(this.rep&&(a=this.rep.getTimestampSec(),t.isNonNullable(a)&&(a+=.1),this.rep.stop()),this.currentManifestEntry=e,this.rep=this._representation(e),i(`switch to quality: codecs=${e.codecs}; headerUrl=${e.headerUrl}; bitrate=${e.bitrate}`),this.bitrate=e.bitrate,t.assertNonNullable(this.bitrateSwitcher),this.bitrateSwitcher.notifySwitch(this.bitrate),this.rep.start(a),s({name:'qualitySwitch',quality:e}))}_qualityAvailable(e){return t.isNonNullable(this.manifest.find((t=>t.name===e)))}_initBitrateSwitcher(){const{logger:t,playerCallback:e}=this.params,i=e=>{if(!this.autoQuality)return;let i,s,a;this.currentManifestEntry&&this._qualityAvailable(this.currentManifestEntry.name)&&e<this.bitrate&&(s=this._getBufferSizeSec(),a=e/this.bitrate,s>10&&a>.8||s>15&&a>.5||s>20&&a>.3)?t(`Not switching: buffer=${Math.floor(s)}; bitrate=${this.bitrate}; newRate=${Math.floor(e)}`):(i=this._selectQuality(e),i?this._switchToQuality(i):t(`Could not find quality by bitrate ${e}`))},s=(()=>({updateChunk:(t,i)=>{const s=tc();if(this.chunkRateEstimator.addInterval(t,s,i)){const a=this.chunkRateEstimator.getBitRate();return e({name:'bandwidth',size:i,duration:s-t,speed:a}),!0}},get:()=>{const t=this.chunkRateEstimator.getBitRate();return t?.85*t:0}}))();let a,r=-1/0,n=!0;const o=()=>{let t=s.get();if(t&&a&&this.autoQuality){if(n&&t>a&&ec(r)<3e4)return;i(t)}n=this.autoQuality};return{updateChunk:(t,e)=>{const i=s.updateChunk(t,e);return i&&o(),i},notifySwitch:t=>{const e=tc();t<a&&(r=e),a=t}}}_fetchManifest(t,e,i){this.manifestRequest=sc(this.urlResolver.resolve(t,!0),e,i,(()=>this._retryCallback())).withJSONResponse().withTimeout(1e4).withRetryCount(3).withRetryInterval(300,2e3).send().withFinally((()=>{this.manifestRequest=void 0}))}_playVideoElement(t){const{videoElement:e}=this.params;Zl(e).then((e=>{e||null==t||t()}))}_handleManifestUpdate(t){const{logger:e,playerCallback:i,videoElement:s}=this.params;this.manifest=(t=>{const e=[];return(null==t?void 0:t.length)?(t.forEach(((t,i)=>{t.video&&s.canPlayType(t.codecs).replace(/no/,'')&&window.MediaSource.isTypeSupported(t.codecs)&&(t.index=i,e.push(t))})),e.sort((function(t,e){return t.video&&e.video?e.video.height-t.video.height:e.bitrate-t.bitrate})),e):(this.params.playerCallback({name:'error',type:'partial_metadata'}),[])})(t),e(`Valid manifest entries: ${this.manifest.length}/${t.length}`),i({name:'manifest',manifest:this.manifest})}_refetchManifest(t){this.destroyed||(this.manifestRefetchTimer&&clearTimeout(this.manifestRefetchTimer),this.manifestRefetchTimer=window.setTimeout((()=>{this._fetchManifest(t,(e=>{this.destroyed||(this._handleManifestUpdate(e),this._refetchManifest(t))}),(()=>this._refetchManifest(t)))}),6e4))}_initManifest(){this._fetchManifest(this.manifestUrl,(t=>{this.destroyed||(this._handleManifestUpdate(t),this._refetchManifest(this.manifestUrl))}),(()=>this._handleNetworkError()))}}var oc;!function(t){t.STOPPED='stopped',t.MANIFEST_READY='manifest_ready',t.READY='ready',t.PLAYING='playing',t.PAUSED='paused'}(oc||(oc={}));const uc=[oc.PAUSED,oc.PLAYING,oc.READY],dc=[oc.PAUSED,oc.PLAYING,oc.READY];class lc{constructor(e){this.subscription=new t.Subscription,this.videoState=new ru(oc.STOPPED),this.representations$=new t.ValueSubject([]),this.textTracksManager=new Al,this.maxSeekBackTime$=new t.ValueSubject(1/0),this.zeroTime$=new t.ValueSubject(void 0),this.liveOffset=new Nl,this._dashCb=e=>{var i,s,a,r;switch(e.name){case'buffering':{const t=e.isBuffering;this.params.output.isBuffering$.next(t);break}case'error':this.params.output.error$.next({id:`DashLiveProviderInternal:${e.type}`,message:'LiveDashPlayer reported error'});break;case'manifest':{const t=e.manifest,r=[];for(const e of t){const t=null!==(i=e.name)&&void 0!==i?i:e.index.toString(10),a=null!==(s=Kl(e.name))&&void 0!==s?s:su(e.video),n=e.bitrate/1e3,o=Object.assign({},e.video);if(!a)continue;const u={id:t,quality:a,bitrate:n,size:o};r.push({track:u,representation:e})}this.representations$.next(r),this.params.output.availableVideoTracks$.next(r.map((({track:t})=>t))),(null===(a=this.videoState.getTransition())||void 0===a?void 0:a.to)===oc.MANIFEST_READY&&this.videoState.setState(oc.MANIFEST_READY);break}case'qualitySwitch':{const i=e.quality,s=null===(r=this.representations$.getValue().find((({representation:t})=>t===i)))||void 0===r?void 0:r.track;this.params.output.hostname$.next(new URL(i.headerUrl,this.params.source.url).hostname),t.isNonNullable(s)&&this.params.output.currentVideoTrack$.next(s);break}case'bandwidth':{const{size:t,duration:i}=e;this.params.dependencies.throughputEstimator.addRawSpeed(t,i);break}case'index':this.maxSeekBackTime$.next(e.shiftDuration),this.zeroTime$.next(e.zeroTime)}},this.syncPlayback=()=>{var e;const i=this.videoState.getState(),s=this.videoState.getTransition(),a=this.params.desiredState.playbackState.getState(),r=this.params.desiredState.playbackState.getTransition(),n=this.params.desiredState.seekState.getState();if(this.log({message:`[syncPlayback] videoState: ${i}; videoTransition: ${JSON.stringify(s)}; desiredPlaybackState: ${a}; seekState: ${JSON.stringify(n)};`}),a!==exports.PlaybackState.STOPPED){if(!s){if(dc.includes(i)){const i=null===(e=this.params.desiredState.videoTrack.getTransition())||void 0===e?void 0:e.to;t.isNonNullable(i)&&this.setVideoTrack(i);const s=this.params.desiredState.autoVideoTrackSwitching.getTransition();s&&this.setAutoQuality(s.to)}if((null==r?void 0:r.to)!==exports.PlaybackState.PAUSED&&n.state===l.Requested&&uc.includes(i))this.seek(n.position-this.liveOffset.getTotalPausedTime());else switch(i){case oc.STOPPED:return this.videoState.startTransitionTo(oc.MANIFEST_READY),void this.dash.attachSource(Xo(this.params.source.url));case oc.MANIFEST_READY:this.videoState.startTransitionTo(oc.READY),this.prepare();break;case oc.READY:return void(a===exports.PlaybackState.PAUSED?this.videoState.setState(oc.PAUSED):a===exports.PlaybackState.PLAYING&&(this.videoState.startTransitionTo(oc.PLAYING),this.dash.play((()=>{this.liveOffset.pause(),this.videoState.setState(oc.PAUSED)}))));case oc.PLAYING:return void(a===exports.PlaybackState.PAUSED&&(this.videoState.startTransitionTo(oc.PAUSED),this.liveOffset.pause(),this.dash.pause()));case oc.PAUSED:return void(a===exports.PlaybackState.PLAYING&&(this.videoState.startTransitionTo(oc.PLAYING),this.liveOffset.getTotalPausedTime()<this.params.config.maxPausedTime&&this.liveOffset.getTotalOffset()<this.maxSeekBackTime$.getValue()?(this.liveOffset.resume(),this.dash.play((()=>{this.liveOffset.pause(),this.videoState.setState(oc.PAUSED)})),this.params.output.position$.next(-this.liveOffset.getTotalOffset()/1e3)):this.seek(-this.liveOffset.getTotalOffset())));default:return t.assertNever(i)}}}else i!==oc.STOPPED&&(this.videoState.startTransitionTo(oc.STOPPED),this.dash.destroy(),this.video.setAttribute('src',''),this.video.load(),this.videoState.setState(oc.STOPPED))},this.params=e,this.log=this.params.dependencies.logger.createComponentLog('DashLiveProvider');const i=t=>{e.output.error$.next({id:'DashLiveProvider',message:'DashLiveProvider internal logic error',thrown:t})};t.merge(this.videoState.stateChangeStarted$.pipe(t.map((t=>({transition:t,type:'start'})))),this.videoState.stateChangeEnded$.pipe(t.map((t=>({transition:t,type:'end'}))))).subscribe((({transition:t,type:e})=>{this.log({message:`[videoState change] ${e}: ${JSON.stringify(t)}`})})),this.video=xl(e.container),this.params.output.element$.next(this.video),this.dash=this.createLiveDashPlayer(),this.params.output.duration$.next(1/0),this.params.output.position$.next(0),this.params.output.isLive$.next(!0),this.params.output.hostname$.next(Yl(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.textTracksManager.connect(this.video,this.params.desiredState,this.params.output);const s=Cl(this.video);this.subscription.add(s.canplay$.subscribe((()=>{var t;(null===(t=this.videoState.getTransition())||void 0===t?void 0:t.to)===oc.READY&&this.videoState.setState(oc.READY)}),i)).add(s.pause$.subscribe((()=>{this.videoState.setState(oc.PAUSED)}),i)).add(s.playing$.subscribe((()=>{this.params.desiredState.seekState.getState().state===l.Applying&&this.params.output.seekedEvent$.next(),this.videoState.setState(oc.PLAYING)}),i)).add(s.error$.subscribe(this.params.output.error$)).add(this.maxSeekBackTime$.pipe(t.filterChanged(),t.map((t=>-t/1e3))).subscribe(this.params.output.duration$)).add(t.combine({zeroTime:this.zeroTime$.pipe(t.filter(t.isNonNullable)),position:s.timeUpdate$}).subscribe((({zeroTime:t,position:e})=>this.params.output.liveTime$.next(t+1e3*e)),i)).add(kl(this.video,this.params.desiredState.isLooped,i)).add(wl(this.video,this.params.desiredState.volume,s.volumeState$,i)).add(s.volumeState$.subscribe(this.params.output.volume$,i)).add(Pl(this.video,this.params.desiredState.playbackRate,s.playbackRateState$,i)).add(s.loadStart$.subscribe(this.params.output.firstBytesEvent$)).add(s.playing$.subscribe(this.params.output.firstFrameEvent$)).add(s.canplay$.subscribe(this.params.output.canplay$)).add(this.params.desiredState.autoVideoTrackLimits.stateChangeEnded$.subscribe((({to:{max:t}})=>{const e=t&&Zo[t].height;this.dash.setMaxAutoQuality(e)}))).add(this.videoState.stateChangeEnded$.subscribe((e=>{switch(e.to){case oc.STOPPED:this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.desiredState.playbackState.setState(exports.PlaybackState.STOPPED);break;case oc.MANIFEST_READY:case oc.READY:break;case oc.PAUSED:this.params.desiredState.playbackState.setState(exports.PlaybackState.PAUSED);break;case oc.PLAYING:this.params.desiredState.playbackState.setState(exports.PlaybackState.PLAYING);break;default:return t.assertNever(e.to)}}),i)).add(t.merge(e.desiredState.playbackState.stateChangeStarted$,e.desiredState.seekState.stateChangeEnded$,e.desiredState.videoTrack.stateChangeStarted$,e.desiredState.autoVideoTrackSwitching.stateChangeStarted$,this.videoState.stateChangeEnded$,t.observableFrom(['init'])).pipe(t.debounce(0)).subscribe(this.syncPlayback,i))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.video.remove(),this.params.output.element$.next(void 0),this.dash.destroy()}createLiveDashPlayer(){const t=new nc({videoElement:this.video,config:{maxParallelRequests:this.params.config.maxParallelRequests,minBuffer:this.params.tuning.live.minBuffer,minBufferSegments:this.params.tuning.live.minBufferSegments,lowLatencyMinBuffer:this.params.tuning.live.lowLatencyMinBuffer,lowLatencyMinBufferSegments:this.params.tuning.live.lowLatencyMinBufferSegments},playerCallback:this._dashCb,logger:t=>{this.params.dependencies.logger.log({message:String(t),component:'LiveDashPlayer'})}});return t.pause(),t}prepare(){var e,i,s,a,r,n;const o=this.representations$.getValue(),u=null!==(i=null===(e=this.params.desiredState.videoTrack.getTransition())||void 0===e?void 0:e.to)&&void 0!==i?i:this.params.desiredState.videoTrack.getState(),d=null!==(a=null===(s=this.params.desiredState.autoVideoTrackSwitching.getTransition())||void 0===s?void 0:s.to)&&void 0!==a?a:this.params.desiredState.autoVideoTrackSwitching.getState(),l=!d&&t.isNonNullable(u)?u:null===(r=Gl(o.map((({track:t})=>t)),{container:{width:this.video.offsetWidth,height:this.video.offsetHeight},throughput:this.params.dependencies.throughputEstimator.throughput$.getValue(),tuning:this.params.tuning.autoTrackSelection,limits:this.params.desiredState.autoVideoTrackLimits.getState()}))||void 0===r?void 0:r.id,c=null===(n=o.find((({track:t})=>t.id===l)))||void 0===n?void 0:n.representation;t.assertNonNullable(c,'Representations missing'),this.dash.startPlay(c,d),this.params.desiredState.videoTrack.getTransition()&&this.params.desiredState.videoTrack.setState(l),this.params.desiredState.autoVideoTrackSwitching.getTransition()&&this.params.desiredState.autoVideoTrackSwitching.setState(d)}setVideoTrack(e){var i;const s=null===(i=this.representations$.getValue().find((({track:t})=>t.id===e)))||void 0===i?void 0:i.representation;t.assertNonNullable(s,`No such representation ${e}`),this.dash.switchByName(s.name),this.params.desiredState.videoTrack.setState(e)}setAutoQuality(t){this.dash.setAutoQualityEnabled(t),this.params.desiredState.autoVideoTrackSwitching.setState(t)}seek(t){this.log({message:`[seek] position: ${t}`}),this.params.output.willSeekEvent$.next();const e=-t,i=e<this.maxSeekBackTime$.getValue()?e:0;this.liveOffset.resetTo(i),this.dash.reinit(Xo(this.params.source.url,i))}}var cc=t=>{var e,i;const s=t.get('X-Delivery-Type'),a=t.get('X-Reused');return{type:null===s?exports.HttpConnectionType.HTTP1:null!==(e=s)&&void 0!==e?e:void 0,reused:null===a?void 0:null!==(i={1:!0,0:!1}[a])&&void 0!==i?i:void 0}},hc=(t,e)=>{let i=0;for(let s=0;s<t.length;s++){const a=1e3*t.start(s),r=1e3*t.end(s);a<=e&&e<=r&&(i=r)}return Math.max(i-e,0)};class pc{constructor(t,e=[],i,s,a,r){this._failoverIndex=0,this._failoverCount=0,this._xhr=null,this._retryTimeout=0,this._url=t,this._failoverHosts=e,this._completeCb=i,this._progressCb=s,this._headersCb=a,this._errorCb=r,this._request()}_request(){this._xhr=new XMLHttpRequest,this._xhr.open('GET',this._url,!0),this._xhr.overrideMimeType('text/plain; charset=x-user-defined');let e=!1;this._xhr.onreadystatechange=()=>{var i,s,a,r,n,o,u,d;if(t.assertNonNullable(this._xhr),(null===(i=this._xhr)||void 0===i?void 0:i.status)>=400)return null===(s=this._errorCb)||void 0===s||s.call(this,`Http${null===(a=this._xhr)||void 0===a?void 0:a.status}`,`XHR response code ${null===(r=this._xhr)||void 0===r?void 0:r.status}`),void this.abort();if(4!==this._xhr.readyState||0!==this._xhr.status)try{if(this._xhr.readyState>=2&&!e){e=!0;const t=vl(this._xhr.getAllResponseHeaders().trim().split(/[\n\r]+/).map((t=>t.split(':').map((t=>t.trim())))));null===(n=this._headersCb)||void 0===n||n.call(this,new Headers(t))}else 4===this._xhr.readyState?null===(o=this._completeCb)||void 0===o||o.call(this,this._xhr.response):3===this._xhr.readyState&&(null===(u=this._progressCb)||void 0===u||u.call(this,this._xhr.response))}catch(t){throw null===(d=this._errorCb)||void 0===d||d.call(this,'XHR2CallbackError',`xhr2 callback threw ${String(t)}`,t),t}},this._xhr.onerror=()=>{var t;null===(t=this._xhr)||void 0===t||t.abort(),this._retryTimeout=window.setTimeout((()=>{var t;if(this._xhr)if(++this._failoverCount>=30)this._xhr=null,null===(t=this._errorCb)||void 0===t||t.call(this,'XHR2Failover','XHR failed, retrying failover host');else{let t;this._failoverIndex>=this._failoverHosts.length?(t=this._url,this._failoverIndex=0):(t=this._url.replace((t=>{const e=document.createElement('a');return e.href=t,e.host})(this._url),this._failoverHosts[this._failoverIndex]),this._failoverIndex++),this._xhr.open('GET',t,!0),this._xhr.send(null)}}),500)},this._xhr.send(null)}abort(){window.clearTimeout(this._retryTimeout),this._completeCb=this._progressCb=this._errorCb=void 0,this._xhr&&(this._xhr.abort(),this._xhr=null)}}class mc{constructor(t){this._maxBufferDuration=Number.POSITIVE_INFINITY,this._isFull=!1,this._params=t,this._mediaSource=t.mediaSource,this._sourceBuffer=t.sourceBuffer,this._onDashCallback=t.onDashCallback}_appendBuffer(t,e){try{this._isFull=!1;(this._sourceBuffer.appendBuffer||this._sourceBuffer.append).bind(this._sourceBuffer)(t),null==e||e()}catch(t){if('QuotaExceededError'!==t.name)throw this._params.onError('AppendBuffer','Unknown Buffer error',t),t;{this._isFull=!0;const t=this._sourceBuffer.buffered;let e=0;for(let i=0,s=t.length;i<s;i++)e+=t.end(i)-t.start(i);e&&(this._maxBufferDuration=Math.round(e))}}}getMaxBufferDuration(){return this._maxBufferDuration}isFull(){return this._isFull}load(t,e,i,s,a,r,n){this.abort((()=>{let o=0;const u=Date.now();let d=0,l=0,c=0;const h=t=>{s(mc._str2ua(t.substr(o))),o=t.length};let p=t.baseURL+'&bytes='+e+'-'+i;this._params.requestQuic&&(p=yl(p)),this._lastXhr=new pc(p,t.failoverHosts,(t=>{this._lastXhr=void 0,h(t);const e=Date.now()-u;this._params.onBandwidthChange({size:t.length,duration:e,speed:8*t.length/(e/1e3)}),this._onDashCallback('loading',{size:t.length,done:!0}),null==a||a()}),(t=>{if(t.length-o>n&&h(t),0===l)return void(l=Date.now());c=t.length-d;const e=Date.now()-l;c>=102400&&e>=1e3&&(this._params.onBandwidthChange({size:c,duration:e,speed:8*c/(e/1e3)}),c=0,d=t.length,l=Date.now()),this._onDashCallback('loading',{size:t.length,done:!1})}),r,((t,e,i)=>this._params.onError(t,e,i)))}))}abort(t){var e;null===(e=this._lastXhr)||void 0===e||e.abort(),this._lastXhr=void 0,this._sbUpdatingStop(this._lastStreamUpdatingCallback),this._lastStreamUpdatingCallback=this._sbUpdatingWatch((()=>{this._appendPromiseUint8Array&&(this._appendBuffer(this._appendPromiseUint8Array),this._appendPromiseUint8Array=void 0),this._lastStreamUpdatingCallback=this._sbUpdatingWatch((()=>{'open'===this._mediaSource.readyState&&this._sourceBuffer.abort(),null==t||t()}))}))}_sbUpdatingWatch(t){if(this._sourceBuffer.updating){const e=()=>{try{this._sbUpdatingStop(e),this._sbUpdatingWatch(t)}catch(t){throw this._params.onError('SourceBuffer','Source Buffer update error',t),t}};return this._sourceBuffer.addEventListener('updateend',e,!1),e}t()}_sbUpdatingStop(t){t&&this._sourceBuffer.removeEventListener('updateend',t,!1)}append(t,e){this._appendPromiseUint8Array?this._appendPromiseUint8Array=mc._concatUint8(this._appendPromiseUint8Array,t):(this._appendPromiseUint8Array=t,this._lastStreamUpdatingCallback=this._sbUpdatingWatch((()=>{this._appendPromiseUint8Array&&this._appendBuffer(this._appendPromiseUint8Array,(()=>{this._appendPromiseUint8Array=void 0,e&&this._sbUpdatingWatch(e)}))})))}endOfStream(){'open'===this._mediaSource.readyState&&this._sbUpdatingWatch((()=>this._mediaSource.endOfStream()))}static _concatUint8(t,e){const i=new Uint8Array(t.byteLength+e.byteLength);return i.set(t,0),i.set(e,t.byteLength),i}static _str2ua(t){const e=new Uint8Array(t.length);for(let i=0;i<t.length;i++)e[i]=t.charCodeAt(i);return e}remove(t,e){this._sbUpdatingWatch((()=>{!this._sourceBuffer.updating&&this._sourceBuffer.remove&&this._sourceBuffer.remove(t,e),this._maxBufferDuration=Number.POSITIVE_INFINITY}))}destroy(){var t;null===(t=this._lastXhr)||void 0===t||t.abort(),this._sbUpdatingStop(this._lastStreamUpdatingCallback),'open'===this._mediaSource.readyState&&this._sourceBuffer.abort()}}class fc{constructor(t){var e;this._representations=[],this._appendVector={},this._cachingPaused=!1,this._duration=0,this.STREAM_END_THRESHOLD=1,this._params=t,this._video=t.video,this._buffer=t.buffer,this._onDashCallback=null!==(e=t.onDashCallback)&&void 0!==e?e:()=>{},this._config=t.config}_parseDurationFromISO8601(t){const e=(t,e)=>{const i=t?parseFloat(t.replace(',','.')):NaN;return(isNaN(i)?0:i)*e},i=/^(-)?P(?:(-?[0-9,.]*)Y)?(?:(-?[0-9,.]*)M)?(?:(-?[0-9,.]*)W)?(?:(-?[0-9,.]*)D)?(?:T(?:(-?[0-9,.]*)H)?(?:(-?[0-9,.]*)M)?(?:(-?[0-9,.]*)S)?)?$/.exec(t),s='-'===(null==i?void 0:i[1])?-1:1;e(null==i?void 0:i[2],s),e(null==i?void 0:i[3],s),e(null==i?void 0:i[4],s),e(null==i?void 0:i[5],s);return 3600*e(null==i?void 0:i[6],s)+60*e(null==i?void 0:i[7],s)+e(null==i?void 0:i[8],s)}getRepresentations(){return this._representations}attachSource(t,e){let i=t;this._config.REQUEST_QUIC&&(i=yl(i)),new pc(i,e,(t=>{this.attachManifest(t,e,(t=>{const e=document.createElement('a');return e.href=t,e.origin})(i))}),void 0,(t=>{this._params.onResponseHeaders(t)}),((t,e,i)=>this._params.onError(t,e,i)))}attachManifest(t,e,i){const s=(new DOMParser).parseFromString(t,'text/xml').documentElement,a=(t,e)=>{const i=t.attributes.getNamedItem(e);return i?i.value:null};this._duration=this._parseDurationFromISO8601(String(a(s,'mediaPresentationDuration')));const r=[],n=[];Array.prototype.forEach.call(s.getElementsByTagName('Representation'),(t=>{var s,o,u,d,l,c,h,p,m,f,b,S,v,g,y,T,E,k,w;const P=t.getElementsByTagName('SegmentBase')[0],$=P&&a(P,'indexRange').split('-'),A=P&&P.getElementsByTagName('Initialization')[0],x=A&&a(A,'range').split('-');if(!x||!$){const e=t.parentElement;if('text'===(null==e?void 0:e.getAttribute('contentType'))){const a=null!==(s=t.getAttribute('id'))&&void 0!==s?s:void 0,r=(i?i+'/':'')+(null===(l=null===(d=null===(u=null===(o=t.getElementsByTagName('BaseURL'))||void 0===o?void 0:o[0])||void 0===u?void 0:u.childNodes)||void 0===d?void 0:d[0])||void 0===l?void 0:l.data),h=null!==(c=e.getAttribute('lang'))&&void 0!==c?c:void 0;r&&n.push({id:a,url:r,language:h})}return}const N=Number(null===(h=t.attributes.getNamedItem('bandwidth'))||void 0===h?void 0:h.value),R=(i?i+'/':'')+t.getElementsByTagName('BaseURL')[0].childNodes[0].data;let D;const C=null!==(m=null===(p=t.attributes.getNamedItem('frameRate'))||void 0===p?void 0:p.value)&&void 0!==m?m:void 0;D=C?_l(C):void 0,r.push({width:Number(null===(f=t.attributes.getNamedItem('width'))||void 0===f?void 0:f.value),height:Number(null===(b=t.attributes.getNamedItem('height'))||void 0===b?void 0:b.value),bandwidth:N,baseURL:R,failoverHosts:e,indexFrom:Number($[0]),indexTo:Number($[1]),initFrom:Number(x[0]),initTo:Number(x[1]),codecs:null!==(v=null===(S=t.attributes.getNamedItem('codecs'))||void 0===S?void 0:S.value)&&void 0!==v?v:void 0,mimeType:null!==(y=null===(g=t.attributes.getNamedItem('mimeType'))||void 0===g?void 0:g.value)&&void 0!==y?y:void 0,fps:D,bufferSize:.1*N/8,bufferLength:.1,name:null!==(E=null===(T=t.attributes.getNamedItem('okQuality'))||void 0===T?void 0:T.value)&&void 0!==E?E:void 0,id:null!==(w=null===(k=t.attributes.getNamedItem('id'))||void 0===k?void 0:k.value)&&void 0!==w?w:void 0})})),r.length?(this._representations=r,n.forEach((({id:t,language:e,url:i})=>{const s=document.createElement('track');s.setAttribute('src',i),t&&s.setAttribute('id',t),e&&s.setAttribute('srclang',e),this._video.appendChild(s)})),this._representations.sort(((t,e)=>e.bandwidth-t.bandwidth)),this._params.onManifestReady(this._representations)):this._onDashCallback('error')}_loadInitAndSidx(t,e){if(t===this._currentRepresentation)return void(e&&e());if(t.refs)return void this._stream.abort((()=>{this._stream.append(t.initMessage,e)}));const i=Date.now();this._stream.load(t,t.initFrom,t.indexTo,(i=>{let s=t.initTo-t.initFrom+1;if(!i.byteLength)return void this._params.onError('EmptyResponse','Empty response');t.initMessage=new Uint8Array(i.buffer,0,s);const a=new DataView(i.buffer);s+=12;const r=a.getUint32(s+4,!1);s+=8;let n=a.getUint32(s,!1),o=a.getUint32(s+4,!1)+(t.indexTo+1);s+=8;const u=a.getUint16(s+2,!1);s+=4,t.refs=[];for(let e=0;e<u;e+=1){const e=o+(2147483647&a.getUint32(s,!1)),i=n+a.getUint32(s+4,!1);s+=12,t.refs.push({fromTime:n/r,toTime:i/r,fromOffset:o,toOffset:e-1}),o=e,n=i}const d=t.refs[t.refs.length-1];d.toTime-d.fromTime<.3&&t.refs.pop(),this._stream.append(t.initMessage,e)}),void 0,(t=>{this._params.onResponseHeaders(t),this._params.onIdxRequestPing(Date.now()-i)}),t.indexTo-t.initFrom+1)}startPlay(t){const e=window.MediaSource||window.WebKitMediaSource;if(!e)return void this._params.onError('MediaSourceNotSupported','MediaSource is not supported');const i=new e;let s,a;const r=()=>{const e=this._findRef(this._video.currentTime);if(!e||this._video.paused)return;if(!this._cachingPaused&&void 0!==this._lastLoadOffset&&this._lastLoadOffset-this._video.currentTime<this._config.FRONT_CACHE_DURATION&&this._lastLoadOffset-this._video.currentTime<this._stream.getMaxBufferDuration()){const t=this._stream.isFull()?this._findBufferRangeEnd(this._video.currentTime):this._lastLoadOffset;this._loadRef(this._params.selectRepresentation(this._representations),t)}const i=this._appendVector[String(e.fromTime)];let r;i!==s&&(s=i,this._params.onRepresentationPlay(i));if(this._findRef(e.toTime)){const e=this._buffer.getByTime(this._video.currentTime);if(!e)return void this._onDashCallback('buffering');r=e.to-this._video.currentTime,r<t.bufferLength&&(this._onDashCallback('buffering'),a!==e.to&&(a=e.to,window.setTimeout((()=>{try{const t=this._buffer.getNextWithGap(e);t&&(this._video.currentTime=t.from)}catch(t){throw this._params.onError('GapSyncError',`Seek Error ${String(t)}`,t),t}}),1e3*r)))}},n=()=>{this._loopTimeout=window.setTimeout((()=>{try{r()}catch(t){throw this._params.onError('LoopError',`Dash Loop exception ${String(t)}`,t),t}n()}),250)},o=()=>{if(!this._stream)try{const e=i.addSourceBuffer(`${t.mimeType}; codecs="${t.codecs}"`);this._stream=new mc({mediaSource:i,sourceBuffer:e,requestQuic:this._params.config.REQUEST_QUIC,onBandwidthChange:this._params.onBandwidthChange,onError:this._params.onError,onDashCallback:this._onDashCallback})}catch(t){throw this._params.onError('DashSourceOpen',`Source open exception ${String(t)}`,t),t}this._loadInitAndSidx(t),i.duration||(i.duration=this._duration),this._loopTimeout||n(),i.removeEventListener('sourceopen',o),i.removeEventListener('webkitsourceopen',o)};i.addEventListener('sourceopen',o,!1),i.addEventListener('webkitsourceopen',o,!1),this._video&&(this._video.src=window.URL.createObjectURL(i),this._video.addEventListener('waiting',(()=>{const t=this._video&&this._video.played.length;t&&!this._video.currentTime&&this._video.loop?this._video.duration-this._video.played.end(t-1)<this.STREAM_END_THRESHOLD&&this.seek(0):this._video.duration-this._video.currentTime<this.STREAM_END_THRESHOLD&&this._stream.endOfStream()})))}_loadRef(t,e,i=!1,s=!1){this._lastLoadOffset=void 0,this._loadInitAndSidx(t,(()=>{this._currentRepresentation=t;const a=this._findRef(e);if(a){if(i){this._isLastRef(a)&&e>=a.toTime&&(e=a.fromTime);const t=this._findRef(this._video.currentTime),i=Math.abs(this._video.currentTime-e),r=s||this._video.duration<this._config.SEEK_IN_SEGMENT_THRESHOLD/1e3||a===t||i<=this._config.SEEK_IN_SEGMENT_DELTA/1e3;this._video.currentTime=r?e:a.fromTime}this._appendVector[String(a.fromTime)]=t,this._stream.load(t,a.fromOffset,a.toOffset,((t,e)=>this._stream.append(t,e)),(()=>{this._lastLoadOffset=a.toTime,this._video.duration-this._lastLoadOffset<this.STREAM_END_THRESHOLD&&this._stream.endOfStream()}),(t=>this._params.onResponseHeaders(t)),t.bufferSize)}}))}setQualityByRepresentation(t,e=!1){const i=this._buffer.getByTime(this._video.currentTime),s=this._findRef(this._video.currentTime);if(!i||!s)return void(this._video.currentTime&&e&&this._loadRef(t,this._video.currentTime));const a=.1;if(s.toTime<i.to+a){const e=this._findRef(s.toTime);e&&e.toTime<i.to+a?(this._buffer.smartRemove(s.fromTime-a,e.toTime+a,((t,e)=>this._stream.remove(t,e))),this._loadRef(t,e.toTime)):(this._buffer.smartRemove(s.fromTime-a,s.toTime+a,((t,e)=>this._stream.remove(t,e))),this._loadRef(t,s.toTime))}}setQuality(t){return this.setQualityByRepresentation(this._representations[t])}pauseCaching(){this._cachingPaused=!0}resumeCaching(){this._cachingPaused=!1}seek(t,e){this._stream&&this._buffer.getByTime(t)?this._video.currentTime=t:this._loadRef(this._params.selectRepresentation(this._representations),t,!0,e)}updateRefsForCurrentTime(){const e=this._video.currentTime;this._stream&&!t.isNullable(this._buffer.getByTime(e))||this._loadRef(this._params.selectRepresentation(this._representations),e,!1)}_findRef(t){var e;const i=null===(e=this._currentRepresentation)||void 0===e?void 0:e.refs;if(!i)return;if(Array.isArray(i)&&0===i.length)return void this._params.onError('emptyrefs','Empty refs');let s;for(let e=0;e<i.length;e++){const a=i[e];if(a.fromTime<=t&&a.toTime>t)return a;a.fromTime>t&&(!s||a.fromTime<s.fromTime)&&(s=a)}if(!s){const e=i[i.length-1];if(t>e.toTime)return e}return s}_isLastRef(t){var e;const i=null===(e=this._currentRepresentation)||void 0===e?void 0:e.refs;if(!i)return!1;const s=i[i.length-1];return t.fromTime===s.fromTime}_findBufferRangeEnd(t){let e=this._video.buffered.length;for(;e-- >0;){const i=this._video.buffered.start(e),s=this._video.buffered.end(e);if(t>i&&t<s)return Math.round(10*s)/10}return t}destroy(){this._stream&&this._stream.destroy(),clearTimeout(this._loopTimeout),this._loopTimeout=void 0}}var bc;!function(t){t.STOPPED='stopped',t.MANIFEST_LOADED='manifest-loaded',t.INITIAL_REPRESENTATION_SELECTED='initial-representation-selected',t.METADATA_LOADED='metadata-loaded',t.READY='ready',t.PLAYING='playing',t.PAUSED='paused'}(bc||(bc={}));const Sc=[bc.PAUSED,bc.PLAYING];class vc{constructor(e){this.videoState=new ru(bc.STOPPED),this.subscription=new t.Subscription,this.representations$=new t.ValueSubject([]),this.currentRepresentation$=new t.ValueSubject(void 0),this.textTracksManager=new Al,this.elementSize$=new t.ValueSubject(void 0),this.dashLiteEvents={idxRequestPing$:new t.Subject,responseHeaders$:new t.Subject,manifestReady$:new t.Subject,representationPlay$:new t.Subject,error$:new t.Subject},this.handleManifestReady=t=>{var e,i,s;const a=[];for(const r of t){const t=null!==(i=null!==(e=r.name)&&void 0!==e?e:r.id)&&void 0!==i?i:r.height.toString(10),n=null!==(s=r.name&&Kl(r.name))&&void 0!==s?s:su(r),o=r.bandwidth/1e3,u={width:r.width,height:r.height},d=r.fps;if(!n)continue;const l={id:t,quality:n,bitrate:o,size:u,fps:d};a.push({track:l,representation:r})}this.representations$.next(a),this.params.output.availableVideoTracks$.next(a.map((({track:t})=>t))),this.videoState.setState(bc.MANIFEST_LOADED)},this.handleRepresentationPlay=t=>{var e;const i=null===(e=this.representations$.getValue().find((({representation:e})=>e===t)))||void 0===e?void 0:e.track;if(i){this.params.output.currentVideoTrack$.next(i);this.params.desiredState.videoTrack.getTransition()&&this.params.desiredState.videoTrack.setState(i.id)}},this.selectRepresentation=()=>{const e=this.currentRepresentation$.getValue();return t.assertNonNullable(e,'Can\'t select representation. something went wrong'),e},this.syncPlayback=()=>{const e=this.videoState.getState(),i=this.videoState.getTransition(),s=this.params.desiredState.playbackState.getState(),a=this.params.desiredState.playbackState.getTransition(),r=this.params.desiredState.seekState.getState();if(this.log({message:`[syncPlayback] videoState: ${e}; videoTransition: ${JSON.stringify(i)}; desiredPlaybackState: ${s}; seekState: ${JSON.stringify(r)};`}),s!==exports.PlaybackState.STOPPED){if(!i)switch((null==a?void 0:a.to)!==exports.PlaybackState.PAUSED&&r.state===l.Requested&&Sc.includes(e)&&this.seek(r.position,r.forcePrecise),e){case bc.STOPPED:return this.videoState.startTransitionTo(bc.MANIFEST_LOADED),void this.prepare();case bc.MANIFEST_LOADED:return void this.videoState.startTransitionTo(bc.INITIAL_REPRESENTATION_SELECTED);case bc.INITIAL_REPRESENTATION_SELECTED:return this.videoState.startTransitionTo(bc.METADATA_LOADED),void this.dash.startPlay(this.selectRepresentation());case bc.METADATA_LOADED:return this.videoState.startTransitionTo(bc.READY),void this.dash.updateRefsForCurrentTime();case bc.READY:return void(s===exports.PlaybackState.PAUSED?(this.videoState.setState(bc.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED)):s===exports.PlaybackState.PLAYING&&(this.videoState.startTransitionTo(bc.PLAYING),this.playIfAllowed()));case bc.PLAYING:return void(s===exports.PlaybackState.PAUSED?(this.videoState.startTransitionTo(bc.PAUSED),this.video.pause()):(null==a?void 0:a.to)===exports.PlaybackState.PLAYING&&Ko(this.params.desiredState.playbackState,exports.PlaybackState.PLAYING));case bc.PAUSED:return void(s===exports.PlaybackState.PLAYING?(this.videoState.startTransitionTo(bc.PLAYING),this.playIfAllowed()):(null==a?void 0:a.to)===exports.PlaybackState.PAUSED&&Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED));default:return t.assertNever(e)}}else e!==bc.STOPPED&&(this.videoState.startTransitionTo(bc.STOPPED),this.dash.destroy(),this.video.setAttribute('src',''),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(bc.STOPPED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.STOPPED,!0))},this.params=e,this.log=this.params.dependencies.logger.createComponentLog('DashProvider'),t.merge(this.videoState.stateChangeStarted$.pipe(t.map((t=>({transition:t,type:'start'})))),this.videoState.stateChangeEnded$.pipe(t.map((t=>({transition:t,type:'end'}))))).subscribe((({transition:t,type:e})=>{this.log({message:`[videoState change] ${e}: ${JSON.stringify(t)}`})})),this.video=xl(e.container),this.params.output.element$.next(this.video),this.params.output.isLive$.next(!1),'url'===this.params.source.type&&this.params.output.hostname$.next(Yl(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.buffer=new Rl(this.video),this.dash=new fc({video:this.video,buffer:this.buffer,selectRepresentation:this.selectRepresentation,onIdxRequestPing:t=>this.dashLiteEvents.idxRequestPing$.next(t),onResponseHeaders:t=>this.dashLiteEvents.responseHeaders$.next(t),onManifestReady:t=>this.dashLiteEvents.manifestReady$.next(t),onRepresentationPlay:t=>this.dashLiteEvents.representationPlay$.next(t),onBandwidthChange:t=>this.params.dependencies.throughputEstimator.addRawSpeed(t.size,t.duration),onError:(t,e,i)=>{this.log({message:`[DashLite error], ${t}`}),this.dashLiteEvents.error$.next({id:t,message:e,thrown:i})},config:{SEEK_IN_SEGMENT_THRESHOLD:this.params.tuning.dashSeekInSegmentDurationThreshold,SEEK_IN_SEGMENT_DELTA:this.params.tuning.dashSeekInSegmentAlwaysSeekDelta,FRONT_CACHE_DURATION:this.params.config.cacheDuration/1e3,REQUEST_QUIC:this.params.tuning.requestQuick}}),this.subscribe()}subscribe(){const{output:e,desiredState:i}=this.params,s=t=>{e.error$.next({id:'DashProvider',message:'DashProvider internal logic error',thrown:t})},a=()=>{const t=this.params.desiredState.autoVideoTrackSwitching.getState(),e=this.params.desiredState.autoVideoTrackSwitching.getTransition();return e?e.to:t},r=Cl(this.video),n=(t,e)=>this.subscription.add(t.subscribe(e,s));n(r.timeUpdate$,e.position$),n(r.durationChange$,e.duration$),n(r.ended$,e.endedEvent$),n(r.looped$,e.loopedEvent$),n(r.error$,e.error$),n(r.isBuffering$,e.isBuffering$),n(r.playing$,e.firstFrameEvent$),n(r.canplay$,e.canplay$),this.subscription.add(r.seeking$.subscribe((()=>{t.isNullable(this.params.desiredState.seekState.getState().state!==l.Applying)&&(this.videoState.getState()===bc.PLAYING||this.videoState.getState()===bc.PAUSED)&&this.dash.updateRefsForCurrentTime()}))),this.subscription.add(r.seeked$.subscribe(e.seekedEvent$,s)),this.subscription.add(kl(this.video,i.isLooped,s)),this.subscription.add(wl(this.video,i.volume,r.volumeState$,s)),this.subscription.add(r.volumeState$.subscribe(this.params.output.volume$)),this.subscription.add(Pl(this.video,i.playbackRate,r.playbackRateState$,s)),this.textTracksManager.connect(this.video,i,e),n(Ql(this.video),this.elementSize$),this.subscription.add(r.canplay$.subscribe((()=>{var t;(null===(t=this.videoState.getTransition())||void 0===t?void 0:t.to)===bc.READY&&this.videoState.setState(bc.READY)}),s)).add(r.pause$.subscribe((()=>{this.videoState.setState(bc.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED)}))).add(r.playing$.subscribe((()=>{this.videoState.setState(bc.PLAYING),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PLAYING)}),s)).add(r.loadedMetadata$.subscribe((()=>{this.videoState.setState(bc.METADATA_LOADED)}),s)).add(r.currentBuffer$.subscribe((t=>{this.buffer.fill(),e.currentBuffer$.next(t)}),s)).add(this.dashLiteEvents.error$.pipe(t.map((({id:t,message:e,thrown:i})=>({id:`DashLite_${t}`,message:e,thrown:i})))).subscribe(this.params.output.error$)).add(t.merge(this.params.desiredState.videoTrack.transitionStarted$,this.params.desiredState.autoVideoTrackSwitching.transitionStarted$,this.representations$,this.params.dependencies.throughputEstimator.rttAdjustedThroughput$,this.params.desiredState.autoVideoTrackLimits.stateChangeEnded$,this.params.output.element$,this.elementSize$,t.fromEvent(this.video,'progress')).pipe(t.map((()=>{var e,i,s;const r=this.currentRepresentation$.getValue(),n=this.representations$.getValue(),o=this.params.desiredState.autoVideoTrackSwitching.getTransition(),u=this.params.desiredState.videoTrack.getState(),d=this.params.dependencies.throughputEstimator.rttAdjustedThroughput$.getValue(),l=this.elementSize$.getValue(),c=a();let h;if(o&&this.params.desiredState.autoVideoTrackSwitching.setState(o.to),!c&&t.isNonNullable(u))h=u;else{const t=hc(this.video.buffered,1e3*this.video.currentTime),s=c?this.params.tuning.dash.forwardBufferTargetAuto:this.params.tuning.dash.forwardBufferTargetManual,a=Math.min(t/s,1);h=null===(i=Gl(n.map((({track:t})=>t)),{container:l,throughput:d,tuning:this.params.tuning.autoTrackSelection,limits:this.params.desiredState.autoVideoTrackLimits.getState(),forwardBufferHealth:a,playbackRate:this.video.playbackRate,current:null===(e=n.find((({representation:t})=>t===r)))||void 0===e?void 0:e.track}))||void 0===i?void 0:i.id}return t.isNonNullable(h)?null===(s=n.find((({track:t})=>t.id===h)))||void 0===s?void 0:s.representation:void 0})),t.filterChanged()).subscribe(this.currentRepresentation$,s)).add(t.combine({needToSelectRepresentation:this.videoState.stateChangeStarted$.pipe(t.filter((t=>t.to===bc.INITIAL_REPRESENTATION_SELECTED))),currentRepresentationSelected:this.currentRepresentation$.pipe(t.filter(t.isNonNullable))}).pipe(t.once()).subscribe((()=>this.videoState.setState(bc.INITIAL_REPRESENTATION_SELECTED)),s)).add(this.currentRepresentation$.pipe(t.filter(t.isNonNullable),t.filterChanged(((t,e)=>this.params.tuning.autoTrackSelection.lazyQualitySwitch&&a()?t.height<=e.height:t===e))).subscribe((t=>{const e=hc(this.video.buffered,1e3*this.video.currentTime),i=Math.min(e/this.params.tuning.dash.forwardBufferTarget,1);(!this.params.tuning.autoTrackSelection.lazyQualitySwitch||i<=.5||!a())&&(this.dash.setQualityByRepresentation(t,!0),this.params.output.hostname$.next(Yl(t.baseURL)))}),s)).add(this.dashLiteEvents.responseHeaders$.subscribe((t=>{const{type:e,reused:i}=cc(t);this.params.output.httpConnectionType$.next(e),this.params.output.httpConnectionReused$.next(i)}))).add(this.dashLiteEvents.idxRequestPing$.pipe(t.once(),t.mapTo(void 0)).subscribe(this.params.output.firstBytesEvent$)).add(this.dashLiteEvents.idxRequestPing$.subscribe((t=>this.params.dependencies.throughputEstimator.addRawRtt(t)))).add(this.dashLiteEvents.manifestReady$.subscribe(this.handleManifestReady,s)).add(this.dashLiteEvents.representationPlay$.pipe(t.filter(t.isNonNullable)).subscribe(this.handleRepresentationPlay,s)).add(t.merge(i.playbackState.stateChangeStarted$,i.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,t.observableFrom(['init'])).pipe(t.debounce(0)).subscribe(this.syncPlayback,s))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.video.remove(),this.params.output.element$.next(void 0),this.buffer.destroy(),this.dash.destroy()}prepare(){const e=this.params.source;switch(e.type){case'url':this.dash.attachSource(e.url);break;case'raw':this.dash.attachManifest(e.raw);break;default:return t.assertNever(e)}}seek(t,e=!1){this.log({message:`[seek] position: ${t}`}),this.params.output.willSeekEvent$.next(),this.dash.seek(t/1e3,e)}playIfAllowed(){Zl(this.video).then((t=>{t||(this.videoState.setState(bc.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED,!0))}))}}var gc,yc,Tc,Ec,kc;!function(t){t.VIDEO='video',t.AUDIO='audio',t.TEXT='text'}(gc||(gc={})),function(t){t.WEBM_AS_IN_SPEC='urn:mpeg:dash:profile:webm-on-demand:2012',t.WEBM_AS_IN_FFMPEG='urn:webm:dash:profile:webm-on-demand:2012'}(yc||(yc={})),function(t){t.BYTE_RANGE='byteRange',t.TEMPLATE='template'}(Tc||(Tc={})),function(t){t.NONE='none',t.DOWNLOADING='downloading',t.DOWNLOADED='downloaded',t.PARTIALLY_FED='partially_fed',t.FED='fed'}(Ec||(Ec={})),function(t){t.MP4='mp4',t.WEBM='webm'}(kc||(kc={}));var wc=(t,e)=>{for(let i=0;i<t.length;i++){if(1e3*t.start(i)<=e&&1e3*t.end(i)>e)return!0}return!1};const Pc='function'!=typeof window.requestIdleCallback||'function'!=typeof window.cancelIdleCallback?(t,e={})=>{const i=e.timeout||1,s=performance.now();return window.setTimeout((()=>{t({get didTimeout(){return!e.timeout&&performance.now()-s-1>i},timeRemaining:()=>Math.max(0,performance.now()-s+1)})}),1)}:window.requestIdleCallback;var $c,Ac,xc=()=>{const{userAgent:t}=window.navigator;return!/chrome/i.test(t)&&/webkit|safari|khtml/i.test(t)};let Nc=!1;try{Nc=xc()&&parseInt(null!==(Ac=null===($c=navigator.userAgent.match(/Version\/(\d+)/))||void 0===$c?void 0:$c[1])&&void 0!==Ac?Ac:'',10)<16}catch(t){console.error(t)}class Rc{constructor(e){this.bufferFull$=new t.Subject,this.error$=new t.Subject,this.queue=[],this.currentTask=null,this.destroyed=!1,this.completeTask=()=>{var t;try{if(this.currentTask){const e=null===(t=this.currentTask.signal)||void 0===t?void 0:t.aborted;this.currentTask.callback(!e),this.currentTask=null}this.queue.length&&this.pull()}catch(t){this.error$.next({id:'BufferTaskQueueUnknown',message:'Buffer appending or removal failed',thrown:t})}},this.buffer=e,this.buffer.addEventListener('updateend',this.completeTask)}append(t,e){return uu(this,void 0,void 0,(function*(){return(!e||!e.aborted)&&new Promise((i=>{const s={operation:'append',data:t,signal:e,callback:i};this.queue.push(s),this.pull()}))}))}remove(t,e,i){return uu(this,void 0,void 0,(function*(){return(!i||!i.aborted)&&new Promise((s=>{const a={operation:'remove',from:t,to:e,signal:i,callback:s};this.queue.unshift(a),this.pull()}))}))}abort(t){return uu(this,void 0,void 0,(function*(){return new Promise((e=>{let i;i=Nc&&t?{operation:'safariAbort',init:t,callback:e}:{operation:'abort',callback:e};for(const{callback:t}of this.queue)t(!1);i&&(this.queue=[i]),this.pull()}))}))}destroy(){this.destroyed=!0,this.buffer.removeEventListener('updateend',this.completeTask)}pull(){var t;if(this.buffer.updating||this.currentTask||this.destroyed)return;const e=this.queue.shift();if(!e)return;if(null===(t=e.signal)||void 0===t?void 0:t.aborted)return e.callback(!1),void this.pull();this.currentTask=e;const{operation:i}=this.currentTask;try{this.execute(this.currentTask)}catch(t){t instanceof DOMException&&'QuotaExceededError'===t.name&&'append'===i&&this.bufferFull$.next(this.currentTask.data.byteLength),t instanceof DOMException&&'InvalidStateError'===t.name&&'remove'===i||this.error$.next({id:`BufferTaskQueue:${i}`,message:'Buffer operation failed',thrown:t}),this.currentTask.callback(!1),this.currentTask=null}this.currentTask&&'abort'===this.currentTask.operation&&this.completeTask()}execute(e){const{operation:i}=e;switch(i){case'append':this.buffer.appendBuffer(e.data);break;case'remove':this.buffer.remove(e.from/1e3,e.to/1e3);break;case'abort':this.buffer.abort();break;case'safariAbort':this.buffer.abort(),this.buffer.appendBuffer(e.init);break;default:t.assertNever(i)}}}var Dc;!function(t){t[t.HEADER=0]='HEADER',t[t.PARAM=1]='PARAM'}(Dc||(Dc={}));class Cc{constructor({throughputEstimator:e,requestQuic:i}){this.lastConnectionType$=new t.ValueSubject(void 0),this.lastConnectionReused$=new t.ValueSubject(void 0),this.lastRequestFirstBytes$=new t.ValueSubject(void 0),this.abortAllController=new vu,this.subscription=new t.Subscription,this.fetchManifest=t.abortable(this.abortAllController.signal,function(t){return lu(this,arguments,(function*(){let e=t;this.requestQuic&&(e=yl(e));const i=yield yield du(Su(e,{signal:this.abortAllController.signal}).catch(_c));return i?(this.onHeadersReceived(i.headers),yield du(i.text())):yield du(null)}))}.bind(this)),this.fetch=t.abortable(this.abortAllController.signal,function(e,{rangeMethod:i=Dc.HEADER,range:s,onProgress:a,priority:r='auto',signal:n,measureThroughput:o=!0}={}){var u,d,l,c;return lu(this,arguments,(function*(){let h=e;const p=new Headers;if(s)switch(i){case Dc.HEADER:p.append('Range',`${s.from}-${s.to}`);break;case Dc.PARAM:{const t=new URL(h,location.href);t.searchParams.append('bytes',`${s.from}-${s.to}`),h=t.toString();break}default:t.assertNever(i)}this.requestQuic&&(h=yl(h));let m=this.abortAllController.signal;if(n){const e=new vu;if(this.subscription.add(t.merge(t.fromEvent(this.abortAllController.signal,'abort'),t.fromEvent(n,'abort')).subscribe((()=>{try{e.abort()}catch(t){_c(t)}}))),this.abortAllController.signal.aborted||n.aborted)try{e.abort()}catch(t){_c(t)}m=e.signal}const f=t.now(),b=yield yield du(Su(h,{priority:r,headers:p,signal:m}).catch(_c)),S=t.now();if(null===(u=this.throughputEstimator)||void 0===u||u.addRawRtt(S-f),!b)return yield du(null);if(!b.ok||!b.body)return yield du(Promise.reject(new Error(`Fetch error ${b.status}: ${b.statusText}`)));this.onHeadersReceived(b.headers);const v=parseInt(null!==(d=b.headers.get('Content-Length'))&&void 0!==d?d:'',10)||s&&s.to-s.from+1||NaN;if(!v){const e=yield yield du(b.arrayBuffer());return null===(l=this.throughputEstimator)||void 0===l||l.addRawSpeed(e.byteLength,t.now()-S),null==a||a(new DataView(e),e.byteLength),yield du(e)}if(!a&&!o)return yield du(b.arrayBuffer());const[g,y]=b.body.tee(),T=g.getReader();o&&(null===(c=this.throughputEstimator)||void 0===c||c.trackStream(y));let E=0;const k=new ArrayBuffer(v),w=new Uint8Array(k),P=new DataView(k);let $=!1;const A=t=>{$=!0,_c(t)},x=t.abortable(m,function({done:e,value:i}){return lu(this,arguments,(function*(){if(0===E&&this.lastRequestFirstBytes$.next(t.now()-f),m.aborted)return yield du(void 0);e?null==a||a(P,E):i&&(w.set(i,E),E+=i.byteLength,null==a||a(P,E),yield yield du(null==T?void 0:T.read().then(x,A)))}))}.bind(this));return yield yield du(null==T?void 0:T.read().then(x,A)),yield du($?null:k)}))}.bind(this)),this.fetchByteRangeRepresentation=t.abortable(this.abortAllController.signal,function(t,e,i){return lu(this,arguments,(function*(){if(t.type!==Tc.BYTE_RANGE)return yield du(null);const{from:s,to:a}=t.initRange;let r,n,o=s,u=a,d=!1;t.indexRange&&(r=t.indexRange.from,n=t.indexRange.to,d=a+1===r,d&&(o=Math.min(r,s),u=Math.max(n,a))),o=Math.min(o,0);const l=yield yield du(this.fetch(t.url,{rangeMethod:Dc.PARAM,range:{from:o,to:u},priority:i,measureThroughput:!1}));if(!l)return yield du(null);const c=new DataView(l,s-o,a-o+1);if(!e.validateData(c))throw new Error('Invalid media file');const h=e.parseInit(c);let p;if(d&&void 0!==r&&void 0!==n)p=new DataView(l,r-o,n-r+1);else{const s=e.getIndexRange(h);if(s){const e=yield yield du(this.fetch(t.url,{rangeMethod:Dc.PARAM,range:s,priority:i,measureThroughput:!1}));if(!e)return yield du(null);p=new DataView(e)}}if(!p)throw new ReferenceError('No way to load representation index');const m=e.parseSegments(p,h);return yield du({dataView:new DataView(l),segments:m})}))}.bind(this)),this.fetchTemplateRepresentation=t.abortable(this.abortAllController.signal,function(t,e){return lu(this,arguments,(function*(){if(t.type!==Tc.TEMPLATE)return yield du(null);const i=new URL(t.initUrl,t.baseUrl).toString(),s=yield yield du(this.fetch(i,{priority:e,measureThroughput:!1}));if(!s)return yield du(null);const a=t.segments.map((t=>Object.assign(Object.assign({},t),{status:Ec.NONE,size:void 0})));return yield du({segments:a,dataView:new DataView(s)})}))}.bind(this)),this.throughputEstimator=e,this.requestQuic=i}onHeadersReceived(t){const{type:e,reused:i}=cc(t);this.lastConnectionType$.next(e),this.lastConnectionReused$.next(i)}fetchRepresentation(e,i,s='auto'){var a,r;return uu(this,void 0,void 0,(function*(){const{type:n}=e;switch(n){case Tc.BYTE_RANGE:return null!==(a=yield this.fetchByteRangeRepresentation(e,i,s))&&void 0!==a?a:null;case Tc.TEMPLATE:return null!==(r=yield this.fetchTemplateRepresentation(e,s))&&void 0!==r?r:null;default:t.assertNever(n)}}))}destroy(){this.abortAllController.abort(),this.subscription.unsubscribe()}}const _c=t=>{if(!(t instanceof DOMException)||'AbortError'!==t.name&&20!==t.code)throw t},Ic=new TextDecoder('ascii'),Lc=t=>{let e=0,i=t.getUint32(e);e+=4;const s=new DataView(t.buffer,t.byteOffset+e,4),a=Ic.decode(s);e+=4,0===i?i=1/0:1===i&&(e+=8,i=1/0);const r=Math.min(i,t.byteLength)-e;return{id:a,size:i,contents:new DataView(t.buffer,t.byteOffset+e,r)}},Oc={validateData:t=>'ftyp'===Ic.decode(new DataView(t.buffer,t.byteOffset+4,4)),parseInit:()=>null,getIndexRange:()=>{},parseSegments:t=>{const e=Lc(t),i=[];let s=0;const a=()=>{const t=e.contents.getUint32(s);return s+=4,t};if(0!==(4278190080&a()))throw new SyntaxError('Unsupported sidx version');a();const r=a(),n=a(),o=a(),u=4294967295&a();let d=n/r*1e3,l=t.byteOffset+t.byteLength+o;for(let t=0;t<u;t++){const t=a(),e=t>>>31,s=t<<1>>>1,n=a();if(a(),0!==e)throw new Error('Unsupported multilevel sidx');const o=n/r*1e3;i.push({status:Ec.NONE,time:{from:d,to:d+o},byte:{from:l,to:l+s-1}}),d+=o,l+=s}return i},parseFeedableSegmentChunk:t=>{let e=0,i=!1,s=!1;for(;e<=t.byteLength&&!i;){const a=new DataView(t.buffer,t.byteOffset+e);try{const i=Lc(a);if(s||(s='mdat'===i.id),!(e+i.size<=t.byteLength))break;e+=i.size}catch(t){i=!0}}return e>0&&e<=t.byteLength&&s?new DataView(t.buffer,t.byteOffset,e):null}};var Bc,Mc;!function(t){t[t.EBML=440786851]='EBML',t[t.EBMLVersion=17030]='EBMLVersion',t[t.EBMLReadVersion=17143]='EBMLReadVersion',t[t.EBMLMaxIDLength=17138]='EBMLMaxIDLength',t[t.EBMLMaxSizeLength=17139]='EBMLMaxSizeLength',t[t.DocType=17026]='DocType',t[t.DocTypeVersion=17031]='DocTypeVersion',t[t.DocTypeReadVersion=17029]='DocTypeReadVersion',t[t.Void=236]='Void',t[t.Segment=408125543]='Segment',t[t.SeekHead=290298740]='SeekHead',t[t.Seek=19899]='Seek',t[t.SeekID=21419]='SeekID',t[t.SeekPosition=21420]='SeekPosition',t[t.Info=357149030]='Info',t[t.TimestampScale=2807729]='TimestampScale',t[t.Duration=17545]='Duration',t[t.Tracks=374648427]='Tracks',t[t.Chapters=272869232]='Chapters',t[t.Cluster=524531317]='Cluster',t[t.Timestamp=231]='Timestamp',t[t.SilentTracks=22612]='SilentTracks',t[t.SilentTrackNumber=22743]='SilentTrackNumber',t[t.Position=167]='Position',t[t.PrevSize=171]='PrevSize',t[t.SimpleBlock=163]='SimpleBlock',t[t.BlockGroup=160]='BlockGroup',t[t.EncryptedBlock=175]='EncryptedBlock',t[t.Attachments=423732329]='Attachments',t[t.Tags=307544935]='Tags',t[t.Cues=475249515]='Cues',t[t.CuePoint=187]='CuePoint',t[t.CueTime=179]='CueTime',t[t.CueTrackPositions=183]='CueTrackPositions',t[t.CueTrack=247]='CueTrack',t[t.CueClusterPosition=241]='CueClusterPosition',t[t.CueRelativePosition=240]='CueRelativePosition',t[t.CueDuration=178]='CueDuration',t[t.CueBlockNumber=21368]='CueBlockNumber',t[t.CueCodecState=234]='CueCodecState',t[t.CueReference=219]='CueReference',t[t.CueRefTime=150]='CueRefTime'}(Bc||(Bc={})),function(t){t.SignedInteger='int',t.UnsignedInteger='uint',t.Float='float',t.String='string',t.UTF8='utf8',t.Date='date',t.Master='master',t.Binary='binary'}(Mc||(Mc={}));const Vc={[Bc.EBML]:{type:Mc.Master},[Bc.EBMLVersion]:{type:Mc.UnsignedInteger},[Bc.EBMLReadVersion]:{type:Mc.UnsignedInteger},[Bc.EBMLMaxIDLength]:{type:Mc.UnsignedInteger},[Bc.EBMLMaxSizeLength]:{type:Mc.UnsignedInteger},[Bc.DocType]:{type:Mc.String},[Bc.DocTypeVersion]:{type:Mc.UnsignedInteger},[Bc.DocTypeReadVersion]:{type:Mc.UnsignedInteger},[Bc.Void]:{type:Mc.Binary},[Bc.Segment]:{type:Mc.Master},[Bc.SeekHead]:{type:Mc.Master},[Bc.Seek]:{type:Mc.Master},[Bc.SeekID]:{type:Mc.Binary},[Bc.SeekPosition]:{type:Mc.UnsignedInteger},[Bc.Info]:{type:Mc.Master},[Bc.TimestampScale]:{type:Mc.UnsignedInteger},[Bc.Duration]:{type:Mc.Float},[Bc.Tracks]:{type:Mc.Master},[Bc.Chapters]:{type:Mc.Master},[Bc.Cluster]:{type:Mc.Master},[Bc.Timestamp]:{type:Mc.UnsignedInteger},[Bc.SilentTracks]:{type:Mc.Master},[Bc.SilentTrackNumber]:{type:Mc.UnsignedInteger},[Bc.Position]:{type:Mc.UnsignedInteger},[Bc.PrevSize]:{type:Mc.UnsignedInteger},[Bc.SimpleBlock]:{type:Mc.Binary},[Bc.BlockGroup]:{type:Mc.Master},[Bc.EncryptedBlock]:{type:Mc.Binary},[Bc.Attachments]:{type:Mc.Master},[Bc.Tags]:{type:Mc.Master},[Bc.Cues]:{type:Mc.Master},[Bc.CuePoint]:{type:Mc.Master},[Bc.CueTime]:{type:Mc.UnsignedInteger},[Bc.CueTrackPositions]:{type:Mc.Master},[Bc.CueTrack]:{type:Mc.UnsignedInteger},[Bc.CueClusterPosition]:{type:Mc.UnsignedInteger},[Bc.CueRelativePosition]:{type:Mc.UnsignedInteger},[Bc.CueDuration]:{type:Mc.UnsignedInteger},[Bc.CueBlockNumber]:{type:Mc.UnsignedInteger},[Bc.CueCodecState]:{type:Mc.UnsignedInteger},[Bc.CueReference]:{type:Mc.Master},[Bc.CueRefTime]:{type:Mc.UnsignedInteger}},Uc=t=>{const e=t.getUint8(0);let i=0;128&e?i=1:64&e?i=2:32&e?i=3:16&e&&(i=4);const s=Fc(t,i),a=s in Vc,r=a?Vc[s].type:Mc.Binary,n=t.getUint8(i);let o=0;128&n?o=1:64&n?o=2:32&n?o=3:16&n?o=4:8&n?o=5:4&n?o=6:2&n?o=7:1&n&&(o=8);const u=new DataView(t.buffer,t.byteOffset+i+1,o-1),d=((n&255>>o)<<8*(o-1))+Fc(u),l=i+o;let c;return c=l+d>t.byteLength?new DataView(t.buffer,t.byteOffset+l):new DataView(t.buffer,t.byteOffset+l,d),{tag:a?s:'0x'+s.toString(16).toUpperCase(),type:r,tagHeaderSize:l,tagSize:l+d,value:c,valueSize:d}},Fc=(t,e=t.byteLength)=>{switch(e){case 1:return t.getUint8(0);case 2:return t.getUint16(0);case 3:return t.getUint16(0)<<8|t.getUint8(2);case 4:return t.getUint32(0);case 5:return t.getUint32(0)<<8|t.getUint8(4);case 6:return t.getUint32(0)<<16|t.getUint16(4);case 7:return t.getUint32(0)<<32|t.getUint16(4)<<8|t.getUint8(6);case 8:return t.getUint32(0)<<32|t.getUint32(4)}return 0},jc=(e,i)=>{switch(i){case Mc.SignedInteger:return e.getInt8(0);case Mc.UnsignedInteger:return Fc(e);case Mc.Float:return 4===e.byteLength?e.getFloat32(0):e.getFloat64(0);case Mc.String:return new TextDecoder('ascii').decode(e);case Mc.UTF8:return new TextDecoder('utf-8').decode(e);case Mc.Date:return new Date(Date.UTC(2001,0)+e.getInt8(0)).getTime();case Mc.Master:case Mc.Binary:return e;default:t.assertNever(i)}},qc=(t,e)=>{let i=0;for(;i<t.byteLength;){const s=new DataView(t.buffer,t.byteOffset+i),a=Uc(s);if(!e(a))return;a.type===Mc.Master&&qc(a.value,e),i=a.value.byteOffset-t.byteOffset+a.valueSize}},Hc=[Bc.Info,Bc.SeekHead,Bc.Tracks,Bc.Chapters,Bc.Cluster,Bc.Cues,Bc.Attachments,Bc.Tags],Gc=[Bc.Timestamp,Bc.SilentTracks,Bc.SilentTrackNumber,Bc.Position,Bc.PrevSize,Bc.SimpleBlock,Bc.BlockGroup,Bc.EncryptedBlock],Yc={validateData:t=>{if(t.getUint32(0)!==Bc.EBML)return!1;let e,i,s;const a=Uc(t);return qc(a.value,(({tag:t,type:a,value:r})=>(t===Bc.EBMLReadVersion?e=jc(r,a):t===Bc.DocType?i=jc(r,a):t===Bc.DocTypeReadVersion&&(s=jc(r,a)),!0))),(void 0===e||e<=1)&&void 0!==i&&'webm'===i&&(void 0===s||s<=2)},parseInit:e=>{let i,s,a,r,n,o,u=!1,d=!1,l=!1;return qc(e,(({tag:t,type:e,value:c,valueSize:h})=>{if(t===Bc.SeekID){const t=jc(c,e);o=Fc(t)}else t!==Bc.SeekPosition&&(o=void 0);return t===Bc.Segment?(i=c.byteOffset,s=c.byteOffset+h):t===Bc.Info?u=!0:t===Bc.SeekHead?d=!0:t===Bc.TimestampScale?a=jc(c,e):t===Bc.Duration?r=jc(c,e):t===Bc.SeekPosition&&o===Bc.Cues?n=jc(c,e):u&&d&&Hc.includes(t)&&(l=!0),!l})),t.assertNonNullable(i,'Failed to parse webm Segment start'),t.assertNonNullable(s,'Failed to parse webm Segment end'),t.assertNonNullable(r,'Failed to parse webm Segment duration'),a=null!=a?a:1e6,{segmentStart:Math.round(i/1e9*a*1e3),segmentEnd:Math.round(s/1e9*a*1e3),timeScale:a,segmentDuration:Math.round(r/1e9*a*1e3),cuesSeekPosition:n}},getIndexRange:e=>{if(t.isNullable(e.cuesSeekPosition))return;const i=e.segmentStart+e.cuesSeekPosition;return{from:i,to:i+1048576}},parseSegments:(e,i)=>{let s=!1,a=!1;const r=e=>t.isNonNullable(e.time)&&t.isNonNullable(e.position),n=[];let o;return qc(e,(({tag:t,type:e,value:i})=>{switch(t){case Bc.Cues:s=!0;break;case Bc.CuePoint:o&&r(o)&&n.push(o),o={};break;case Bc.CueTime:o&&(o.time=jc(i,e));break;case Bc.CueTrackPositions:break;case Bc.CueClusterPosition:o&&(o.position=jc(i,e));break;default:s&&Hc.includes(t)&&(a=!0)}return!(s&&a)})),o&&r(o)&&n.push(o),n.map(((t,e)=>{const{time:s,position:a}=t,r=n[e+1];return{status:Ec.NONE,time:{from:s,to:r?r.time:i.segmentDuration},byte:{from:i.segmentStart+a,to:r?i.segmentStart+r.position-1:i.segmentEnd-1}}}))},parseFeedableSegmentChunk:t=>{let e=0,i=!1;try{qc(t,(s=>s.tag===Bc.Cluster?s.tagSize<=t.byteLength?(e=s.tagSize,!1):(e+=s.tagHeaderSize,!0):!!Gc.includes(s.tag)&&(e+s.tagSize<=t.byteLength&&(e+=s.tagSize,i||(i=[Bc.SimpleBlock,Bc.BlockGroup,Bc.EncryptedBlock].includes(s.tag))),!0)))}catch(t){}return e>0&&e<=t.byteLength&&i?new DataView(t.buffer,t.byteOffset,e):null}};class Qc{constructor(e,i,s,a,{fetcher:r,tuning:n,getCurrentPosition:o}){switch(this.onLastSegment$=new t.ValueSubject(!1),this.fullyBuffered$=new t.ValueSubject(!1),this.playingRepresentation$=new t.ValueSubject(void 0),this.error$=new t.Subject,this.gaps=[],this.subscription=new t.Subscription,this.allInitsLoaded=!1,this.activeSegments=new Set,this.downloadAbortController=new vu,this.destroyAbortController=new vu,this.bufferLimit=1/0,this.failedDownloads=0,this.startWith=t.abortable(this.destroyAbortController.signal,function(e){return lu(this,arguments,(function*(){const i=this.representations.get(e);t.assertNonNullable(i,`Cannot find representation ${e}`),this.playingRepresentationId=e,this.downloadingRepresentationId=e,this.sourceBuffer=this.mediaSource.addSourceBuffer(`${i.mime}; codecs="${i.codecs}"`),this.sourceBufferTaskQueue=new Rc(this.sourceBuffer),this.subscription.add(t.fromEvent(this.sourceBuffer,'updateend').subscribe((()=>this.checkEjectedSegments()),(t=>this.error$.next({id:'SegmentEjection',message:'Error when trying to clear segments ejected by browser',thrown:t})))),this.subscription.add(t.fromEvent(this.sourceBuffer,'error').subscribe((()=>this.error$.next({id:'SourceBuffer',message:'SourceBuffer Error event fired'})))),this.subscription.add(this.sourceBufferTaskQueue.bufferFull$.subscribe((t=>this.pruneBuffer(t)))),this.subscription.add(this.sourceBufferTaskQueue.error$.subscribe((t=>this.error$.next(t)))),yield yield du(this.loadInit(i,'high',!0));const s=this.initData.get(i.id),a=this.segments.get(i.id);if(t.assertNonNullable(s,'No init buffer for starting representation'),t.assertNonNullable(a,'No segments for starting representation'),!(s instanceof ArrayBuffer))return yield du(void 0);let r=0;for(const t of a)t.time.from-r>=300&&this.gaps.push({representation:i.id,from:r,to:t.time.from}),r=t.time.to;t.isNonNullable(i.duration)&&i.duration-r>=300&&this.gaps.push({representation:i.id,from:r,to:i.duration}),yield yield du(this.sourceBufferTaskQueue.append(s,this.destroyAbortController.signal)),this.playingRepresentation$.next(this.playingRepresentationId)}))}.bind(this)),this.switchTo=t.abortable(this.destroyAbortController.signal,function(e){return lu(this,arguments,(function*(){if(e===this.downloadingRepresentationId||e===this.switchingToRepresentationId)return yield du(void 0);this.switchingToRepresentationId=e;const i=this.representations.get(e);t.assertNonNullable(i,`No such representation ${e}`);let s=this.initData.get(e);if(t.isNullable(s)?yield yield du(this.loadInit(i,'high',!1)):s instanceof Promise&&(yield yield du(s)),s=this.initData.get(e),!(s&&s instanceof ArrayBuffer&&this.sourceBuffer))return yield du(void 0);this.switchingToRepresentationId=void 0,this.downloadingRepresentationId=e,this.abort(),yield yield du(this.sourceBufferTaskQueue.append(s,this.downloadAbortController.signal));const a=this.getCurrentPosition();t.isNonNullable(a)&&this.maintain(a)}))}.bind(this)),this.fetcher=r,this.tuning=n,this.forwardBufferTarget=n.dash.forwardBufferTargetAuto,this.getCurrentPosition=o,this.container=s,s){case kc.MP4:this.containerParser=Oc;break;case kc.WEBM:this.containerParser=Yc;break;default:t.assertNever(s)}this.initData=new Map(a.map((t=>[t.id,null]))),this.segments=new Map,this.representations=new Map(a.map((t=>[t.id,t]))),this.kind=e,this.mediaSource=i,this.sourceBuffer=null}abort(){for(const t of this.activeSegments)this.abortSegment(t.segment);this.activeSegments.clear(),this.downloadAbortController.abort(),this.downloadAbortController=new vu,this.abortBuffer()}maintain(e){if(t.isNullable(this.downloadingRepresentationId)||t.isNullable(this.playingRepresentationId)||t.isNullable(this.sourceBuffer))return;const i=this.representations.get(this.downloadingRepresentationId),s=this.segments.get(this.downloadingRepresentationId);if(t.assertNonNullable(i,`No such representation ${this.downloadingRepresentationId}`),!s)return;const a=s.find((t=>e>=t.time.from&&e<t.time.to));let r=e;if(this.playingRepresentationId!==this.downloadingRepresentationId){const t=100,i=hc(this.sourceBuffer.buffered,e),s=a?a.time.to+t:-1/0;a&&i>=a.time.to-e+t&&(r=s)}let n=[];if(isFinite(this.bufferLimit)&&(t=>{let e=0;for(let i=0;i<t.length;i++)e+=t.end(i)-t.start(i);return 1e3*e})(this.sourceBuffer.buffered)>=.8*this.bufferLimit)this.pruneBuffer(1/0);else if(!this.activeSegments.size&&(n=this.selectForwardBufferSegments(s,i.segmentReference.type,r),n.length)){let t='auto';if(this.tuning.dash.useFetchPriorityHints&&a)if(n.includes(a))t='high';else{const e=Bl(n,0);e&&e.time.from-a.time.to>=this.forwardBufferTarget/2&&(t='low')}this.loadSegments(n,i,t)}!this.allInitsLoaded&&a&&a.status===Ec.FED&&!n.length&&hc(this.sourceBuffer.buffered,e)>3e3&&this.loadNextInit();const o=Bl(s,-1);o&&o.status===Ec.FED&&(this.fullyBuffered$.next(!0),this.onLastSegment$.next(a===o))}findSegmentStartTime(t){var e,i,s;const a=null!==(i=null!==(e=this.switchingToRepresentationId)&&void 0!==e?e:this.downloadingRepresentationId)&&void 0!==i?i:this.playingRepresentationId;if(!a)return;const r=this.segments.get(a);if(!r)return;const n=r.find((e=>e.time.from<=t&&e.time.to>=t));return null!==(s=null==n?void 0:n.time.from)&&void 0!==s?s:void 0}setTarget(t){this.forwardBufferTarget=t}destroy(){var t;this.initData.clear(),this.segments.clear(),this.representations.clear(),null===(t=this.sourceBufferTaskQueue)||void 0===t||t.destroy(),this.gapDetectionIdleCallback&&window.cancelIdleCallback&&window.cancelIdleCallback(this.gapDetectionIdleCallback),this.initLoadIdleCallback&&window.cancelIdleCallback&&window.cancelIdleCallback(this.initLoadIdleCallback),this.subscription.unsubscribe(),this.sourceBuffer&&'open'===this.mediaSource.readyState&&(this.abortBuffer(),this.mediaSource.removeSourceBuffer(this.sourceBuffer)),this.sourceBuffer=null,this.downloadAbortController.abort(),this.destroyAbortController.abort()}selectForwardBufferSegments(t,e,i){const s=t.findIndex((({status:t,time:{from:e,to:s}})=>t===Ec.NONE&&(e>i||e<=i&&s>=i)&&s<=i+this.forwardBufferTarget));if(-1===s)return[];if(e!==Tc.BYTE_RANGE)return t.slice(s,s+1);const a=t;let r=0;const n=[];for(let t=s;t<a.length&&r<=this.tuning.dash.segmentRequestSize;t++){const e=a[t];if(r+=e.byte.to+1-e.byte.from,e.status!==Ec.NONE)break;n.push(e)}return n}loadSegments(e,i,s='auto'){return uu(this,void 0,void 0,(function*(){if(!e.length)return;let a,r,n=e;const{type:o}=i.segmentReference;switch(o){case Tc.BYTE_RANGE:a=i.segmentReference.url,r={from:Bl(e,0).byte.from,to:Bl(e,-1).byte.to};break;case Tc.TEMPLATE:{const t=Bl(e,0);a=new URL(t.url,i.segmentReference.baseUrl).toString(),n=[t];break}default:t.assertNever(o)}for(const t of n)t.status=Ec.DOWNLOADING,this.activeSegments.add({segment:t,loadedBytes:0,fedBytes:0,representationId:i.id});const{signal:u}=this.downloadAbortController;if(this.failedDownloads&&(yield t.abortable(u,function(){return lu(this,arguments,(function*(){const e=t.getExponentialDelay(this.failedDownloads,this.tuning.downloadBackoff);yield yield du(new Promise((t=>setTimeout(t,e))))}))}.bind(this))(),u.aborted))for(const t of this.activeSegments)e.includes(t.segment)&&this.abortSegment(t.segment);this.fetcher.fetch(a,{rangeMethod:Dc.PARAM,range:r,onProgress:(t,e)=>{if(!u.aborted)try{this.onSomeDataLoaded(t,i.id,r?r.from:0,e,u)}catch(t){this.error$.next({id:'SegmentFeeding',message:'Error when feeding segments',thrown:t})}},signal:u,priority:s}).then((()=>this.failedDownloads=0),(t=>{for(const t of this.activeSegments)e.includes(t.segment)&&this.abortSegment(t.segment);this.onSegmentDownloadError(t)}))}))}onSegmentDownloadError(e){var i;let s=!1;const a=this.getCurrentPosition();if(this.sourceBuffer&&t.isNonNullable(a)){s=hc(null===(i=this.sourceBuffer)||void 0===i?void 0:i.buffered,a)>=this.tuning.downloadBackoff.bufferThreshold}this.failedDownloads++,s||this.error$.next({id:'SegmentDownload',message:'Error when fetching segments',thrown:e})}onSomeDataLoaded(t,e,i,s,a){if(!this.activeSegments.size)return;const r=t=>{this.abortSegment(t.segment)},n=t=>{var i;this.playingRepresentationId=e,this.playingRepresentation$.next(this.playingRepresentationId),t.segment.status=Ec.FED,'size'in t.segment&&(t.segment.size=t.fedBytes);for(const s of this.representations.values())if(s.id!==e)for(const e of null!==(i=this.segments.get(s.id))&&void 0!==i?i:[])e.status===Ec.FED&&e.time.from===t.segment.time.from&&e.time.to===t.segment.time.to&&(e.status=Ec.NONE);this.activeSegments.delete(t),this.detectGapsWhenIdle(e,[t.segment])},o=this.representations.get(e);if(!o)return;const u=o.segmentReference.type,d=t.byteLength;for(const o of this.activeSegments){const{segment:l}=o,c=u===Tc.BYTE_RANGE,h=c?l.byte.to-l.byte.from+1:d;if(o.representationId!==e)continue;if(!(!c||l.byte.from>=i&&l.byte.to<i+t.byteLength))continue;if(a.aborted){r(o);continue}const p=c?l.byte.from-i:0,m=p<s,f=(c?l.byte.to-i:t.byteLength)<=s;if(l.status===Ec.DOWNLOADING&&m&&f){l.status=Ec.DOWNLOADED,this.activeSegments.delete(o);const e=new DataView(t.buffer,t.byteOffset+p,h);this.sourceBufferTaskQueue.append(e,a).then((t=>t&&!a.aborted?n(o):r(o)))}else if(this.tuning.dash.enableSubSegmentBufferFeeding&&m&&(o.loadedBytes=Math.min(h,s-p),o.loadedBytes>o.fedBytes)){const e=new DataView(t.buffer,t.byteOffset+p+o.fedBytes,o.loadedBytes-o.fedBytes),i=o.loadedBytes===h?e:this.containerParser.parseFeedableSegmentChunk(e);(null==i?void 0:i.byteLength)&&(l.status=Ec.PARTIALLY_FED,o.fedBytes+=i.byteLength,this.sourceBufferTaskQueue.append(i,a).then((t=>{!t||a.aborted?r(o):o.fedBytes===h&&n(o)})))}}}abortSegment(t){t.status===Ec.PARTIALLY_FED?(this.sourceBufferTaskQueue.remove(t.time.from,t.time.to).then((()=>t.status=Ec.NONE)),t.status=Ec.NONE):t.status=Ec.NONE;for(const e of this.activeSegments.values())if(e.segment===t){this.activeSegments.delete(e);break}}loadNextInit(){if(this.allInitsLoaded||this.initLoadIdleCallback)return;let t=null,e=!1;for(const[i,s]of this.initData.entries()){const a=s instanceof Promise;e||(e=a),null===s&&(t=i)}if(!t)return void(this.allInitsLoaded=!0);if(e)return;const i=this.representations.get(t);i&&(this.initLoadIdleCallback=Pc((()=>Wo(this.loadInit(i,'low',!1),(()=>this.initLoadIdleCallback=null)))))}loadInit(e,i='auto',s=!1){return uu(this,void 0,void 0,(function*(){const a=this.tuning.dash.useFetchPriorityHints?i:'auto',r=(!s&&this.failedDownloads>0?t.abortable(this.destroyAbortController.signal,function(){return lu(this,arguments,(function*(){const e=t.getExponentialDelay(this.failedDownloads,this.tuning.downloadBackoff);yield yield du(new Promise((t=>setTimeout(t,e))))}))}.bind(this))():Promise.resolve()).then((()=>this.fetcher.fetchRepresentation(e.segmentReference,this.containerParser,a))).then((t=>{if(!t)return;const{dataView:i,segments:s}=t,a=i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength);this.initData.set(e.id,a),this.segments.set(e.id,s)})).then((()=>this.failedDownloads=0),(t=>{this.initData.set(e.id,null),s&&this.error$.next({id:'LoadInits',message:'loadInit threw',thrown:t})}));return this.initData.set(e.id,r),r}))}pruneBuffer(e){return uu(this,void 0,void 0,(function*(){const i=this.getCurrentPosition();if(!this.sourceBuffer||!this.playingRepresentationId||t.isNullable(i))return!1;if(this.sourceBuffer.updating)return!1;const s=this.segments.get(this.playingRepresentationId);if(!s)return!1;let a=0,r=1/0,n=-1/0,o=!1;const u=t=>{var e;r=Math.min(r,t.time.from),n=Math.max(n,t.time.to);const i='size'in t?null!==(e=t.size)&&void 0!==e?e:0:t.byte.to-t.byte.from;a+=i};for(const t of s){if(t.time.to>=i||a>=e)break;t.status===Ec.FED&&u(t)}if(o=isFinite(r)&&isFinite(n),!o){a=0,r=1/0,n=-1/0;for(const t of s){if(t.time.from<i+this.forwardBufferTarget||a>e)break;t.status===Ec.FED&&u(t)}}return o=isFinite(r)&&isFinite(n),!!o&&this.sourceBufferTaskQueue.remove(r/1e3,n/1e3)}))}abortBuffer(){if(!this.sourceBuffer||'open'!==this.mediaSource.readyState)return;const t=this.playingRepresentationId&&this.initData.get(this.playingRepresentationId),e=t instanceof ArrayBuffer?t:void 0;this.sourceBufferTaskQueue.abort(e)}detectGaps(t,e){if(this.sourceBuffer)for(const i of e){let e={representation:t,from:i.time.from,to:i.time.to};for(let t=0;t<this.sourceBuffer.buffered.length;t++){const s=1e3*this.sourceBuffer.buffered.start(t),a=1e3*this.sourceBuffer.buffered.end(t);if(!(a<=i.time.from||s>=i.time.to)){if(s<=i.time.from&&a>=i.time.to){e=void 0;break}a>i.time.from&&a<i.time.to&&(e.from=a),s<i.time.to&&s>i.time.from&&(e.to=s)}}e&&e.to-e.from>=1&&this.gaps.push(e)}}detectGapsWhenIdle(t,e){this.gapDetectionIdleCallback||(this.gapDetectionIdleCallback=Pc((()=>{try{this.detectGaps(t,e)}catch(t){this.error$.next({id:'GapDetection',message:'detectGaps threw',thrown:t})}finally{this.gapDetectionIdleCallback=null}})))}checkEjectedSegments(){if(t.isNullable(this.sourceBuffer)||t.isNullable(this.playingRepresentationId))return;const e=[];for(let t=0;t<this.sourceBuffer.buffered.length;t++){const i=1e3*this.sourceBuffer.buffered.start(t),s=1e3*this.sourceBuffer.buffered.end(t);e.push({from:i,to:s})}const i=this.tuning.dash.segmentTimelineTolerance;for(const t of this.segments.values())for(const s of t){const t=e.some((t=>t.from-i<=s.time.from&&t.to+i>=s.time.to));s.status!==Ec.FED||t||(s.status=Ec.NONE)}}}const zc=t=>{if(!t.startsWith('P'))return;const e=(t,e)=>{const i=t?parseFloat(t.replace(',','.')):NaN;return(isNaN(i)?0:i)*e},i=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/.exec(t),s='-'===(null==i?void 0:i[1])?-1:1;return 24*e(null==i?void 0:i[5],s)*60*60*1e3+60*e(null==i?void 0:i[6],s)*60*1e3+60*e(null==i?void 0:i[7],s)*1e3+1e3*e(null==i?void 0:i[8],s)},Wc=(e,i)=>{let s=e;s=s.replaceAll('$$','$');const a={RepresentationID:i.representationId,Number:i.segmentNumber,Bandwidth:i.bandwidth,Time:i.segmentTime};for(const[e,i]of Object.entries(a)){const a=new RegExp(`\\$${e}(?:%0(\\d+)d)?\\$`,'g');s=s.replaceAll(a,((e,s)=>t.isNullable(i)?e:t.isNullable(s)?i:i.padStart(parseInt(s,10),'0')))}return s},Jc=(e,i)=>{var s,a,r,n,o,u,d,l,c,h,p,m,f,b,S,v,g,y,T,E,k,w,P,$,A,x,N,R,D,C,_,I,L,O,B;const M={video:[],audio:[],text:[]},V=(new DOMParser).parseFromString(e,'application/xml').children[0],U=V.getElementsByTagName('Period')[0],F=U.children;let j;const q=V.getAttribute('mediaPresentationDuration'),H=U.getAttribute('duration');if(q)j=zc(q);else if(H){const e=zc(H);t.isNonNullable(e)&&(j=e)}let G=0;const Y=null!==(a=null===(s=V.getAttribute('profiles'))||void 0===s?void 0:s.split(','))&&void 0!==a?a:[],Q=Y.includes(yc.WEBM_AS_IN_FFMPEG)||Y.includes(yc.WEBM_AS_IN_SPEC)?kc.WEBM:kc.MP4;for(const t of F){const e=t.getAttribute('mimeType'),s=t.getAttribute('codecs'),a=null!==(r=t.getAttribute('contentType'))&&void 0!==r?r:null==e?void 0:e.split('/')[0],V=null!==(o=null===(n=t.getAttribute('profiles'))||void 0===n?void 0:n.split(','))&&void 0!==o?o:[],U=t.querySelectorAll('Representation');if('text'!==a)for(const r of U){const n=null!==(u=r.getAttribute('mimeType'))&&void 0!==u?u:e,o=null!==(l=null!==(d=r.getAttribute('codecs'))&&void 0!==d?d:s)&&void 0!==l?l:'',U=null!==(h=null!==(c=r.getAttribute('contentType'))&&void 0!==c?c:null==n?void 0:n.split('/')[0])&&void 0!==h?h:a,F=null!==(m=null===(p=t.getAttribute('profiles'))||void 0===p?void 0:p.split(','))&&void 0!==m?m:[],q=parseInt(null!==(f=r.getAttribute('width'))&&void 0!==f?f:'',10),H=parseInt(null!==(b=r.getAttribute('height'))&&void 0!==b?b:'',10),Q=parseInt(null!==(S=r.getAttribute('bandwidth'))&&void 0!==S?S:'',10)/1e3,z=null!==(v=r.getAttribute('frameRate'))&&void 0!==v?v:'',W=null!==(g=r.getAttribute('quality'))&&void 0!==g?g:void 0,J=z?_l(z):void 0,X=`${null!==(y=r.getAttribute('id'))&&void 0!==y?y:(G++).toString(10)}@${'video'===U?`${H}p`:'audio'===U?`${Q}Kbps`:o}`,K=null!==(k=null===(E=null===(T=r.querySelector('BaseURL'))||void 0===T?void 0:T.textContent)||void 0===E?void 0:E.trim())&&void 0!==k?k:'',Z=new URL(K,i).toString(),tt=[...Y,...V,...F];let et;const it=r.querySelector('SegmentBase'),st=r.querySelector('SegmentTemplate');if(it){const t=null!==(P=null===(w=r.querySelector('SegmentBase Initialization'))||void 0===w?void 0:w.getAttribute('range'))&&void 0!==P?P:'',[e,i]=t.split('-').map((t=>parseInt(t,10))),s={from:e,to:i},a=null===($=r.querySelector('SegmentBase'))||void 0===$?void 0:$.getAttribute('indexRange'),[n,o]=a?a.split('-').map((t=>parseInt(t,10))):[],u=a?{from:n,to:o}:void 0;et={type:Tc.BYTE_RANGE,url:Z,initRange:s,indexRange:u}}else{if(!st)throw new ReferenceError('Unknown MPD segment referencing type');{const t={representationId:null!==(A=r.getAttribute('id'))&&void 0!==A?A:void 0,bandwidth:null!==(x=r.getAttribute('bandwidth'))&&void 0!==x?x:void 0},e=parseInt(null!==(N=st.getAttribute('timescale'))&&void 0!==N?N:'',10),i=null!==(R=st.getAttribute('initialization'))&&void 0!==R?R:'',s=st.getAttribute('media'),a=null!==(C=parseInt(null!==(D=st.getAttribute('startNumber'))&&void 0!==D?D:'',10))&&void 0!==C?C:1,n=Wc(i,t);if(!s)throw new ReferenceError('No media attribute in SegmentTemplate');const o=null!==(_=st.querySelectorAll('SegmentTimeline S'))&&void 0!==_?_:[],u=[];let d=a,l=0;for(const i of o){const a=1e3*parseInt(null!==(I=i.getAttribute('d'))&&void 0!==I?I:'',10),r=parseInt(null!==(L=i.getAttribute('r'))&&void 0!==L?L:'',10)||0,n=null!==(B=parseInt(null!==(O=i.getAttribute('t'))&&void 0!==O?O:'',10))&&void 0!==B?B:void 0;for(let i=0;i<r+1;i++){const i=Wc(s,Object.assign(Object.assign({},t),{segmentNumber:d.toString(10),segmentTime:n.toString(10)})),r=n?n/e:l;l+=a/e;const o=l;d++,u.push({time:{from:r,to:o},url:i})}}et={type:Tc.TEMPLATE,baseUrl:Z,initUrl:n,segments:u}}}if(!U||!n)continue;const at={video:gc.VIDEO,audio:gc.AUDIO,text:gc.TEXT}[U];at&&M[at].push({id:X,kind:at,segmentReference:et,profiles:tt,duration:j,bitrate:Q,mime:n,codecs:o,width:q,height:H,fps:J,quality:W})}}return{duration:j,container:Q,representations:M}},Xc=['timeupdate','progress','play','seeked','stalled'];var Kc,Zc;!function(t){t.NONE='none',t.MANIFEST_LOADED='manifest_loaded',t.REPRESENTATION_SELECTED='representation_selected'}(Kc||(Kc={}));class th{constructor(e){this.element=null,this.source=null,this.manifest=null,this.subscription=new t.Subscription,this.state$=new ru(Kc.NONE),this.currentVideoRepresentation$=new t.ValueSubject(void 0),this.error$=new t.Subject,this.lastConnectionType$=new t.ValueSubject(void 0),this.lastConnectionReused$=new t.ValueSubject(void 0),this.lastRequestFirstBytes$=new t.ValueSubject(void 0),this.forceEnded$=new t.Subject,this.gapWatchdogStarted=!1,this.destroyController=new vu,this.initManifest=t.abortable(this.destroyController.signal,function(t,e){return lu(this,arguments,(function*(){this.element=t,this.state$.startTransitionTo(Kc.MANIFEST_LOADED);const i=yield yield du(this.fetcher.fetchManifest(e).catch((t=>this.error$.next({id:'LoadManifest',message:'Failed to load manifest',thrown:t}))));if(!i)return yield du(null);let s;try{s=Jc(null!=i?i:'',e)}catch(t){this.error$.next({id:'ManifestParsing',message:'Failed to parse MPD manifest',thrown:t})}if(!s)return yield du(null);const a=({mime:e,codecs:i})=>{var s,a,r;return Boolean((null===(s=t.canPlayType)||void 0===s?void 0:s.call(t,e))&&(null===(r=null===(a=window.MediaSource)||void 0===a?void 0:a.isTypeSupported)||void 0===r?void 0:r.call(a,`${e}; codecs="${i}"`)))};return this.manifest=Object.assign(Object.assign({},s),{representations:vl(Object.entries(s.representations).map((([t,e])=>[t,e.filter(a)])))}),this.manifest.representations.video.length?this.state$.setState(Kc.MANIFEST_LOADED):this.error$.next({id:'NoRepresentations',message:'No playable video representations'}),yield du(this.manifest)}))}.bind(this)),this.initRepresentations=t.abortable(this.destroyController.signal,function(e,i){return lu(this,arguments,(function*(){t.assertNonNullable(this.manifest),t.assertNonNullable(this.element),this.state$.startTransitionTo(Kc.REPRESENTATION_SELECTED),this.source=new MediaSource,this.element.src=URL.createObjectURL(this.source);const s={fetcher:this.fetcher,tuning:this.tuning,getCurrentPosition:()=>this.element?1e3*this.element.currentTime:void 0};this.videoBufferManager=new Qc(gc.VIDEO,this.source,this.manifest.container,this.manifest.representations.video,s),this.bufferManagers=[this.videoBufferManager],t.isNonNullable(i)&&(this.audioBufferManager=new Qc(gc.AUDIO,this.source,this.manifest.container,this.manifest.representations.audio,s),this.bufferManagers.push(this.audioBufferManager)),this.subscription.add(this.fetcher.lastConnectionType$.subscribe(this.lastConnectionType$)),this.subscription.add(this.fetcher.lastConnectionReused$.subscribe(this.lastConnectionReused$)),this.subscription.add(this.fetcher.lastRequestFirstBytes$.subscribe(this.lastRequestFirstBytes$));const a=t.merge(...this.bufferManagers.map((t=>t.fullyBuffered$))).pipe(t.map((()=>this.bufferManagers.every((t=>t.fullyBuffered$.getValue()))))),r=t.merge(...this.bufferManagers.map((t=>t.onLastSegment$))).pipe(t.map((()=>this.bufferManagers.some((t=>t.onLastSegment$.getValue())))));this.subscription.add(t.merge(this.forceEnded$,t.combine({allBuffersFull:a,someBufferEnded:r}).pipe(t.filter((({allBuffersFull:t,someBufferEnded:e})=>t&&e)))).subscribe((()=>{var t;if(this.source&&'open'===this.source.readyState&&Array.from(this.source.sourceBuffers).every((t=>!t.updating)))try{null===(t=this.source)||void 0===t||t.endOfStream()}catch(t){this.error$.next({id:'EndOfStream',message:'Failed to end MediaSource stream',thrown:t})}}))),this.subscription.add(t.merge(...this.bufferManagers.map((t=>t.error$))).subscribe(this.error$)),this.subscription.add(this.videoBufferManager.playingRepresentation$.subscribe(this.currentVideoRepresentation$)),'open'!==this.source.readyState&&(yield yield du(new Promise((t=>{var e;return null===(e=this.source)||void 0===e?void 0:e.addEventListener('sourceopen',t)})))),t.isNonNullable(this.manifest.duration)&&(this.source.duration=this.manifest.duration/1e3),this.audioBufferManager&&t.isNonNullable(i)?yield yield du(Promise.all([this.videoBufferManager.startWith(e),this.audioBufferManager.startWith(i)])):yield yield du(this.videoBufferManager.startWith(e)),this.state$.setState(Kc.REPRESENTATION_SELECTED),t.assertNonNullable(this.element),this.subscription.add(t.merge(...Xc.map((e=>t.fromEvent(this.element,e))),t.fromEvent(window,'online')).subscribe(this.tick,(t=>{this.error$.next({id:'DashVKPlayer',message:'Internal logic error',thrown:t})}))),this.subscription.add(t.fromEvent(this.element,'progress').subscribe((()=>{this.element&&2===this.element.readyState&&!this.element.seeking&&(this.element.currentTime=this.element.currentTime)}))),this.subscription.add(t.fromEvent(this.element,'waiting').subscribe((()=>{this.element&&2===this.element.readyState&&!this.element.seeking&&wc(this.element.buffered,1e3*this.element.currentTime)&&(this.element.currentTime=this.element.currentTime)}))),this.tick()}))}.bind(this)),this.tick=()=>{var e,i;if(!this.element||!this.videoBufferManager)return;const s=1e3*this.element.currentTime;this.videoBufferManager.maintain(s),null===(e=this.audioBufferManager)||void 0===e||e.maintain(s),!this.videoBufferManager.gaps.length&&!(null===(i=this.audioBufferManager)||void 0===i?void 0:i.gaps.length)||this.gapWatchdogStarted||(this.gapWatchdogStarted=!0,this.gapWatchdogSubscription=t.interval(this.tuning.gapWatchdogInterval).subscribe((()=>this.jumGap()),(t=>{this.error$.next({id:'GapWatchdog',message:'Error handling gaps',thrown:t})})),this.subscription.add(this.gapWatchdogSubscription))},this.throughputEstimator=e.throughputEstimator,this.tuning=e.tuning,this.fetcher=new Cc({throughputEstimator:this.throughputEstimator,requestQuic:this.tuning.requestQuick})}switchRepresentation(t,e){return uu(this,void 0,void 0,(function*(){const i={[gc.VIDEO]:this.videoBufferManager,[gc.AUDIO]:this.audioBufferManager,[gc.TEXT]:null}[t];return null==i?void 0:i.switchTo(e)}))}seek(e,i){var s,a,r,n,o;let u;t.assertNonNullable(this.element),t.assertNonNullable(this.videoBufferManager),u=i||1e3*this.element.duration<=this.tuning.dashSeekInSegmentDurationThreshold||Math.abs(1e3*this.element.currentTime-e)<=this.tuning.dashSeekInSegmentAlwaysSeekDelta?e:Math.max(null!==(s=this.videoBufferManager.findSegmentStartTime(e))&&void 0!==s?s:e,null!==(r=null===(a=this.audioBufferManager)||void 0===a?void 0:a.findSegmentStartTime(e))&&void 0!==r?r:e),wc(this.element.buffered,u)||(this.videoBufferManager.abort(),null===(n=this.audioBufferManager)||void 0===n||n.abort()),this.videoBufferManager.maintain(u),null===(o=this.audioBufferManager)||void 0===o||o.maintain(u),this.element.currentTime=u/1e3}stop(){var t,e;this.element=null,this.source=null,this.manifest=null,this.currentVideoRepresentation$.next(void 0),null===(t=this.videoBufferManager)||void 0===t||t.destroy(),this.videoBufferManager=null,null===(e=this.audioBufferManager)||void 0===e||e.destroy(),this.audioBufferManager=null,this.bufferManagers=[],this.state$.setState(Kc.NONE)}setBufferTarget(t){for(const e of this.bufferManagers)e.setTarget(t)}destroy(){this.subscription.unsubscribe(),this.destroyController.abort(),this.fetcher.destroy(),this.stop(),this.source=null}jumGap(){if(!this.element||!this.videoBufferManager)return;const t=1e3*this.element.currentTime,e=1===this.element.readyState?this.tuning.endGapTolerance:0;for(const i of this.bufferManagers)for(const s of i.gaps)if(i.playingRepresentation$.getValue()===s.representation&&s.from-e<=t&&s.to+e>t){if(1e3*this.element.duration-s.to<this.tuning.endGapTolerance)return this.forceEnded$.next(),this.gapWatchdogSubscription.unsubscribe(),void(this.gapWatchdogStarted=!1);this.element.currentTime=s.to/1e3;break}}}!function(t){t.STOPPED='stopped',t.READY='ready',t.PLAYING='playing',t.PAUSED='paused'}(Zc||(Zc={}));const eh=({id:t,width:e,height:i,bitrate:s,fps:a,quality:r})=>{var n;const o=null!==(n=r?Kl(r):void 0)&&void 0!==n?n:su({width:e,height:i});return o&&{id:t,quality:o,bitrate:s,size:{width:e,height:i},fps:a}},ih=(t,e,i)=>{var s;const a=e.indexOf(i);return null!==(s=Bl(t,Math.round(t.length*a/e.length)))&&void 0!==s?s:Bl(t,-1)};class sh{constructor(e){this.subscription=new t.Subscription,this.videoState=new ru(Zc.STOPPED),this.elementSize$=new t.ValueSubject(void 0),this.textTracksManager=new Al,this.videoTracks=[],this.audioRepresentations=new Map,this.videoTrackSwitchHistory=new Hl,this.syncPlayback=()=>{const e=this.videoState.getState(),i=this.params.desiredState.playbackState.getState(),s=this.params.desiredState.playbackState.getTransition(),a=this.params.desiredState.seekState.getState();if(!this.videoState.getTransition())if(a.state===l.Requested&&(null==s?void 0:s.to)!==exports.PlaybackState.PAUSED&&e!==Zc.STOPPED&&i!==exports.PlaybackState.STOPPED&&this.seek(a.position,a.forcePrecise),i!==exports.PlaybackState.STOPPED){if(e===Zc.STOPPED)return this.videoState.startTransitionTo(Zc.READY),void this.prepare();switch(e){case Zc.READY:return void(i===exports.PlaybackState.PAUSED?(this.videoState.setState(Zc.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED)):i===exports.PlaybackState.PLAYING&&(this.videoState.startTransitionTo(Zc.PLAYING),this.playIfAllowed()));case Zc.PLAYING:return void(i===exports.PlaybackState.PAUSED?(this.videoState.startTransitionTo(Zc.PAUSED),this.video.pause()):(null==s?void 0:s.to)===exports.PlaybackState.PLAYING&&Ko(this.params.desiredState.playbackState,exports.PlaybackState.PLAYING));case Zc.PAUSED:return void(i===exports.PlaybackState.PLAYING?(this.videoState.startTransitionTo(Zc.PLAYING),this.playIfAllowed()):(null==s?void 0:s.to)===exports.PlaybackState.PAUSED&&Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED));default:return t.assertNever(e)}}else e!==Zc.STOPPED&&(this.videoState.startTransitionTo(Zc.STOPPED),this.player.stop(),this.video.setAttribute('src',''),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(Zc.STOPPED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.STOPPED,!0))},this.params=e,this.video=xl(this.params.container),this.params.output.element$.next(this.video),this.params.output.availableVideoTracks$.next([]),this.params.output.hostname$.next(Yl(this.params.source.url)),this.params.output.isLive$.next(!1),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.player=new th({throughputEstimator:this.params.dependencies.throughputEstimator,tuning:this.params.tuning}),this.subscribe()}subscribe(){const{output:e,desiredState:i}=this.params,s=Cl(this.video),a=t=>{e.error$.next({id:'DashVKProvider',message:'DashVKProvider internal logic error',thrown:t})},r=(t,e)=>this.subscription.add(t.subscribe(e,a));r(s.timeUpdate$,e.position$),r(s.durationChange$,e.duration$),r(s.ended$,e.endedEvent$),r(s.looped$,e.loopedEvent$),r(s.error$,e.error$),r(s.isBuffering$,e.isBuffering$),r(s.currentBuffer$,e.currentBuffer$),r(s.playing$,e.firstFrameEvent$),r(s.canplay$,e.canplay$),r(this.player.error$,e.error$),r(this.player.lastConnectionType$,e.httpConnectionType$),r(this.player.lastConnectionReused$,e.httpConnectionReused$),r(this.player.lastRequestFirstBytes$.pipe(t.filter(t.isNonNullable),t.once(),t.mapTo(void 0)),e.firstBytesEvent$),this.subscription.add(s.seeked$.subscribe(e.seekedEvent$,a)),this.subscription.add(kl(this.video,i.isLooped,a)),this.subscription.add(wl(this.video,i.volume,s.volumeState$,a)),this.subscription.add(s.volumeState$.subscribe(this.params.output.volume$,a)),this.subscription.add(Pl(this.video,i.playbackRate,s.playbackRateState$,a)),r(Ql(this.video),this.elementSize$),this.subscription.add(s.playing$.subscribe((()=>{this.videoState.setState(Zc.PLAYING),Ko(i.playbackState,exports.PlaybackState.PLAYING)}),a)).add(s.pause$.subscribe((()=>{this.videoState.setState(Zc.PAUSED),Ko(i.playbackState,exports.PlaybackState.PAUSED)}),a)).add(s.canplay$.subscribe((()=>{this.videoState.getState()===Zc.PLAYING&&this.playIfAllowed()}),a)),this.subscription.add(this.player.state$.stateChangeEnded$.pipe(t.filter((({to:t})=>t===Kc.REPRESENTATION_SELECTED))).subscribe((()=>{this.videoState.setState(Zc.READY)})));const n=t=>e.error$.next({id:'RepresentationSwitch',message:'Switching representations threw',thrown:t});this.subscription.add(t.merge(this.player.state$.stateChangeEnded$,i.videoTrack.stateChangeStarted$,i.autoVideoTrackSwitching.transitionStarted$,this.params.dependencies.throughputEstimator.rttAdjustedThroughput$,i.autoVideoTrackLimits.stateChangeEnded$,this.elementSize$,t.fromEvent(this.video,'progress')).subscribe((()=>{var s,a,r,o,u,d,l,c;const h=this.player.state$.getState(),p=this.player.state$.getTransition();if(h===Kc.NONE||!this.videoTracks.length)return;const m=h===Kc.MANIFEST_LOADED&&!p,f=h===Kc.REPRESENTATION_SELECTED&&!p,b=i.autoVideoTrackSwitching.getState(),S=i.videoTrack.getState(),v=null===(s=this.videoTracks.find((({track:{id:t}})=>t===S)))||void 0===s?void 0:s.track,g=e.currentVideoTrack$.getValue(),y=hc(this.video.buffered,1e3*this.video.currentTime),T=b?this.params.tuning.dash.forwardBufferTargetAuto:this.params.tuning.dash.forwardBufferTargetManual,E=Math.min(y/Math.min(T,(1e3*this.video.duration||1/0)-1e3*this.video.currentTime),1),k=Math.max(v&&!b&&null!==(r=null===(a=this.audioRepresentations.get(v.id))||void 0===a?void 0:a.bitrate)&&void 0!==r?r:0,g&&null!==(u=null===(o=this.audioRepresentations.get(g.id))||void 0===o?void 0:o.bitrate)&&void 0!==u?u:0),w=Gl(this.videoTracks.map((({track:t})=>t)),{container:this.elementSize$.getValue(),throughput:this.params.dependencies.throughputEstimator.rttAdjustedThroughput$.getValue(),tuning:this.params.tuning.autoTrackSelection,limits:i.autoVideoTrackLimits.getState(),reserve:k,forwardBufferHealth:E,current:g,history:this.videoTrackSwitchHistory,playbackRate:this.video.playbackRate}),P=b?null!=w?w:v:null!=v?v:w;if(i.autoVideoTrackSwitching.getTransition()&&(i.autoVideoTrackSwitching.setState(b),this.player.setBufferTarget(T)),m){const e=P&&(null===(d=this.videoTracks.find((({track:t})=>t===P)))||void 0===d?void 0:d.representation);t.assertNonNullable(e),this.player.initRepresentations(e.id,null===(l=this.audioRepresentations.get(e.id))||void 0===l?void 0:l.id)}else if(f){const t=P&&(null===(c=this.videoTracks.find((({track:t})=>t===P)))||void 0===c?void 0:c.representation);if(t){const e=this.audioRepresentations.get(t.id);this.player.switchRepresentation(gc.VIDEO,t.id).catch(n),e&&this.player.switchRepresentation(gc.AUDIO,e.id).catch(n)}}}),a)),this.subscription.add(this.player.currentVideoRepresentation$.pipe(t.filterChanged(),t.map((t=>{var e;return t&&(null===(e=this.videoTracks.find((({representation:{id:e}})=>e===t)))||void 0===e?void 0:e.track)}))).subscribe(e.currentVideoTrack$,a)),this.textTracksManager.connect(this.video,i,e);const o=t.merge(i.playbackState.stateChangeStarted$,i.videoTrack.stateChangeStarted$,i.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,t.observableFrom(['init'])).pipe(t.debounce(0));this.subscription.add(o.subscribe(this.syncPlayback,a))}prepare(){return uu(this,void 0,void 0,(function*(){const t=yield this.player.initManifest(this.video,this.params.source.url);if(!t)return;this.videoTracks=[];const e=Array.from(t.representations.audio).sort(((t,e)=>e.bitrate-t.bitrate)),i=Array.from(t.representations.video).sort(((t,e)=>e.bitrate-t.bitrate));for(const t of i){const s=eh(t);if(s){this.videoTracks.push({track:s,representation:t});const a=ih(e,i,t);a&&this.audioRepresentations.set(t.id,a)}}this.params.output.availableVideoTracks$.next(this.videoTracks.map((({track:t})=>t)))}))}seek(t,e){this.params.output.willSeekEvent$.next(),this.player.seek(t,e)}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.video.remove(),this.params.output.element$.next(void 0),this.player.destroy()}playIfAllowed(){Zl(this.video).then((t=>{t||(this.videoState.setState(Zc.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED,!0))}))}}const ah={};var rh;!function(t){t.INITIALIZING='initializing',t.STOPPED='stopped',t.READY='ready',t.PLAYING='playing',t.PAUSED='paused'}(rh||(rh={}));const nh=(e,i)=>new t.Observable((t=>{const s=(e,i)=>t.next(i);return e.on(i,s),()=>e.off(i,s)}));class oh{constructor(e){this.subscription=new t.Subscription,this.videoState=new ru(rh.INITIALIZING),this.textTracksManager=new Al,this.trackLevels=new Map,this.syncPlayback=()=>{const e=this.videoState.getState(),i=this.params.desiredState.playbackState.getState(),s=this.params.desiredState.playbackState.getTransition(),a=this.params.desiredState.seekState.getState();if(e!==rh.INITIALIZING)switch((null==s?void 0:s.to)!==exports.PlaybackState.PAUSED&&a.state===l.Requested&&this.seek(a.position),i){case exports.PlaybackState.STOPPED:switch(e){case rh.STOPPED:break;case rh.READY:case rh.PLAYING:case rh.PAUSED:this.stop();break;default:t.assertNever(e)}break;case exports.PlaybackState.PLAYING:switch(e){case rh.PLAYING:break;case rh.STOPPED:this.prepare();break;case rh.READY:case rh.PAUSED:this.playIfAllowed();break;default:t.assertNever(e)}break;case exports.PlaybackState.PAUSED:switch(e){case rh.PAUSED:break;case rh.STOPPED:this.prepare();break;case rh.READY:this.videoState.setState(rh.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED);break;case rh.PLAYING:this.pause();break;default:t.assertNever(e)}break;default:t.assertNever(i)}},this.video=xl(e.container),this.params=e,this.params.output.element$.next(this.video),this.params.output.isLive$.next(!1),this.params.output.hostname$.next(Yl(this.params.source.url)),this.loadHlsJs()}destroy(){var t,e;this.subscription.unsubscribe(),this.trackLevels.clear(),this.textTracksManager.destroy(),null===(t=this.hls)||void 0===t||t.detachMedia(),null===(e=this.hls)||void 0===e||e.destroy(),this.video.remove(),this.params.output.element$.next(void 0)}loadHlsJs(){let t=!1;const e=e=>{t||this.params.output.error$.next({id:'timeout'===e?'HlsJsTimeout':'HlsJsLoadError',message:'Failed to load Hls.js',thrown:e}),t=!0},s=window.setTimeout((()=>e('timeout')),5e3);Wo(Promise.resolve().then((function(){return i(require('hls.js'))})).then((e=>{t||(ah.Hls=e.default,ah.Events=e.default.Events,this.init())}),e),(()=>{window.clearTimeout(s),t=!0}))}init(){t.assertNonNullable(ah.Hls,'hls.js not loaded'),this.hls=new ah.Hls({fragLoadingMaxRetry:5,levelLoadingMaxRetry:2,manifestLoadingMaxRetry:2,fragLoadingMaxRetryTimeout:16e3,manifestLoadingMaxRetryTimeout:2e3,levelLoadingMaxRetryTimeout:2e3}),this.subscribe(),this.videoState.setState(rh.STOPPED)}subscribe(){t.assertNonNullable(ah.Events,'hls.js not loaded');const{desiredState:e,output:i}=this.params,s=t=>{i.error$.next({id:'HlsJsProvider',message:'HlsJsProvider internal logic error',thrown:t})},a=Cl(this.video),r=(t,e)=>this.subscription.add(t.subscribe(e,s));r(a.timeUpdate$,i.position$),r(a.durationChange$,i.duration$),r(a.ended$,i.endedEvent$),r(a.looped$,i.loopedEvent$),r(a.error$,i.error$),r(a.isBuffering$,i.isBuffering$),r(a.currentBuffer$,i.currentBuffer$),r(a.loadStart$,i.firstBytesEvent$),r(a.playing$,i.firstFrameEvent$),r(a.canplay$,i.canplay$),r(a.seeked$,i.seekedEvent$),this.subscription.add(kl(this.video,e.isLooped,s)),this.subscription.add(wl(this.video,e.volume,a.volumeState$,s)),this.subscription.add(a.volumeState$.subscribe(this.params.output.volume$)),this.subscription.add(Pl(this.video,e.playbackRate,a.playbackRateState$,s)),this.subscription.add(nh(this.hls,ah.Events.ERROR).subscribe((t=>{var e;t.fatal&&i.error$.next({id:['HlsJsFatal',t.type,t.details].join('_'),message:`HlsJs fatal ${t.type} ${t.details}, ${null===(e=t.err)||void 0===e?void 0:e.message} ${t.reason}`,thrown:t.error})}))),this.subscription.add(a.playing$.subscribe((()=>{this.videoState.setState(rh.PLAYING),Ko(e.playbackState,exports.PlaybackState.PLAYING)}),s)).add(a.pause$.subscribe((()=>{this.videoState.setState(rh.PAUSED),Ko(e.playbackState,exports.PlaybackState.PAUSED)}),s)).add(a.canplay$.subscribe((()=>{var t;(null===(t=this.videoState.getTransition())||void 0===t?void 0:t.to)===rh.READY&&this.videoState.setState(rh.READY),this.videoState.getState()===rh.PLAYING&&this.playIfAllowed()}),s)),r(nh(this.hls,ah.Events.MANIFEST_PARSED).pipe(t.map((({levels:t})=>t.reduce(((t,e)=>{var i,s;const a=e.name||e.height.toString(10),{width:r,height:n}=e,o=null!==(s=Kl(null!==(i=e.attrs.QUALITY)&&void 0!==i?i:''))&&void 0!==s?s:su({width:r,height:n});if(!o)return t;const u=e.attrs['FRAME-RATE']?parseFloat(e.attrs['FRAME-RATE']):void 0,d={id:a.toString(),quality:o,bitrate:e.bitrate/1e3,size:{width:r,height:n},fps:u};return this.trackLevels.set(a,{track:d,level:e}),t.push(d),t}),[])))),i.availableVideoTracks$),r(nh(this.hls,ah.Events.LEVEL_LOADING).pipe(t.map((({url:t})=>Yl(t)))),i.hostname$),this.subscription.add(El(e.autoVideoTrackSwitching,(()=>this.hls.autoLevelEnabled),(t=>{this.hls.nextLevel=t?-1:this.hls.currentLevel,this.hls.loadLevel=t?-1:this.hls.loadLevel}),{onError:s}));const n=t=>{var e;return null===(e=Array.from(this.trackLevels.values()).find((({level:e})=>e===t)))||void 0===e?void 0:e.track},o=nh(this.hls,ah.Events.LEVEL_SWITCHED).pipe(t.map((({level:t})=>n(this.hls.levels[t]))));o.pipe(t.filter(t.isNonNullable)).subscribe(i.currentVideoTrack$,s),this.subscription.add(El(e.videoTrack,(()=>{var t;return null===(t=n(this.hls.levels[this.hls.currentLevel]))||void 0===t?void 0:t.id}),(e=>{var i;if(t.isNullable(e))return;const s=null===(i=this.trackLevels.get(e))||void 0===i?void 0:i.level;if(!s)return;const a=this.hls.levels.indexOf(s),r=this.hls.currentLevel,n=this.hls.levels[r];!n||s.bitrate>n.bitrate?this.hls.nextLevel=a:(this.hls.loadLevel=a,this.hls.loadLevel=a)}),{changed$:o.pipe(t.map((t=>null==t?void 0:t.id))),onError:s})),r(a.progress$,(()=>{this.params.dependencies.throughputEstimator.addRawThroughput(this.hls.bandwidthEstimate/1e3)})),this.textTracksManager.connect(this.video,e,i);const u=t.merge(e.playbackState.stateChangeStarted$,e.videoTrack.stateChangeStarted$,e.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,t.observableFrom(['init'])).pipe(t.debounce(0));this.subscription.add(u.subscribe(this.syncPlayback,s))}prepare(){this.videoState.startTransitionTo(rh.READY),this.hls.attachMedia(this.video),this.hls.loadSource(this.params.source.url)}playIfAllowed(){return uu(this,void 0,void 0,(function*(){this.videoState.startTransitionTo(rh.PLAYING);(yield Zl(this.video))||(this.videoState.setState(rh.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED,!0))}))}pause(){this.videoState.startTransitionTo(rh.PAUSED),this.video.pause()}seek(t){this.params.output.willSeekEvent$.next(),this.video.currentTime=t/1e3}stop(){this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.hls.stopLoad(),this.hls.detachMedia(),this.video.setAttribute('src',''),this.video.load(),this.videoState.setState(rh.STOPPED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.STOPPED,!0)}}const uh=t=>{let e=null;if(t.QUALITY&&(e=Kl(t.QUALITY)),!e&&t.RESOLUTION){const[i,s]=t.RESOLUTION.split('x').map((t=>parseInt(t,10)));e=su({width:i,height:s})}return null!=e?e:null},dh=(t,e=t)=>uu(void 0,void 0,void 0,(function*(){var i;const s=yield Su(t),a=(yield s.text()).split('\n'),r=[];for(let t=0;t<a.length;t++){const s=a[t].match(/^#EXT-X-STREAM-INF:(.+)/);if(!s)continue;const n=vl(s[1].split(',').map((t=>t.split('=')))),o=null!==(i=n.QUALITY)&&void 0!==i?i:`stream-${n.BANDWIDTH}`,u=uh(n);let d;n.BANDWIDTH&&(d=parseInt(n.BANDWIDTH,10)/1e3||void 0),!d&&n['AVERAGE-BANDWIDTH']&&(d=parseInt(n['AVERAGE-BANDWIDTH'],10)/1e3||void 0);const l=n['FRAME-RATE']?parseFloat(n['FRAME-RATE']):void 0;let c;if(n.RESOLUTION){const[t,e]=n.RESOLUTION.split('x').map((t=>parseInt(t,10)));t&&e&&(c={width:t,height:e})}const h=new URL(a[++t],e).toString();u&&r.push({id:o,quality:u,url:h,bandwidth:d,size:c,fps:l})}return r}));var lh,ch,hh;!function(t){t.STOPPED='stopped',t.READY='ready',t.PLAYING='playing',t.CHANGING_MANIFEST='changing_manifest',t.PAUSED='paused'}(lh||(lh={}));class ph{constructor(e){var i;this.subscription=new t.Subscription,this.videoState=new ru(lh.STOPPED),this.textTracksManager=new Al,this.manifests$=new t.ValueSubject([]),this.liveOffset=new Nl,this.manifestStartTime$=new t.ValueSubject(void 0),this.syncPlayback=()=>{const e=this.videoState.getState(),i=this.params.desiredState.playbackState.getState(),s=this.params.desiredState.playbackState.getTransition(),a=this.params.desiredState.videoTrack.getTransition(),r=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(i===exports.PlaybackState.STOPPED)return void(e!==lh.STOPPED&&(this.videoState.startTransitionTo(lh.STOPPED),this.video.setAttribute('src',''),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(lh.STOPPED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.STOPPED,!0)));if(this.videoState.getTransition())return;const n=this.params.desiredState.seekState.getState();if(e===lh.STOPPED)return this.videoState.startTransitionTo(lh.READY),void this.prepare();if(a||r){const t=this.videoState.getState();return this.videoState.setState(lh.CHANGING_MANIFEST),this.videoState.startTransitionTo(t),this.prepare(),void(n.state===l.None&&this.params.desiredState.seekState.setState({state:l.Requested,position:-this.liveOffset.getTotalOffset(),forcePrecise:!0}))}if((null==s?void 0:s.to)!==exports.PlaybackState.PAUSED&&n.state===l.Requested)return this.videoState.startTransitionTo(lh.READY),this.seek(n.position-this.liveOffset.getTotalPausedTime()),void this.prepare();switch(e){case lh.READY:return void(i===exports.PlaybackState.PAUSED?(this.videoState.setState(lh.PAUSED),this.liveOffset.pause(),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED)):i===exports.PlaybackState.PLAYING&&(this.videoState.startTransitionTo(lh.PLAYING),this.playIfAllowed()));case lh.PLAYING:return void(i===exports.PlaybackState.PAUSED?(this.videoState.startTransitionTo(lh.PAUSED),this.liveOffset.pause(),this.video.pause()):(null==s?void 0:s.to)===exports.PlaybackState.PLAYING&&Ko(this.params.desiredState.playbackState,exports.PlaybackState.PLAYING));case lh.PAUSED:return void(i===exports.PlaybackState.PLAYING?(this.videoState.startTransitionTo(lh.PLAYING),this.liveOffset.getTotalPausedTime()<this.params.config.maxPausedTime&&this.liveOffset.getTotalOffset()<this.maxSeekBackTime$.getValue()?(this.liveOffset.resume(),this.playIfAllowed(),this.params.output.position$.next(-this.liveOffset.getTotalOffset()/1e3)):this.seek(-this.liveOffset.getTotalOffset())):(null==s?void 0:s.to)===exports.PlaybackState.PAUSED&&(Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED),this.liveOffset.pause()));case lh.CHANGING_MANIFEST:break;default:return t.assertNever(e)}},this.params=e,this.video=xl(e.container),this.params.output.element$.next(this.video);const s={id:'master',quality:exports.VideoQuality.INVARIANT,url:this.params.source.url};this.manifests$.next([s]),dh(Xo(this.params.source.url),this.params.source.url).then((t=>{this.manifests$.next([s,...t])}),(t=>this.params.output.error$.next({id:'ExtractHlsQualities',message:'Error fetching manifest and extracting qualities',thrown:t}))),this.params.output.isLive$.next(!0),this.params.output.hostname$.next(Yl(this.params.source.url)),this.maxSeekBackTime$=new t.ValueSubject(null!==(i=e.source.maxSeekBackTime)&&void 0!==i?i:1/0),this.subscribe()}selectManifest(){var t,e;const{autoVideoTrackSwitching:i,videoTrack:s}=this.params.desiredState,a=i.getState(),r=s.getTransition(),n=null!==(e=null!==(t=null==r?void 0:r.to)&&void 0!==t?t:s.getState())&&void 0!==e?e:'master',o=this.manifests$.getValue();if(!o)return;const u=a?'master':n;return a&&!r&&s.startTransitionTo('master'),o.find((t=>t.id===u))}subscribe(){const{output:e,desiredState:i}=this.params,s=t=>{e.error$.next({id:'HlsLiveProvider',message:'HlsLiveProvider internal logic error',thrown:t})},a=Cl(this.video),r=(t,e)=>this.subscription.add(t.subscribe(e,s));r(a.ended$,e.endedEvent$),r(a.error$,e.error$),r(a.isBuffering$,e.isBuffering$),r(a.currentBuffer$,e.currentBuffer$),r(a.loadedMetadata$,e.firstBytesEvent$),r(a.playing$,e.firstFrameEvent$),r(a.canplay$,e.canplay$),this.subscription.add(i.isLooped.stateChangeStarted$.subscribe((()=>i.isLooped.setState(!1)),s)),this.subscription.add(wl(this.video,i.volume,a.volumeState$,s)),this.subscription.add(a.volumeState$.subscribe(this.params.output.volume$,s)),this.subscription.add(Pl(this.video,i.playbackRate,a.playbackRateState$,s)),this.textTracksManager.connect(this.video,i,e),this.subscription.add(a.playing$.subscribe((()=>{this.videoState.setState(lh.PLAYING),Ko(i.playbackState,exports.PlaybackState.PLAYING)}),s)).add(a.pause$.subscribe((()=>{this.videoState.setState(lh.PAUSED),Ko(i.playbackState,exports.PlaybackState.PAUSED)}),s)).add(a.canplay$.subscribe((()=>{var t;(null===(t=this.videoState.getTransition())||void 0===t?void 0:t.to)===lh.READY&&this.videoState.setState(lh.READY),this.videoState.getState()===lh.PLAYING&&this.playIfAllowed()}),s)),this.subscription.add(this.maxSeekBackTime$.pipe(t.filterChanged(),t.map((t=>-t/1e3))).subscribe(this.params.output.duration$,s)),this.subscription.add(a.loadedMetadata$.subscribe((()=>{const e=this.params.desiredState.seekState.getState(),i=this.videoState.getTransition(),s=this.params.desiredState.videoTrack.getTransition(),a=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(s&&t.isNonNullable(s.to)){const t=s.to;this.params.desiredState.videoTrack.setState(t);const e=this.manifests$.getValue().find((e=>e.id===t));e&&(this.params.output.currentVideoTrack$.next(e),this.params.output.hostname$.next(Yl(e.url)))}a&&this.params.desiredState.autoVideoTrackSwitching.setState(a.to),i&&i.from===lh.CHANGING_MANIFEST&&this.videoState.setState(i.to),e&&e.state===l.Requested&&this.seek(e.position)}),s)),this.subscription.add(a.loadedData$.subscribe((()=>{var t,e;const i=null===(e=null===(t=this.video)||void 0===t?void 0:t.getStartDate())||void 0===e?void 0:e.getTime();this.manifestStartTime$.next(i||void 0)}),s)),this.subscription.add(t.combine({startTime:this.manifestStartTime$.pipe(t.filter(t.isNonNullable)),currentTime:a.timeUpdate$}).subscribe((({startTime:t,currentTime:e})=>this.params.output.liveTime$.next(t+1e3*e)),s)),this.subscription.add(this.manifests$.pipe(t.map((t=>t.map((({id:t,quality:e,size:i,bandwidth:s,fps:a})=>({id:t,quality:e,size:i,fps:a,bitrate:s})))))).subscribe(this.params.output.availableVideoTracks$,s));const n=t.merge(i.playbackState.stateChangeStarted$,i.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,i.videoTrack.stateChangeStarted$,i.autoVideoTrackSwitching.stateChangeStarted$,t.observableFrom(['init'])).pipe(t.debounce(0));this.subscription.add(n.subscribe(this.syncPlayback,s))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.video.remove(),this.params.output.element$.next(void 0)}prepare(){const e=this.selectManifest();if(t.isNullable(e))return;const i=Xo(e.url,this.liveOffset.getTotalOffset());var s;this.video.setAttribute('src',i),this.video.load(),(s=i,uu(void 0,void 0,void 0,(function*(){const t=yield Su(s,{method:'HEAD'});return t.headers.has('X-Playback-Duration')?parseInt(t.headers.get('X-Playback-Duration'),10):void 0}))).then((e=>{t.isNullable(e)||this.maxSeekBackTime$.next(e)}))}playIfAllowed(){Zl(this.video).then((t=>{t||(this.videoState.setState(lh.PAUSED),this.liveOffset.pause(),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED,!0))}))}seek(t){this.params.output.willSeekEvent$.next();const e=-t,i=e<this.maxSeekBackTime$.getValue()?e:0;this.liveOffset.resetTo(i),this.params.output.position$.next(-i/1e3),this.params.output.seekedEvent$.next()}}!function(t){t.STOPPED='stopped',t.READY='ready',t.PLAYING='playing',t.CHANGING_MANIFEST='changing_manifest',t.PAUSED='paused'}(ch||(ch={}));class mh{constructor(e){this.subscription=new t.Subscription,this.videoState=new ru(ch.STOPPED),this.textTracksManager=new Al,this.manifests$=new t.ValueSubject([]),this.syncPlayback=()=>{const e=this.videoState.getState(),i=this.params.desiredState.playbackState.getState(),s=this.params.desiredState.playbackState.getTransition(),a=this.params.desiredState.videoTrack.getTransition(),r=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(i===exports.PlaybackState.STOPPED)return void(e!==ch.STOPPED&&(this.videoState.startTransitionTo(ch.STOPPED),this.video.setAttribute('src',''),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(ch.STOPPED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.STOPPED,!0)));if(this.videoState.getTransition())return;const n=this.params.desiredState.seekState.getState();if(e===ch.STOPPED)return this.videoState.startTransitionTo(ch.READY),void this.prepare();if(a||r){const t=this.videoState.getState();this.videoState.setState(ch.CHANGING_MANIFEST),this.videoState.startTransitionTo(t);const{currentTime:e}=this.video;return this.prepare(),void(n.state===l.None&&this.params.desiredState.seekState.setState({state:l.Requested,position:1e3*e,forcePrecise:!0}))}switch((null==s?void 0:s.to)!==exports.PlaybackState.PAUSED&&n.state===l.Requested&&this.seek(n.position),e){case ch.READY:return void(i===exports.PlaybackState.PAUSED?(this.videoState.setState(ch.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED)):i===exports.PlaybackState.PLAYING&&(this.videoState.startTransitionTo(ch.PLAYING),this.playIfAllowed()));case ch.PLAYING:return void(i===exports.PlaybackState.PAUSED?(this.videoState.startTransitionTo(ch.PAUSED),this.video.pause()):(null==s?void 0:s.to)===exports.PlaybackState.PLAYING&&Ko(this.params.desiredState.playbackState,exports.PlaybackState.PLAYING));case ch.PAUSED:return void(i===exports.PlaybackState.PLAYING?(this.videoState.startTransitionTo(ch.PLAYING),this.playIfAllowed()):(null==s?void 0:s.to)===exports.PlaybackState.PAUSED&&Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED));case ch.CHANGING_MANIFEST:break;default:return t.assertNever(e)}},this.params=e,this.video=xl(e.container),this.params.output.element$.next(this.video);const i={id:'master',quality:exports.VideoQuality.INVARIANT,url:this.params.source.url};this.manifests$.next([i]),this.params.output.isLive$.next(!1),this.params.output.hostname$.next(Yl(this.params.source.url)),dh(this.params.source.url).then((t=>{this.manifests$.next([i,...t])}),(t=>this.params.output.error$.next({id:'ExtractHlsQualities',message:'Error fetching manifest and extracting qualities',thrown:t}))),this.subscribe()}selectManifest(){var t,e;const{autoVideoTrackSwitching:i,videoTrack:s}=this.params.desiredState,a=i.getState(),r=s.getTransition(),n=null!==(e=null!==(t=null==r?void 0:r.to)&&void 0!==t?t:s.getState())&&void 0!==e?e:'master',o=this.manifests$.getValue();if(!o)return;const u=a?'master':n;return a&&!r&&s.startTransitionTo('master'),o.find((t=>t.id===u))}subscribe(){const{output:e,desiredState:i}=this.params,s=t=>{e.error$.next({id:'HlsProvider',message:'HlsProvider internal logic error',thrown:t})},a=Cl(this.video),r=(t,e)=>this.subscription.add(t.subscribe(e));r(a.timeUpdate$,e.position$),r(a.durationChange$,e.duration$),r(a.ended$,e.endedEvent$),r(a.looped$,e.loopedEvent$),r(a.error$,e.error$),r(a.isBuffering$,e.isBuffering$),r(a.currentBuffer$,e.currentBuffer$),r(a.loadedMetadata$,e.firstBytesEvent$),r(a.playing$,e.firstFrameEvent$),r(a.canplay$,e.canplay$),r(a.seeked$,e.seekedEvent$),this.subscription.add(kl(this.video,i.isLooped,s)),this.subscription.add(wl(this.video,i.volume,a.volumeState$,s)),this.subscription.add(a.volumeState$.subscribe(this.params.output.volume$,s)),this.subscription.add(Pl(this.video,i.playbackRate,a.playbackRateState$,s)),this.textTracksManager.connect(this.video,i,e),this.subscription.add(a.playing$.subscribe((()=>{this.videoState.setState(ch.PLAYING),Ko(i.playbackState,exports.PlaybackState.PLAYING)}),s)).add(a.pause$.subscribe((()=>{this.videoState.setState(ch.PAUSED),Ko(i.playbackState,exports.PlaybackState.PAUSED)}),s)).add(a.canplay$.subscribe((()=>{var t;(null===(t=this.videoState.getTransition())||void 0===t?void 0:t.to)===ch.READY&&this.videoState.setState(ch.READY),this.videoState.getState()===ch.PLAYING&&this.playIfAllowed()}),s).add(a.loadedMetadata$.subscribe((()=>{const e=this.params.desiredState.seekState.getState(),i=this.videoState.getTransition(),s=this.params.desiredState.videoTrack.getTransition(),a=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(s&&t.isNonNullable(s.to)){const t=s.to;this.params.desiredState.videoTrack.setState(t);const e=this.manifests$.getValue().find((e=>e.id===t));e&&(this.params.output.currentVideoTrack$.next(e),this.params.output.hostname$.next(Yl(e.url)))}a&&this.params.desiredState.autoVideoTrackSwitching.setState(a.to),i&&i.from===ch.CHANGING_MANIFEST&&this.videoState.setState(i.to),e.state===l.Requested&&this.seek(e.position)}),s))),this.subscription.add(this.manifests$.pipe(t.map((t=>t.map((({id:t,quality:e,size:i,bandwidth:s,fps:a})=>({id:t,quality:e,size:i,fps:a,bitrate:s})))))).subscribe(this.params.output.availableVideoTracks$,s));const n=t.merge(i.playbackState.stateChangeStarted$,i.seekState.stateChangeEnded$,i.videoTrack.stateChangeStarted$,i.autoVideoTrackSwitching.stateChangeStarted$,this.videoState.stateChangeEnded$,t.observableFrom(['init'])).pipe(t.debounce(0));this.subscription.add(n.subscribe(this.syncPlayback,s))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.video.remove(),this.params.output.element$.next(void 0)}prepare(){const e=this.selectManifest();t.isNullable(e)||(this.video.setAttribute('src',e.url),this.video.load())}playIfAllowed(){Zl(this.video).then((t=>{t||(this.videoState.setState(ch.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED,!0))}))}seek(t){this.params.output.willSeekEvent$.next(),this.video.currentTime=t/1e3}}!function(t){t.STOPPED='stopped',t.READY='ready',t.PLAYING='playing',t.PAUSED='paused'}(hh||(hh={}));class fh{constructor(e){this.subscription=new t.Subscription,this.videoState=new ru(hh.STOPPED),this.trackUrls={},this.textTracksManager=new Al,this.syncPlayback=()=>{const e=this.videoState.getState(),i=this.params.desiredState.playbackState.getState(),s=this.params.desiredState.playbackState.getTransition();if(i===exports.PlaybackState.STOPPED)return void(e!==hh.STOPPED&&(this.videoState.startTransitionTo(hh.STOPPED),this.video.setAttribute('src',''),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(hh.STOPPED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.STOPPED,!0)));if(this.videoState.getTransition())return;const a=this.params.desiredState.videoTrack.getTransition(),r=this.params.desiredState.seekState.getState();if(e===hh.STOPPED)return this.videoState.startTransitionTo(hh.READY),void this.prepare();if(a){const{currentTime:t}=this.video;return this.prepare(),void(r.state===l.None&&this.params.desiredState.seekState.setState({state:l.Requested,position:1e3*t,forcePrecise:!0}))}switch((null==s?void 0:s.to)!==exports.PlaybackState.PAUSED&&r.state===l.Requested&&this.seek(r.position),e){case hh.READY:return void(i===exports.PlaybackState.PAUSED?(this.videoState.setState(hh.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED)):i===exports.PlaybackState.PLAYING&&(this.videoState.startTransitionTo(hh.PLAYING),this.playIfAllowed()));case hh.PLAYING:return void(i===exports.PlaybackState.PAUSED?(this.videoState.startTransitionTo(hh.PAUSED),this.video.pause()):(null==s?void 0:s.to)===exports.PlaybackState.PLAYING&&Ko(this.params.desiredState.playbackState,exports.PlaybackState.PLAYING));case hh.PAUSED:return void(i===exports.PlaybackState.PLAYING?(this.videoState.startTransitionTo(hh.PLAYING),this.playIfAllowed()):(null==s?void 0:s.to)===exports.PlaybackState.PAUSED&&Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED));default:return t.assertNever(e)}},this.params=e,this.video=xl(e.container),this.params.output.element$.next(this.video),Object.entries(this.params.source).forEach((([t,e],i)=>{const s=i.toString(10);this.trackUrls[s]={track:{quality:t,id:s},url:e}})),this.params.output.availableVideoTracks$.next(Object.values(this.trackUrls).map((({track:t})=>t))),this.params.output.isLive$.next(!1),this.subscribe()}subscribe(){const{output:e,desiredState:i}=this.params,s=t=>{e.error$.next({id:'MpegProvider',message:'MpegProvider internal logic error',thrown:t})},a=Cl(this.video),r=(t,e)=>this.subscription.add(t.subscribe(e,s));r(a.timeUpdate$,e.position$),r(a.durationChange$,e.duration$),r(a.ended$,e.endedEvent$),r(a.looped$,e.loopedEvent$),r(a.error$,e.error$),r(a.isBuffering$,e.isBuffering$),r(a.currentBuffer$,e.currentBuffer$),r(a.loadedMetadata$,e.firstBytesEvent$),r(a.playing$,e.firstFrameEvent$),r(a.canplay$,e.canplay$),r(a.seeked$,e.seekedEvent$),this.subscription.add(kl(this.video,i.isLooped,s)),this.subscription.add(wl(this.video,i.volume,a.volumeState$,s)),this.subscription.add(a.volumeState$.subscribe(this.params.output.volume$,s)),this.subscription.add(Pl(this.video,i.playbackRate,a.playbackRateState$,s)),this.subscription.add(a.playing$.subscribe((()=>{this.videoState.setState(hh.PLAYING),Ko(i.playbackState,exports.PlaybackState.PLAYING)}),s)).add(a.pause$.subscribe((()=>{this.videoState.setState(hh.PAUSED),Ko(i.playbackState,exports.PlaybackState.PAUSED)}),s)).add(a.canplay$.subscribe((()=>{var e;(null===(e=this.videoState.getTransition())||void 0===e?void 0:e.to)===hh.READY&&this.videoState.setState(hh.READY);const i=this.params.desiredState.videoTrack.getTransition();i&&t.isNonNullable(i.to)&&(this.params.desiredState.videoTrack.setState(i.to),this.params.output.currentVideoTrack$.next(this.trackUrls[i.to].track)),this.videoState.getState()===hh.PLAYING&&this.playIfAllowed()}),s)),this.subscription.add(i.autoVideoTrackSwitching.stateChangeStarted$.subscribe((()=>i.autoVideoTrackSwitching.setState(!1)),s)),this.textTracksManager.connect(this.video,i,e);const n=t.merge(i.playbackState.stateChangeStarted$,i.videoTrack.stateChangeStarted$,i.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,t.observableFrom(['init'])).pipe(t.debounce(0));this.subscription.add(n.subscribe(this.syncPlayback,s))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.trackUrls={},this.video.remove(),this.params.output.element$.next(void 0)}prepare(){var e,i;const s=null!==(i=null===(e=this.params.desiredState.videoTrack.getTransition())||void 0===e?void 0:e.to)&&void 0!==i?i:this.params.desiredState.videoTrack.getState();t.assertNonNullable(s,'MpegProvider: track is not selected');let{url:a}=this.trackUrls[s];t.assertNonNullable(a,`MpegProvider: No url for ${s}`),this.params.tuning.requestQuick&&(a=yl(a)),this.video.setAttribute('src',a),this.video.load(),this.params.output.hostname$.next(Yl(a))}playIfAllowed(){Zl(this.video).then((t=>{t||(this.videoState.setState(hh.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED,!0))}))}seek(t){this.params.output.willSeekEvent$.next(),this.video.currentTime=t/1e3}}const bh=['stun:videostun.mycdn.me:80'],Sh=()=>null;class vh{constructor(t,e){this.ws=null,this.peerConnection=null,this.serverUrl='',this.streamKey='',this.stream=null,this.signalingType='JOIN',this.retryCount=0,this.externalStartCallback=Sh,this.externalStopCallback=Sh,this.externalErrorCallback=Sh,this.options=this.normalizeOptions(e);const i=t.split('/');this.serverUrl=i.slice(0,i.length-1).join('/'),this.streamKey=i[i.length-1]}onStart(t){try{this.externalStartCallback=t}catch(t){this.handleSystemError(t)}}onStop(t){try{this.externalStopCallback=t}catch(t){this.handleSystemError(t)}}onError(t){try{this.externalErrorCallback=t}catch(t){this.handleSystemError(t)}}connect(){this.connectWS()}disconnect(){try{this.externalStopCallback(),this.closeConnections()}catch(t){this.handleSystemError(t)}}connectWS(){this.ws||(this.ws=new WebSocket(this.serverUrl),this.ws.onopen=this.onSocketOpen.bind(this),this.ws.onmessage=this.onSocketMessage.bind(this),this.ws.onclose=this.onSocketClose.bind(this),this.ws.onerror=this.onSocketError.bind(this))}onSocketOpen(){this.handleLogin()}onSocketClose(t){try{if(!this.ws)return;this.ws=null,t.code>1e3?(this.retryCount++,this.retryCount>this.options.maxRetryNumber?this.handleNetworkError():this.scheduleRetry()):this.externalStopCallback()}catch(t){this.handleRTCError(t)}}onSocketError(t){try{this.externalErrorCallback(new Error(t.toString()))}catch(t){this.handleRTCError(t)}}onSocketMessage(t){try{const e=this.parseMessage(t.data);switch(e.type){case'JOIN':case'CALL_JOIN':this.handleJoinMessage(e);break;case'UPDATE':this.handleUpdateMessage(e);break;case'STATUS':this.handleStatusMessage(e)}}catch(t){this.handleRTCError(t)}}handleJoinMessage(t){switch(t.inviteType){case'ANSWER':this.handleAnswer(t.sdp);break;case'CANDIDATE':this.handleCandidate(t.candidate)}}handleStatusMessage(t){switch(t.status){case'UNPUBLISHED':this.handleUnpublished()}}handleUpdateMessage(t){return uu(this,void 0,void 0,(function*(){try{const e=yield this.createOffer();this.peerConnection&&(yield this.peerConnection.setLocalDescription(e)),this.handleAnswer(t.sdp)}catch(t){this.handleRTCError(t)}}))}handleLogin(){return uu(this,void 0,void 0,(function*(){try{const t={iceServers:[{urls:bh}]};this.peerConnection=new RTCPeerConnection(t),this.peerConnection.ontrack=this.onPeerConnectionStream.bind(this),this.peerConnection.onicecandidate=this.onPeerConnectionIceCandidate.bind(this),this.peerConnection.oniceconnectionstatechange=this.onPeerConnectionIceConnectionStateChange.bind(this);const e=yield this.createOffer();yield this.peerConnection.setLocalDescription(e),this.send({type:this.signalingType,inviteType:'OFFER',streamKey:this.streamKey,sdp:e.sdp,callSupport:!1})}catch(t){this.handleRTCError(t)}}))}handleAnswer(t){return uu(this,void 0,void 0,(function*(){try{this.peerConnection&&(yield this.peerConnection.setRemoteDescription(new RTCSessionDescription({type:'answer',sdp:t})))}catch(t){this.handleRTCError(t)}}))}handleCandidate(t){return uu(this,void 0,void 0,(function*(){if(t)try{this.peerConnection&&(yield this.peerConnection.addIceCandidate(t))}catch(t){this.handleRTCError(t)}}))}handleUnpublished(){try{this.closeConnections(),this.externalStopCallback()}catch(t){this.handleRTCError(t)}}handleSystemError(t){this.options.errorChanel&&this.options.errorChanel.next({id:'webrtc-provider-error',message:t.message})}onPeerConnectionStream(t){return uu(this,void 0,void 0,(function*(){const e=t.streams[0];this.stream&&this.stream.id===e.id||(this.stream=e,this.externalStartCallback(this.stream))}))}onPeerConnectionIceCandidate(t){t.candidate&&this.send({type:this.signalingType,inviteType:'CANDIDATE',candidate:t.candidate})}onPeerConnectionIceConnectionStateChange(){if(this.peerConnection){const t=this.peerConnection.iceConnectionState;['failed','closed'].indexOf(t)>-1&&(this.retryCount++,this.retryCount>this.options.maxRetryNumber?this.handleNetworkError():(this.closeConnections(),this.scheduleRetry()))}}createOffer(){return uu(this,void 0,void 0,(function*(){if(!this.peerConnection)throw new Error('Can not create offer - no peer connection instance ');const t=yield this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0,voiceActivityDetection:!1}),e=t.sdp||'';if(!/^a=rtpmap:\d+ H264\/\d+$/m.test(e))throw new Error('No h264 codec support error');return t}))}handleRTCError(t){try{this.externalErrorCallback(t||new Error('RTC connection error'))}catch(t){this.handleSystemError(t)}}handleNetworkError(){try{this.externalErrorCallback(new Error('Network error'))}catch(t){this.handleSystemError(t)}}send(t){this.ws&&this.ws.send(JSON.stringify(t))}parseMessage(t){try{return JSON.parse(t)}catch(t){throw new Error('Can not parse socket message')}}closeConnections(){const t=this.ws;t&&(this.ws=null,t.close(1e3)),this.removePeerConnection()}removePeerConnection(){let t=this.peerConnection;t&&(this.peerConnection=null,t.close(),t.ontrack=null,t.onicecandidate=null,t.oniceconnectionstatechange=null,t=null)}scheduleRetry(){this.retryTimeout=setTimeout(this.connectWS.bind(this),1e3)}normalizeOptions(t={}){const e={stunServerList:bh,maxRetryNumber:3,errorChanel:null};return t.stunServerList&&(e.stunServerList=t.stunServerList),t.maxRetryNumber&&t.maxRetryNumber>0&&(e.maxRetryNumber=t.maxRetryNumber),e}}var gh,yh,Th,Eh,kh,wh,Ph,$h,Ah,xh,Nh,Rh,Dh,Ch,_h,Ih,Lh,Oh;!function(t){t.STOPPED='stopped',t.READY='ready',t.PLAYING='playing',t.PAUSED='paused'}(gh||(gh={}));class Bh{constructor(e){this.videoState=new ru(gh.STOPPED),this.maxSeekBackTime$=new t.ValueSubject(0),this.syncPlayback=()=>{const e=this.videoState.getState(),i=this.params.desiredState.playbackState.getState(),s=this.params.desiredState.playbackState.getTransition();if(i===exports.PlaybackState.STOPPED)return void(e!==gh.STOPPED&&(this.videoState.startTransitionTo(gh.STOPPED),this.video.pause(),this.video.srcObject=null,this.params.output.position$.next(0),this.params.output.duration$.next(0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(gh.STOPPED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.STOPPED,!0)));if(this.videoState.getTransition())return;const a=this.params.desiredState.videoTrack.getTransition();if(e===gh.STOPPED)return this.videoState.startTransitionTo(gh.READY),void this.prepare();if(a)this.prepare();else switch(e){case gh.READY:return void(i===exports.PlaybackState.PAUSED?(this.videoState.setState(gh.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED)):i===exports.PlaybackState.PLAYING&&(this.videoState.startTransitionTo(gh.PLAYING),this.playIfAllowed()));case gh.PLAYING:return void(i===exports.PlaybackState.PAUSED?(this.videoState.startTransitionTo(gh.PAUSED),this.video.pause()):(null==s?void 0:s.to)===exports.PlaybackState.PLAYING&&Ko(this.params.desiredState.playbackState,exports.PlaybackState.PLAYING));case gh.PAUSED:return void(i===exports.PlaybackState.PLAYING?(this.videoState.startTransitionTo(gh.PLAYING),this.playIfAllowed()):(null==s?void 0:s.to)===exports.PlaybackState.PAUSED&&Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED));default:return t.assertNever(e)}},this.subscription=new t.Subscription,this.params=e,this.log=this.params.dependencies.logger.createComponentLog('WebRTCLiveProvider'),this.video=xl(e.container),this.liveStreamClient=new vh(this.params.source.url,{maxRetryNumber:this.params.tuning.webrtc.connectionRetryMaxNumber,errorChanel:this.params.output.error$}),this.liveStreamClient.onStart(this.onLiveStreamStart.bind(this)),this.liveStreamClient.onStop(this.onLiveStreamStop.bind(this)),this.liveStreamClient.onError(this.onLiveStreamError.bind(this)),this.subscribe()}destroy(){this.subscription.unsubscribe(),this.video.remove(),this.params.output.element$.next(void 0),this.liveStreamClient.disconnect()}subscribe(){const{output:e,desiredState:i}=this.params,s=t=>{e.error$.next({id:'WebRTCLiveProvider',message:'WebRTCLiveProvider internal logic error',thrown:t})};t.merge(this.videoState.stateChangeStarted$.pipe(t.map((t=>({transition:t,type:'start'})))),this.videoState.stateChangeEnded$.pipe(t.map((t=>({transition:t,type:'end'}))))).subscribe((({transition:t,type:e})=>{this.log({message:`[videoState change] ${e}: ${JSON.stringify(t)}`})}));const a=Cl(this.video),r=(t,e)=>this.subscription.add(t.subscribe(e,s));r(a.timeUpdate$,e.liveTime$),r(a.ended$,e.endedEvent$),r(a.looped$,e.loopedEvent$),r(a.error$,e.error$),r(a.isBuffering$,e.isBuffering$),r(a.currentBuffer$,e.currentBuffer$),this.subscription.add(a.durationChange$.subscribe((t=>{e.duration$.next(t===1/0?0:t)}))).add(a.canplay$.subscribe((()=>{var t;(null===(t=this.videoState.getTransition())||void 0===t?void 0:t.to)===gh.READY&&this.videoState.setState(gh.READY)}),s)).add(a.pause$.subscribe((()=>{this.videoState.setState(gh.PAUSED)}),s)).add(a.playing$.subscribe((()=>{this.videoState.setState(gh.PLAYING)}),s)).add(a.error$.subscribe(e.error$)).add(this.maxSeekBackTime$.subscribe(this.params.output.duration$)).add(wl(this.video,i.volume,a.volumeState$,s)).add(a.volumeState$.subscribe(e.volume$,s)).add(this.videoState.stateChangeEnded$.subscribe((s=>{switch(s.to){case gh.STOPPED:e.position$.next(0),e.duration$.next(0),i.playbackState.setState(exports.PlaybackState.STOPPED);break;case gh.READY:break;case gh.PAUSED:i.playbackState.setState(exports.PlaybackState.PAUSED);break;case gh.PLAYING:i.playbackState.setState(exports.PlaybackState.PLAYING);break;default:return t.assertNever(s.to)}}),s)).add(t.merge(i.playbackState.stateChangeStarted$,this.videoState.stateChangeEnded$,t.observableFrom(['init'])).pipe(t.debounce(0)).subscribe(this.syncPlayback.bind(this),s)),this.subscription.add(i.isLooped.stateChangeStarted$.subscribe((()=>i.isLooped.setState(!1)),s)),this.subscription.add(i.autoVideoTrackSwitching.stateChangeStarted$.subscribe((()=>i.autoVideoTrackSwitching.setState(!1)),s))}onLiveStreamStart(t){this.params.output.element$.next(this.video),this.params.output.duration$.next(0),this.params.output.position$.next(0),this.params.output.isLive$.next(!0),this.params.output.hostname$.next(Yl(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!1),this.params.output.availableVideoTracks$.next([]),this.params.output.currentVideoTrack$.next({id:'webrtc',quality:exports.VideoQuality.INVARIANT}),this.video.srcObject=t,Ko(this.params.desiredState.playbackState,exports.PlaybackState.PLAYING)}onLiveStreamStop(){this.videoState.startTransitionTo(gh.STOPPED),this.syncPlayback(),this.params.output.position$.next(0),this.params.output.duration$.next(0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.params.output.endedEvent$.next()}onLiveStreamError(t){this.onLiveStreamStop(),this.params.output.error$.next({id:'WebRTC stream runtime error',message:t.message,thrown:t})}playIfAllowed(){Zl(this.video).then((t=>{t||(this.videoState.setState(gh.PAUSED),Ko(this.params.desiredState.playbackState,exports.PlaybackState.PAUSED,!0))}))}prepare(){this.liveStreamClient.connect()}}class Mh{constructor(t){this.iterator=t[Symbol.iterator](),this.next()}next(){this.current=this.iterator.next()}getValue(){if(this.current.done)throw new Error('Iterable is completed');return this.current.value}isCompleted(){return Boolean(this.current.done)}}const Vh=xc(),Uh=(null===(yh=null===navigator||void 0===navigator?void 0:navigator.userAgentData)||void 0===yh?void 0:yh.mobile)||/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(navigator.appVersion),Fh=document.createElement('video'),jh={mse:Boolean(window.MediaSource&&window.MediaStreamTrack&&(null===(Eh=null===(Th=window.SourceBuffer)||void 0===Th?void 0:Th.prototype)||void 0===Eh?void 0:Eh.appendBuffer)),hls:Boolean((null===(kh=Fh.canPlayType)||void 0===kh?void 0:kh.call(Fh,'application/x-mpegurl'))||(null===(wh=Fh.canPlayType)||void 0===wh?void 0:wh.call(Fh,'vnd.apple.mpegURL'))),webrtc:Boolean(window.RTCPeerConnection)},qh={mp4:Boolean(null===(Ph=Fh.canPlayType)||void 0===Ph?void 0:Ph.call(Fh,'video/mp4')),webm:Boolean(null===($h=Fh.canPlayType)||void 0===$h?void 0:$h.call(Fh,'video/webm'))},Hh={h264:Boolean(null===(xh=null===(Ah=window.MediaSource)||void 0===Ah?void 0:Ah.isTypeSupported)||void 0===xh?void 0:xh.call(Ah,'video/mp4; codecs="avc1.42000a,mp4a.40.2"')),h265:Boolean(null===(Rh=null===(Nh=window.MediaSource)||void 0===Nh?void 0:Nh.isTypeSupported)||void 0===Rh?void 0:Rh.call(Nh,'video/mp4; codecs="hev1.1.6.L93.B0"')),vp9:Boolean(null===(Ch=null===(Dh=window.MediaSource)||void 0===Dh?void 0:Dh.isTypeSupported)||void 0===Ch?void 0:Ch.call(Dh,'video/webm; codecs="vp9"')),aac:Boolean(null===(Ih=null===(_h=window.MediaSource)||void 0===_h?void 0:_h.isTypeSupported)||void 0===Ih?void 0:Ih.call(_h,'audio/mp4; codecs="mp4a.40.2"')),opus:Boolean(null===(Oh=null===(Lh=window.MediaSource)||void 0===Lh?void 0:Lh.isTypeSupported)||void 0===Oh?void 0:Oh.call(Lh,'audio/webm; codecs="opus"'))},Gh=(Hh.h264||Hh.h265)&&Hh.aac,Yh=!Vh,Qh=jh.hls&&qh.mp4&&(Uh||Vh),zh=Boolean(window.WebSocket);const Wh=3e4,Jh=18e4,Xh=3,Kh=100,Zh={cacheDuration:12e4},tp={maxPausedTime:3e4,chunkDuration:5e3,maxParallelRequests:5},ep={maxPausedTime:3e4},ip={maxPausedTime:3e4};class sp{constructor(e){this.current$=new t.ValueSubject({type:void 0}),this.providerError$=new t.Subject,this.noAvailableProvidersError$=new t.Subject,this.providerOutput={position$:new t.ValueSubject(0),duration$:new t.ValueSubject(1/0),volume$:new t.ValueSubject({muted:!1,volume:1}),currentVideoTrack$:new t.ValueSubject(void 0),availableVideoTracks$:new t.ValueSubject([]),autoVideoTrackLimitingAvailable$:new t.ValueSubject(!1),currentBuffer$:new t.ValueSubject(void 0),isBuffering$:new t.ValueSubject(!0),error$:new t.Subject,willSeekEvent$:new t.Subject,seekedEvent$:new t.Subject,loopedEvent$:new t.Subject,endedEvent$:new t.Subject,firstBytesEvent$:new t.Subject,firstFrameEvent$:new t.Subject,canplay$:new t.Subject,isLive$:new t.ValueSubject(void 0),liveTime$:new t.ValueSubject(void 0),availableTextTracks$:new t.ValueSubject([]),currentTextTrack$:new t.ValueSubject(void 0),hostname$:new t.ValueSubject(void 0),httpConnectionType$:new t.ValueSubject(void 0),httpConnectionReused$:new t.ValueSubject(void 0),element$:new t.ValueSubject(void 0)},this.subscription=new t.Subscription,this.params=e,this.log=this.params.dependencies.logger.createComponentLog('ProviderContainer');const{formatsToAvoid:i}=this.params.tuning,s=i.length?[...e.screenFormatsPriority.filter((t=>!i.includes(t))),...e.screenFormatsPriority.filter((t=>i.includes(t)))]:e.screenFormatsPriority;this.screenFormatsIterator=new Mh(((e,i=!1)=>e.filter((e=>{switch(e){case exports.VideoFormat.DASH:return jh.mse&&qh.mp4&&Gh&&Yh;case exports.VideoFormat.DASH_SEP:return jh.mse&&qh.mp4&&Gh;case exports.VideoFormat.DASH_WEBM:return jh.mse&&qh.webm&&Hh.vp9&&Hh.opus;case exports.VideoFormat.DASH_LIVE:case exports.VideoFormat.DASH_ONDEMAND:return jh.mse&&qh.mp4&&Gh;case exports.VideoFormat.HLS:case exports.VideoFormat.HLS_LIVE:case exports.VideoFormat.HLS_ONDEMAND:return Qh||i&&jh.mse&&qh.mp4&&Gh;case exports.VideoFormat.MPEG:return qh.mp4;case exports.VideoFormat.DASH_LIVE_WEBM:return!1;case exports.VideoFormat.WEB_RTC_LIVE:return jh.webrtc&&zh&&Hh.h264&&(qh.mp4||qh.webm);default:return t.assertNever(e)}})))(s.filter((i=>t.isNonNullable(e.sources[i]))),this.params.tuning.useHlsJs)),this.chromecastFormatsIterator=new Mh(e.chromecastFormatsPriority.filter((i=>t.isNonNullable(e.sources[i]))))}init(){this.subscription.add(this.initProviderErrorHandling()),this.subscription.add(this.params.dependencies.chromecastInitializer.connection$.subscribe((()=>{this.reinitProvider()})))}destroy(){this.destroyProvider(),this.current$.next({type:void 0}),this.subscription.unsubscribe()}initProvider(){const e=this.chooseDestination(),i=this.chooseFormat(e);if(t.isNullable(i))return void this.handleNoFormatsError(e);let s;try{s=this.createProvider(e,i)}catch(t){this.providerError$.next({id:'ProviderNotConstructed',message:'Failed to create provider',thrown:t})}s?this.current$.next({type:i,provider:s,destination:e}):this.switchToNextProvider()}reinitProvider(){this.destroyProvider(),this.initProvider()}switchToNextProvider(){this.destroyProvider();const e=this.current$.getValue().destination;t.assertNonNullable(e,'No current provider'),this.skipFormat(e),this.initProvider()}destroyProvider(){const t=this.current$.getValue().provider;if(!t)return;this.log({message:'destroyProvider'});const e=1e3*this.providerOutput.position$.getValue(),i=this.params.desiredState.seekState.getState(),s=i.state!==l.None;this.params.desiredState.seekState.setState({state:l.Requested,position:s?i.position:e,forcePrecise:!!s&&i.forcePrecise}),t.destroy();const a=this.providerOutput.isBuffering$;a.getValue()||a.next(!0)}createProvider(e,i){switch(this.log({message:`createProvider: ${e}:${i}`}),e){case n.SCREEN:return this.createScreenProvider(i);case n.CHROMECAST:return this.createChromecastProvider(i);default:return t.assertNever(e)}}createScreenProvider(e){const{sources:i,container:s,desiredState:a}=this.params,r=this.providerOutput,n={container:s,source:null,desiredState:a,output:r,dependencies:this.params.dependencies,tuning:this.params.tuning};switch(e){case exports.VideoFormat.DASH:{const s=i[e];return t.assertNonNullable(s),new vc(Object.assign(Object.assign({},n),{source:s,config:Zh}))}case exports.VideoFormat.DASH_SEP:case exports.VideoFormat.DASH_WEBM:case exports.VideoFormat.DASH_ONDEMAND:{const s=i[e];return t.assertNonNullable(s),this.params.tuning.useDashJs?new Xl(Object.assign(Object.assign({},n),{source:s,format:e,config:ip})):new sh(Object.assign(Object.assign({},n),{source:s}))}case exports.VideoFormat.HLS:case exports.VideoFormat.HLS_ONDEMAND:{const s=i[e];return t.assertNonNullable(s),Qh||!this.params.tuning.useHlsJs?new mh(Object.assign(Object.assign({},n),{source:s})):new oh(Object.assign(Object.assign({},n),{source:s}))}case exports.VideoFormat.HLS_LIVE:{const s=i[e];return t.assertNonNullable(s),new ph(Object.assign(Object.assign({},n),{source:s,config:ep}))}case exports.VideoFormat.MPEG:{const s=i[e];return t.assertNonNullable(s),new fh(Object.assign(Object.assign({},n),{source:s}))}case exports.VideoFormat.DASH_LIVE:{const s=i[e];return t.assertNonNullable(s),new lc(Object.assign(Object.assign({},n),{source:s,config:tp}))}case exports.VideoFormat.WEB_RTC_LIVE:{const n=i[e];return t.assertNonNullable(n),new Bh({container:s,source:n,desiredState:a,output:r,dependencies:this.params.dependencies,tuning:this.params.tuning})}case exports.VideoFormat.DASH_LIVE_WEBM:throw new Error('DASH_LIVE_WEBM is no longer supported');default:return t.assertNever(e)}}createChromecastProvider(e){const{sources:i,container:s,desiredState:a,meta:r}=this.params,n=this.providerOutput,o=this.params.dependencies.chromecastInitializer.connection$.getValue();return t.assertNonNullable(o),new ou({connection:o,meta:r,container:s,source:i,format:e,desiredState:a,output:n,dependencies:this.params.dependencies,tuning:this.params.tuning})}chooseDestination(){return this.params.dependencies.chromecastInitializer.connection$.getValue()?n.CHROMECAST:n.SCREEN}chooseFormat(e){switch(e){case n.SCREEN:return this.screenFormatsIterator.isCompleted()?void 0:this.screenFormatsIterator.getValue();case n.CHROMECAST:return this.chromecastFormatsIterator.isCompleted()?void 0:this.chromecastFormatsIterator.getValue();default:return t.assertNever(e)}}skipFormat(e){switch(e){case n.SCREEN:return this.screenFormatsIterator.next();case n.CHROMECAST:return this.chromecastFormatsIterator.next();default:return t.assertNever(e)}}handleNoFormatsError(e){switch(e){case n.SCREEN:return this.noAvailableProvidersError$.next(),void this.current$.next({type:void 0});case n.CHROMECAST:return void this.params.dependencies.chromecastInitializer.disconnect();default:return t.assertNever(e)}}initProviderErrorHandling(){let e=[],i=0;const s=new t.Subscription;var a;return s.add(t.merge(this.providerOutput.error$,(a={desiredPlaybackState$:this.params.desiredState.playbackState,maxTransitionInterval:Wh,position$:this.providerOutput.position$,providerChanged$:this.current$.pipe(t.filter((({type:t})=>void 0!==t)))},new t.Observable((e=>{const i=new t.Subscription,s=a.desiredPlaybackState$.stateChangeStarted$.pipe(t.map((({from:t,to:e})=>`${t}-${e}`))),r=a.desiredPlaybackState$.stateChangeEnded$,n=a.providerChanged$,o=new t.Subject;let u=0,d='unknown';return i.add(s.subscribe((t=>{u&&window.clearTimeout(u),d=t,u=window.setTimeout((()=>o.next(t)),a.maxTransitionInterval)}))),i.add(r.subscribe((()=>{window.clearTimeout(u),d='provider change',u=0}))),i.add(n.subscribe((()=>{u&&(window.clearTimeout(u),u=window.setTimeout((()=>o.next(d)),a.maxTransitionInterval))}))),i.add(o.subscribe(e)),()=>{window.clearTimeout(u),i.unsubscribe()}}))).pipe(t.map((t=>({id:`ProviderHangup:${t}`,message:`A ${t} transition failed to complete within reasonable time`}))))).subscribe(this.providerError$)),s.add(this.providerError$.pipe(t.throttle(Kh,{leading:!1,trailing:!0})).subscribe((()=>{const s=Date.now();this.current$.getValue().destination===n.CHROMECAST?(this.destroyProvider(),this.params.dependencies.chromecastInitializer.stopMedia().then((()=>{this.switchToNextProvider()}),(()=>{this.params.dependencies.chromecastInitializer.disconnect()}))):t.isNonNullable(e[i])&&s<e[i]+Jh?(e=[],this.switchToNextProvider()):(e[i]=s,this.reinitProvider()),i=(i+1)%Xh}))),s}}const ap=(t,e,i)=>i*e+(1-i)*t;class rp{constructor(e){var i;this.prevReported=void 0,this.pastMeasures=[],this.measuresCursor=0,this.params=e,this.pastMeasures=Array(e.deviationDepth),this.slow=this.fast=this.smoothed=this.prevReported=e.initial,this.smoothed$=new t.ValueSubject(e.initial),this.debounced$=new t.ValueSubject(e.initial);const s=null!==(i=e.label)&&void 0!==i?i:'value'+Math.random().toString(16).substring(2,6);this.rawSeries$=new jl(`raw_${s}`),this.smoothedSeries$=new jl(`smoothed_${s}`),this.reportedSeries$=new jl(`reported_${s}`),this.rawSeries$.next(e.initial),this.smoothedSeries$.next(e.initial),this.reportedSeries$.next(e.initial)}next(e){let i=0,s=0;for(let t=0;t<this.pastMeasures.length;t++)void 0!==this.pastMeasures[t]&&(i+=Math.pow(this.pastMeasures[t]-this.smoothed,2),s++);i/=s;const a=Math.sqrt(i),r=this.smoothed+this.params.deviationFactor*a,n=this.smoothed-this.params.deviationFactor*a;this.pastMeasures[this.measuresCursor]=e,this.measuresCursor=(this.measuresCursor+1)%this.pastMeasures.length,this.rawSeries$.next(e),this.slow=ap(this.slow,e,this.params.emaAlphaSlow),this.fast=ap(this.fast,e,this.params.emaAlphaFast);const o=this.params.fastDirection>0?Math.max:Math.min;this.smoothed=o(this.slow,this.fast),this.smoothed$.next(this.smoothed),this.smoothedSeries$.next(this.smoothed),this.smoothed>r||this.smoothed<n||(t.isNullable(this.prevReported)||Math.abs(this.smoothed-this.prevReported)/this.prevReported>=this.params.changeThreshold)&&(this.prevReported=this.smoothed,this.debounced$.next(this.smoothed),this.reportedSeries$.next(this.smoothed))}}var np;!function(t){t[t.LOCAL_STORAGE=0]='LOCAL_STORAGE',t[t.SESSION_STORAGE=1]='SESSION_STORAGE',t[t.RUNTIME=2]='RUNTIME'}(np||(np={}));const op=new Map;let up=np.RUNTIME;const dp=`vk-videoplayer-dummy-key-${Math.random()}`;(()=>{try{localStorage.setItem(dp,'test'),localStorage.removeItem(dp),up=np.LOCAL_STORAGE}catch(t){if(!(t instanceof DOMException||t instanceof TypeError))throw t;try{sessionStorage.getItem(dp),up=np.SESSION_STORAGE}catch(t){if(!(t instanceof DOMException||t instanceof TypeError))throw t;up=np.RUNTIME}}})();const lp=(e,i)=>{switch(up){case np.LOCAL_STORAGE:try{localStorage.setItem(e,i)}catch(t){if(!(t instanceof DOMException))throw t;console.error(t)}break;case np.SESSION_STORAGE:try{sessionStorage.setItem(e,i)}catch(t){if(!(t instanceof DOMException))throw t;console.error(t)}break;case np.RUNTIME:return void op.set(e,i);default:t.assertNever(up)}},cp=window.navigator.connection,hp=()=>{const e=null==cp?void 0:cp.downlink;if(t.isNonNullable(e)&&10!==e)return 1e3*e},pp=()=>{const e=null==cp?void 0:cp.rtt;if(t.isNonNullable(e)&&3e3!==e)return e},mp=(t,e,i)=>{const s=8*i;return s/(s/t+e)};class fp{constructor(e){var i,s;this.subscription=new t.Subscription,this.concurrentDownloads=new Set,this.tuningConfig=e;const a=fp.load('one_video_throughput')||(e.useBrowserEstimation?hp():void 0)||5e3,r=null!==(s=null!==(i=fp.load('one_video_rtt'))&&void 0!==i?i:e.useBrowserEstimation?pp():void 0)&&void 0!==s?s:0;if(this.throughput$=new t.ValueSubject(a),this.rtt$=new t.ValueSubject(r),this.rttAdjustedThroughput$=new t.ValueSubject(mp(a,r,e.rttPenaltyRequestSize)),this.throughput=new rp({initial:a,emaAlphaSlow:e.emaAlphaSlow,emaAlphaFast:e.emaAlphaFast,changeThreshold:e.changeThreshold,fastDirection:-1,deviationDepth:e.deviationDepth,deviationFactor:e.deviationFactor,label:'throughput'}),this.rtt=new rp({initial:r,emaAlphaSlow:e.emaAlphaSlow,emaAlphaFast:e.emaAlphaFast,changeThreshold:e.changeThreshold,fastDirection:1,deviationDepth:e.deviationDepth,deviationFactor:e.deviationFactor,label:'rtt'}),e.useBrowserEstimation){const e=()=>{const e=hp();e&&this.throughput.next(e);const i=pp();t.isNonNullable(i)&&this.rtt.next(i)};cp&&'onchange'in cp&&this.subscription.add(t.fromEvent(cp,'change').subscribe(e)),e()}this.subscription.add(this.throughput.smoothed$.subscribe((t=>{lp('one_video_throughput',t.toFixed(0))}))),this.subscription.add(this.rtt.smoothed$.subscribe((t=>{lp('one_video_rtt',t.toFixed(0))}))),this.subscription.add(this.throughput.debounced$.subscribe(this.throughput$)),this.subscription.add(this.rtt.debounced$.subscribe(this.rtt$)),this.subscription.add(t.combine({throughput:this.throughput.smoothed$,rtt:this.rtt.smoothed$}).pipe(t.map((({throughput:t,rtt:i})=>mp(t,i,e.rttPenaltyRequestSize))),t.filter((t=>{const i=this.rttAdjustedThroughput$.getValue()||0;return Math.abs(t-i)/i>=e.changeThreshold}))).subscribe(this.rttAdjustedThroughput$))}destroy(){this.concurrentDownloads.clear(),this.subscription.unsubscribe()}trackXHR(e){let i=0,s=t.now();const a=new t.Subscription;switch(this.subscription.add(a),this.concurrentDownloads.add(e),e.readyState){case 4:break;case 3:case 2:a.add(t.fromEvent(e,'progress').pipe(t.once()).subscribe((e=>{i=e.loaded,s=t.now()})));break;case 1:case 0:a.add(t.fromEvent(e,'loadstart').subscribe((()=>{i=0,s=t.now()})))}a.add(t.fromEvent(e,'loadend').subscribe((r=>{if(200===e.status){const e=r.loaded,a=t.now(),n=e-i,o=a-s;this.addRawSpeed(n,o,1)}this.concurrentDownloads.delete(e),a.unsubscribe()})))}trackStream(e){const i=e.getReader();if(!i)return void e.cancel('Could not get reader');let s=0;const a=t.now();let r=0,n=t.now();const o=t=>{this.concurrentDownloads.delete(e),i.releaseLock(),e.cancel(`Throughput Estimator error: ${t}`).catch((()=>{}))},u=({done:d,value:l})=>uu(this,void 0,void 0,(function*(){d?(this.addRawSpeed(s,t.now()-a,1),this.concurrentDownloads.delete(e)):l&&(s+=l.byteLength,r+=l.byteLength,r>=this.tuningConfig.streamMinSampleSize&&t.now()-n>=this.tuningConfig.streamMinSampleTime&&(this.addRawSpeed(r,t.now()-n,this.concurrentDownloads.size),r=0,n=t.now()),yield null==i?void 0:i.read().then(u,o))}));this.concurrentDownloads.add(e),null==i||i.read().then(u,o)}addRawSpeed(t,e,i=1){if(fp.sanityCheck(t,e)){const s=8*t/e;this.throughput.next(s*i)}}addRawThroughput(t){this.throughput.next(t)}addRawRtt(t){this.rtt.next(t)}static sanityCheck(t,e){const i=8*t/e;return!(!i||!isFinite(i))&&(!(i>1e6)&&(!(i<30)&&(!(t<10240)&&!(e<=20))))}static load(e){var i;const s=(e=>{var i,s;switch(up){case np.LOCAL_STORAGE:return null!==(i=localStorage.getItem(e))&&void 0!==i?i:void 0;case np.SESSION_STORAGE:return null!==(s=sessionStorage.getItem(e))&&void 0!==s?s:void 0;case np.RUNTIME:return op.get(e);default:t.assertNever(up)}})(e);if(t.isNonNullable(s))return null!==(i=parseInt(s,10))&&void 0!==i?i:void 0}}const bp={throughputEstimator:{emaAlphaSlow:.2,emaAlphaFast:.7,changeThreshold:.05,useBrowserEstimation:!0,rttPenaltyRequestSize:1048576,streamMinSampleSize:10240,streamMinSampleTime:300,deviationDepth:10,deviationFactor:.5},autoTrackSelection:{bitrateFactorAtEmptyBuffer:1.8,bitrateFactorAtFullBuffer:1.2,usePixelRatio:!0,limitByContainer:!0,containerSizeFactor:2,lazyQualitySwitch:!0,minBufferToSwitchUp:.3,considerPlaybackRate:!1,trackCooldown:3e3},dash:{forwardBufferTarget:6e4,forwardBufferTargetAuto:6e4,forwardBufferTargetManual:3e5,segmentRequestSize:1048576,representationSwitchForwardBufferGap:3e3,enableSubSegmentBufferFeeding:!0,segmentTimelineTolerance:100,useFetchPriorityHints:!0},live:{minBuffer:3e3,minBufferSegments:3,lowLatencyMinBuffer:1e3,lowLatencyMinBufferSegments:1},downloadBackoff:{bufferThreshold:100,start:100,factor:2,max:3e3,random:.1},enableTelemetryAtStart:!1,formatsToAvoid:[],disableChromecast:!1,chromecastReceiverId:void 0,useWebmBigRequest:!0,bigRequestMinInitSize:51200,bigRequestMinDataSize:1048576,stripRangeHeader:!0,flushShortLoopedBuffers:!0,insufficientBufferRuleMargin:1e4,dashSeekInSegmentDurationThreshold:18e4,dashSeekInSegmentAlwaysSeekDelta:1e4,endGapTolerance:300,stallIgnoreThreshold:33,gapWatchdogInterval:50,requestQuick:!1,useDashJs:!1,useHlsJs:!0,webrtc:{connectionRetryMaxNumber:3}};const Sp=({playbackState:e,seekState:i,playbackAbort$:s,looped$:a,position$:r})=>new t.Observable((n=>{let o;const u=e.transitionEnded$.pipe(t.filter((t=>(t.from===exports.PlaybackState.PAUSED||t.from===exports.PlaybackState.STOPPED)&&t.to===exports.PlaybackState.PLAYING))),d=e.stateChangeEnded$.pipe(t.filter((t=>t.from===exports.PlaybackState.PLAYING&&t.to===exports.PlaybackState.PAUSED))),c=i.stateChangeEnded$.pipe(t.filter((({to:t})=>{var i,s;return t.state===l.Requested&&(null!==(s=null===(i=e.getTransition())||void 0===i?void 0:i.from)&&void 0!==s?s:e.getState())===exports.PlaybackState.PLAYING}))),h=i.stateChangeEnded$.pipe(t.filter((({from:t,to:i})=>{var s,a;return t.state===l.Applying&&i.state===l.None&&(null!==(a=null===(s=e.getTransition())||void 0===s?void 0:s.from)&&void 0!==a?a:e.getState())===exports.PlaybackState.PLAYING}))),p=t.merge(u,h).pipe(t.map((()=>r.getValue())),t.filter(t.isNonNullable)),m=t.merge(t.merge(d,c,s),a).pipe(t.map((()=>r.getValue())),t.filter(t.isNonNullable));return(new t.Subscription).add(p.subscribe((t=>{o=t}))).add(m.subscribe((e=>{if(t.isNullable(o)||o===e)return;const i={from:o,to:e};o=void 0,n.next(i)})))})),vp={[n.SCREEN]:{vod:[...Qh?[exports.VideoFormat.HLS,exports.VideoFormat.HLS_ONDEMAND]:[],exports.VideoFormat.DASH_WEBM,exports.VideoFormat.DASH_SEP,exports.VideoFormat.DASH,exports.VideoFormat.DASH_ONDEMAND,...Qh?[]:[exports.VideoFormat.HLS,exports.VideoFormat.HLS_ONDEMAND],exports.VideoFormat.MPEG],live:Qh?[exports.VideoFormat.WEB_RTC_LIVE,exports.VideoFormat.HLS_LIVE,exports.VideoFormat.DASH_LIVE]:[exports.VideoFormat.WEB_RTC_LIVE,exports.VideoFormat.DASH_LIVE,exports.VideoFormat.HLS_LIVE]},[n.CHROMECAST]:{vod:[exports.VideoFormat.DASH_WEBM,exports.VideoFormat.DASH_SEP,exports.VideoFormat.DASH_ONDEMAND,exports.VideoFormat.HLS,exports.VideoFormat.HLS_ONDEMAND,exports.VideoFormat.MPEG],live:[exports.VideoFormat.HLS_LIVE]}};Object.defineProperty(exports,'Observable',{enumerable:!0,get:function(){return t.Observable}}),Object.defineProperty(exports,'Subject',{enumerable:!0,get:function(){return t.Subject}}),Object.defineProperty(exports,'Subscription',{enumerable:!0,get:function(){return t.Subscription}}),Object.defineProperty(exports,'ValueSubject',{enumerable:!0,get:function(){return t.ValueSubject}}),exports.Player=class{constructor(e={}){if(this.subscription=new t.Subscription,this.logger=new t.Logger,this.isPlaybackStarted=!1,this.desiredState={playbackState:new ru(exports.PlaybackState.STOPPED),seekState:new ru({state:l.None}),volume:new ru({volume:1,muted:!1}),videoTrack:new ru(void 0),autoVideoTrackSwitching:new ru(!0),autoVideoTrackLimits:new ru({}),isLooped:new ru(!1),playbackRate:new ru(1),externalTextTracks:new ru([]),currentTextTrack:new ru(void 0),textTrackCuesSettings:new ru({})},this.info={playbackState$:new t.ValueSubject(exports.PlaybackState.STOPPED),position$:new t.ValueSubject(0),duration$:new t.ValueSubject(1/0),muted$:new t.ValueSubject(!1),volume$:new t.ValueSubject(1),availableQualities$:new t.ValueSubject([]),availableQualitiesFps$:new t.ValueSubject({}),currentQuality$:new t.ValueSubject(void 0),isAutoQualityEnabled$:new t.ValueSubject(!0),autoQualityLimitingAvailable$:new t.ValueSubject(!1),autoQualityLimits$:new t.ValueSubject({}),currentPlaybackRate$:new t.ValueSubject(1),currentBuffer$:new t.ValueSubject({start:0,end:0}),isBuffering$:new t.ValueSubject(!0),isStalled$:new t.ValueSubject(!1),isEnded$:new t.ValueSubject(!1),isLooped$:new t.ValueSubject(!1),isLive$:new t.ValueSubject(void 0),liveTime$:new t.ValueSubject(void 0),currentFormat$:new t.ValueSubject(void 0),availableTextTracks$:new t.ValueSubject([]),currentTextTrack$:new t.ValueSubject(void 0),throughputEstimation$:new t.ValueSubject(void 0),rttEstimation$:new t.ValueSubject(void 0),videoBitrate$:new t.ValueSubject(void 0),hostname$:new t.ValueSubject(void 0),httpConnectionType$:new t.ValueSubject(void 0),httpConnectionReused$:new t.ValueSubject(void 0),chromecastState$:new t.ValueSubject(exports.ChromecastState.NOT_AVAILABLE),chromecastDeviceName$:new t.ValueSubject(void 0),intrinsicVideoSize$:new t.ValueSubject(void 0)},this.events={inited$:new t.Subject,started$:new t.Subject,startAttempt$:new t.Subject,willPause$:new t.Subject,willResume$:new t.Subject,willDestruct$:new t.Subject,watchCoverageRecord$:new t.Subject,watchCoverageLive$:new t.Subject,managedError$:new t.Subject,fatalError$:new t.Subject,ended$:new t.Subject,looped$:new t.Subject,seeked$:new t.Subject,willSeek$:new t.Subject,firstBytes$:new t.Subject,firstFrame$:new t.Subject,canplay$:new t.Subject,log$:new t.Subject},this.experimental={element$:new t.ValueSubject(void 0),enableDebugTelemetry$:new t.ValueSubject(!1),dumpTelemetry:Ul},this.initLogs(),this.tuning=(t=>{const e={};for(const i of Object.keys(bp)){const s=bp[i],a=t[i];Array.isArray(s)&&Array.isArray(a)?e[i]=a:e[i]='object'==typeof s&&'object'==typeof a?Object.assign(Object.assign({},s),a):null!=a?a:s}return e})(e),this.chromecastInitializer=new c({receiverApplicationId:e.chromecastReceiverId,isDisabled:e.disableChromecast,dependencies:{logger:this.logger}}),this.throughputEstimator=new fp(this.tuning.throughputEstimator),this.initChromecastSubscription(),this.initDesiredStateSubscriptions(),Proxy&&Reflect)return new Proxy(this,{get:(t,e,i)=>{const s=Reflect.get(t,e,i);return'function'!=typeof s?s:(...i)=>{try{return s.apply(t,i)}catch(t){const s=i.map((t=>JSON.stringify(t,((t,e)=>{const i=typeof e;return['number','string','boolean'].includes(i)?e:null===e?null:`<${i}>`})))),a=`Player.${String(e)}`,r=`Exception calling ${a} (${s.join(', ')})`;throw this.events.fatalError$.next({id:a,message:r,thrown:t}),t}}}})}initVideo(e){var i,s;return this.config=e,this.domContainer=(e=>{const i='string'==typeof e.container?document.getElementById(e.container):e.container;return t.assertNonNullable(i,`Wrong container or containerId {${e.container}}`),i})(e),this.chromecastInitializer.contentId=null===(i=e.meta)||void 0===i?void 0:i.videoId,this.providerContainer=new sp({screenFormatsPriority:[...vp[n.SCREEN].live,...vp[n.SCREEN].vod],chromecastFormatsPriority:[...vp[n.CHROMECAST].live,...vp[n.CHROMECAST].vod],sources:e.sources,meta:null!==(s=e.meta)&&void 0!==s?s:{},container:this.domContainer,desiredState:this.desiredState,dependencies:{throughputEstimator:this.throughputEstimator,chromecastInitializer:this.chromecastInitializer,logger:this.logger},tuning:this.tuning}),this.initProviderContainerSubscription(this.providerContainer),this.initStartingVideoTrack(this.providerContainer),this.providerContainer.init(),this.initDebugTelemetry(),this}destroy(){var t;this.events.willDestruct$.next(),null===(t=this.providerContainer)||void 0===t||t.destroy(),this.throughputEstimator.destroy(),this.chromecastInitializer.destroy(),this.subscription.unsubscribe()}play(){const t=this.desiredState.playbackState;return t.getState()!==exports.PlaybackState.PLAYING&&t.startTransitionTo(exports.PlaybackState.PLAYING),this}pause(){const t=this.desiredState.playbackState;return t.getState()!==exports.PlaybackState.PAUSED&&t.startTransitionTo(exports.PlaybackState.PAUSED),this}stop(){const t=this.desiredState.playbackState;return t.getState()!==exports.PlaybackState.STOPPED&&t.startTransitionTo(exports.PlaybackState.STOPPED),this}seekTime(t,e=!0){return this.events.willSeek$.next({from:this.getExactTime(),to:t}),this.desiredState.seekState.setState({state:l.Requested,position:1e3*t,forcePrecise:e}),this}seekPercent(t){const e=this.info.duration$.getValue();return isFinite(e)&&this.seekTime(Math.abs(e)*t),this}setVolume(t){return this.chromecastInitializer.castState$.getValue()===exports.ChromecastState.CONNECTED?this.chromecastInitializer.setVolume(t):this.desiredState.volume.startTransitionTo({volume:t,muted:this.desiredState.volume.getState().muted}),this}setMuted(t){return this.chromecastInitializer.castState$.getValue()===exports.ChromecastState.CONNECTED?this.chromecastInitializer.setMuted(t):this.desiredState.volume.startTransitionTo({volume:this.desiredState.volume.getState().volume,muted:t}),this}setQuality(e){t.assertNonNullable(this.providerContainer);const i=this.providerContainer.providerOutput.availableVideoTracks$.getValue();i.length||(this.explicitInitialQuality=e);const s=i.find((t=>t.quality===e));return s&&this.desiredState.videoTrack.startTransitionTo(s.id),this}setAutoQuality(t){return this.desiredState.autoVideoTrackSwitching.startTransitionTo(t),this}setAutoQualityLimits(t){return this.desiredState.autoVideoTrackLimits.setState(t),this}setPlaybackRate(e){var i;t.assertNonNullable(this.providerContainer);const s=null===(i=this.providerContainer)||void 0===i?void 0:i.providerOutput.element$.getValue();return s&&(this.desiredState.playbackRate.setState(e),s.playbackRate=e),this}setExternalTextTracks(t){return this.desiredState.externalTextTracks.startTransitionTo(t.map((t=>Object.assign({type:'external'},t)))),this}selectTextTrack(t){var e;return(void 0===t||(null===(e=this.providerContainer)||void 0===e?void 0:e.providerOutput.availableTextTracks$.getValue().find((e=>e.id===t))))&&this.desiredState.currentTextTrack.startTransitionTo(t),this}setTextTrackCueSettings(t){return this.desiredState.textTrackCuesSettings.startTransitionTo(t),this}setLooped(t){return this.desiredState.isLooped.startTransitionTo(t),this}toggleChromecast(){this.chromecastInitializer.toggleConnection()}getExactTime(){t.assertNonNullable(this.providerContainer);const e=this.providerContainer.providerOutput.element$.getValue();if(t.isNullable(e))return this.info.position$.getValue();const i=this.desiredState.seekState.getState(),s=i.state===l.None?void 0:i.position;return t.isNonNullable(s)?s/1e3:e.currentTime}getAllLogs(){return this.logger.getAllLogs()}initDesiredStateSubscriptions(){this.subscription.add(t.merge(this.desiredState.playbackState.stateChangeStarted$,this.desiredState.playbackState.forceChanged$).pipe(t.map((t=>t.to))).subscribe(this.info.playbackState$)).add(this.desiredState.isLooped.stateChangeEnded$.pipe(t.map((t=>t.to))).subscribe(this.info.isLooped$)).add(this.desiredState.playbackRate.stateChangeEnded$.pipe(t.map((t=>t.to))).subscribe(this.info.currentPlaybackRate$)).add(this.desiredState.autoVideoTrackSwitching.stateChangeEnded$.pipe(t.map((t=>t.to))).subscribe(this.info.isAutoQualityEnabled$)).add(this.desiredState.autoVideoTrackLimits.stateChangeEnded$.pipe(t.map((t=>t.to))).subscribe(this.info.autoQualityLimits$));const e=new t.Subscription;this.subscription.add(e),this.subscription.add(this.desiredState.playbackState.stateChangeStarted$.pipe(t.filter((t=>t.to===exports.PlaybackState.PLAYING)),t.filter((()=>!this.isPlaybackStarted))).subscribe((()=>{this.initedAt=t.now(),this.events.inited$.next(),e.unsubscribe(),e.add(this.desiredState.playbackState.stateChangeEnded$.pipe(t.filter((t=>t.to===exports.PlaybackState.PLAYING||t.to===exports.PlaybackState.PAUSED)),t.debounce(0),t.once()).subscribe((t=>{const e=t.to===exports.PlaybackState.PLAYING,i=this.info.muted$.getValue(),s=e?i?exports.StartStatus.SuccessWithoutSound:exports.StartStatus.SuccessWithSound:exports.StartStatus.Failed;this.events.startAttempt$.next(s)})))}))),this.subscription.add(this.desiredState.playbackState.stateChangeEnded$.pipe(t.filter((t=>t.to===exports.PlaybackState.PLAYING))).subscribe((()=>{if(!this.isPlaybackStarted){const t=this.info.muted$.getValue();this.isPlaybackStarted=!0,this.events.started$.next(t)}}))).add(this.desiredState.playbackState.stateChangeStarted$.subscribe((t=>{switch(t.to){case exports.PlaybackState.PAUSED:this.events.willPause$.next();break;case exports.PlaybackState.PLAYING:this.isPlaybackStarted&&this.events.willResume$.next()}})))}initProviderContainerSubscription(e){this.subscription.add(e.providerOutput.willSeekEvent$.subscribe((()=>{const t=this.desiredState.seekState.getState();t.state===l.Requested?this.desiredState.seekState.setState(Object.assign(Object.assign({},t),{state:l.Applying})):this.events.managedError$.next({id:`WillSeekIn${t.state}`,message:'Received unexpeceted willSeek$'})}))).add(e.providerOutput.seekedEvent$.subscribe((()=>{this.desiredState.seekState.getState().state===l.Applying&&(this.desiredState.seekState.setState({state:l.None}),this.events.seeked$.next())}))).add(e.current$.pipe(t.map((t=>t.type))).subscribe(this.info.currentFormat$)).add(e.current$.pipe(t.map((t=>t.destination)),t.filterChanged()).subscribe((()=>{this.isPlaybackStarted=!1}))).add(e.providerOutput.availableVideoTracks$.pipe(t.map((t=>t.map((({quality:t})=>t)).sort(((t,e)=>au(t)?1:au(e)?-1:tu(e,t)?1:-1))))).subscribe(this.info.availableQualities$)).add(e.providerOutput.availableVideoTracks$.subscribe((t=>{const e={};for(const i of t)i.fps&&(e[i.quality]=i.fps);this.info.availableQualitiesFps$.next(e)}))).add(e.providerOutput.currentVideoTrack$.subscribe((t=>{this.info.currentQuality$.next(null==t?void 0:t.quality),this.info.videoBitrate$.next(null==t?void 0:t.bitrate);const i=e.providerOutput.element$.getValue();i&&this.info.intrinsicVideoSize$.next({width:i.videoWidth,height:i.videoHeight})}))).add(e.providerOutput.hostname$.pipe(t.filterChanged()).subscribe(this.info.hostname$)).add(e.providerOutput.httpConnectionType$.pipe(t.filterChanged()).subscribe(this.info.httpConnectionType$)).add(e.providerOutput.httpConnectionReused$.pipe(t.filterChanged()).subscribe(this.info.httpConnectionReused$)).add(e.providerOutput.currentTextTrack$.subscribe(this.info.currentTextTrack$)).add(e.providerOutput.availableTextTracks$.subscribe(this.info.availableTextTracks$)).add(e.providerOutput.autoVideoTrackLimitingAvailable$.subscribe(this.info.autoQualityLimitingAvailable$)).add(e.providerOutput.currentBuffer$.pipe(t.map((t=>t?{start:t.from,end:t.to}:{start:0,end:0}))).subscribe(this.info.currentBuffer$)).add(e.providerOutput.duration$.subscribe(this.info.duration$)).add(e.providerOutput.isBuffering$.subscribe(this.info.isBuffering$)).add(e.providerOutput.isLive$.subscribe(this.info.isLive$)).add(e.providerOutput.liveTime$.subscribe(this.info.liveTime$)).add(e.providerOutput.volume$.pipe(t.map((t=>t.muted)),t.filterChanged()).subscribe(this.info.muted$)).add(e.providerOutput.volume$.pipe(t.map((t=>t.volume)),t.filterChanged()).subscribe(this.info.volume$)).add((({seekState:e,position$:i})=>t.merge(e.stateChangeEnded$.pipe(t.map((({to:t})=>{var e;return t.state===l.None?void 0:(null!==(e=t.position)&&void 0!==e?e:NaN)/1e3})),t.filter(t.isNonNullable)),i.pipe(t.filter((()=>e.getState().state===l.None)))))({seekState:this.desiredState.seekState,position$:e.providerOutput.position$}).subscribe(this.info.position$)).add(t.merge(e.providerOutput.endedEvent$.pipe(t.mapTo(!0)),e.providerOutput.seekedEvent$.pipe(t.mapTo(!1))).pipe(t.filterChanged()).subscribe(this.info.isEnded$)).add(e.providerOutput.endedEvent$.subscribe(this.events.ended$)).add(e.providerOutput.loopedEvent$.subscribe(this.events.looped$)).add(e.providerError$.subscribe(this.events.managedError$)).add(e.noAvailableProvidersError$.pipe(t.map((t=>({id:'NoProviders',message:'No suitable providers or all providers failed'})))).subscribe(this.events.fatalError$)).add(e.providerOutput.element$.subscribe(this.experimental.element$)).add(e.providerOutput.firstBytesEvent$.pipe(t.once(),t.map((()=>t.now()-this.initedAt))).subscribe(this.events.firstBytes$)).add(e.providerOutput.firstFrameEvent$.pipe(t.once(),t.map((()=>t.now()-this.initedAt))).subscribe(this.events.firstFrame$)).add(e.providerOutput.canplay$.pipe(t.once(),t.map((()=>t.now()-this.initedAt))).subscribe(this.events.canplay$)).add(this.throughputEstimator.throughput$.subscribe(this.info.throughputEstimation$)).add(this.throughputEstimator.rtt$.subscribe(this.info.rttEstimation$));const i=new t.ValueSubject(!1);this.subscription.add(e.providerOutput.seekedEvent$.subscribe((()=>i.next(!1)))).add(e.providerOutput.willSeekEvent$.subscribe((()=>i.next(!0))));const s=new t.ValueSubject(!0);this.subscription.add(e.current$.subscribe((()=>s.next(!0)))).add(this.desiredState.playbackState.stateChangeEnded$.pipe(t.filter((({to:t})=>t===exports.PlaybackState.PLAYING)),t.once()).subscribe((()=>s.next(!1))));let a=0;const r=t.merge(e.providerOutput.isBuffering$,i,s).pipe(t.map((()=>{const t=e.providerOutput.isBuffering$.getValue(),a=i.getValue()||s.getValue();return t&&!a})),t.filterChanged());this.subscription.add(r.subscribe((t=>{t?a=window.setTimeout((()=>this.info.isStalled$.next(!0)),this.tuning.stallIgnoreThreshold):(window.clearTimeout(a),this.info.isStalled$.next(!1))})));const n=new t.Subscription;this.subscription.add(n);const o=t.merge(t.fromEvent(window,'beforeunload'),this.events.willDestruct$,e.current$.pipe(t.filter((t=>Boolean(null==t?void 0:t.provider)))));e.providerOutput.isLive$.pipe(t.filterChanged()).subscribe((e=>{switch(t.assertNonNullable(this.providerContainer),n.unsubscribe(),e){case!0:n.add(Sp({seekState:this.desiredState.seekState,playbackState:this.desiredState.playbackState,playbackAbort$:o,looped$:this.events.looped$,position$:this.providerContainer.providerOutput.liveTime$}).pipe(t.map((({from:t,to:e})=>({start:t,end:e})))).subscribe(this.events.watchCoverageLive$));break;case!1:n.add(Sp({seekState:this.desiredState.seekState,playbackState:this.desiredState.playbackState,looped$:this.events.looped$,playbackAbort$:o,position$:this.providerContainer.providerOutput.position$}).pipe(t.map((({from:t,to:e})=>({start:t,end:e})))).subscribe(this.events.watchCoverageRecord$))}}))}initChromecastSubscription(){this.subscription.add(this.chromecastInitializer.castState$.subscribe(this.info.chromecastState$)),this.subscription.add(this.chromecastInitializer.connection$.pipe(t.map((t=>null==t?void 0:t.castDevice.friendlyName))).subscribe(this.info.chromecastDeviceName$)),this.subscription.add(this.chromecastInitializer.errorEvent$.subscribe(this.events.managedError$))}initStartingVideoTrack(e){const i=new t.Subscription;this.subscription.add(i),this.subscription.add(e.current$.pipe(t.filterChanged(((t,e)=>t.provider===e.provider))).subscribe((()=>{i.unsubscribe(),i.add(e.providerOutput.availableVideoTracks$.pipe(t.filter((t=>t.length>0)),t.once()).subscribe((t=>{this.setStartingVideoTrack(t)})))})))}setStartingVideoTrack(t){let e;this.explicitInitialQuality&&(e=t.find((({quality:t})=>t===this.explicitInitialQuality)),this.explicitInitialQuality=void 0),e||(e=Gl(t,{container:this.domContainer.getBoundingClientRect(),throughput:this.throughputEstimator.throughput$.getValue(),tuning:this.tuning.autoTrackSelection,limits:this.desiredState.autoVideoTrackLimits.getState(),playbackRate:this.info.currentPlaybackRate$.getValue(),forwardBufferHealth:0})),this.desiredState.videoTrack.startTransitionTo(e.id),this.info.currentQuality$.next(e.quality),this.info.videoBitrate$.next(e.bitrate)}initLogs(){this.subscription.add(t.merge(this.desiredState.videoTrack.stateChangeStarted$.pipe(t.map((t=>({transition:t,entity:'quality',type:'start'})))),this.desiredState.videoTrack.stateChangeEnded$.pipe(t.map((t=>({transition:t,entity:'quality',type:'end'})))),this.desiredState.autoVideoTrackSwitching.stateChangeStarted$.pipe(t.map((t=>({transition:t,entity:'autoQualityEnabled',type:'start'})))),this.desiredState.autoVideoTrackSwitching.stateChangeEnded$.pipe(t.map((t=>({transition:t,entity:'autoQualityEnabled',type:'end'})))),this.desiredState.seekState.stateChangeStarted$.pipe(t.map((t=>({transition:t,entity:'seekState',type:'start'})))),this.desiredState.seekState.stateChangeEnded$.pipe(t.map((t=>({transition:t,entity:'seekState',type:'end'})))),this.desiredState.playbackState.stateChangeStarted$.pipe(t.map((t=>({transition:t,entity:'playbackState',type:'start'})))),this.desiredState.playbackState.stateChangeEnded$.pipe(t.map((t=>({transition:t,entity:'playbackState',type:'end'}))))).pipe(t.map((t=>({component:'desiredState',message:`[${t.entity} change] ${t.type}: ${JSON.stringify(t.transition)}`})))).subscribe(this.logger.log)),this.subscription.add(this.logger.log$.subscribe(this.events.log$))}initDebugTelemetry(){var e;const i=null===(e=this.providerContainer)||void 0===e?void 0:e.providerOutput;t.assertNonNullable(this.providerContainer),t.assertNonNullable(i),Vl={},this.experimental.enableDebugTelemetry$.next(this.tuning.enableTelemetryAtStart),[this.experimental.enableDebugTelemetry$.subscribe((t=>{Ml=t})),this.providerContainer.current$.subscribe((({type:t})=>Fl('provider',t))),i.duration$.subscribe((t=>Fl('duration',t))),i.availableVideoTracks$.pipe(t.filter((t=>!!t.length)),t.once()).subscribe((t=>Fl('tracks',t))),this.events.fatalError$.subscribe(new jl('fatalError')),this.events.managedError$.subscribe(new jl('managedError')),i.position$.subscribe(new jl('position')),i.currentVideoTrack$.pipe(t.map((t=>null==t?void 0:t.quality))).subscribe(new jl('quality')),this.info.currentBuffer$.subscribe(new jl('buffer')),i.isBuffering$.subscribe(new jl('isBuffering'))].forEach((t=>this.subscription.add(t))),Fl('codecs',Object.keys(Hh).filter((t=>Hh[t])))}},exports.SDK_VERSION='@vkontakte/videoplayer-core@2.0.71';
